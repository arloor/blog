---
title: "安卓Vpn开发思路"
author: "刘港欢"
date: 2019-01-30
categories: [ "网络编程"]
tags: ["program"]
weight: 10
---

经过2个月的开发，我的http代理可以说没有遗憾了，当然还有可以改进的地方，比如多用户认证啥的，但是没有必要啦。

为了在安卓上也能愉快地使用自己开发的代理，研究了一下安卓Vpnservice，在此记录一下当前的成功，并确定以后的开发思路。
<!--more-->

# Vpn examples

初步搭一个vpn应用的框架[原文](https://www.tuicool.com/articles/uuiMje)

经测试，是可以的，但是具体功能并没有实现

# 所发现的第一个问题

Vpnservice是安卓提供给开发者用于开发自己的VPN的服务。开发者继承这个Vpnservice，从而实现VPN。先说一下，这个VPNservice的原理。手机本身是有一块网卡，安卓虚拟出一个网卡，然后通过NAT，将真实网卡上的出站流量转发到虚拟网卡上，然后Vpnservice获取这个虚拟网卡上的“流量”，并转发给Vpn的服务端。其实还是挺好理解的。问题在于，上面说的流量，并不是传输层的tcp/udp流量，而是ip数据报。

所以问题来了。之前代理所操作的是tcp包，现在要处理ip数据报。而且java语言只提供了传输层（tcp/udp）的socket传输api。这意味着，开发Vpn必定有一部分需要使用其他语言（C/C++）。

看安卓example的[ToyVpn](https://android.googlesource.com/platform/development/+/master/samples/ToyVpn)中server的代码，发现他的代码就是直接open /dev下的网卡文件，然后读写来收取ip数据（一切皆文件真的骚。。）

# 解决方案

一句话：将ip数据报通过Udp发送给代理服务器，代理服务器解包后得到原始的ip数据报，通过C/C++写进网卡文件。

通过Udp传输的原因是，Udp（用户数据报）是ip数据报的简单包裹，不像tcp数据包那样，增加了很复杂的东西，也不进行失败重传等操作。要清楚，我们这里传输的是较底层的ip数据报，在ip数据报的上层，可能是UDP，也可能是TCP，不管传输层是什么协议，消息的正确性，失败重传等等，都有人做过，我们只要传就好了，所以用UDP是最好的。

通过C/C++写进网卡，这个可能要用JNI，没用过，学学吧。


其实就是ip over udp。下面是一段对这个概念的阐释：[原文](https://www.cnblogs.com/zhangzl2013/p/foo_over_udp.html)

数据报文封包和UDP隧道相对来说还是比较容易理解的概念。试想一个进入隧道的TCP数据包：

![](/img/090749575304490.jpg)


这个数据报有正常的IP和TCP头，后面是用户要发送的数据。封包的过程如下：

![](/img/090751088583813.jpg)


这样，这个数据包就是一个UDP数据包，里面装的是TCP数据包。系统可以将他想普通的UDP数据包一样发送；在接收端，额外的UDP头部被去掉后，原始的TCP数据包继续进入网络堆栈进行处理。


# 解决方案二

在安卓机上解析ip数据报，最终拿到tcp/udp的数据部分，最后传输。怎么看怎么不合理。。