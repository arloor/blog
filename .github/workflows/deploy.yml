name: Deploy

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  all:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set outputs
      id: vars
      run: echo "sha_short=$(git rev-parse --short=8 HEAD)" >> $GITHUB_OUTPUT
    - name: prepare
      run: |
        hugoVersion="0.96.0"
        hugoVersion="0.121.1"
        hugoURL=https://github.com/gohugoio/hugo/releases/download/v${hugoVersion}/hugo_extended_${hugoVersion}_Linux-64bit.tar.gz
        sudo apt install -y tar curl
        mkdir /tmp/hugo
        curl -Lf "$hugoURL" -o /tmp/hugo/hugo.tar.gz
        tar -zxf /tmp/hugo/hugo.tar.gz -C /tmp/hugo/
        install /tmp/hugo/hugo /usr/local/bin/
        hugo -d public
    - name: Deploy
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./public
    - name: install ssh keys
      run: |
        install -m 600 -D /dev/null ~/.ssh/id_rsa
        echo "${{ secrets.SSH_PRIVATE_KEY }}" >> ~/.ssh/id_rsa
        for i in ${{ secrets.SSH_HOST }};do
          echo "add ${i} to known_hosts"
          ssh-keyscan -H ${i} >> ~/.ssh/known_hosts
        done
    - name: connect and pull
      run: |
        for i in ${{ secrets.SSH_HOST }};do
          echo "connect to ${i}";
          ssh root@${i} '
              mkdir -p /usr/share/nginx/html;
              if [ ! -d /usr/share/nginx/html/blog ];then 
                echo "blog目录不存在，clone";
                git clone https://github.com/arloor/blog.git -b gh-pages /usr/share/nginx/html/blog;
              else
                if [ -d /usr/share/nginx/html/blog/.git ];then
                  echo "blog目录存在，是git仓库，pull";
                  cd /usr/share/nginx/html/blog;
                  git reset --hard;
                  git checkout gh-pages;
                  git reset --hard;
                  git pull --rebase;
                else
                  echo "blog目录存在，但不是git仓库，重新clone";
                  rm -rf /usr/share/nginx/html/blog;
                  git clone https://github.com/arloor/blog.git -b gh-pages /usr/share/nginx/html/blog;
                fi
              fi 
            '
        done
    - name: cleanup
      run: rm -rf ~/.ssh
