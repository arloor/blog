<!DOCTYPE html>
<html lang="zh-CN">

    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    
    <link rel="canonical" href="https://www.arloor.com/posts/startup-onboot-macos/">
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.157.0">

    
    
    

<title>MacOS开机自启动、资源限制、定时任务 • ARLOOR</title>
<meta name="description" content="今天，你学习了吗">
<meta name="keywords" content="刘港欢, arloor, moontell">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="MacOS开机自启动、资源限制、定时任务">
  <meta name="twitter:description" content="本文介绍使用 MacOS 的 LaunchAgents 和 LaunchDaemons 实现开机自启动、资源限制和定时任务的配置方法。">
      <meta name="twitter:site" content="@njulgh">

<meta property="og:url" content="https://www.arloor.com/posts/startup-onboot-macos/">
  <meta property="og:site_name" content="ARLOOR">
  <meta property="og:title" content="MacOS开机自启动、资源限制、定时任务">
  <meta property="og:description" content="本文介绍使用 MacOS 的 LaunchAgents 和 LaunchDaemons 实现开机自启动、资源限制和定时任务的配置方法。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-12-16T19:31:51+08:00">
    <meta property="article:modified_time" content="2025-12-16T19:31:51+08:00">
    <meta property="article:tag" content="Undefined">


    





<link rel="stylesheet" href="/styles/atom-one-dark.min.css">








<link rel="stylesheet" href="/scss/hyde-hyde.debf1b963c1830f6b9b96ee48c2b4a22c31c7c3885a87bed290c0e198fc6a08d.css" integrity="sha256-3r8bljwYMPa5uW7kjCtKIsMcfDiFqHvtKQwOGY/GoI0=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">




<link rel="stylesheet" href="/scss/hugo-toc.6b7222b4ddd3cebd47d144a2e37ade6cbbb64f47e31d8feac655896156ade206.css" integrity="sha256-a3IitN3Tzr1H0USi43rebLu2T0fjHY/qxlWJYVat4gY=">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    

</head>



<body class="  ">
  
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="/">
          
          ARLOOR
          
        </a>
      </span>
      <a href="/">
        
        
        <div class="author-image">
          <img src="/img/head.jpeg" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
        
      </a>
      
      <p class="site__description">
         都是瞎写的 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">ARLOOR</label>
      <div class="menu-content menu-content--mobile">
        <div class="show-in-small">
          <a href="/">
            
            
            <div class="author-image">
              <img src="/img/head.jpeg" alt="Author Image"
                class="img--circle img--headshot element--center">
            </div>
            
            
          </a>
        </div>
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>文章</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/">
						<span>分类</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>关于我</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/grafana-iframe">
						<span>Grafana</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/net-iframe">
						<span>网速监控</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/nat">
						<span>NAT规则</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/stock">
						<span>股票监控</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://x.com/njulgh" rel="me" target="_blank"><i class="fa-brands fa-x-twitter fa-lg"></i></a>
	
	
	
	
	
	<a href="https://github.com/arloor" rel="me" target="_blank"><i class="fa-brands fa-github fa-lg"></i></a>
	
	
	
	
	
	
	
	
	
	
	
	
	
	<a href="https://t.me/never_contact_me" rel="me" target="_blank"><i class="fa-brands fa-telegram fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="mailto:admin@arloor.com" rel="me" target="_blank"><i class="fa-solid fa-at fa-lg"></i></a>
	
	
	
	
</section>
      </div>
    </div>
    <div class="menu-content menu-content--desktop">
      <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>文章</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/">
						<span>分类</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>关于我</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/grafana-iframe">
						<span>Grafana</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/net-iframe">
						<span>网速监控</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/nat">
						<span>NAT规则</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/stock">
						<span>股票监控</span>
					</a>
				</li>
			 
		
	</ul>
</div>

    </div>
    <div class="social-wrap social-wrap--desktop">
      <section class="social">
	
	<a href="https://x.com/njulgh" rel="me" target="_blank"><i class="fa-brands fa-x-twitter fa-lg"></i></a>
	
	
	
	
	
	<a href="https://github.com/arloor" rel="me" target="_blank"><i class="fa-brands fa-github fa-lg"></i></a>
	
	
	
	
	
	
	
	
	
	
	
	
	
	<a href="https://t.me/never_contact_me" rel="me" target="_blank"><i class="fa-brands fa-telegram fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="mailto:admin@arloor.com" rel="me" target="_blank"><i class="fa-solid fa-at fa-lg"></i></a>
	
	
	
	
</section>
    </div>
    
<div class="copyright">
  &copy; 2026 arloor
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>


<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/arloor/hyde-arloor">hyde-arloor</a>.
</div>


  </div>
</div>

  <div class="content container">
    
    
<article>
  <header>
    <h1>MacOS开机自启动、资源限制、定时任务</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Dec 16, 2025
    
    
    
      
      
          in
          
          
              <a class="badge badge-category" href="/categories/undefined">UNDEFINED</a>
              
          
      
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/undefined">undefined</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 5 min read
</div>


  </header>
  
  
  
    <div class="toc-wrapper">
      <input type="checkbox" id="tocToggle">
      <label for="tocToggle">Table of Content</label>
      
          <nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#编写-agentdaemon-配置文件plist-文件">编写 Agent/Daemon 配置文件（plist 文件）</a></li>
    <li><a href="#服务管理脚本">服务管理脚本</a></li>
    <li><a href="#launchctl-子命令说明">launchctl 子命令说明</a></li>
    <li><a href="#服务禁用数据库清理">服务禁用数据库清理</a></li>
    <li><a href="#全局资源限制">全局资源限制</a></li>
    <li><a href="#macos-定时任务">macOS 定时任务</a></li>
  </ul>
</nav>
      
    </div>
  
  
  <div class="post">
    <p>本文介绍使用 MacOS 的 LaunchAgents 和 LaunchDaemons 实现开机自启动、资源限制和定时任务的配置方法。</p>
<h2 id="前言">前言</h2>
<p>在 MacOS 上的“登陆项与扩展”中有两种开机自启方式：</p>
<ol>
<li>登录项（Login Items）：适用于图形界面应用程序</li>
<li>启动代理与守护进程（LaunchAgents 和 LaunchDaemons）：适用于后台服务和命令行工具</li>
</ol>



<img src="/img/macos-startup.png" alt="" width="600px" style="max-width: 100%;">

<p>本文介绍如何使用使用 LaunchAgents 和 LaunchDaemons 来实现开机自启动、资源限制和定时任务。</p>
<h2 id="编写-agentdaemon-配置文件plist-文件">编写 Agent/Daemon 配置文件（plist 文件）</h2>
<p>LaunchAgents 和 LaunchDaemons 的配置文件使用 plist 格式，通常以 <code>.plist</code> 作为文件扩展名。根据不同的使用场景，plist 文件应放置在不同的目录中：</p>
<table>
  <thead>
      <tr>
          <th>plist 目录</th>
          <th>domain-target</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>/Library/LaunchDaemons/</td>
          <td>system</td>
          <td>系统级守护进程。系统启动时加载</td>
      </tr>
      <tr>
          <td>/Library/LaunchAgents/</td>
          <td>gui/<!-- raw HTML omitted --></td>
          <td>所有用户的图形界面代理。任何用户 GUI 登录时加载</td>
      </tr>
      <tr>
          <td>~/Library/LaunchAgents/</td>
          <td>gui/<!-- raw HTML omitted --></td>
          <td>当前用户的图形界面代理。本用户 GUI 登录时加载</td>
      </tr>
  </tbody>
</table>
<p>参考：</p>
<ol>
<li><code>man launchd.plist</code></li>
<li><a href="https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/CreatingLaunchdJobs.html">Apple Developer Documentation - launchd.plist</a></li>
<li><a href="https://www.launchd.info/">Launchd.info</a></li>
</ol>
<p>下面是一个示例 plist 文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">&lt;!DOCTYPE plist PUBLIC &#34;-//Apple//DTD PLIST 1.0//EN&#34; &#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd&#34;&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;plist</span> <span style="color:#a6e22e">version=</span><span style="color:#e6db74">&#34;1.0&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dict&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;key&gt;</span>Label<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;string&gt;</span>com.arloor.sslocal<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">&lt;!-- 退出后是否重启 --&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;key&gt;</span>KeepAlive<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;false</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">&lt;!-- 加载后立即启动，即开机自启。如果设置为false，则bootstrap后还需要kickstart才会启动 --&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;key&gt;</span>RunAtLoad<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;true</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;key&gt;</span>WorkingDirectory<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;string&gt;</span>/tmp<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;key&gt;</span>EnvironmentVariables<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;dict&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;key&gt;</span>aPATH<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;string&gt;</span>/bin:/usr/bin:/usr/local/bin<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;/dict&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;key&gt;</span>ProgramArguments<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;array&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;string&gt;</span>/Users/bytedance/.cargo/bin/sslocal<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;string&gt;</span>--local-addr<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;string&gt;</span>localhost:2080<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;string&gt;</span>-k<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;string&gt;</span>xxxxxxxx<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;string&gt;</span>-m<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;string&gt;</span>aes-256-gcm<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;string&gt;</span>-s<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;string&gt;</span>host:port<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;string&gt;</span>-v<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;/array&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">&lt;!-- 软资源限制 --&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;key&gt;</span>SoftResourceLimits<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;dict&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;key&gt;</span>NumberOfFiles<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;integer&gt;</span>65536<span style="color:#f92672">&lt;/integer&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;/dict&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">&lt;!-- 硬资源限制 --&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;key&gt;</span>HardResourceLimits<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;dict&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;key&gt;</span>NumberOfFiles<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;integer&gt;</span>65536<span style="color:#f92672">&lt;/integer&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;/dict&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">&lt;!-- 标准输出路径 --&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;key&gt;</span>StandardOutPath<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;string&gt;</span>/tmp/sslocal.log<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">&lt;!-- 标准错误路径 --&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;key&gt;</span>StandardErrorPath<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;string&gt;</span>/tmp/sslocal.log<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dict&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/plist&gt;</span>
</span></span></code></pre></div><p>各字段解释：</p>
<table>
  <thead>
      <tr>
          <th>字段名</th>
          <th>说明</th>
          <th>是否必填</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Label</td>
          <td>服务的唯一标识符</td>
          <td>是</td>
      </tr>
      <tr>
          <td>ProgramArguments</td>
          <td>要执行的命令及其参数</td>
          <td>是</td>
      </tr>
      <tr>
          <td>RunAtLoad</td>
          <td>是否在加载时启动服务</td>
          <td>否</td>
      </tr>
      <tr>
          <td>KeepAlive</td>
          <td>服务退出后是否自动重启</td>
          <td>否</td>
      </tr>
      <tr>
          <td>WorkingDirectory</td>
          <td>服务的工作目录</td>
          <td>否</td>
      </tr>
      <tr>
          <td>EnvironmentVariables</td>
          <td>设置服务的环境变量</td>
          <td>否</td>
      </tr>
      <tr>
          <td>SoftResourceLimits</td>
          <td>设置服务的软资源限制</td>
          <td>否</td>
      </tr>
      <tr>
          <td>HardResourceLimits</td>
          <td>设置服务的硬资源限制</td>
          <td>否</td>
      </tr>
      <tr>
          <td>StandardOutPath</td>
          <td>标准输出日志文件路径</td>
          <td>否</td>
      </tr>
      <tr>
          <td>StandardErrorPath</td>
          <td>标准错误日志文件路径</td>
          <td>否</td>
      </tr>
  </tbody>
</table>
<p>我们主要通过 <code>RunAtLoad = True</code> 实现开机自启，建议任何自定义 plist 都设置 <code>RunAtLoad = True</code>。</p>
<h2 id="服务管理脚本">服务管理脚本</h2>
<p>这里提供一个脚本用于启动和停止 LaunchAgent/LaunchDaemon 服务，效果类似于 Linux 上的 systemctl：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#! /bin/bash
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sub_command<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>service_name<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用while循环读取参数</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> <span style="color:#f92672">[</span> $# -gt <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;enable&#34;</span> <span style="color:#f92672">]</span> <span style="color:#f92672">||</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;disable&#34;</span> <span style="color:#f92672">]</span> <span style="color:#f92672">||</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;start&#34;</span> <span style="color:#f92672">]</span> <span style="color:#f92672">||</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;stop&#34;</span> <span style="color:#f92672">]</span> <span style="color:#f92672">||</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;restart&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        sub_command<span style="color:#f92672">=</span>$1
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        service_name<span style="color:#f92672">=</span>$1
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>    shift <span style="color:#75715e"># 移除第一个参数</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$service_name<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;ERROR: need service name&#34;</span>
</span></span><span style="display:flex;"><span>    exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>userID<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$userID<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;0&#34;</span> <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    domain_target<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;system&#34;</span>
</span></span><span style="display:flex;"><span>    plist_path<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/Library/LaunchDaemons/&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}||{</span>
</span></span><span style="display:flex;"><span>    domain_target<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;gui/</span><span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    plist_path<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$HOME<span style="color:#e6db74">/Library/LaunchAgents/&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;domain_target=</span><span style="color:#e6db74">${</span>domain_target<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;plist_path=</span><span style="color:#e6db74">${</span>plist_path<span style="color:#e6db74">}${</span>service_name<span style="color:#e6db74">}</span><span style="color:#e6db74">.plist&#34;</span>
</span></span><span style="display:flex;"><span>echo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;sub_command: </span><span style="color:#e6db74">${</span>sub_command<span style="color:#e6db74">}</span><span style="color:#e6db74"> [</span><span style="color:#e6db74">${</span>service_name<span style="color:#e6db74">}</span><span style="color:#e6db74">]&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span> -f <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>plist_path<span style="color:#e6db74">}${</span>service_name<span style="color:#e6db74">}</span><span style="color:#e6db74">.plist&#34;</span> <span style="color:#f92672">]</span> <span style="color:#f92672">||</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;ERROR: plist file not found: </span><span style="color:#e6db74">${</span>plist_path<span style="color:#e6db74">}${</span>service_name<span style="color:#e6db74">}</span><span style="color:#e6db74">.plist&#34;</span>
</span></span><span style="display:flex;"><span>    exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>get_cur_pid<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    launchctl list | awk -v sn<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>service_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#39;$3 == sn {print $1}&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;</span>$sub_command<span style="color:#e6db74">&#34;</span> in
</span></span><span style="display:flex;"><span>    enable<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        launchctl enable <span style="color:#e6db74">${</span>domain_target<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>service_name<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>        launchctl bootstrap <span style="color:#e6db74">${</span>domain_target<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>plist_path<span style="color:#e6db74">}${</span>service_name<span style="color:#e6db74">}</span>.plist 2&gt;/dev/null
</span></span><span style="display:flex;"><span>        pid<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>launchctl kickstart -p <span style="color:#e6db74">${</span>domain_target<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>service_name<span style="color:#e6db74">}</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$pid<span style="color:#e6db74">&#34;</span> !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>            echo 进程ID $pid
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            echo 启动失败
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>        ;;
</span></span><span style="display:flex;"><span>    disable<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        launchctl bootout <span style="color:#e6db74">${</span>domain_target<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>service_name<span style="color:#e6db74">}</span> 2&gt;/dev/null
</span></span><span style="display:flex;"><span>        launchctl disable <span style="color:#e6db74">${</span>domain_target<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>service_name<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>        ;;
</span></span><span style="display:flex;"><span>    start<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        pid<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>launchctl kickstart -p <span style="color:#e6db74">${</span>domain_target<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>service_name<span style="color:#e6db74">}</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$pid<span style="color:#e6db74">&#34;</span> !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>            echo 新进程 $pid
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            echo 启动失败
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>        ;;
</span></span><span style="display:flex;"><span>    stop<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        old_pid<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>get_cur_pid<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$old_pid<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 服务已退出，无PID</span>
</span></span><span style="display:flex;"><span>            old_pid<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$old_pid<span style="color:#e6db74">&#34;</span> !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>            echo 关闭老进程 $old_pid
</span></span><span style="display:flex;"><span>            launchctl kill <span style="color:#ae81ff">9</span> <span style="color:#e6db74">${</span>domain_target<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>service_name<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>        ;;
</span></span><span style="display:flex;"><span>    restart<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        old_pid<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>get_cur_pid<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$old_pid<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 服务已退出，无PID</span>
</span></span><span style="display:flex;"><span>            old_pid<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$old_pid<span style="color:#e6db74">&#34;</span> !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>            echo 旧进程ID $old_pid
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            echo 无旧进程
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>        pid<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>launchctl kickstart -kp <span style="color:#e6db74">${</span>domain_target<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>service_name<span style="color:#e6db74">}</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$pid<span style="color:#e6db74">&#34;</span> !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>            echo 新进程ID $pid
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            echo 重启失败
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>        ;;
</span></span><span style="display:flex;"><span>    *<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;ERROR: unknown sub_command: </span>$sub_command<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;Usage: </span>$0<span style="color:#e6db74"> {enable|disable|start|stop|restart} service_name&#34;</span>
</span></span><span style="display:flex;"><span>        exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        ;;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">esac</span>
</span></span></code></pre></div><p>把这个脚本命名成 <code>systemctl</code>，那你就可以：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl enable com.arloor.sslocal  <span style="color:#75715e"># 设置开机自启并立即启动</span>
</span></span><span style="display:flex;"><span>systemctl disable com.arloor.sslocal <span style="color:#75715e"># 停止进程并取消开机自启</span>
</span></span><span style="display:flex;"><span>systemctl start com.arloor.sslocal   <span style="color:#75715e"># 启动（不改变开机自启设置）</span>
</span></span><span style="display:flex;"><span>systemctl stop com.arloor.sslocal    <span style="color:#75715e"># 停止进程（不改变开机自启设置）</span>
</span></span><span style="display:flex;"><span>systemctl restart com.arloor.sslocal   <span style="color:#75715e"># 重新启动（不改变开机自启设置）</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo systemctl enable xxxx  <span style="color:#75715e"># 操作 /Library/LaunchDaemons/下的plist</span>
</span></span><span style="display:flex;"><span>sudo systemctl disable xxxx
</span></span><span style="display:flex;"><span>sudo systemctl start xxxx
</span></span><span style="display:flex;"><span>sudo systemctl stop xxxx
</span></span><span style="display:flex;"><span>sudo systemctl restart xxxx
</span></span></code></pre></div><table>
  <thead>
      <tr>
          <th>命令</th>
          <th>说明</th>
          <th>实现细节</th>
          <th>是否影响开机自启</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>systemctl enable xxx</td>
          <td>设置开机自启并立即启动进程</td>
          <td>launchctl enable + bootstrap</td>
          <td>是</td>
      </tr>
      <tr>
          <td>systemctl disable xxx</td>
          <td>停止进程并取消开机自启</td>
          <td>launchctl bootout + disable</td>
          <td>是</td>
      </tr>
      <tr>
          <td>systemctl start xxx</td>
          <td>启动，不改变开机自启设置</td>
          <td>launchctl kickstart -kp</td>
          <td>否</td>
      </tr>
      <tr>
          <td>systemctl stop xxx</td>
          <td>停止进程，不改变开机自启设置</td>
          <td>launchctl bootout</td>
          <td>否</td>
      </tr>
      <tr>
          <td>systemctl restart xxx</td>
          <td>重新启动，不改变开机自启设置</td>
          <td>launchctl kill + kickstart</td>
          <td>否</td>
      </tr>
  </tbody>
</table>
<p>如果使用 <code>sudo</code> 执行 <code>systemctl</code>，则操作的是系统级的 LaunchDaemons;否则操作的是当前用户的 LaunchAgents。</p>
<h2 id="launchctl-子命令说明">launchctl 子命令说明</h2>
<blockquote>
<ul>
<li><code>bootstrap</code> 和 <code>bootout</code>相当于老命令 load 和 unload （RunAtLoad 的那个 Load）。只有在 service 是 enable 的状态下才有效。所以上面的脚本中，bootout 在 disable 之前，bootstrap 后 enable 之后。</li>
<li><code>unload -w</code> 等同于 <code>bootout + disable</code>，停止进程并禁用开机自启动。已废弃。</li>
<li><code>load -w</code> 等同于 <code>enable + bootstrap</code>，启动进程并设置开机自启动。已废弃。</li>
<li><code>bootstrap</code> 需要使用 plist 的路径，而不是 service-name</li>
<li><code>launchctl kickstart -p</code> 启动并打印 PID，但不会修改 enable/disable 状态。</li>
</ul>
</blockquote>
<h2 id="服务禁用数据库清理">服务禁用数据库清理</h2>
<p>LaunchAgents/LaunchDaemons 是否被 disable 存储在单独的文件中。由于 MacOS 不会自动删除 plist 已经被删除的 LaunchAgents/LaunchDaemons。这导致<code>launchctl print-disabled gui/$(id -u)</code>时会看到一些无效的项目。如果想手动删除这些项目，需要先在恢复模式（开机时按住 ⌘R）关闭安全模式，然后才能通过 vim 修改。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># LaunchAgents</span>
</span></span><span style="display:flex;"><span>/private/var/db/com.apple.xpc.launchd/disabled.<span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>.plist
</span></span><span style="display:flex;"><span><span style="color:#75715e"># LaunchDaemons</span>
</span></span><span style="display:flex;"><span>/private/var/db/com.apple.xpc.launchd/disabled.plist
</span></span></code></pre></div><p>或者直接在恢复模式使用 PlistBuddy 删除</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 删除 LaunchAgents 禁用项</span>
</span></span><span style="display:flex;"><span>/usr/libexec/Plistbuddy <span style="color:#e6db74">&#34;/Volumes/{系统卷名称}/var/db/com.apple.xpc.launchd/disabled.{用户ID}.plist&#34;</span> -c Delete:<span style="color:#f92672">{</span>Label<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除 LaunchDaemons 禁用项</span>
</span></span><span style="display:flex;"><span>/usr/libexec/Plistbuddy <span style="color:#e6db74">&#34;/Volumes/{系统卷名称}/var/db/com.apple.xpc.launchd/disabled.plist&#34;</span> -c Delete:<span style="color:#f92672">{</span>Label<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 示例</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># /usr/libexec/Plistbuddy &#34;/Volumes/Macintosh HD/var/db/com.apple.xpc.launchd/disabled.502.plist&#34; -c Delete:local.job</span>
</span></span></code></pre></div><h2 id="全局资源限制">全局资源限制</h2>
<p>unix 系统都限制了可打开文件数，上面的 plist 修改了单个进程的文件描述符数量限制。如何修改全局资源限制呢？</p>
<ol>
<li>新建 <code>/Library/LaunchDaemons/limit.maxfiles.plist</code> 文件，写入</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e">&lt;!DOCTYPE plist PUBLIC &#34;-//Apple//DTD PLIST 1.0//EN&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         &#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd&#34;&gt;</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">&lt;plist</span> <span style="color:#a6e22e">version=</span><span style="color:#e6db74">&#34;1.0&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">&lt;dict&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">&lt;key&gt;</span>Label<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">&lt;string&gt;</span>limit.maxfiles<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">&lt;key&gt;</span>ProgramArguments<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">&lt;array&gt;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">&lt;string&gt;</span>launchctl<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">&lt;string&gt;</span>limit<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">&lt;string&gt;</span>maxfiles<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">&lt;string&gt;</span>64000<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">&lt;string&gt;</span>524288<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">&lt;/array&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">&lt;key&gt;</span>RunAtLoad<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">&lt;true/&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">&lt;/dict&gt;</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">&lt;/plist&gt;</span>
</span></span></code></pre></div><ol start="2">
<li>修改文件权限</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo chown root:wheel /Library/LaunchDaemons/limit.maxfiles.plist
</span></span><span style="display:flex;"><span>sudo chmod <span style="color:#ae81ff">644</span> /Library/LaunchDaemons/limit.maxfiles.plist
</span></span></code></pre></div><ol start="3">
<li>加载 plist 文件(或重启系统后生效 launchd 在启动时会自动加载该目录的 plist)</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo systemctl enable limit.maxfiles
</span></span></code></pre></div><ol start="4">
<li>确认更改后的限制</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>launchctl limit maxfiles
</span></span></code></pre></div><p>详见<a href="https://zidongwudaijun.com/2017/02/max-osx-ulimit/">Mac OS X 下的资源限制</a></p>
<h2 id="macos-定时任务">macOS 定时任务</h2>
<p>参考<a href="https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/ScheduledJobs.html">Scheduling Timed Jobs</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">&lt;!DOCTYPE plist PUBLIC &#34;-//Apple//DTD PLIST 1.0//EN&#34; &#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd&#34;&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;plist</span> <span style="color:#a6e22e">version=</span><span style="color:#e6db74">&#34;1.0&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dict&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;key&gt;</span>Label<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;string&gt;</span>com.arloor.job<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">&lt;!-- 加载后立即执行一次 --&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;key&gt;</span>RunAtLoad<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;true</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;key&gt;</span>WorkingDirectory<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;string&gt;</span>/tmp<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;key&gt;</span>ProgramArguments<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;array&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;string&gt;</span>/Users/arloor/bin/work<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/array&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;key&gt;</span>StartCalendarInterval<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dict&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">&lt;!-- 每天10点执行一次 --&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;key&gt;</span>Hour<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;integer&gt;</span>10<span style="color:#f92672">&lt;/integer&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;key&gt;</span>Minute<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;integer&gt;</span>0<span style="color:#f92672">&lt;/integer&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dict&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">&lt;!-- 标准输出路径 --&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;key&gt;</span>StandardOutPath<span style="color:#f92672">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;string&gt;</span>/tmp/work.log<span style="color:#f92672">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dict&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/plist&gt;</span>
</span></span></code></pre></div><ol>
<li>这样设置后，每天 10 点会执行一次。</li>
<li>如果 10 点刚好 mac 在待机，则唤醒后会执行一次。</li>
<li>如果 10 点是关机的，则开机后不会执行。</li>
<li>还有个 StartInterval 的参数，每多少秒执行一次。这个参数因睡眠导致的错过在唤醒时不会执行的。</li>
</ol>
  </div>
  

<div class="navigation navigation-single">
    
    <a href="/posts/windows-powershell/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Windows Powershell常用脚本</span>
    </a>
    
    
    <a href="/posts/play-with-k3s/" class="navigation-next">
      <span class="navigation-tittle">K3S上手玩</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  


</article>


  </div>
<style>
  .content.container {
        width: 100%;
        max-width: none;
        height: calc(100vh - var(--sidebar-height, 49px));
        border: none;
        display: block;
        overflow-y: auto;
        box-sizing: border-box;
        margin-left: 0;
        margin-right: 0;
  }

  body:not(.type-iframe) .content.container {
        padding-left: max(1.5rem, calc((100% - var(--content-max-width, 38rem)) / 2));
        padding-right: max(1.5rem, calc((100% - var(--content-max-width, 38rem)) / 2));
  }
</style>
<script>
    (function () {
        var contentSelector = '.content.container';
        var rafId = 0;
        var resizeDebounceTimer = 0;
        var pendingHashScroll = false;

        function getHashTarget() {
            var hash = window.location.hash;
            var targetId = '';

            if (!hash || hash === '#') {
                return null;
            }

            targetId = hash.slice(1);
            try {
                targetId = decodeURIComponent(targetId);
            } catch (e) {
                
            }

            return document.getElementById(targetId);
        }

        function scrollToHashTarget() {
            var target = getHashTarget();
            if (!target) {
                return;
            }
            try {
                target.scrollIntoView({ block: 'start', inline: 'nearest' });
            } catch (e) {
                target.scrollIntoView(true);
            }
        }

        function applyPendingHashScroll() {
            if (!pendingHashScroll) {
                return;
            }
            pendingHashScroll = false;
            scrollToHashTarget();
        }

        function resizeContentHeight() {
            var content = document.querySelector(contentSelector);
            if (!content) {
                return;
            }
            var rect = content.getBoundingClientRect();
            var available = window.innerHeight - rect.top;
            if (available < 0) {
                available = 0;
            }
            content.style.height = available + 'px';
            applyPendingHashScroll();
        }

        function scheduleResize() {
            if (rafId) {
                return;
            }
            rafId = window.requestAnimationFrame(function () {
                rafId = 0;
                resizeContentHeight();
            });
        }

        function scheduleResizeDebounced(delay) {
            window.clearTimeout(resizeDebounceTimer);
            resizeDebounceTimer = window.setTimeout(scheduleResize, delay || 120);
        }

        function requestHashScroll() {
            if (!window.location.hash || window.location.hash === '#') {
                return;
            }
            pendingHashScroll = true;
            scheduleResize();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function () {
                scheduleResize();
                requestHashScroll();
            }, { once: true });
        } else {
            scheduleResize();
            requestHashScroll();
        }

        window.addEventListener('load', function () {
            scheduleResize();
            requestHashScroll();
        });
        window.addEventListener('pageshow', function () {
            scheduleResize();
            requestHashScroll();
        });
        window.addEventListener('hashchange', requestHashScroll);
        window.addEventListener('resize', function () {
            scheduleResizeDebounced(120);
        });

        var menuToggle = document.getElementById('menuToggle');
        if (menuToggle) {
            menuToggle.addEventListener('change', function () {
                scheduleResize();
                window.setTimeout(scheduleResize, 250);
            });
        }
    })();
</script>
  
    



<script defer src="/js/all.js" crossorigin="anonymous"></script>

    
    
    <script src="/js/highlight.min.js"></script>
    <script src="/js/languages/dos.min.js"></script>
        
    <script type="text/javascript">
        
        hljs.highlightAll();
    </script>
    

<style>
    .code-block-wrapper {
        position: relative;
    }
    .copy-code-button {
        position: absolute;
        top: 8px;
        right: 8px;
        padding: 6px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.3s, background 0.3s;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .copy-code-button svg {
        width: 16px;
        height: 16px;
        fill: #fff;
        transition: fill 0.3s;
    }
    .code-block-wrapper:hover .copy-code-button {
        opacity: 1;
    }
    .copy-code-button:hover {
        background: rgba(255, 255, 255, 0.2);
    }
    .copy-code-button.copied {
        background: rgba(46, 160, 67, 0.8);
        border-color: rgba(46, 160, 67, 1);
    }
    .copy-code-button.copied svg {
        fill: #fff;
    }
</style>
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
        
        document.querySelectorAll('pre code').forEach(function(codeBlock) {
            var pre = codeBlock.parentNode;
            
            
            if (pre.parentNode.classList.contains('code-block-wrapper')) {
                return;
            }
            
            
            var wrapper = document.createElement('div');
            wrapper.className = 'code-block-wrapper';
            pre.parentNode.insertBefore(wrapper, pre);
            wrapper.appendChild(pre);
            
            
            var button = document.createElement('button');
            button.className = 'copy-code-button';
            button.innerHTML = '<svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path></svg>';
            button.setAttribute('aria-label', '复制代码');
            button.setAttribute('title', '复制代码');
            
            var copyIcon = '<svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path></svg>';
            var checkIcon = '<svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16"><path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path></svg>';
            
            
            button.addEventListener('click', function() {
                var code = codeBlock.textContent;
                navigator.clipboard.writeText(code).then(function() {
                    button.innerHTML = checkIcon;
                    button.classList.add('copied');
                    button.setAttribute('aria-label', '已复制');
                    button.setAttribute('title', '已复制');
                    setTimeout(function() {
                        button.innerHTML = copyIcon;
                        button.classList.remove('copied');
                        button.setAttribute('aria-label', '复制代码');
                        button.setAttribute('title', '复制代码');
                    }, 2000);
                }).catch(function(err) {
                    console.error('复制失败:', err);
                });
            });
            
            wrapper.appendChild(button);
        });
    });
</script>




    



</body>

</html>
