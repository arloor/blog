<!DOCTYPE html>
<html lang="zh-CN">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    
    <link rel="canonical" href="https://www.arloor.com/posts/java-agent/">
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.139.3">

    
    
    

<title>Java Agent实现指南 • ARLOOR</title>
<meta name="description" content="今天，你学习了吗">
<meta name="keywords" content="刘港欢, arloor, moontell">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Java Agent实现指南">
  <meta name="twitter:description" content="Java Agent是字节码修改技术，Mtrace使用Java Agent修改字节码来实现trace的跨线程传递，opentelemetry也通过Java Agent来实现该需求。">
      <meta name="twitter:site" content="@njulgh">

<meta property="og:url" content="https://www.arloor.com/posts/java-agent/">
  <meta property="og:site_name" content="ARLOOR">
  <meta property="og:title" content="Java Agent实现指南">
  <meta property="og:description" content="Java Agent是字节码修改技术，Mtrace使用Java Agent修改字节码来实现trace的跨线程传递，opentelemetry也通过Java Agent来实现该需求。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-03-07T14:11:11+08:00">
    <meta property="article:modified_time" content="2022-03-07T14:11:11+08:00">
    <meta property="article:tag" content="Obs">
    <meta property="article:tag" content="Java">


    





<link rel="stylesheet" href="/styles/atom-one-dark.min.css">








<link rel="stylesheet" href="/scss/hyde-hyde.484b96856b25751067d56c8c0af9dc1fd6372707029b6d56ee178da6bead45b5.css" integrity="sha256-SEuWhWsldRBn1WyMCvncH9Y3JwcCm21W7heNpr6tRbU=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">




<link rel="stylesheet" href="/scss/hugo-toc.0873834b0f2e9fdc9e1d0301e8ebce21fc10383882a41e9373f29b90e85a9987.css" integrity="sha256-CHODSw8un9yeHQMB6OvOIfwQODiCpB6Tc/KbkOhamYc=">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    

</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="/">
          
          ARLOOR
          
        </a>
      </span>
      <a href="/">
        
        
        <div class="author-image">
          <img src="/img/head.jpeg" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
        
      </a>
      
      <p class="site__description">
         都是瞎写的 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">ARLOOR</label>
      <div class="menu-content">
        <div class="show-in-small">
          <a href="/">
            
            
            <div class="author-image">
              <img src="/img/head.jpeg" alt="Author Image"
                class="img--circle img--headshot element--center">
            </div>
            
            
          </a>
        </div>
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>文章</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/">
						<span>分类</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>关于我</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="http://beian.miit.gov.cn/">
						<span>苏ICP备17024437号</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://x.com/njulgh" rel="me"><i class="fa-brands fa-x-twitter fa-lg"></i></a>
	
	
	
	
	
	<a href="https://github.com/arloor" rel="me"><i class="fa-brands fa-github fa-lg"></i></a>
	
	
	
	
	
	
	
	
	
	
	
	
	
	<a href="https://t.me/never_contact_me" rel="me"><i class="fa-brands fa-telegram fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="mailto:admin@arloor.com" rel="me"><i class="fa-solid fa-at fa-lg"></i></a>
	
	
	
	
</section>
      </div>
    </div>
    
<div class="copyright">
  &copy; 2024 arloor
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>


<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/arloor/hyde-arloor">hyde-arloor</a>.
</div>


  </div>
</div>
        <div class="content container">
            
    
<article>
  <header>
    <h1>Java Agent实现指南</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Mar 7, 2022
    
    
    
      
      
          in
          
          
              <a class="badge badge-category" href="/categories/undefined">UNDEFINED</a>
              
          
      
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/obs">obs</a>
           
      
          <a class="badge badge-tag" href="/tags/java">java</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 10 min read
</div>


  </header>
  
  
  
    <div class="toc-wrapper">
      <input type="checkbox" id="tocToggle">
      <label for="tocToggle">Table of Content</label>
      
          <nav id="TableOfContents">
  <ul>
    <li><a href="#两种加载方式">两种加载方式</a>
      <ul>
        <li><a href="#静态加载">静态加载</a></li>
        <li><a href="#动态加载">动态加载</a></li>
      </ul>
    </li>
    <li><a href="#java-agent-jar包规范">Java Agent Jar包规范</a></li>
    <li><a href="#agent如何做字节码修改的">Agent如何做字节码修改的？</a>
      <ul>
        <li><a href="#1通过instrumentation注册classfiletransformer">1.通过Instrumentation注册ClassFileTransformer</a></li>
        <li><a href="#2classfiletransformer使用javassist修改字节码">2.ClassFileTransformer使用javassist修改字节码</a></li>
      </ul>
    </li>
    <li><a href="#类加载问题动态加载中存在">类加载问题（动态加载中存在）</a>
      <ul>
        <li><a href="#问题案例">问题案例</a></li>
      </ul>
    </li>
    <li><a href="#根因">根因</a>
      <ul>
        <li><a href="#解决">解决</a></li>
        <li><a href="#java-agent中类加载的更多信息">Java Agent中类加载的更多信息</a></li>
        <li><a href="#其他注意点">其他注意点</a></li>
      </ul>
    </li>
    <li><a href="#参考文档">参考文档</a></li>
  </ul>
</nav>
      
    </div>
  
  
  <div class="post">
    <p>Java Agent是字节码修改技术，Mtrace使用Java Agent修改字节码来实现trace的跨线程传递，opentelemetry也通过Java Agent来实现该需求。</p>
<h2 id="两种加载方式">两种加载方式</h2>
<h3 id="静态加载">静态加载</h3>
<p>静态加载就是在java的启动命令中指定javaagent的路径。</p>
<pre tabindex="0"><code>JAVA_AGENT_JAR_PARH=java-agent.jar
java -Xbootclasspath/a:${JAVA_AGENT_JAR_PARH} -javaagent:${JAVA_AGENT_JAR_PARH} -jar xxxx.jar
</code></pre><h3 id="动态加载">动态加载</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>String name <span style="color:#f92672">=</span> ManagementFactory.<span style="color:#a6e22e">getRuntimeMXBean</span>().<span style="color:#a6e22e">getName</span>();
</span></span><span style="display:flex;"><span>String pid <span style="color:#f92672">=</span> name.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#34;@&#34;</span>)<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">final</span> VirtualMachine vm <span style="color:#f92672">=</span> VirtualMachine.<span style="color:#a6e22e">attach</span>(pid);
</span></span><span style="display:flex;"><span>vm.<span style="color:#a6e22e">loadAgent</span>(${JAVA_AGENT_JAR_PARH},${ARGS});
</span></span><span style="display:flex;"><span>vm.<span style="color:#a6e22e">detach</span>();
</span></span></code></pre></div><blockquote>
<p>VirtualMachine在jdk（非jre）下的lib/tools.jar，classpath可能不包含该jar包，需要反射调用URLClassLoader类的addURL方法增加tools.jar，然后再得到VirtualMachine类，如下：</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.File;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.lang.reflect.Method;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.net.URL;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.net.URLClassLoader;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.security.AccessController;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.security.PrivilegedActionException;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.security.PrivilegedExceptionAction;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.ArrayList;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.List;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 从lib/tools.jar加载VirtualMachine
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">VmClassLoader</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String VIRTUAL_MACHINE_CLASSNAME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;com.sun.tools.attach.VirtualMachine&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">volatile</span> Class<span style="color:#f92672">&lt;?&gt;</span> vmClass;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            vmClass <span style="color:#f92672">=</span> getVirtualMachineClass();
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (ClassNotFoundException e) {
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;not found tools.jar&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Class<span style="color:#f92672">&lt;?&gt;</span> getVmClass() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> vmClass;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> Class<span style="color:#f92672">&lt;?&gt;</span> getVirtualMachineClass() <span style="color:#66d9ef">throws</span> ClassNotFoundException {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> AccessController.<span style="color:#a6e22e">doPrivileged</span>(<span style="color:#66d9ef">new</span> PrivilegedExceptionAction<span style="color:#f92672">&lt;</span>Class<span style="color:#f92672">&lt;?&gt;&gt;</span>() {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">public</span> Class<span style="color:#f92672">&lt;?&gt;</span> run() <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">return</span> ClassLoader.<span style="color:#a6e22e">getSystemClassLoader</span>().<span style="color:#a6e22e">loadClass</span>(VIRTUAL_MACHINE_CLASSNAME);
</span></span><span style="display:flex;"><span>                    } <span style="color:#66d9ef">catch</span> (ClassNotFoundException cnfe) {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">for</span> (File jar : getPossibleToolsJars()) {
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                                Method method <span style="color:#f92672">=</span> URLClassLoader.<span style="color:#a6e22e">class</span>.<span style="color:#a6e22e">getDeclaredMethod</span>(<span style="color:#e6db74">&#34;addURL&#34;</span>, URL.<span style="color:#a6e22e">class</span>);
</span></span><span style="display:flex;"><span>                                method.<span style="color:#a6e22e">setAccessible</span>(<span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>                                method.<span style="color:#a6e22e">invoke</span>(ClassLoader.<span style="color:#a6e22e">getSystemClassLoader</span>(), jar.<span style="color:#a6e22e">toURI</span>().<span style="color:#a6e22e">toURL</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                                <span style="color:#66d9ef">return</span> ClassLoader.<span style="color:#a6e22e">getSystemClassLoader</span>().<span style="color:#a6e22e">loadClass</span>(VIRTUAL_MACHINE_CLASSNAME);
</span></span><span style="display:flex;"><span>                            } <span style="color:#66d9ef">catch</span> (Exception t) {
</span></span><span style="display:flex;"><span>                                System.<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;Exception while loading tools.jar from  &#34;</span> <span style="color:#f92672">+</span> jar <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; &#34;</span> <span style="color:#f92672">+</span> ExceptionUtil.<span style="color:#a6e22e">getMessage</span>(t));
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ClassNotFoundException(VIRTUAL_MACHINE_CLASSNAME);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            });
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (PrivilegedActionException pae) {
</span></span><span style="display:flex;"><span>            Throwable actual <span style="color:#f92672">=</span> pae.<span style="color:#a6e22e">getCause</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (actual <span style="color:#66d9ef">instanceof</span> ClassNotFoundException) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> (ClassNotFoundException) actual;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> AssertionError(<span style="color:#e6db74">&#34;Unexpected checked exception : &#34;</span> <span style="color:#f92672">+</span> actual);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> List<span style="color:#f92672">&lt;</span>File<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getPossibleToolsJars</span>() {
</span></span><span style="display:flex;"><span>        List<span style="color:#f92672">&lt;</span>File<span style="color:#f92672">&gt;</span> jars <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        File javaHome <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> File(System.<span style="color:#a6e22e">getProperty</span>(<span style="color:#e6db74">&#34;java.home&#34;</span>));
</span></span><span style="display:flex;"><span>        File jreSourced <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> File(javaHome, <span style="color:#e6db74">&#34;lib/tools.jar&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (jreSourced.<span style="color:#a6e22e">exists</span>()) {
</span></span><span style="display:flex;"><span>            jars.<span style="color:#a6e22e">add</span>(jreSourced);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#e6db74">&#34;jre&#34;</span>.<span style="color:#a6e22e">equals</span>(javaHome.<span style="color:#a6e22e">getName</span>())) {
</span></span><span style="display:flex;"><span>            File jdkHome <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> File(javaHome, <span style="color:#e6db74">&#34;../&#34;</span>);
</span></span><span style="display:flex;"><span>            File jdkSourced <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> File(jdkHome, <span style="color:#e6db74">&#34;lib/tools.jar&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (jdkSourced.<span style="color:#a6e22e">exists</span>()) {
</span></span><span style="display:flex;"><span>                jars.<span style="color:#a6e22e">add</span>(jdkSourced);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> jars;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="java-agent-jar包规范">Java Agent Jar包规范</h2>
<p>Java Agent是以单独jar包的形式发布的，jar包本身有一些规范：</p>
<p><code>MANIFEST.MF</code>文件，静态加载必须指定<code>Premain-Class</code>这个类；动态加载必须指定<code>Agent-Class</code>。通常也会加入<code>Can-Redefine-Classes</code> 和 <code>Can-Retransform-Classes</code> 选项。</p>
<p><code>Premain-Class</code>一定要有premain方法，动态加载一定要有agentmain方法</p>
<p><code>MANIFEST.MF</code>可以使用maven的<code>maven-jar-plugin</code>进行配置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;project</span> <span style="color:#a6e22e">xmlns=</span><span style="color:#e6db74">&#34;http://maven.apache.org/POM/4.0.0&#34;</span> <span style="color:#a6e22e">xmlns:xsi=</span><span style="color:#e6db74">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#a6e22e">xsi:schemaLocation=</span><span style="color:#e6db74">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;modelVersion&gt;</span>4.0.0<span style="color:#f92672">&lt;/modelVersion&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>com.meituan.mtrace<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>mtrace-agent<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;version&gt;</span>1.3.1-SNAPSHOT<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.javassist<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>javassist<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;version&gt;</span>3.21.0-GA<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;packaging&gt;</span>jar<span style="color:#f92672">&lt;/packaging&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;name&gt;</span>${project.artifactId}<span style="color:#f92672">&lt;/name&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;build&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;plugins&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;artifactId&gt;</span>maven-jar-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;version&gt;</span>3.0.2<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;archive&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;manifestEntries&gt;</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">&lt;Premain-Class&gt;</span>com.meituan.mtrace.agent.Agent<span style="color:#f92672">&lt;/Premain-Class&gt;</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">&lt;Agent-Class&gt;</span>com.meituan.mtrace.agent.Agent<span style="color:#f92672">&lt;/Agent-Class&gt;</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">&lt;Boot-Class-Path&gt;</span>${project.artifactId}-${project.version}.jar<span style="color:#f92672">&lt;/Boot-Class-Path&gt;</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">&lt;Can-Redefine-Classes&gt;</span>true<span style="color:#f92672">&lt;/Can-Redefine-Classes&gt;</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">&lt;Can-Retransform-Classes&gt;</span>true<span style="color:#f92672">&lt;/Can-Retransform-Classes&gt;</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">&lt;Can-Set-Native-Method-Prefix&gt;</span>false<span style="color:#f92672">&lt;/Can-Set-Native-Method-Prefix&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;/manifestEntries&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;/archive&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;artifactId&gt;</span>maven-shade-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;version&gt;</span>3.0.0<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;executions&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;execution&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;phase&gt;</span>package<span style="color:#f92672">&lt;/phase&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;goals&gt;</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">&lt;goal&gt;</span>shade<span style="color:#f92672">&lt;/goal&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;/goals&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">&lt;createSourcesJar&gt;</span>true<span style="color:#f92672">&lt;/createSourcesJar&gt;</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">&lt;relocations&gt;</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#f92672">&lt;relocation&gt;</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#f92672">&lt;pattern&gt;</span>javassist<span style="color:#f92672">&lt;/pattern&gt;</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#f92672">&lt;shadedPattern&gt;</span>com.meituan.mtrace.agent.javassist<span style="color:#f92672">&lt;/shadedPattern&gt;</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#f92672">&lt;/relocation&gt;</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">&lt;/relocations&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;/execution&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;/executions&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/plugins&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/build&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/project&gt;</span>
</span></span></code></pre></div><p>这里面还有个maven-shade-plugin插件将javassist的类移动到com.meituan.mtrace.agent.javassist。这么做的原因是避开类加载导致的问题，先不展开</p>
<h2 id="agent如何做字节码修改的">Agent如何做字节码修改的？</h2>
<h3 id="1通过instrumentation注册classfiletransformer">1.通过Instrumentation注册ClassFileTransformer</h3>
<p>直接看Premain-class和Agent-class的定义，在我们这里名字就是Agent</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.*;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.lang.instrument.ClassFileTransformer;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.lang.instrument.Instrumentation;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.concurrent.ScheduledThreadPoolExecutor;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.concurrent.ThreadPoolExecutor;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.jar.JarFile;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Agent</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">Agent</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> InstantiationError(<span style="color:#e6db74">&#34;Must not instantiate this class&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 静态加载
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">premain</span>(String agentArgs, Instrumentation instrumentation) {
</span></span><span style="display:flex;"><span>        System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;premain start&#34;</span>);
</span></span><span style="display:flex;"><span>        install(agentArgs, instrumentation, <span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>        System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;premain end&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 动态加载
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">agentmain</span>(String agentArgs, Instrumentation instrumentation) {
</span></span><span style="display:flex;"><span>        System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;agentmain start&#34;</span>);
</span></span><span style="display:flex;"><span>        install(agentArgs, instrumentation, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>        System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;agentmain end&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">synchronized</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">install</span>(String agentArgs, Instrumentation instrumentation, <span style="color:#66d9ef">boolean</span> atRuntime) {
</span></span><span style="display:flex;"><span>        ClassFileTransformer transformer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PoolTransformer();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 主动寻找agentJar中的TraceRunnable等类</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 否则会报 compile error: no such class: com.meituan.mtrace.thread.TraceRunnable</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (atRuntime) {
</span></span><span style="display:flex;"><span>                instrumentation.<span style="color:#a6e22e">appendToBootstrapClassLoaderSearch</span>(<span style="color:#66d9ef">new</span> JarFile(<span style="color:#66d9ef">new</span> File(agentArgs)));
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(ExceptionUtil.<span style="color:#a6e22e">getMessage</span>(e));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        instrumentation.<span style="color:#a6e22e">addTransformer</span>(transformer, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (atRuntime) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Transformer触发的时机是类加载时，redefine时和retransform时</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// ForkJoinTask会在之后进行类加载，那是会触发transformer</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 而ThreadPoolExecutor和ScheduledThreadPoolExecutor在之前已经类加载了</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 所以需要手动retransform一下</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                ClassLoader.<span style="color:#a6e22e">getSystemClassLoader</span>().<span style="color:#a6e22e">loadClass</span>(<span style="color:#e6db74">&#34;java.util.concurrent.ThreadPoolExecutor&#34;</span>);
</span></span><span style="display:flex;"><span>                ClassLoader.<span style="color:#a6e22e">getSystemClassLoader</span>().<span style="color:#a6e22e">loadClass</span>(<span style="color:#e6db74">&#34;java.util.concurrent.ScheduledThreadPoolExecutor&#34;</span>);
</span></span><span style="display:flex;"><span>                instrumentation.<span style="color:#a6e22e">retransformClasses</span>(ThreadPoolExecutor.<span style="color:#a6e22e">class</span>, ScheduledThreadPoolExecutor.<span style="color:#a6e22e">class</span>);
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>                System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(ExceptionUtil.<span style="color:#a6e22e">getMessage</span>(e));
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>用伪代码描述是</p>
<ol>
<li>
<p>将让BootstrapClassloader加载agent.jar中的类</p>
<ol>
<li>一定需要使用BootstrapClassloader加载agent.jar中的类，可以使用如下两种方式</li>
</ol>
<pre tabindex="0"><code>启动参数：-Xbootclasspath/a:${JAVA_AGENT_JAR_PARH}
运行时代码：instrumentation.appendToBootstrapClassLoaderSearch(new JarFile(new File(agentArgs)))
</code></pre></li>
<li>
<p>注册ClassFileTransformer，ClassFileTransformer去做具体的字节码修改，内部使用javassist实现。</p>
</li>
<li>
<p>由于字节码的修改触发时间是类加载、retransform、redefine。对于已经被类加载的类需要手动retransform才会触发字节码修改。</p>
<ol>
<li>如果静态加载agent，则agent的加载早于其他类，则不需要手动retransform。</li>
</ol>
</li>
<li>
<p>如果希望ClassFileTransformer是一次性的，其他agent（idea远程debug，arthas）接入时这些变更不再来一遍，调用inst.removeTransformer(transformer);</p>
</li>
</ol>
<h3 id="2classfiletransformer使用javassist修改字节码">2.ClassFileTransformer使用javassist修改字节码</h3>
<p>ClassFileTransformer接口定义如下，只有一个transform接口</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">ClassFileTransformer</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 部分Java DOC
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param loader                the defining loader of the class to be transformed,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *                              may be &lt;code&gt;null&lt;/code&gt; if the bootstrap loader
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param className             the name of the class in the internal form of fully
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *                              qualified class and interface names as defined in
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *                              &lt;i&gt;The Java Virtual Machine Specification&lt;/i&gt;.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *                              For example, &lt;code&gt;&#34;java/util/List&#34;&lt;/code&gt;.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param classBeingRedefined   if this is triggered by a redefine or retransform,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *                              the class being redefined or retransformed;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *                              if this is a class load, &lt;code&gt;null&lt;/code&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param protectionDomain      the protection domain of the class being defined or redefined
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param classfileBuffer       the input byte buffer in class file format - must not be modified
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws IllegalClassFormatException if the input does not represent a well-formed class file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return  a well-formed class file buffer (the result of the transform),
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                or &lt;code&gt;null&lt;/code&gt; if no transform is performed.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @see Instrumentation#redefineClasses
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">transform</span>(  ClassLoader         loader,
</span></span><span style="display:flex;"><span>                String              className,
</span></span><span style="display:flex;"><span>                Class<span style="color:#f92672">&lt;?&gt;</span>            classBeingRedefined,
</span></span><span style="display:flex;"><span>                ProtectionDomain    protectionDomain,
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span>              classfileBuffer)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throws</span> IllegalClassFormatException;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>一个ClassFIleTranformer的实现:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> javassist.ClassPool;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> javassist.CtClass;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> javassist.LoaderClassPath;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> javassist.CtClass;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> javassist.CtMethod;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.lang.reflect.Modifier;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.ByteArrayInputStream;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.IOException;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.lang.instrument.ClassFileTransformer;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.lang.instrument.IllegalClassFormatException;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.security.ProtectionDomain;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.HashSet;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.Set;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.logging.Level;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.logging.Logger;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PoolTransformer</span> <span style="color:#66d9ef">implements</span> ClassFileTransformer {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Logger log <span style="color:#f92672">=</span> Logger.<span style="color:#a6e22e">getLogger</span>(AbstractTransformer.<span style="color:#a6e22e">class</span>.<span style="color:#a6e22e">getName</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Set<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> targetClasses <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashSet();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">AbstractTransformer</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">targetClasses</span>.<span style="color:#a6e22e">addAll</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">targets</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Set<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getTargetClasses</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">targetClasses</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> <span style="color:#a6e22e">transform</span>(ClassLoader loader, String className, Class<span style="color:#f92672">&lt;?&gt;</span> classBeingRedefined, ProtectionDomain protectionDomain, <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> classfileBuffer) <span style="color:#66d9ef">throws</span> IllegalClassFormatException {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (className <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> className.<span style="color:#a6e22e">length</span>() <span style="color:#f92672">!=</span> 0 <span style="color:#f92672">&amp;&amp;</span> classfileBuffer <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> classfileBuffer.<span style="color:#a6e22e">length</span> <span style="color:#f92672">!=</span> 0) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">targetClasses</span>.<span style="color:#a6e22e">contains</span>(className)) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">boolean</span> atClassLoading <span style="color:#f92672">=</span> classBeingRedefined <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>                log.<span style="color:#a6e22e">log</span>(Level.<span style="color:#a6e22e">INFO</span>, <span style="color:#e6db74">&#34;Transforming class &#34;</span> <span style="color:#f92672">+</span> className <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; @classloading?&#34;</span> <span style="color:#f92672">+</span> atClassLoading);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">doTransform</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getCtClass</span>(loader, classfileBuffer));
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">catch</span> (Throwable var7) {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> CtClass <span style="color:#a6e22e">getCtClass</span>(ClassLoader loader, <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> classfileBuffer) <span style="color:#66d9ef">throws</span> IOException {
</span></span><span style="display:flex;"><span>        ClassPool classPool <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ClassPool(<span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (loader <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>            classPool.<span style="color:#a6e22e">appendClassPath</span>(<span style="color:#66d9ef">new</span> LoaderClassPath(ClassLoader.<span style="color:#a6e22e">getSystemClassLoader</span>()));
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            classPool.<span style="color:#a6e22e">appendClassPath</span>(<span style="color:#66d9ef">new</span> LoaderClassPath(loader));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        classPool.<span style="color:#a6e22e">importPackage</span>(<span style="color:#e6db74">&#34;com.meituan.mtrace.agent.runtime.wrapper&#34;</span>);
</span></span><span style="display:flex;"><span>        classPool.<span style="color:#a6e22e">importPackage</span>(<span style="color:#e6db74">&#34;java.util.concurrent&#34;</span>);
</span></span><span style="display:flex;"><span>        CtClass ctClass <span style="color:#f92672">=</span> classPool.<span style="color:#a6e22e">makeClass</span>(<span style="color:#66d9ef">new</span> ByteArrayInputStream(classfileBuffer), <span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>        ctClass.<span style="color:#a6e22e">defrost</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> ctClass;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Set<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">targets</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> HashSet(Arrays.<span style="color:#a6e22e">asList</span>(<span style="color:#e6db74">&#34;java/util/concurrent/ThreadPoolExecutor&#34;</span>,<span style="color:#e6db74">&#34;java/util/concurrent/ScheduledThreadPoolExecutor&#34;</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isBootstrap</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> <span style="color:#a6e22e">doTransform</span>(CtClass ctClass) <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>        CtMethod<span style="color:#f92672">[]</span> methods <span style="color:#f92672">=</span> ctClass.<span style="color:#a6e22e">getDeclaredMethods</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> length <span style="color:#f92672">=</span> methods.<span style="color:#a6e22e">length</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> index <span style="color:#f92672">=</span> 0; index <span style="color:#f92672">&lt;</span> length; <span style="color:#f92672">++</span>index) {
</span></span><span style="display:flex;"><span>            CtMethod method <span style="color:#f92672">=</span> methods<span style="color:#f92672">[</span>index<span style="color:#f92672">]</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> modifiers <span style="color:#f92672">=</span> method.<span style="color:#a6e22e">getModifiers</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (Modifier.<span style="color:#a6e22e">isPublic</span>(modifiers) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>Modifier.<span style="color:#a6e22e">isStatic</span>(modifiers)) {
</span></span><span style="display:flex;"><span>                StringBuilder builder <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StringBuilder();
</span></span><span style="display:flex;"><span>                CtClass<span style="color:#f92672">[]</span> types <span style="color:#f92672">=</span> method.<span style="color:#a6e22e">getParameterTypes</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0; i <span style="color:#f92672">&lt;</span> types.<span style="color:#a6e22e">length</span>; <span style="color:#f92672">++</span>i) {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> (<span style="color:#e6db74">&#34;java.lang.Runnable&#34;</span>.<span style="color:#a6e22e">equals</span>(types<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span>.<span style="color:#a6e22e">getName</span>())) {
</span></span><span style="display:flex;"><span>                        builder.<span style="color:#a6e22e">append</span>(String.<span style="color:#a6e22e">format</span>(<span style="color:#e6db74">&#34;if (TaskWrapper.shouldReform() &amp;&amp; $%d != null) { $%d = TaskWrapper.wrapRunnable($%d, \&#34;%s\&#34;); }&#34;</span>, i <span style="color:#f92672">+</span> 1, i <span style="color:#f92672">+</span> 1, i <span style="color:#f92672">+</span> 1, method.<span style="color:#a6e22e">getName</span>()));
</span></span><span style="display:flex;"><span>                    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#e6db74">&#34;java.util.concurrent.Callable&#34;</span>.<span style="color:#a6e22e">equals</span>(types<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span>.<span style="color:#a6e22e">getName</span>())) {
</span></span><span style="display:flex;"><span>                        builder.<span style="color:#a6e22e">append</span>(String.<span style="color:#a6e22e">format</span>(<span style="color:#e6db74">&#34;if (TaskWrapper.shouldReform() &amp;&amp; $%d != null) { $%d = TaskWrapper.wrapCallable($%d, \&#34;%s\&#34;); }&#34;</span>, i <span style="color:#f92672">+</span> 1, i <span style="color:#f92672">+</span> 1, i <span style="color:#f92672">+</span> 1, method.<span style="color:#a6e22e">getName</span>()));
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (builder.<span style="color:#a6e22e">length</span>() <span style="color:#f92672">&gt;</span> 0) {
</span></span><span style="display:flex;"><span>                    method.<span style="color:#a6e22e">insertBefore</span>(builder.<span style="color:#a6e22e">toString</span>());
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> ctClass.<span style="color:#a6e22e">toBytecode</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>伪代码:</p>
<ol>
<li>
<p>从classfileBuffer中生成javassist的CtClass对象——对字节码的抽象，并且可以进行修改。</p>
</li>
<li>
<p>修改CtClass对象，插入一些增强代码。</p>
</li>
</ol>
<h2 id="类加载问题动态加载中存在">类加载问题（动态加载中存在）</h2>
<p>以上介绍了agent开发的全部过程，但是知道上面的内容并不能开发一个正确的agent，特别是能够动态加载的agent，根因就是类加载问题。</p>
<h3 id="问题案例">问题案例</h3>
<p>arthas反编译我们修改后的ThreadPoolExecutor类，看到已经被正确的修改了——字节码修改生效了。</p>
<p>但是却没有达成我们的目标——跨线程传递span，为什么？</p>
<h2 id="根因">根因</h2>
<p>很长一段时间，我一筹莫展，直到用arthas的jad反编译来看看字节码修改是否生效，才发现了一些端倪：
<img src="/img/arthas-jad-trace-runnable.png" alt=""></p>
<p>TraceRunnable、Context等类竟然有两个类，一个由SystemClassLoader加载（AppClassLoader），一个由BootstrapClassLoader加载（null）。mtrace的跨线程传递trace其实就是将当前span放到threadlocal中，跨线程时把父线程的threadlocal的span放置到子线程的threadlocal中。而Context类就是threadlocal的容器。但是现在Context类实际有两个，业务代码把span放到ContextA类中，threapool从ContextB类中拿span，但是ContextB中并没有span，这就导致了跨线程传递失败。</p>
<p>存放threadlocal的类的Context定义：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Context</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> ThreadLocal<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> SERVER_CONTEXT <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ThreadLocal<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> ThreadLocal<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> CLIENT_CONTEXT <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ThreadLocal<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Object <span style="color:#a6e22e">getServerContext</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> SERVER_CONTEXT.<span style="color:#a6e22e">get</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Object <span style="color:#a6e22e">getClientContext</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> CLIENT_CONTEXT.<span style="color:#a6e22e">get</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setServerContext</span>(Object obj) {
</span></span><span style="display:flex;"><span>        SERVER_CONTEXT.<span style="color:#a6e22e">set</span>(obj);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setClientContext</span>(Object obj) {
</span></span><span style="display:flex;"><span>        CLIENT_CONTEXT.<span style="color:#a6e22e">set</span>(obj);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">removeServerContext</span>() {
</span></span><span style="display:flex;"><span>        SERVER_CONTEXT.<span style="color:#a6e22e">remove</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">removeClientContext</span>() {
</span></span><span style="display:flex;"><span>        CLIENT_CONTEXT.<span style="color:#a6e22e">remove</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>经过反复试验，如果在加载agent前，业务代码加载了TraceRunnale（进一步加载了Context类），则跨线程透传失败——根因是生成了不同的Context类。如果在加载agent之后，才使用TraceRunnable，那么会直接使用agent中由BootstrapClassloader加载的TraceRunnable——只有一个Context类，跨线程透传成功。</p>
<h3 id="解决">解决</h3>
<p>避免在Agent中加载任何会使用Context类的类，比如TraceRunnable等。</p>
<p>最终我们采用一种类似“代理模式”的设计。agent中使用的TaskWrapper是一个代理，真实实现（TraceRunnable）在非agent中注册进去。</p>
<p>TaskWrapper定义：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.concurrent.Callable;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TaskWrapper</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> TaskWrapper.<span style="color:#a6e22e">Reformer</span> reformer; <span style="color:#75715e">//真实实现</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">TaskWrapper</span>() {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">registerReformer</span>(TaskWrapper.<span style="color:#a6e22e">Reformer</span> r) { <span style="color:#75715e">// 提供运行时注册方案</span>
</span></span><span style="display:flex;"><span>        reformer <span style="color:#f92672">=</span> r;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">shouldReform</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> reformer <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> <span style="color:#66d9ef">false</span> : reformer.<span style="color:#a6e22e">shouldReform</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Runnable <span style="color:#a6e22e">wrapRunnable</span>(Runnable runnable, String methodName) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> reformer <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> runnable : reformer.<span style="color:#a6e22e">wrapRunnable</span>(runnable, methodName);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Callable <span style="color:#a6e22e">wrapCallable</span>(Callable callable, String methodName) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> reformer <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> callable : reformer.<span style="color:#a6e22e">wrapCallable</span>(callable, methodName);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Reformer</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">shouldReform</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Runnable <span style="color:#a6e22e">wrapRunnable</span>(Runnable runnable, String methodName);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Callable <span style="color:#a6e22e">wrapCallable</span>(Callable callable, String methodName);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>具体在非agent中注册进去的过程是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">//  1. 动态加载agent</span>
</span></span><span style="display:flex;"><span>String name <span style="color:#f92672">=</span> ManagementFactory.<span style="color:#a6e22e">getRuntimeMXBean</span>().<span style="color:#a6e22e">getName</span>();
</span></span><span style="display:flex;"><span>String pid <span style="color:#f92672">=</span> name.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#34;@&#34;</span>)<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">final</span> VirtualMachine vm <span style="color:#f92672">=</span> VirtualMachine.<span style="color:#a6e22e">attach</span>(pid);
</span></span><span style="display:flex;"><span>vm.<span style="color:#a6e22e">loadAgent</span>(${JAVA_AGENT_JAR_PARH},${ARGS});
</span></span><span style="display:flex;"><span>vm.<span style="color:#a6e22e">detach</span>();
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 2. 注册reformer</span>
</span></span><span style="display:flex;"><span>            TaskWrapper.<span style="color:#a6e22e">registerReformer</span>(<span style="color:#66d9ef">new</span> TaskWrapper.<span style="color:#a6e22e">Reformer</span>() {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">shouldReform</span>() {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> Tracer.<span style="color:#a6e22e">id</span>() <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">public</span> Runnable <span style="color:#a6e22e">wrapRunnable</span>(Runnable runnable, String methodName) {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> TraceRunnable.<span style="color:#a6e22e">get</span>(runnable);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">public</span> Callable <span style="color:#a6e22e">wrapCallable</span>(Callable callable, String methodName) {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> TraceCallable.<span style="color:#a6e22e">get</span>(callable);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            });
</span></span></code></pre></div><p>可能唯一要注意的是TaskWrapper.register也要在vm.loadAgent后面，否则的话TaskWrapper也会加载两遍。</p>
<h3 id="java-agent中类加载的更多信息">Java Agent中类加载的更多信息</h3>
<p>javaDoc中有一段描述：</p>
<pre tabindex="0"><code>* &lt;p&gt; The agent should take care to ensure that the JAR does not contain any* classes or resources other than those to be defined by the bootstrap* class loader for the purpose of instrumentation.* Failure to observe this warning could result in unexpected* behavior that is difficult to diagnose. For example, suppose there is a* loader L, and L&#39;s parent for delegation is the bootstrap class loader.* Furthermore, a method in class C, a class defined by L, makes reference to* a non-public accessor class C$1. If the JAR file contains a class C$1 then* the delegation to the bootstrap class loader will cause C$1 to be defined* by the bootstrap class loader. In this example an &lt;code&gt;IllegalAccessError&lt;/code&gt;* will be thrown that may cause the application to fail. One approach to* avoiding these types of issues, is to use a unique package name for the* instrumentation classes.
</code></pre><p>类加载问题会导致一些奇怪问题，上述javaDoc举了一个例子。<a href="https://tianshuang.me/2021/10/Java-Agent-%E7%9A%84%E7%B1%BB%E5%8A%A0%E8%BD%BD%E9%9A%94%E7%A6%BB%E5%AE%9E%E7%8E%B0/">Java Agent 的类加载隔离实现 | Poison (tianshuang.me)</a>这篇博客举了另一个例子，他解释了为什么要用Maven Shade Plugin去做一些relocation，通过移动包路径改变类名，从而消灭同名但由不同类加载器加载导致的不同类存在，并且给出了opentelemtry、elasticsearch APM agent的agent类加载隔离实现。</p>
<p>我们直接跳到opentelemtry的类加载隔离实现：<a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/docs/contributing/javaagent-jar-components.md">opentelemetry-java-instrumentation/javaagent-jar-components.md at main · open-telemetry/opentelemetry-java-instrumentation (github.com)</a></p>
<p>这个文档先陈述了一个事实——<strong>agentJar中的类除了Premain-Class/Agent-class由SystemClassLoader（应用类加载器）加载，其他类都由BootstrapClassloader加载</strong>。</p>
<h3 id="其他注意点">其他注意点</h3>
<p>对于ThreadPoolExecutor的封装比较简单，对于ForkJoinPool的封装需要对ForkJoinTask进行修改，而且需要增加Field。<strong>JVM规范里写到，一旦一个类被加载后，他的scheme不能被改变，也就是不能增减属性和方法</strong>。如果在ForkJoinTask已经被类加载后尝试修改，会失败并报错：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>java.<span style="color:#a6e22e">lang</span>.<span style="color:#a6e22e">UnsupportedOperationException</span>: <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">redefinition</span> failed: attempted to change the <span style="color:#a6e22e">schema</span> (add<span style="color:#f92672">/</span>remove fields)
</span></span><span style="display:flex;"><span>	at sun.<span style="color:#a6e22e">instrument</span>.<span style="color:#a6e22e">InstrumentationImpl</span>.<span style="color:#a6e22e">retransformClasses0</span>(Native Method) <span style="color:#f92672">~[?</span>:1.<span style="color:#a6e22e">8</span>.<span style="color:#a6e22e">0_251</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>	at sun.<span style="color:#a6e22e">instrument</span>.<span style="color:#a6e22e">InstrumentationImpl</span>.<span style="color:#a6e22e">retransformClasses</span>(InstrumentationImpl.<span style="color:#a6e22e">java</span>:144) <span style="color:#f92672">~[?</span>:1.<span style="color:#a6e22e">8</span>.<span style="color:#a6e22e">0_251</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>	at com.<span style="color:#a6e22e">meituan</span>.<span style="color:#a6e22e">mtrace</span>.<span style="color:#a6e22e">agent</span>.<span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">Injector</span>.<span style="color:#a6e22e">doRetransform</span>(Injector.<span style="color:#a6e22e">java</span>:68) <span style="color:#f92672">[?</span>:<span style="color:#f92672">?]</span>
</span></span><span style="display:flex;"><span>	at com.<span style="color:#a6e22e">meituan</span>.<span style="color:#a6e22e">mtrace</span>.<span style="color:#a6e22e">agent</span>.<span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">Injector</span>.<span style="color:#a6e22e">inject</span>(Injector.<span style="color:#a6e22e">java</span>:48) <span style="color:#f92672">[?</span>:<span style="color:#f92672">?]</span>
</span></span><span style="display:flex;"><span>	at com.<span style="color:#a6e22e">meituan</span>.<span style="color:#a6e22e">mtrace</span>.<span style="color:#a6e22e">agent</span>.<span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">Injector</span>.<span style="color:#a6e22e">start</span>(Injector.<span style="color:#a6e22e">java</span>:26) <span style="color:#f92672">[?</span>:<span style="color:#f92672">?]</span>
</span></span><span style="display:flex;"><span>	at com.<span style="color:#a6e22e">meituan</span>.<span style="color:#a6e22e">mtrace</span>.<span style="color:#a6e22e">agent</span>.<span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">AgentLaunch</span>.<span style="color:#a6e22e">start</span>(AgentLaunch.<span style="color:#a6e22e">java</span>:45) <span style="color:#f92672">[?</span>:<span style="color:#f92672">?]</span>
</span></span><span style="display:flex;"><span>	at com.<span style="color:#a6e22e">meituan</span>.<span style="color:#a6e22e">mtrace</span>.<span style="color:#a6e22e">agent</span>.<span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">AgentLaunch</span>.<span style="color:#a6e22e">agentmain</span>(AgentLaunch.<span style="color:#a6e22e">java</span>:25) <span style="color:#f92672">[?</span>:<span style="color:#f92672">?]</span>
</span></span><span style="display:flex;"><span>	at sun.<span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">NativeMethodAccessorImpl</span>.<span style="color:#a6e22e">invoke0</span>(Native Method) <span style="color:#f92672">~[?</span>:1.<span style="color:#a6e22e">8</span>.<span style="color:#a6e22e">0_251</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>	at sun.<span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">NativeMethodAccessorImpl</span>.<span style="color:#a6e22e">invoke</span>(NativeMethodAccessorImpl.<span style="color:#a6e22e">java</span>:62) <span style="color:#f92672">~[?</span>:1.<span style="color:#a6e22e">8</span>.<span style="color:#a6e22e">0_251</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>	at sun.<span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">DelegatingMethodAccessorImpl</span>.<span style="color:#a6e22e">invoke</span>(DelegatingMethodAccessorImpl.<span style="color:#a6e22e">java</span>:43) <span style="color:#f92672">~[?</span>:1.<span style="color:#a6e22e">8</span>.<span style="color:#a6e22e">0_251</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>	at java.<span style="color:#a6e22e">lang</span>.<span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">Method</span>.<span style="color:#a6e22e">invoke</span>(Method.<span style="color:#a6e22e">java</span>:498) <span style="color:#f92672">~[?</span>:1.<span style="color:#a6e22e">8</span>.<span style="color:#a6e22e">0_251</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>	at sun.<span style="color:#a6e22e">instrument</span>.<span style="color:#a6e22e">InstrumentationImpl</span>.<span style="color:#a6e22e">loadClassAndStartAgent</span>(InstrumentationImpl.<span style="color:#a6e22e">java</span>:386) <span style="color:#f92672">[?</span>:1.<span style="color:#a6e22e">8</span>.<span style="color:#a6e22e">0_251</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>	at sun.<span style="color:#a6e22e">instrument</span>.<span style="color:#a6e22e">InstrumentationImpl</span>.<span style="color:#a6e22e">loadClassAndCallAgentmain</span>(InstrumentationImpl.<span style="color:#a6e22e">java</span>:411) <span style="color:#f92672">[?</span>:1.<span style="color:#a6e22e">8</span>.<span style="color:#a6e22e">0_251</span><span style="color:#f92672">]</span>
</span></span></code></pre></div><h2 id="参考文档">参考文档</h2>
<p><a href="https://jawhiow.github.io/2019/04/24/java/%E8%AF%A6%E8%A7%A3%E5%B8%B8%E7%94%A8%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%EF%BC%9AContextClassLoader/">详解常用类加载器：ContextClassLoader | 静坐听雨，无问西东 (jawhiow.github.io)</a></p>
<p><a href="https://tianshuang.me/2021/10/Java-Agent-%E7%9A%84%E7%B1%BB%E5%8A%A0%E8%BD%BD%E9%9A%94%E7%A6%BB%E5%AE%9E%E7%8E%B0/">Java Agent 的类加载隔离实现 | Poison (tianshuang.me)</a></p>
  </div>
  

<div class="navigation navigation-single">
    
    <a href="/posts/opentelemetry-trace/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Opentelemetry是怎么做链路追踪的</span>
    </a>
    
    
    <a href="/posts/java-diy-classloader/" class="navigation-next">
      <span class="navigation-tittle">Java自定义Classloader</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  


</article>


        </div>
        
    



<script defer src="/js/all.js" crossorigin="anonymous"></script>

    
    
    <script src="/js/highlight.min.js"></script>
    <script src="/js/languages/dos.min.js"></script>
        
    <script type="text/javascript">
        
        hljs.highlightAll();
    </script>
    




    



    </body>
</html>
