<!DOCTYPE html>
<html lang="zh-CN">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    
    <link rel="canonical" href="https://www.arloor.com/posts/k8s-kubeadm/">
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.152.2">

    
    
    

<title>使用Kubeadm安装K8S 1.27.3 • ARLOOR</title>
<meta name="description" content="今天，你学习了吗">
<meta name="keywords" content="刘港欢, arloor, moontell">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="使用Kubeadm安装K8S 1.27.3">
  <meta name="twitter:description" content="尝试使用kubeadm安装k8s">
      <meta name="twitter:site" content="@njulgh">

<meta property="og:url" content="https://www.arloor.com/posts/k8s-kubeadm/">
  <meta property="og:site_name" content="ARLOOR">
  <meta property="og:title" content="使用Kubeadm安装K8S 1.27.3">
  <meta property="og:description" content="尝试使用kubeadm安装k8s">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-07-19T19:48:26+08:00">
    <meta property="article:modified_time" content="2023-07-19T19:48:26+08:00">
    <meta property="article:tag" content="K8s">


    





<link rel="stylesheet" href="/styles/atom-one-dark.min.css">








<link rel="stylesheet" href="/scss/hyde-hyde.484b96856b25751067d56c8c0af9dc1fd6372707029b6d56ee178da6bead45b5.css" integrity="sha256-SEuWhWsldRBn1WyMCvncH9Y3JwcCm21W7heNpr6tRbU=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">




<link rel="stylesheet" href="/scss/hugo-toc.0873834b0f2e9fdc9e1d0301e8ebce21fc10383882a41e9373f29b90e85a9987.css" integrity="sha256-CHODSw8un9yeHQMB6OvOIfwQODiCpB6Tc/KbkOhamYc=">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    

</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="/">
          
          ARLOOR
          
        </a>
      </span>
      <a href="/">
        
        
        <div class="author-image">
          <img src="/img/head.jpeg" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
        
      </a>
      
      <p class="site__description">
         都是瞎写的 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">ARLOOR</label>
      <div class="menu-content">
        <div class="show-in-small">
          <a href="/">
            
            
            <div class="author-image">
              <img src="/img/head.jpeg" alt="Author Image"
                class="img--circle img--headshot element--center">
            </div>
            
            
          </a>
        </div>
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>文章</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/">
						<span>分类</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>关于我</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/grafana/d/a0d0b2fe-285a-44ba-8509-a404961d6da49/rust-http-proxy">
						<span>Grafana</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="http://beian.miit.gov.cn/">
						<span>沪ICP备2025110448号</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://x.com/njulgh" rel="me"><i class="fa-brands fa-x-twitter fa-lg"></i></a>
	
	
	
	
	
	<a href="https://github.com/arloor" rel="me"><i class="fa-brands fa-github fa-lg"></i></a>
	
	
	
	
	
	
	
	
	
	
	
	
	
	<a href="https://t.me/never_contact_me" rel="me"><i class="fa-brands fa-telegram fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="mailto:admin@arloor.com" rel="me"><i class="fa-solid fa-at fa-lg"></i></a>
	
	
	
	
</section>
      </div>
    </div>
    
<div class="copyright">
  &copy; 2025 arloor
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>


<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/arloor/hyde-arloor">hyde-arloor</a>.
</div>


  </div>
</div>
        <div class="content container">
            
    
<article>
  <header>
    <h1>使用Kubeadm安装K8S 1.27.3</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Jul 19, 2023
    
    
    
      
      
          in
          
          
              <a class="badge badge-category" href="/categories/undefined">UNDEFINED</a>
              
          
      
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/k8s">k8s</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 7 min read
</div>


  </header>
  
  
  
    <div class="toc-wrapper">
      <input type="checkbox" id="tocToggle">
      <label for="tocToggle">Table of Content</label>
      
          <nav id="TableOfContents">
  <ul>
    <li><a href="#kubeadm安装控制面">kubeadm安装控制面</a>
      <ul>
        <li><a href="#机器配置">机器配置</a></li>
        <li><a href="#安装containerd">安装containerd</a></li>
        <li><a href="#安装crictl">安装crictl</a></li>
        <li><a href="#安装kubtelet-kubeadm-kubectl">安装kubtelet kubeadm kubectl</a></li>
        <li><a href="#初始化控制面节点">初始化控制面节点</a></li>
        <li><a href="#安装网络插件解决node-not-ready">安装网络插件，解决node not ready</a></li>
        <li><a href="#让控制面节点也能调度pod">让控制面节点也能调度pod</a></li>
        <li><a href="#检验dns正确">检验dns正确</a></li>
        <li><a href="#在控制面节点上跑一个nginx的pod">在控制面节点上跑一个nginx的pod</a></li>
      </ul>
    </li>
    <li><a href="#常用组件安装">常用组件安装</a>
      <ul>
        <li><a href="#装个我的代理">装个我的代理</a></li>
        <li><a href="#helm包管理器">helm包管理器</a></li>
        <li><a href="#metric-server">metric server</a></li>
        <li><a href="#kubernetes-dashboard">kubernetes dashboard</a></li>
      </ul>
    </li>
    <li><a href="#参考文档">参考文档</a></li>
    <li><a href="#其他">其他</a>
      <ul>
        <li><a href="#metal-lb">metal lb</a></li>
        <li><a href="#ingress-nginx并通过hostnetwork暴露18080和1443端口">ingress-nginx并通过hostNetwork暴露18080和1443端口</a></li>
        <li><a href="#nodeport方式安装ingress-nginx">NodePort方式安装Ingress Nginx</a></li>
      </ul>
    </li>
  </ul>
</nav>
      
    </div>
  
  
  <div class="post">
    <p>尝试使用kubeadm安装k8s</p>
<h2 id="kubeadm安装控制面">kubeadm安装控制面</h2>
<h3 id="机器配置">机器配置</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 关闭swap</span>
</span></span><span style="display:flex;"><span>swapoff -a <span style="color:#75715e"># 临时关闭</span>
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;/.*swap.*/d&#39;</span> /etc/fstab <span style="color:#75715e"># 永久关闭，下次开机生效</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 加载内核模块</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">overlay
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">br_netfilter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo modprobe overlay
</span></span><span style="display:flex;"><span>sudo modprobe br_netfilter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># sysctl params required by setup, params persist across reboots</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-iptables  = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.ip_forward                 = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Apply sysctl params without reboot</span>
</span></span><span style="display:flex;"><span>sudo sysctl --system
</span></span></code></pre></div><h3 id="安装containerd">安装containerd</h3>
<p>当前版本为1.7.2</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget  https://github.com/containerd/containerd/releases/download/v1.7.2/containerd-1.7.2-linux-amd64.tar.gz -O /tmp/containerd.tar.gz
</span></span><span style="display:flex;"><span>tar -zxvf /tmp/containerd.tar.gz -C /usr/local
</span></span><span style="display:flex;"><span>containerd -v <span style="color:#75715e"># 1.7.2</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## runc</span>
</span></span><span style="display:flex;"><span>wget https://github.com/opencontainers/runc/releases/download/v1.1.7/runc.amd64 -O /tmp/runc.amd64
</span></span><span style="display:flex;"><span>install -m <span style="color:#ae81ff">755</span> /tmp/runc.amd64 /usr/local/sbin/runc
</span></span><span style="display:flex;"><span><span style="color:#75715e">## cni</span>
</span></span><span style="display:flex;"><span>wget https://github.com/containernetworking/plugins/releases/download/v1.3.0/cni-plugins-linux-amd64-v1.3.0.tgz -O /tmp/cni-plugins-linux-amd64-v1.3.0.tgz
</span></span><span style="display:flex;"><span>mkdir -p /opt/cni/bin
</span></span><span style="display:flex;"><span>tar Cxzvf /opt/cni/bin /tmp/cni-plugins-linux-amd64-v1.3.0.tgz
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 生成containerd配置文件</span>
</span></span><span style="display:flex;"><span>mkdir -p /etc/containerd
</span></span><span style="display:flex;"><span>containerd config default &gt; /etc/containerd/config.toml
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 使用Systemd作为cggroup驱动</span>
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;s/SystemdCgroup = false/SystemdCgroup = true/&#39;</span>  /etc/containerd/config.toml
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 使用阿里云镜像的sandbox，和下面的kubeadm init --image-repository镜像保持一致，否则kubeadm init时控制面启动失败</span>
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;s/sandbox_image.*/sandbox_image = &#34;registry.aliyuncs.com\/google_containers\/pause:3.9&#34;/&#39;</span> /etc/containerd/config.toml
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 从/etc/containerd/config.toml的disabled_plugins中去掉cri</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## systemd服务</span>
</span></span><span style="display:flex;"><span>wget https://raw.githubusercontent.com/containerd/containerd/main/containerd.service -O /lib/systemd/system/containerd.service
</span></span></code></pre></div><p>修改containerd.service的代理配置，否则镜像都拉不下来，calico网络插件也装不了</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vim /lib/systemd/system/containerd.service
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在[Service]块中增加代理配置</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># NO_PROXY中</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  10.96.0.0/16是kubeadm init --service-cidr的默认地址</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  192.168.0.0/16是kubeadmin init --pod-network-cidr我们填入的地址，也是calico网络插件工作的地址</span>
</span></span><span style="display:flex;"><span>Environment<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;HTTP_PROXY=http://127.0.0.1:3128/&#34;</span>
</span></span><span style="display:flex;"><span>Environment<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;HTTPS_PROXY=http://127.0.0.1:3128/&#34;</span>
</span></span><span style="display:flex;"><span>Environment<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;NO_PROXY=192.168.0.0/16,127.0.0.1,10.0.0.0/8,172.16.0.0/12,localhost&#34;</span>
</span></span></code></pre></div><p>启动containerd服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable --now containerd
</span></span></code></pre></div><h3 id="安装crictl">安装crictl</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.27.0/crictl-v1.27.0-linux-amd64.tar.gz -O /tmp/crictl-v1.27.0-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>tar -zxvf /tmp/crictl-v1.27.0-linux-amd64.tar.gz -C /tmp
</span></span><span style="display:flex;"><span>install -m <span style="color:#ae81ff">755</span> /tmp/crictl /usr/local/bin/crictl
</span></span><span style="display:flex;"><span>crictl --runtime-endpoint<span style="color:#f92672">=</span>unix:///run/containerd/containerd.sock  version
</span></span></code></pre></div><h3 id="安装kubtelet-kubeadm-kubectl">安装kubtelet kubeadm kubectl</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[kubernetes]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name=Kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearch
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enabled=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgcheck=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgkey=https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">exclude=kubelet kubeadm kubectl
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 关闭selinux</span>
</span></span><span style="display:flex;"><span>setenforce <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;s/SELINUX=enforcing/SELINUX=disabled/&#39;</span> /etc/selinux/config  
</span></span><span style="display:flex;"><span>sudo yum install -y kubectl-1.27.4 kubeadm-1.27.4 kubectl-1.27.4 --disableexcludes<span style="color:#f92672">=</span>kubernetes <span style="color:#75715e">#指定版本安装</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo systemctl enable --now kubelet <span style="color:#75715e"># 启动kubelet服务，但是会一直重启，这是正常的</span>
</span></span><span style="display:flex;"><span>kubelet --version <span style="color:#75715e"># Kubernetes v1.27.3</span>
</span></span><span style="display:flex;"><span>kubectl version --short <span style="color:#75715e"># Client Version: v1.27.3</span>
</span></span></code></pre></div><h3 id="初始化控制面节点">初始化控制面节点</h3>
<p>控制面节点是控制面组件运行的地方，包括etcd和api server。是kubectl打交道的地方.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># echo $(ip addr|grep &#34;inet &#34; |awk -F &#34;[ /]+&#34; &#39;{print $3}&#39;|grep -v &#34;127.0.0.1&#34;) $(hostname) &gt;&gt; /etc/hosts</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># echo 127.0.0.1 $(hostname) &gt;&gt; /etc/hosts</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kubeadm config print init-defaults --component-configs KubeletConfiguration &gt; /etc/kubernetes/init-default.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># sed -i &#39;s/imageRepository: registry.k8s.io/imageRepository: registry.aliyuncs.com\/google_containers/&#39; /etc/kubernetes/init-default.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># sed -i &#39;s/criSocket: .*/criSocket: unix:\/\/\/run\/containerd\/containerd.sock/&#39; /etc/kubernetes/init-default.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># sed -i &#39;s/cgroupDriver: .*/cgroupDriver: systemd/&#39; /etc/kubernetes/init-default.yaml</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># # 将advertiseAddress改成实际地址</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kubeadm config images pull --config /etc/kubernetes/init-default.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kubeadm init --config /etc/kubernetes/init-default.yaml</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#66d9ef">$(</span>ip addr|grep <span style="color:#e6db74">&#34;inet &#34;</span> |awk -F <span style="color:#e6db74">&#34;[ /]+&#34;</span> <span style="color:#e6db74">&#39;{print $3}&#39;</span>|grep -v <span style="color:#e6db74">&#34;127.0.0.1&#34;</span><span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>hostname<span style="color:#66d9ef">)</span> &gt;&gt; /etc/hosts
</span></span><span style="display:flex;"><span>kubeadm config images pull --image-repository registry.aliyuncs.com/google_containers
</span></span><span style="display:flex;"><span>kubeadm init --control-plane-endpoint<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>hostname<span style="color:#66d9ef">)</span> --pod-network-cidr<span style="color:#f92672">=</span>192.168.0.0/16 --image-repository registry.aliyuncs.com/google_containers --cri-socket unix:///run/containerd/containerd.sock
</span></span><span style="display:flex;"><span>watch crictl --runtime-endpoint<span style="color:#f92672">=</span>unix:///run/containerd/containerd.sock ps -a
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 如果执行有问题，就kubeadm reset重新进行kubeadm init</span>
</span></span></code></pre></div><p>设置kube config</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>  sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</span></span><span style="display:flex;"><span>kubectl get cs <span style="color:#75715e"># 使用kubectl与集群交互</span>
</span></span></code></pre></div><p>让其他节点加入集群：我这里只用控制面了，就不操作了</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Then you can join any number of worker nodes by running the following on each as root:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubeadm join mi:6443 --token 9j2kbw.05vncqjs7bntu4wu <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        --discovery-token-ca-cert-hash sha256:7c5d6e9360110ffb1784601a06043c9467e054283e851909d70161d36e9f08ef <span style="color:#75715e">#--ignore-preflight-errors=all</span>
</span></span></code></pre></div><h3 id="安装网络插件解决node-not-ready">安装网络插件，解决node not ready</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl get nodes
</span></span><span style="display:flex;"><span>NAME   STATUS     ROLES           AGE   VERSION
</span></span><span style="display:flex;"><span>node   NotReady   control-plane   49m   v1.27.3
</span></span><span style="display:flex;"><span>$ kubectl describe nodes node|grep KubeletNotReady
</span></span><span style="display:flex;"><span>  Ready            False   Wed, <span style="color:#ae81ff">19</span> Jul <span style="color:#ae81ff">2023</span> 22:52:58 +0800   Wed, <span style="color:#ae81ff">19</span> Jul <span style="color:#ae81ff">2023</span> 22:06:46 +0800   KubeletNotReady              container runtime network not ready: NetworkReady<span style="color:#f92672">=</span>false reason:NetworkPluginNotReady message:Network plugin returns error: cni plugin not initialized
</span></span></code></pre></div><p>下面安装Calico网络插件，前提是 <code>--pod-network-cidr=192.168.0.0/16</code>，并且containerd正确设置了代理，否则下载不了Calico</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 创建tigera operator</span>
</span></span><span style="display:flex;"><span>kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/tigera-operator.yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建Calico网络插件</span>
</span></span><span style="display:flex;"><span>kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/custom-resources.yaml
</span></span><span style="display:flex;"><span>watch kubectl get pods -n calico-system <span style="color:#75715e"># 两秒刷新一次，直到所有Calico的pod变成running</span>
</span></span></code></pre></div><p>下面是安装flannel网络插件，和Calico网络插件选一个即可</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml -O kube-flannel.yml
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;s/10.244.0.0\/16/192.168.0.0\/16/&#39;</span> kube-flannel.yml
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in <span style="color:#66d9ef">$(</span>grep <span style="color:#e6db74">&#34;image: &#34;</span> kube-flannel.yml | awk -F <span style="color:#e6db74">&#39;[ &#34;]+&#39;</span> <span style="color:#e6db74">&#39;{print $3}&#39;</span>|uniq<span style="color:#66d9ef">)</span>; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>        echo 下载 $i
</span></span><span style="display:flex;"><span>        crictl --runtime-endpoint<span style="color:#f92672">=</span>unix:///run/containerd/containerd.sock pull <span style="color:#e6db74">${</span>i<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>kubectl apply -f kube-flannel.yml
</span></span><span style="display:flex;"><span>watch kubectl get pod -n kube-flannel
</span></span></code></pre></div><h3 id="让控制面节点也能调度pod">让控制面节点也能调度pod</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl taint nodes --all node-role.kubernetes.io/control-plane-
</span></span><span style="display:flex;"><span>kubectl taint nodes --all node-role.kubernetes.io/master-
</span></span></code></pre></div><h3 id="检验dns正确">检验dns正确</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl run curl --image<span style="color:#f92672">=</span>radial/busyboxplus:curl -it --rm
</span></span><span style="display:flex;"><span>nslookup kubernetes.default
</span></span></code></pre></div><h3 id="在控制面节点上跑一个nginx的pod">在控制面节点上跑一个nginx的pod</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f https://k8s.io/examples/pods/simple-pod.yaml
</span></span><span style="display:flex;"><span>watch kubectl get pods -o wide <span style="color:#75715e"># 显示nginx的pod正Running在192.168.254.8上</span>
</span></span><span style="display:flex;"><span>curl 192.168.254.8
</span></span><span style="display:flex;"><span>kubectl delete pod nginx <span style="color:#75715e"># 删除这个pod</span>
</span></span></code></pre></div><h2 id="常用组件安装">常用组件安装</h2>
<h3 id="装个我的代理">装个我的代理</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt; proxy.yaml <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: apps/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Deployment
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: proxy-deployment
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  replicas: 1 # tells deployment to run 2 pods matching the template
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  selector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    matchLabels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      kubernetes.io/os: linux
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  template:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      labels:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        kubernetes.io/os: linux
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      # 因为使用hostNetwork模式，最好限定好nodeName
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      # nodeSelector:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      #   kubernetes.io/hostname: mi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      containers:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - image: arloor/rust_http_proxy:1.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        imagePullPolicy: Always
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        name: proxy
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        env:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - name: port
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          value: &#34;443&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - name: basic_auth
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          value: &#34;Basic xxxxx==&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - name: ask_for_auth
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          value: &#34;false&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - name: over_tls
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          value: &#34;true&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - name: raw_key
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          value: &#34;/pems/arloor.dev.key&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - name: cert
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          value: &#34;/pems/fullchain.cer&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - name: web_content_path
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          value: &#34;/web_content_path&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        volumeMounts:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - mountPath: /pems
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          name: pems
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - mountPath: /web_content_path
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          name: content
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      restartPolicy: Always
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      hostNetwork: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      dnsPolicy: ClusterFirstWithHostNet
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      volumes:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - name: pems
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        hostPath:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          path: /root/.acme.sh/arloor.dev
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          type: Directory
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - name: content
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        hostPath:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          path: /usr/share/nginx/html/blog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          type: Directory
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>kubectl apply -f proxy.yaml
</span></span><span style="display:flex;"><span>watch kubectl get pod
</span></span></code></pre></div><h3 id="helm包管理器">helm包管理器</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://get.helm.sh/helm-v3.12.0-linux-amd64.tar.gz -O /tmp/helm-v3.12.0-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>tar -zxvf /tmp/helm-v3.12.0-linux-amd64.tar.gz -C /tmp
</span></span><span style="display:flex;"><span>mv /tmp/linux-amd64/helm  /usr/local/bin/
</span></span></code></pre></div><h3 id="metric-server">metric server</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.6.3/components.yaml
</span></span></code></pre></div><p>修改 <code>components.yaml</code> 中容器的启动参数，加入 <code>--kubelet-insecure-tls</code> 。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in <span style="color:#66d9ef">$(</span>grep <span style="color:#e6db74">&#34;image: &#34;</span> components.yaml | awk -F <span style="color:#e6db74">&#39;[ &#34;]+&#39;</span> <span style="color:#e6db74">&#39;{print $3}&#39;</span>|uniq<span style="color:#66d9ef">)</span>; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>        echo 下载 $i
</span></span><span style="display:flex;"><span>        crictl --runtime-endpoint<span style="color:#f92672">=</span>unix:///run/containerd/containerd.sock pull <span style="color:#e6db74">${</span>i<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>crictl --runtime-endpoint<span style="color:#f92672">=</span>unix:///run/containerd/containerd.sock images|grep registry.k8s.io
</span></span><span style="display:flex;"><span>kubectl apply -f components.yaml
</span></span><span style="display:flex;"><span>watch kubectl get pod -n kube-system
</span></span><span style="display:flex;"><span>kubectl get service -n ingress-nginx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                 TYPE           CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>                      AGE
</span></span><span style="display:flex;"><span>ingress-nginx-controller             LoadBalancer   10.97.175.254   &lt;pending&gt;     80:30873/TCP,443:31834/TCP   4m42s
</span></span><span style="display:flex;"><span>ingress-nginx-controller-admission   ClusterIP      10.99.75.35     &lt;none&gt;        443/TCP                      4m42s
</span></span></code></pre></div><p>metrics-server的pod正常启动后，等一段时间就可以使用kubectl top查看集群和pod的metrics信息。</p>
<h3 id="kubernetes-dashboard">kubernetes dashboard</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml -O dashboard.yaml
</span></span></code></pre></div><p>修改dashboard.yaml成hostNetWork： 参考<a href="https://hackmd.io/@compalAA/SykoBsSbi#Step3-%E6%89%8B%E5%8B%95%E4%B8%8B%E8%BC%89image">K8S Dashboard安裝/操作</a></p>
<ol>
<li>Service/kubernetes-dashboard的spec中增加  type: NodePort</li>
<li><del>Deployment/dashboard-metrics-scraper最后一行增加hostNetwork: true、dnsPolicy: ClusterFirstWithHostNet 和containers：并排</del></li>
<li>在args中增加 - &ndash;token-ttl=43200 将token过期时间改为12小时</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f dashboard.yaml
</span></span><span style="display:flex;"><span>watch kubectl get svc -n kubernetes-dashboard
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>NAME                        TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>         AGE   SELECTOR
</span></span><span style="display:flex;"><span>dashboard-metrics-scraper   ClusterIP   10.106.143.149   &lt;none&gt;        8000/TCP        53s   k8s-app<span style="color:#f92672">=</span>dashboard-metrics-scraper
</span></span><span style="display:flex;"><span>kubernetes-dashboard        NodePort    10.97.248.169    &lt;none&gt;        443:31611/TCP   53s   k8s-app<span style="color:#f92672">=</span>kubernetes-dashboard
</span></span></code></pre></div><p><code>443:31611/TCP</code> 表示我们可以通过外网ip:31611来访问dashboard，快速得到这个端口可以用下面的命令</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get svc -n kubernetes-dashboard |grep NodePort|awk -F <span style="color:#e6db74">&#39;[ :/]+&#39;</span> <span style="color:#e6db74">&#39;{print $6}&#39;</span>
</span></span></code></pre></div><p>生成访问token: 参考<a href="https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md">creating-sample-user</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f - <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ServiceAccount
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: admin-user
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: kubernetes-dashboard
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ClusterRoleBinding
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: admin-user
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">roleRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  apiGroup: rbac.authorization.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  kind: ClusterRole
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: cluster-admin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">subjects:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- kind: ServiceAccount
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: admin-user
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: kubernetes-dashboard
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>打印port，并生成token，随后通过token访问 <code>https://ip/31611</code> 即可使用dashboard。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt; /usr/local/bin/token <span style="color:#e6db74">&lt;&lt;\EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo Port: `kubectl get svc -n kubernetes-dashboard |grep NodePort|awk -F &#39;[ :/]+&#39; &#39;{print $6}&#39;`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">echo Token: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kubectl -n kubernetes-dashboard create token admin-user
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>chmod +x /usr/local/bin/token
</span></span><span style="display:flex;"><span>token
</span></span></code></pre></div><p><img src="/img/k8s-workloads.png" alt="">
<img src="/img/k8s-nodes.png" alt=""></p>
<h2 id="参考文档">参考文档</h2>
<ul>
<li><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">install-kubeadm</a></li>
<li><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/">create-cluster-kubeadm</a></li>
<li><a href="https://github.com/containerd/containerd/blob/main/docs/getting-started.md">containerd get started</a></li>
<li><a href="https://blog.csdn.net/weixin_52156647/article/details/129765134">kubernetes新版本使用kubeadm init的超全问题解决和建议</a></li>
<li><a href="https://docs.tigera.io/calico/latest/getting-started/kubernetes/quickstart">calico quick start</a></li>
<li><a href="https://blog.51cto.com/u_15343792/5142108">containerd设置代理</a></li>
<li><a href="https://kubernetes.io/docs/concepts/workloads/pods/">工作负载pods</a></li>
<li><a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">工作负载deployment</a></li>
<li><a href="https://blog.frognew.com/2023/06/kubeadm-install-kubernetes-1.27.html">使用kubeadm部署Kubernetes 1.27</a></li>
<li><a href="https://kubernetes.github.io/ingress-nginx/deploy/">ingress-nginx deploy</a></li>
<li><a href="https://blog.51cto.com/u_1472521/4909743">ingress-nginx 更改地址</a></li>
<li><a href="https://docs.nginx.com/nginx-ingress-controller/tutorials/custom-listen-ports/">ingress-nginx custom-listen-ports</a></li>
<li><a href="https://icloudnative.io/posts/deploy-k3s-cross-public-cloud/">跨云厂商部署 k3s 集群</a></li>
<li><a href="https://icloudnative.io/posts/use-wireguard-as-kubernetes-cni/">使用 WireGuard 作为 Kubernetes 的 CNI 插件(打通云厂商)</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/584998631">Kubernetes 入门到实践：借助 WireGuard 跨云搭建 K3s 集群环境</a></li>
<li><a href="http://kingsd.top/2020/05/14/k3s-Region/">K3S+Rancher2.x跨Region搭建方案</a></li>
<li><a href="http://kingsd.top/2023/07/13/k3s-k8s/">K3s vs K8s：轻量级和全功能的对决</a></li>
<li><a href="http://kingsd.top/2023/07/07/k3s-distributed-hybrid-or-multicloud-cluster/">探索 K3s 简单高效的多云和混合云部署</a></li>
</ul>
<h2 id="其他">其他</h2>
<h3 id="metal-lb">metal lb</h3>
<p>metallb-native.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://raw.githubusercontent.com/metallb/metallb/v0.13.10/config/manifests/metallb-native.yaml -O metallb-native.yaml
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in <span style="color:#66d9ef">$(</span>grep <span style="color:#e6db74">&#34;image: &#34;</span> metallb-native.yaml | awk -F <span style="color:#e6db74">&#39;[ &#34;]+&#39;</span> <span style="color:#e6db74">&#39;{print $3}&#39;</span>|uniq<span style="color:#66d9ef">)</span>; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>        echo 下载 $i
</span></span><span style="display:flex;"><span>        crictl --runtime-endpoint<span style="color:#f92672">=</span>unix:///run/containerd/containerd.sock pull <span style="color:#e6db74">${</span>i<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>kubectl apply -f metallb-native.yaml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt; l2.yaml <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: metallb.io/v1beta1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: IPAddressPool
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: metallb-system
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  addresses:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - 10.0.4.100-10.0.4.200
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  autoAssign: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: metallb.io/v1beta1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: L2Advertisement
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: metallb-system
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ipAddressPools:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>kubectl apply -f l2.yaml
</span></span></code></pre></div><h3 id="ingress-nginx并通过hostnetwork暴露18080和1443端口">ingress-nginx并通过hostNetwork暴露18080和1443端口</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/kubernetes/ingress-nginx/releases/download/helm-chart-4.7.1/ingress-nginx-4.7.1.tgz
</span></span><span style="display:flex;"><span>helm show values ingress-nginx-4.7.1.tgz &gt; values.yaml <span style="color:#75715e"># 查看可以配置的value</span>
</span></span></code></pre></div><p>修改values.yaml：改成使用hostNetwork，并且修改containerPort为非常用端口。我们的环境没有LoadBalencer，所以要用hostNetwork</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  <span style="color:#f92672">containerPort</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>: <span style="color:#ae81ff">18080</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">https</span>: <span style="color:#ae81ff">1443</span>
</span></span><span style="display:flex;"><span>...<span style="color:#ae81ff">.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">hostNetwork</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">## 预下载registry.k8s.io的镜像</span>
</span></span><span style="display:flex;"><span>helm template  ingress-nginx-4.7.1.tgz -f values.yaml &gt; ingress-nginx-deploy.yaml
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in <span style="color:#66d9ef">$(</span>grep <span style="color:#e6db74">&#34;image: &#34;</span> ingress-nginx-deploy.yaml | awk -F <span style="color:#e6db74">&#39;[ &#34;]+&#39;</span> <span style="color:#e6db74">&#39;{print $3}&#39;</span>|uniq<span style="color:#66d9ef">)</span>; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>        echo 下载 $i
</span></span><span style="display:flex;"><span>        crictl --runtime-endpoint<span style="color:#f92672">=</span>unix:///run/containerd/containerd.sock pull <span style="color:#e6db74">${</span>i<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>crictl --runtime-endpoint<span style="color:#f92672">=</span>unix:///run/containerd/containerd.sock images|grep registry.k8s.io
</span></span><span style="display:flex;"><span>systemctl disable rust_http_proxy --now <span style="color:#75715e">#关闭所有占用80、443端口的服务</span>
</span></span><span style="display:flex;"><span>helm install ingress-nginx ingress-nginx-4.7.1.tgz --create-namespace -n ingress-nginx -f values.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># helm install ingress-nginx ingress-nginx-4.7.1.tgz --create-namespace -n ingress-nginx -f values.yaml</span>
</span></span><span style="display:flex;"><span>watch kubectl get pods -o wide  -n ingress-nginx
</span></span><span style="display:flex;"><span>kubectl get services -o wide
</span></span><span style="display:flex;"><span>kubectl get controller -o wide
</span></span></code></pre></div><p>修改端口</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl edit deployment release-name-ingress-nginx-controller <span style="color:#75715e">#  不知道values.yaml里的extraArgs有用吗</span>
</span></span><span style="display:flex;"><span>/ -- 搜索，然后修改：
</span></span><span style="display:flex;"><span>   spec:
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - args:
</span></span><span style="display:flex;"><span>        - /nginx-ingress-controller
</span></span><span style="display:flex;"><span>        - --publish-service<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>POD_NAMESPACE<span style="color:#66d9ef">)</span>/release-name-ingress-nginx-controller
</span></span><span style="display:flex;"><span>        - --election-id<span style="color:#f92672">=</span>release-name-ingress-nginx-leader
</span></span><span style="display:flex;"><span>        - --controller-class<span style="color:#f92672">=</span>k8s.io/ingress-nginx
</span></span><span style="display:flex;"><span>        - --ingress-class<span style="color:#f92672">=</span>nginx
</span></span><span style="display:flex;"><span>        - --configmap<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>POD_NAMESPACE<span style="color:#66d9ef">)</span>/release-name-ingress-nginx-controller
</span></span><span style="display:flex;"><span>        - --validating-webhook<span style="color:#f92672">=</span>:8443
</span></span><span style="display:flex;"><span>        - --validating-webhook-certificate<span style="color:#f92672">=</span>/usr/local/certificates/cert
</span></span><span style="display:flex;"><span>        - --validating-webhook-key<span style="color:#f92672">=</span>/usr/local/certificates/key
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">## 增加以下端口设置</span>
</span></span><span style="display:flex;"><span>        - --http-port<span style="color:#f92672">=</span><span style="color:#ae81ff">18080</span>
</span></span><span style="display:flex;"><span>        - --https-port<span style="color:#f92672">=</span><span style="color:#ae81ff">1443</span>
</span></span><span style="display:flex;"><span>$ kubectl delete pod release-name-ingress-nginx-controller-5c65485f4c-lnm2r <span style="color:#75715e">#删除这个deployment的老pod，就会创建新的pod</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl enable rust_http_proxy --now <span style="color:#75715e">#开启原来的那些服务</span>
</span></span><span style="display:flex;"><span>curl http://xxxx:18080 <span style="color:#75715e"># 404即成功</span>
</span></span></code></pre></div><h3 id="nodeport方式安装ingress-nginx">NodePort方式安装Ingress Nginx</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget -O ingress-nginx.yaml https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.1/deploy/static/provider/baremetal/deploy.yaml
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in <span style="color:#66d9ef">$(</span>grep <span style="color:#e6db74">&#34;image: &#34;</span> ingress-nginx.yaml | awk -F <span style="color:#e6db74">&#39;[ &#34;]+&#39;</span> <span style="color:#e6db74">&#39;{print $3}&#39;</span>|uniq<span style="color:#66d9ef">)</span>; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>        echo 下载 $i
</span></span><span style="display:flex;"><span>        crictl --runtime-endpoint<span style="color:#f92672">=</span>unix:///run/containerd/containerd.sock pull <span style="color:#e6db74">${</span>i<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>kubectl apply -f ingress-nginx.yaml
</span></span><span style="display:flex;"><span>watch kubectl get service -A
</span></span></code></pre></div><p>问题： 在做<a href="https://kubernetes.github.io/ingress-nginx/deploy/#local-testing">local-testing</a>创建ingress时，连接不到admission。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl create deployment demo --image<span style="color:#f92672">=</span>httpd --port<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>$ kubectl expose deployment demo
</span></span><span style="display:flex;"><span>$ kubectl create ingress demo-localhost --class<span style="color:#f92672">=</span>nginx <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --rule<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;demo.localdev.me/*=demo:80&#34;</span>
</span></span><span style="display:flex;"><span>error: failed to create ingress: Internal error occurred: failed calling webhook <span style="color:#e6db74">&#34;validate.nginx.ingress.kubernetes.io&#34;</span>: failed to call webhook: Post <span style="color:#e6db74">&#34;https://ingress-nginx-controller-admission.ingress-nginx.svc:443/networking/v1/ingresses?timeout=10s&#34;</span>: EOF
</span></span></code></pre></div><p>测试了下dns</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl run curl --image<span style="color:#f92672">=</span>radial/busyboxplus:curl -it
</span></span><span style="display:flex;"><span>$ nslookup ingress-nginx-controller-admission.ingress-nginx.svc <span style="color:#75715e"># dns是通的</span>
</span></span><span style="display:flex;"><span>Server:    10.96.0.10
</span></span><span style="display:flex;"><span>Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Name:      ingress-nginx-controller-admission.ingress-nginx.svc
</span></span><span style="display:flex;"><span>Address 1: 10.108.175.87 ingress-nginx-controller-admission.ingress-nginx.svc.cluster.local
</span></span><span style="display:flex;"><span>$ curl https://ingress-nginx-controller-admission.ingress-nginx.svc:443/networking/v1/ingresses?timeout<span style="color:#f92672">=</span>10s
</span></span><span style="display:flex;"><span>curl: <span style="color:#f92672">(</span>6<span style="color:#f92672">)</span> Couldn<span style="color:#e6db74">&#39;t resolve host &#39;</span>ingress-nginx-controller-admission.ingress-nginx.svc<span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>$ curl https://ingress-nginx-controller-admission.ingress-nginx.svc.cluster.local:443/networking/v1/ingresses?timeout<span style="color:#f92672">=</span>10s  -k -v
</span></span><span style="display:flex;"><span>* SSLv3, TLS handshake, Client hello <span style="color:#f92672">(</span>1<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>* SSLv3, TLS handshake, Server hello <span style="color:#f92672">(</span>2<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>* SSLv3, TLS handshake, CERT <span style="color:#f92672">(</span>11<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>* SSLv3, TLS handshake, Server key exchange <span style="color:#f92672">(</span>12<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>* SSLv3, TLS handshake, Server finished <span style="color:#f92672">(</span>14<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>* SSLv3, TLS handshake, Client key exchange <span style="color:#f92672">(</span>16<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>* SSLv3, TLS change cipher, Client hello <span style="color:#f92672">(</span>1<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>* SSLv3, TLS handshake, Finished <span style="color:#f92672">(</span>20<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>* SSLv3, TLS change cipher, Client hello <span style="color:#f92672">(</span>1<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>* SSLv3, TLS handshake, Finished <span style="color:#f92672">(</span>20<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>&gt; GET /networking/v1/ingresses?timeout<span style="color:#f92672">=</span>10s HTTP/1.1
</span></span><span style="display:flex;"><span>&gt; User-Agent: curl/7.35.0
</span></span><span style="display:flex;"><span>&gt; Host: ingress-nginx-controller-admission.ingress-nginx.svc.cluster.local
</span></span><span style="display:flex;"><span>&gt; Accept: */*
</span></span><span style="display:flex;"><span>&gt; 
</span></span><span style="display:flex;"><span>&lt; HTTP/1.1 <span style="color:#ae81ff">400</span> Bad Request
</span></span><span style="display:flex;"><span>&lt; Date: Fri, <span style="color:#ae81ff">21</span> Jul <span style="color:#ae81ff">2023</span> 03:02:07 GMT
</span></span><span style="display:flex;"><span>&lt; Content-Length: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>&lt; 
</span></span></code></pre></div><p>类似的问题在 kubernetes.default 也一样</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span> root@curl:/ <span style="color:#f92672">]</span>$ nslookup kubernetes.default
</span></span><span style="display:flex;"><span>Server:    10.96.0.10
</span></span><span style="display:flex;"><span>Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Name:      kubernetes.default
</span></span><span style="display:flex;"><span>Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span> root@curl:/ <span style="color:#f92672">]</span>$ curl https://kubernetes.default -k
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;kind&#34;</span>: <span style="color:#e6db74">&#34;Status&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;apiVersion&#34;</span>: <span style="color:#e6db74">&#34;v1&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;metadata&#34;</span>: <span style="color:#f92672">{}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;status&#34;</span>: <span style="color:#e6db74">&#34;Failure&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;message&#34;</span>: <span style="color:#e6db74">&#34;forbidden: User \&#34;system:anonymous\&#34; cannot get path \&#34;/\&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;reason&#34;</span>: <span style="color:#e6db74">&#34;Forbidden&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;details&#34;</span>: <span style="color:#f92672">{}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;code&#34;</span>: <span style="color:#ae81ff">403</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span> root@curl:/ <span style="color:#f92672">]</span>$ curl https://kubernetes.default.svc -k
</span></span><span style="display:flex;"><span>curl: <span style="color:#f92672">(</span>6<span style="color:#f92672">)</span> Couldn<span style="color:#e6db74">&#39;t resolve host &#39;</span>kubernetes.default.svc<span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span> root@curl:/ <span style="color:#f92672">]</span>$ curl https://kubernetes.default.svc.cluster.local -k
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;kind&#34;</span>: <span style="color:#e6db74">&#34;Status&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;apiVersion&#34;</span>: <span style="color:#e6db74">&#34;v1&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;metadata&#34;</span>: <span style="color:#f92672">{}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;status&#34;</span>: <span style="color:#e6db74">&#34;Failure&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;message&#34;</span>: <span style="color:#e6db74">&#34;forbidden: User \&#34;system:anonymous\&#34; cannot get path \&#34;/\&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;reason&#34;</span>: <span style="color:#e6db74">&#34;Forbidden&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;details&#34;</span>: <span style="color:#f92672">{}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;code&#34;</span>: <span style="color:#ae81ff">403</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div>
  </div>
  

<div class="navigation navigation-single">
    
    <a href="/posts/k8s-kind/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">K8s Kind使用</span>
    </a>
    
    
    <a href="/posts/clash-tun-gateway/" class="navigation-next">
      <span class="navigation-tittle">Clash Tun模式和透明代理</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  


</article>


        </div>
        
    



<script defer src="/js/all.js" crossorigin="anonymous"></script>

    
    
    <script src="/js/highlight.min.js"></script>
    <script src="/js/languages/dos.min.js"></script>
        
    <script type="text/javascript">
        
        hljs.highlightAll();
    </script>
    




    



    </body>
</html>
