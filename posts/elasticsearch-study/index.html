<!DOCTYPE html>
<html lang="zh-CN">

    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    
    <link rel="canonical" href="https://www.arloor.com/posts/elasticsearch-study/">
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.157.0">

    
    
    

<title>Elasticsearch调研 • ARLOOR</title>
<meta name="description" content="今天，你学习了吗">
<meta name="keywords" content="刘港欢, arloor, moontell">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Elasticsearch调研">
  <meta name="twitter:description" content="目的：调研elasticsearch的启动、debug、评分、插件以实现自定义评分插件。
首先，关于es启动流程的大体介绍lanffy.github.io。在这片文章中，将会主要关注加载插件的部分。
elaticsearch我的fork">
      <meta name="twitter:site" content="@njulgh">

<meta property="og:url" content="https://www.arloor.com/posts/elasticsearch-study/">
  <meta property="og:site_name" content="ARLOOR">
  <meta property="og:title" content="Elasticsearch调研">
  <meta property="og:description" content="目的：调研elasticsearch的启动、debug、评分、插件以实现自定义评分插件。
首先，关于es启动流程的大体介绍lanffy.github.io。在这片文章中，将会主要关注加载插件的部分。
elaticsearch我的fork">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-04-03T15:13:08+08:00">
    <meta property="article:modified_time" content="2020-04-03T15:13:08+08:00">
    <meta property="article:tag" content="Elasticsearch">


    





<link rel="stylesheet" href="/styles/atom-one-dark.min.css">








<link rel="stylesheet" href="/scss/hyde-hyde.debf1b963c1830f6b9b96ee48c2b4a22c31c7c3885a87bed290c0e198fc6a08d.css" integrity="sha256-3r8bljwYMPa5uW7kjCtKIsMcfDiFqHvtKQwOGY/GoI0=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">




<link rel="stylesheet" href="/scss/hugo-toc.6b7222b4ddd3cebd47d144a2e37ade6cbbb64f47e31d8feac655896156ade206.css" integrity="sha256-a3IitN3Tzr1H0USi43rebLu2T0fjHY/qxlWJYVat4gY=">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    

</head>



<body class="  ">
  
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="/">
          
          ARLOOR
          
        </a>
      </span>
      <a href="/">
        
        
        <div class="author-image">
          <img src="/img/head.jpeg" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
        
      </a>
      
      <p class="site__description">
         都是瞎写的 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">ARLOOR</label>
      <div class="menu-content menu-content--mobile">
        <div class="show-in-small">
          <a href="/">
            
            
            <div class="author-image">
              <img src="/img/head.jpeg" alt="Author Image"
                class="img--circle img--headshot element--center">
            </div>
            
            
          </a>
        </div>
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>文章</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/">
						<span>分类</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>关于我</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/grafana-iframe">
						<span>Grafana</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/net-iframe">
						<span>网速监控</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/nat">
						<span>NAT规则</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/stock">
						<span>股票监控</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://x.com/njulgh" rel="me" target="_blank"><i class="fa-brands fa-x-twitter fa-lg"></i></a>
	
	
	
	
	
	<a href="https://github.com/arloor" rel="me" target="_blank"><i class="fa-brands fa-github fa-lg"></i></a>
	
	
	
	
	
	
	
	
	
	
	
	
	
	<a href="https://t.me/never_contact_me" rel="me" target="_blank"><i class="fa-brands fa-telegram fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="mailto:admin@arloor.com" rel="me" target="_blank"><i class="fa-solid fa-at fa-lg"></i></a>
	
	
	
	
</section>
      </div>
    </div>
    <div class="menu-content menu-content--desktop">
      <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>文章</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/">
						<span>分类</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>关于我</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/grafana-iframe">
						<span>Grafana</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/net-iframe">
						<span>网速监控</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/nat">
						<span>NAT规则</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/stock">
						<span>股票监控</span>
					</a>
				</li>
			 
		
	</ul>
</div>

    </div>
    <div class="social-wrap social-wrap--desktop">
      <section class="social">
	
	<a href="https://x.com/njulgh" rel="me" target="_blank"><i class="fa-brands fa-x-twitter fa-lg"></i></a>
	
	
	
	
	
	<a href="https://github.com/arloor" rel="me" target="_blank"><i class="fa-brands fa-github fa-lg"></i></a>
	
	
	
	
	
	
	
	
	
	
	
	
	
	<a href="https://t.me/never_contact_me" rel="me" target="_blank"><i class="fa-brands fa-telegram fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="mailto:admin@arloor.com" rel="me" target="_blank"><i class="fa-solid fa-at fa-lg"></i></a>
	
	
	
	
</section>
    </div>
    
<div class="copyright">
  &copy; 2026 arloor
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>


<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/arloor/hyde-arloor">hyde-arloor</a>.
</div>


  </div>
</div>

  <div class="content container">
    
    
<article>
  <header>
    <h1>Elasticsearch调研</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Apr 3, 2020
    
    
    
      
      
          in
          
          
              <a class="badge badge-category" href="/categories/undefined">UNDEFINED</a>
              
          
      
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/elasticsearch">elasticsearch</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 6 min read
</div>


  </header>
  
  
  
    <div class="toc-wrapper">
      <input type="checkbox" id="tocToggle">
      <label for="tocToggle">Table of Content</label>
      
          <nav id="TableOfContents">
  <ul>
    <li><a href="#在idea中启动调试elasticsearch">在idea中启动调试elasticsearch</a></li>
    <li><a href="#es-评分模块">es 评分模块</a></li>
    <li><a href="#es索引修改使用的评分算法">es索引修改使用的评分算法</a></li>
    <li><a href="#es插件模块">es插件模块</a></li>
    <li><a href="#再看scripted_similarity">再看scripted_similarity</a></li>
  </ul>
</nav>
      
    </div>
  
  
  <div class="post">
    <p>目的：调研elasticsearch的启动、debug、评分、插件以实现自定义评分插件。</p>
<p>首先，关于es启动流程的大体介绍<a href="https://lanffy.github.io/2019/04/09/ElasticSearch-Start-Up-Process">lanffy.github.io</a>。在这片文章中，将会主要关注加载插件的部分。</p>
<p><a href="https://github.com/arloor/elasticsearch/tree/LGH-test">elaticsearch我的fork</a></p>
<h2 id="在idea中启动调试elasticsearch">在idea中启动调试elasticsearch</h2>
<p>es6.6.2需要使用jdk11启动。</p>
<pre tabindex="0"><code>git clone https://github.com/elastic/elasticsearch.git
git checkout v6.6.2
</code></pre><p><strong>将项目导入到idea</strong></p>
<ol>
<li>到项目根目录: ./gradlew idea</li>
<li>Idea create from existing source选择gradle，auto-import</li>
</ol>
<p>要对项目做几处修改：下面直接复制git修改信息</p>
<pre tabindex="0"><code>Index: server/build.gradle
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
&lt;+&gt;UTF-8
===================================================================
--- server/build.gradle	(revision 3bd3e59556628bb84c8d53b09b10c9ac8255e251)
+++ server/build.gradle	(date 1585882097224)
@@ -78,7 +78,7 @@
   compile &#34;org.elasticsearch:elasticsearch-secure-sm:${version}&#34;
   compile &#34;org.elasticsearch:elasticsearch-x-content:${version}&#34;
 
-  compileOnly project(&#39;:libs:plugin-classloader&#39;)
+  compile project(&#39;:libs:plugin-classloader&#39;)
   testRuntime project(&#39;:libs:plugin-classloader&#39;)
 
   // lucene
</code></pre><p>设置maven仓库为阿里云镜像</p>
<pre tabindex="0"><code>Index: build.gradle
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
&lt;+&gt;UTF-8
===================================================================
--- build.gradle	(revision 3bd3e59556628bb84c8d53b09b10c9ac8255e251)
+++ build.gradle	(date 1585878050973)
@@ -48,6 +48,20 @@
   group = &#39;org.elasticsearch&#39;
   version = VersionProperties.elasticsearch
   description = &#34;Elasticsearch subproject ${project.path}&#34;
+
+  // 增加下面部分
+  repositories {
+      google()
+      jcenter()
+      // maven库
+      def cn = &#34;http://maven.aliyun.com/nexus/content/groups/public/&#34;
+      def abroad = &#34;http://central.maven.org/maven2/&#34;
+      // 先从url中下载jar若没有找到，则在artifactUrls中寻找
+      maven {
+        url cn
+        artifactUrls abroad
+      }
+  }
 }
 
 apply plugin: &#39;nebula.info-scm&#39;
</code></pre><p>（可选）设置该项目的gradle代理，加速访问</p>
<pre tabindex="0"><code>Index: gradle.properties
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
&lt;+&gt;GBK
===================================================================
--- gradle.properties	(revision 3bd3e59556628bb84c8d53b09b10c9ac8255e251)
+++ gradle.properties	(date 1585878076127)
@@ -1,3 +1,8 @@
 org.gradle.daemon=true
 org.gradle.jvmargs=-Xmx2g
 options.forkOptions.memoryMaximumSize=2g
+systemProp.http.proxyHost=127.0.0.1
+systemProp.http.proxyPort=1080
+# systemProp.http.proxyUser=userid
+# systemProp.http.proxyPassword=password
+systemProp.http.nonProxyHosts=maven.aliyun.com|localhost
\ No newline at end of file
</code></pre><p>下载es6.6.2的release包<a href="https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.6.2.zip">https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.6.2.zip</a></p>
<p>解压到D:\elasticsearch-6.6.2</p>
<p>设置idea项目的vm options</p>
<pre tabindex="0"><code>-Des.path.home=D:\elasticsearch-6.6.2
-Des.path.conf=D:\elasticsearch-6.6.2\config
-Xms1g
-Xmx1g
-Dlog4j2.disable.jmx=true
-Djava.security.policy=D:\es\config\es.policy
</code></pre><p>D:\es\config\es.policy如下</p>
<pre tabindex="0"><code>grant {
    permission javax.management.MBeanTruePermission &#34;register&#34;;
    permission javax.management.MBeanServerPermission &#34;createMBeanServer&#34;;
    permission java.lang.RuntimePermission &#34;createClassLoader&#34;;
};
</code></pre><p>至此我可以成功启动，如果遇到其他问题，请先refer <a href="https://blog.csdn.net/weixin_38380858/article/details/84258372">https://blog.csdn.net/weixin_38380858/article/details/84258372</a></p>
<h2 id="es-评分模块">es 评分模块</h2>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.6/index-modules-similarity.html">https://www.elastic.co/guide/en/elasticsearch/reference/6.6/index-modules-similarity.html</a></p>
<p>es索引的评分规则在创建或更新索引setting的时候设定，用户可以配置es内置评分算法（如BM25）的参数或创建自己的scripted similarity。</p>
<p>可以使用scripted similarity</p>
<pre tabindex="0"><code>PUT /index
{
  &#34;settings&#34;: {
    &#34;number_of_shards&#34;: 1,
    &#34;similarity&#34;: {
      &#34;scripted_tfidf&#34;: {
        &#34;type&#34;: &#34;scripted&#34;,
        &#34;script&#34;: {
          &#34;source&#34;: &#34;double tf = Math.sqrt(doc.freq); double idf = Math.log((field.docCount+1.0)/(term.docFreq+1.0)) + 1.0; double norm = 1/Math.sqrt(doc.length); return query.boost * tf * idf * norm;&#34;
        }
      }
    }
  },
  &#34;mappings&#34;: {
    &#34;_doc&#34;: {
      &#34;properties&#34;: {
        &#34;field&#34;: {
          &#34;type&#34;: &#34;text&#34;,
          &#34;similarity&#34;: &#34;scripted_tfidf&#34;
        }
      }
    }
  }
}

PUT /index/_doc/1
{
  &#34;field&#34;: &#34;foo bar foo&#34;
}

PUT /index/_doc/2
{
  &#34;field&#34;: &#34;bar baz&#34;
}

POST /index/_refresh

GET /index/_search?explain=true
{
  &#34;query&#34;: {
    &#34;query_string&#34;: {
      &#34;query&#34;: &#34;foo^1.7&#34;,
      &#34;default_field&#34;: &#34;field&#34;
    }
  }
}
</code></pre><p>注意：</p>
<p>While scripted similarities provide a lot of flexibility, there is a set of rules that they need to satisfy. Failing to do so could make Elasticsearch silently return wrong top hits or fail with internal errors at search time:</p>
<ul>
<li>返回分值必须是正的</li>
<li>当所有其他变量不变时，当doc.freq上升，socre不能下降</li>
<li>当所有其他变量不变时，当doc.length上升，score不能上升</li>
</ul>
<p>上面例子中的script similarity计算方式中包含跟文档无关的部分：query.boost * idf。这一部分可以放在<code>weight_script</code>。如下:</p>
<pre tabindex="0"><code>    &#34;similarity&#34;: {
      &#34;scripted_tfidf&#34;: {
        &#34;type&#34;: &#34;scripted&#34;,
        &#34;weight_script&#34;: {
          &#34;source&#34;: &#34;double idf = Math.log((field.docCount+1.0)/(term.docFreq+1.0)) + 1.0; return query.boost * idf;&#34;
        },
        &#34;script&#34;: {
          &#34;source&#34;: &#34;double tf = Math.sqrt(doc.freq); double norm = 1/Math.sqrt(doc.length); return weight * tf * norm;&#34;
        }
    }
</code></pre><h2 id="es索引修改使用的评分算法">es索引修改使用的评分算法</h2>
<p>es提供多个评分算法，并且用户可以自行扩展，那么在检索时，使用哪套评分算法？</p>
<p><strong>1.</strong> 创建/更新mapping时按字段设置</p>
<pre tabindex="0"><code>PUT /index/_mapping/_doc
{
  &#34;properties&#34; : {
    &#34;title&#34; : { &#34;type&#34; : &#34;text&#34;, &#34;similarity&#34; : &#34;my_similarity&#34; }
  }
}
</code></pre><p><strong>2.</strong> 设置默认评分算法</p>
<pre tabindex="0"><code>POST /index/_close

PUT /index/_settings
{
  &#34;index&#34;: {
    &#34;similarity&#34;: {
      &#34;default&#34;: {
        &#34;type&#34;: &#34;boolean&#34;
      }
    }
  }
}

POST /index/_open
</code></pre><h2 id="es插件模块">es插件模块</h2>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/plugins/6.6/index.html">https://www.elastic.co/guide/en/elasticsearch/plugins/6.6/index.html</a></p>
<p>插件包含：jar包、脚本和配置文件。插件必须在集群中的每个节点安装，安装后必须重启节点，插件才可用（动态加载的实现看起来较困难。涉及到集群元数据的插件，需要整个集群的重启</p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/plugins/6.6/plugin-authors.html">插件编写指南</a></p>
<p><strong>开发调试插件</strong></p>
<p>es可以从classpath加载插件，但是在发行版的代码中，隐藏了这个这个功能。稍微改下代码，把这个东西放出来</p>
<pre tabindex="0"><code>Index: server/src/main/java/org/elasticsearch/node/Node.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
&lt;+&gt;UTF-8
===================================================================
--- server/src/main/java/org/elasticsearch/node/Node.java	(revision 1c439191c30172708dceae79ce3125822f8d6e12)
+++ server/src/main/java/org/elasticsearch/node/Node.java	(date 1586246418270)
@@ -265,6 +265,10 @@
         this(environment, Collections.emptyList(), true);
     }
 
+    public Node(Environment environment,Collection&lt;Class&lt;? extends Plugin&gt;&gt; classpathPlugins) {
+        this(environment, classpathPlugins, true);
+    }
+
     /**
      * Constructs a node
      *
</code></pre><p>然后，修改BootStrap中的Node创建代码</p>
<pre tabindex="0"><code>Index: server/src/main/java/org/elasticsearch/bootstrap/Bootstrap.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
&lt;+&gt;UTF-8
===================================================================
--- server/src/main/java/org/elasticsearch/bootstrap/Bootstrap.java	(revision 1c439191c30172708dceae79ce3125822f8d6e12)
+++ server/src/main/java/org/elasticsearch/bootstrap/Bootstrap.java	(date 1586246418279)
@@ -214,22 +214,9 @@
             throw new BootstrapException(e);
         }

-        node = new Node(environment) {
+        Collection plugins = new ArrayList&lt;&gt;();
+        Collections.addAll(plugins, MBM25SimilarityPlugin.class);
+        node = new Node(environment,plugins) {
             @Override
             protected void validateNodeBeforeAcceptingRequests(
                 final BootstrapContext context,
</code></pre><p>下面是一个简单的插件（修改了BM25算法的参数）（这个插件没什么意义，修改BM25参数不需要搞插件）</p>
<pre tabindex="0"><code>package org.elasticsearch.plugin;

import org.apache.lucene.search.similarities.BM25Similarity;
import org.elasticsearch.index.IndexModule;
import org.elasticsearch.plugins.Plugin;


public class MBM25SimilarityPlugin extends Plugin {
    public String name() {
        return &#34;elasticsearch-position-similarity&#34;;
    }

    public String description() {
        return &#34;Elasticsearch scoring plugin based on matching a term or a phrase relative to a position of the term in a searched field.&#34;;
    }

    public void onIndexModule(IndexModule indexModule) {
        indexModule.addSimilarity(&#34;position&#34;, (settings, version, scriptService)-&gt;{
            String DISCOUNT_OVERLAPS=&#34;discount_overlaps&#34;;
            // BM25的k1默认是1.2 b默认是0.75
            float k1 = settings.getAsFloat(&#34;k1&#34;, 1.4f);
            float b = settings.getAsFloat(&#34;b&#34;, 0.8f);
            boolean discountOverlaps = settings.getAsBoolean(DISCOUNT_OVERLAPS, true);

            BM25Similarity similarity = new BM25Similarity(k1, b);
            similarity.setDiscountOverlaps(discountOverlaps);
            return similarity;
        });
    }
}
</code></pre><p>核心是indexModule.addXXXX方法，提供了扩展es各个功能的方法。</p>
<h2 id="再看scripted_similarity">再看scripted_similarity</h2>
<p>上文见识了scripted_similarity的实例，但是没有看用于script的参数的含义，这里再来看下。</p>
<p>各项参数定义的java类，是org.elasticsearch. index.similarity.ScriptedSimilarity类的私有静态内部类。elasticsearch的文档把这些参数写在了painless context中，链接：<a href="https://www.elastic.co/guide/en/elasticsearch/painless/6.6/painless-similarity-context.html">painless-similarity-context.html</a></p>
<p>参数：</p>
<ul>
<li>params (Map, read-only)
<ul>
<li>User-defined parameters passed in at query-time.</li>
<li>(提供查询时传参能力，但是7.6版本<strong>已移除</strong>)</li>
</ul>
</li>
<li>weight (float, read-only)
<ul>
<li>The weight as calculated by a weight script</li>
<li>如果没有weight_script则为1</li>
</ul>
</li>
<li>query.boost (float, read-only)
<ul>
<li>The boost value if provided by the query. If this is not provided the value is 1.0f.</li>
<li>查询时传的参数，会乘一下</li>
</ul>
</li>
<li>field.docCount (long, read-only)
<ul>
<li>The number of documents that have a value for the current field.</li>
<li><strong>分片shard</strong>中该字段有值的文档数量</li>
</ul>
</li>
<li>field.sumDocFreq (long, read-only)
<ul>
<li>The sum of all terms that exist for the current field. If this is not available the value is -1.</li>
</ul>
</li>
<li>field.sumTotalTermFreq (long, read-only)
<ul>
<li>The sum of occurrences in the index for all the terms that exist in the current field. If this is not available the value is -1.</li>
</ul>
</li>
<li>term.docFreq (long, read-only)
<ul>
<li>The number of documents that contain the current term in the index.</li>
<li><strong>分片shard中</strong>包含该term的文档数量</li>
</ul>
</li>
<li>term.totalTermFreq (long, read-only)
<ul>
<li>The total occurrences of the current term in the index.</li>
<li>index中该term的总出现次数</li>
</ul>
</li>
<li>doc.length (long, read-only)
<ul>
<li>The number of tokens the current document has in the current field. This is decoded from the stored norms and may be approximate for long fields</li>
<li>该字段的token数量</li>
</ul>
</li>
<li>doc.freq (long, read-only)
<ul>
<li>The number of occurrences of the current term in the current document for the current field.</li>
<li>该term在该doc的该field中出现的次数</li>
</ul>
</li>
</ul>
<p>有点抽象，尤其是field.sumDocFreq是Σterm.docFreq, field.sumTotalTermFreq是Σterm.totalTermFreq。他们到底有啥用？</p>
<p>可以从一个博客<a href="https://www.jianshu.com/p/1e498888f505">文本相似度-bm25算法原理及实现</a>寻找bm25是如何使用这些参数的（很值得一看，理解es是怎么对每个field评分的）</p>
<p>这里不详细说里面的内容，大概介绍下使用这些参数的方式。field的评分是Σ语素（分词后的token）的评分。token的评分由weight(加权)*token的分数得出。weight最一般的实现是idf，上述script的idf是Math.log((field.docCount+1.0) /(term.docFreq+1.0)) + 1.0 ——field.docCount是总文档数，term.docFreq是该term出现的次数。</p>
<p>另一篇介绍BM25算法的文章<a href="https://www.jianshu.com/p/0b372804ff45">https://www.jianshu.com/p/0b372804ff45</a></p>
<p>对similarity的简单总结：es提供给similarity评分计算的参数有限。无法获取文档中某字段的值，也无法获取用户输入参数。另外，es通过script_similarity给我们提供了自定义相似度算法的方法（当然，只能使用es给我们的那些参数，不能扩展）。因此，使用插件来自定义similarity算法意义不大。</p>
<p>在<a href="/posts/elasticsearch-horspool-score-plugin/">Elasticsearch自定义评分插件</a>中，将介绍使用插件来实现自定义script_score（function_score），以实现自定义评分算法。</p>
  </div>
  

<div class="navigation navigation-single">
    
    <a href="/posts/netty-src-read/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Netty源码阅读</span>
    </a>
    
    
    <a href="/posts/acme-wildcard-ssl-cert/" class="navigation-next">
      <span class="navigation-tittle">acme.sh签发dnspod(腾讯云)和阿里云ssl野卡证书并自动续签</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  


</article>


  </div>
<style>
  .content.container {
        width: 100%;
        max-width: none;
        height: calc(100vh - var(--sidebar-height, 49px));
        border: none;
        display: block;
        overflow-y: auto;
        box-sizing: border-box;
        margin-left: 0;
        margin-right: 0;
  }

  body:not(.type-iframe) .content.container {
        padding-left: max(1.5rem, calc((100% - var(--content-max-width, 38rem)) / 2));
        padding-right: max(1.5rem, calc((100% - var(--content-max-width, 38rem)) / 2));
  }
</style>
<script>
    (function () {
        var contentSelector = '.content.container';
        var rafId = 0;
        var resizeDebounceTimer = 0;
        var pendingHashScroll = false;

        function getHashTarget() {
            var hash = window.location.hash;
            var targetId = '';

            if (!hash || hash === '#') {
                return null;
            }

            targetId = hash.slice(1);
            try {
                targetId = decodeURIComponent(targetId);
            } catch (e) {
                
            }

            return document.getElementById(targetId);
        }

        function scrollToHashTarget() {
            var target = getHashTarget();
            if (!target) {
                return;
            }
            try {
                target.scrollIntoView({ block: 'start', inline: 'nearest' });
            } catch (e) {
                target.scrollIntoView(true);
            }
        }

        function applyPendingHashScroll() {
            if (!pendingHashScroll) {
                return;
            }
            pendingHashScroll = false;
            scrollToHashTarget();
        }

        function resizeContentHeight() {
            var content = document.querySelector(contentSelector);
            if (!content) {
                return;
            }
            var rect = content.getBoundingClientRect();
            var available = window.innerHeight - rect.top;
            if (available < 0) {
                available = 0;
            }
            content.style.height = available + 'px';
            applyPendingHashScroll();
        }

        function scheduleResize() {
            if (rafId) {
                return;
            }
            rafId = window.requestAnimationFrame(function () {
                rafId = 0;
                resizeContentHeight();
            });
        }

        function scheduleResizeDebounced(delay) {
            window.clearTimeout(resizeDebounceTimer);
            resizeDebounceTimer = window.setTimeout(scheduleResize, delay || 120);
        }

        function requestHashScroll() {
            if (!window.location.hash || window.location.hash === '#') {
                return;
            }
            pendingHashScroll = true;
            scheduleResize();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function () {
                scheduleResize();
                requestHashScroll();
            }, { once: true });
        } else {
            scheduleResize();
            requestHashScroll();
        }

        window.addEventListener('load', function () {
            scheduleResize();
            requestHashScroll();
        });
        window.addEventListener('pageshow', function () {
            scheduleResize();
            requestHashScroll();
        });
        window.addEventListener('hashchange', requestHashScroll);
        window.addEventListener('resize', function () {
            scheduleResizeDebounced(120);
        });

        var menuToggle = document.getElementById('menuToggle');
        if (menuToggle) {
            menuToggle.addEventListener('change', function () {
                scheduleResize();
                window.setTimeout(scheduleResize, 250);
            });
        }
    })();
</script>
  
    



<script defer src="/js/all.js" crossorigin="anonymous"></script>

    
    
    <script src="/js/highlight.min.js"></script>
    <script src="/js/languages/dos.min.js"></script>
        
    <script type="text/javascript">
        
        hljs.highlightAll();
    </script>
    

<style>
    .code-block-wrapper {
        position: relative;
    }
    .copy-code-button {
        position: absolute;
        top: 8px;
        right: 8px;
        padding: 6px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.3s, background 0.3s;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .copy-code-button svg {
        width: 16px;
        height: 16px;
        fill: #fff;
        transition: fill 0.3s;
    }
    .code-block-wrapper:hover .copy-code-button {
        opacity: 1;
    }
    .copy-code-button:hover {
        background: rgba(255, 255, 255, 0.2);
    }
    .copy-code-button.copied {
        background: rgba(46, 160, 67, 0.8);
        border-color: rgba(46, 160, 67, 1);
    }
    .copy-code-button.copied svg {
        fill: #fff;
    }
</style>
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
        
        document.querySelectorAll('pre code').forEach(function(codeBlock) {
            var pre = codeBlock.parentNode;
            
            
            if (pre.parentNode.classList.contains('code-block-wrapper')) {
                return;
            }
            
            
            var wrapper = document.createElement('div');
            wrapper.className = 'code-block-wrapper';
            pre.parentNode.insertBefore(wrapper, pre);
            wrapper.appendChild(pre);
            
            
            var button = document.createElement('button');
            button.className = 'copy-code-button';
            button.innerHTML = '<svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path></svg>';
            button.setAttribute('aria-label', '复制代码');
            button.setAttribute('title', '复制代码');
            
            var copyIcon = '<svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path></svg>';
            var checkIcon = '<svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16"><path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path></svg>';
            
            
            button.addEventListener('click', function() {
                var code = codeBlock.textContent;
                navigator.clipboard.writeText(code).then(function() {
                    button.innerHTML = checkIcon;
                    button.classList.add('copied');
                    button.setAttribute('aria-label', '已复制');
                    button.setAttribute('title', '已复制');
                    setTimeout(function() {
                        button.innerHTML = copyIcon;
                        button.classList.remove('copied');
                        button.setAttribute('aria-label', '复制代码');
                        button.setAttribute('title', '复制代码');
                    }, 2000);
                }).catch(function(err) {
                    console.error('复制失败:', err);
                });
            });
            
            wrapper.appendChild(button);
        });
    });
</script>




    



</body>

</html>
