<!DOCTYPE html>
<html lang="zh-CN">

    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    
    <link rel="canonical" href="https://www.arloor.com/posts/springboot-tomcat-config/">
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.157.0">

    
    
    

<title>Springboot内置Tomcat的配置 • ARLOOR</title>
<meta name="description" content="今天，你学习了吗">
<meta name="keywords" content="刘港欢, arloor, moontell">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Springboot内置Tomcat的配置">
  <meta name="twitter:description" content="背景：需要提供一个配置服务给60w&#43;机器，没台机器每分钟请求一次拉取最新配置。springboot的默认tomcat配置是不行的，研究下tomcat有哪些配置项，以及如何在springboot中配置。">
      <meta name="twitter:site" content="@njulgh">

<meta property="og:url" content="https://www.arloor.com/posts/springboot-tomcat-config/">
  <meta property="og:site_name" content="ARLOOR">
  <meta property="og:title" content="Springboot内置Tomcat的配置">
  <meta property="og:description" content="背景：需要提供一个配置服务给60w&#43;机器，没台机器每分钟请求一次拉取最新配置。springboot的默认tomcat配置是不行的，研究下tomcat有哪些配置项，以及如何在springboot中配置。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2021-09-27T17:21:58+08:00">
    <meta property="article:modified_time" content="2021-09-27T17:21:58+08:00">
    <meta property="article:tag" content="Undefined">


    





<link rel="stylesheet" href="/styles/atom-one-dark.min.css">








<link rel="stylesheet" href="/scss/hyde-hyde.debf1b963c1830f6b9b96ee48c2b4a22c31c7c3885a87bed290c0e198fc6a08d.css" integrity="sha256-3r8bljwYMPa5uW7kjCtKIsMcfDiFqHvtKQwOGY/GoI0=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">




<link rel="stylesheet" href="/scss/hugo-toc.6b7222b4ddd3cebd47d144a2e37ade6cbbb64f47e31d8feac655896156ade206.css" integrity="sha256-a3IitN3Tzr1H0USi43rebLu2T0fjHY/qxlWJYVat4gY=">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    

</head>



<body class="  ">
  
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="/">
          
          ARLOOR
          
        </a>
      </span>
      <a href="/">
        
        
        <div class="author-image">
          <img src="/img/head.jpeg" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
        
      </a>
      
      <p class="site__description">
         都是瞎写的 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">ARLOOR</label>
      <div class="menu-content menu-content--mobile">
        <div class="show-in-small">
          <a href="/">
            
            
            <div class="author-image">
              <img src="/img/head.jpeg" alt="Author Image"
                class="img--circle img--headshot element--center">
            </div>
            
            
          </a>
        </div>
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>文章</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/">
						<span>分类</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>关于我</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/grafana-iframe">
						<span>Grafana</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/net-iframe">
						<span>网速监控</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/nat">
						<span>NAT规则</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/stock">
						<span>股票监控</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://x.com/njulgh" rel="me" target="_blank"><i class="fa-brands fa-x-twitter fa-lg"></i></a>
	
	
	
	
	
	<a href="https://github.com/arloor" rel="me" target="_blank"><i class="fa-brands fa-github fa-lg"></i></a>
	
	
	
	
	
	
	
	
	
	
	
	
	
	<a href="https://t.me/never_contact_me" rel="me" target="_blank"><i class="fa-brands fa-telegram fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="mailto:admin@arloor.com" rel="me" target="_blank"><i class="fa-solid fa-at fa-lg"></i></a>
	
	
	
	
</section>
      </div>
    </div>
    <div class="menu-content menu-content--desktop">
      <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>文章</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/">
						<span>分类</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>关于我</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/grafana-iframe">
						<span>Grafana</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/net-iframe">
						<span>网速监控</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/nat">
						<span>NAT规则</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/stock">
						<span>股票监控</span>
					</a>
				</li>
			 
		
	</ul>
</div>

    </div>
    <div class="social-wrap social-wrap--desktop">
      <section class="social">
	
	<a href="https://x.com/njulgh" rel="me" target="_blank"><i class="fa-brands fa-x-twitter fa-lg"></i></a>
	
	
	
	
	
	<a href="https://github.com/arloor" rel="me" target="_blank"><i class="fa-brands fa-github fa-lg"></i></a>
	
	
	
	
	
	
	
	
	
	
	
	
	
	<a href="https://t.me/never_contact_me" rel="me" target="_blank"><i class="fa-brands fa-telegram fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="mailto:admin@arloor.com" rel="me" target="_blank"><i class="fa-solid fa-at fa-lg"></i></a>
	
	
	
	
</section>
    </div>
    
<div class="copyright">
  &copy; 2026 arloor
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>


<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/arloor/hyde-arloor">hyde-arloor</a>.
</div>


  </div>
</div>

  <div class="content container">
    
    
<article>
  <header>
    <h1>Springboot内置Tomcat的配置</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Sep 27, 2021
    
    
    
      
      
          in
          
          
              <a class="badge badge-category" href="/categories/undefined">UNDEFINED</a>
              
          
      
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/undefined">undefined</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 3 min read
</div>


  </header>
  
  
  
    <div class="toc-wrapper">
      <input type="checkbox" id="tocToggle">
      <label for="tocToggle">Table of Content</label>
      
          <nav id="TableOfContents">
  <ul>
    <li><a href="#如何在springboot中修改tomcat的配置">如何在springboot中修改tomcat的配置</a></li>
    <li><a href="#acceptcount是个啥玩意">acceptCount是个啥玩意</a></li>
    <li><a href="#http客户端代码">http客户端代码</a></li>
  </ul>
</nav>
      
    </div>
  
  
  <div class="post">
    <p>背景：需要提供一个配置服务给60w+机器，没台机器每分钟请求一次拉取最新配置。springboot的默认tomcat配置是不行的，研究下tomcat有哪些配置项，以及如何在springboot中配置。</p>
<h2 id="如何在springboot中修改tomcat的配置">如何在springboot中修改tomcat的配置</h2>
<p><a href="https://docs.spring.io/spring-boot/docs/2.2.0.RELEASE/reference/html/howto.html#howto-configure-webserver">springboot官方文档</a>告诉我们可以在<code>application.yml</code>里做一些配置，这些配置都以<code>server.tomcat.</code>开头，但这些仅仅覆盖了常见的配置，全部配置需要我们使用如下代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Component</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyTomcatWebServerCustomizer</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">implements</span> WebServerFactoryCustomizer<span style="color:#f92672">&lt;</span>TomcatServletWebServerFactory<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">customize</span>(ConfigurableWebServerFactory webServerFactory) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//使用工厂类定制tomcat connector</span>
</span></span><span style="display:flex;"><span>        TomcatServletWebServerFactory factory <span style="color:#f92672">=</span> ((TomcatServletWebServerFactory) webServerFactory);
</span></span><span style="display:flex;"><span>        factory.<span style="color:#a6e22e">addConnectorCustomizers</span>(<span style="color:#66d9ef">new</span> TomcatConnectorCustomizer() {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 详见tomcat官方文档：//https://tomcat.apache.org/tomcat-8.5-doc/config/http.html#Common_Attributes</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">customize</span>(Connector connector) {
</span></span><span style="display:flex;"><span>                Http11NioProtocol protocol <span style="color:#f92672">=</span> (Http11NioProtocol) connector.<span style="color:#a6e22e">getProtocolHandler</span>();
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 长连接配置</span>
</span></span><span style="display:flex;"><span>                protocol.<span style="color:#a6e22e">setKeepAliveTimeout</span>(90000);
</span></span><span style="display:flex;"><span>                protocol.<span style="color:#a6e22e">setMaxKeepAliveRequests</span>(600);
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// backlog</span>
</span></span><span style="display:flex;"><span>                protocol.<span style="color:#a6e22e">setAcceptCount</span>(10000);
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 最大连接数</span>
</span></span><span style="display:flex;"><span>                protocol.<span style="color:#a6e22e">setMaxConnections</span>(10000);
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 最大线程数</span>
</span></span><span style="display:flex;"><span>                protocol.<span style="color:#a6e22e">setMaxThreads</span>(1000);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>connector组件在tomcat的整体架构中是处理tcp连接的部分，我们需要优化connector配置让tomcat能承载更多的请求。上面的代码我进行了5项配置，这些配置在<a href="https://tomcat.apache.org/tomcat-9.0-doc/config/http.html#Standard_Implementation">tomcat的配置文档</a>里都有介绍。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>protocol.<span style="color:#a6e22e">setKeepAliveTimeout</span>(90000); <span style="color:#75715e">//表示90秒没有新的请求则断开连接</span>
</span></span><span style="display:flex;"><span>protocol.<span style="color:#a6e22e">setMaxKeepAliveRequests</span>(600); <span style="color:#75715e">// 表示一个socket连接处理600次请求后主动断开</span>
</span></span></code></pre></div><p>剩下的三个参数主要控制 tomcat的连接池、线程池和accept queue大小。引用<a href="https://tomcat.apache.org/tomcat-9.0-doc/config/http.html#Standard_Implementation">tomcat的配置文档</a>的一句话介绍：</p>
<blockquote>
<p>Each incoming, non-asynchronous request requires a thread for the duration of that request. If more simultaneous requests are received than can be handled by the currently available request processing threads, additional threads will be created up to the configured maximum (the value of the maxThreads attribute). If still more simultaneous requests are received, Tomcat will accept new connections until the current number of connections reaches maxConnections. Connections are queued inside the server socket created by the Connector until a thread becomes avaialble to process the connection. Once maxConnections has been reached the operating system will queue further connections. The size of the operating system provided connection queue may be controlled by the acceptCount attribute. If the operating system queue fills, further connection requests may be refused or may time out.</p>
</blockquote>
<p>大意就是：最多<code>maxThreads</code>个线程并行处理<code>maxConnections</code>个socket连接。操作系统最多接受<code>acceptCount</code>个连接。这三个参数控制了一个tomcat应用在一个时刻能处理多少请求(<code>maxThreads</code>),tomcat能监听多少个连接（<code>maxConnections</code>），和操作系统能同时queue多少个已完成三次握手的连接等待应用处理（<code>acceptCount</code>）。</p>
<h2 id="acceptcount是个啥玩意">acceptCount是个啥玩意</h2>
<p>用于控制全连接队列的长度，详见<a href="https://cloud.tencent.com/developer/article/1638042">TCP 半连接队列和全连接队列满了会发生什么？又该如何应对？</a>
<img src="/img/accept-queue.png" alt=""></p>
<h2 id="http客户端代码">http客户端代码</h2>
<p>客户端因为是以jar包的方式提供sdk，所以直接使用jdk的UrlConnection类，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> org.slf4j.Logger;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.slf4j.LoggerFactory;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.IOException;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.InputStream;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.OutputStreamWriter;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.net.HttpURLConnection;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.net.URL;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.nio.charset.Charset;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HttpUtil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Logger LOG <span style="color:#f92672">=</span> LoggerFactory.<span style="color:#a6e22e">getLogger</span>(HttpUtil.<span style="color:#a6e22e">class</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">HttpUtil</span>() {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">get</span>(String url) {
</span></span><span style="display:flex;"><span>        HttpURLConnection connection <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>        InputStream response <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> code <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>1;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            connection <span style="color:#f92672">=</span> (HttpURLConnection) (<span style="color:#66d9ef">new</span> URL(url)).<span style="color:#a6e22e">openConnection</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (connection <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>                connection.<span style="color:#a6e22e">setRequestMethod</span>(<span style="color:#e6db74">&#34;POST&#34;</span>);
</span></span><span style="display:flex;"><span>                connection.<span style="color:#a6e22e">setRequestProperty</span>(<span style="color:#e6db74">&#34;content-type&#34;</span>, <span style="color:#e6db74">&#34;application/json; charset=utf-8&#34;</span>);
</span></span><span style="display:flex;"><span>                connection.<span style="color:#a6e22e">setRequestProperty</span>(<span style="color:#e6db74">&#34;connection&#34;</span>, <span style="color:#e6db74">&#34;close&#34;</span>); <span style="color:#75715e">// 使用短连接</span>
</span></span><span style="display:flex;"><span>                writeContent(connection, JsonUtil.<span style="color:#a6e22e">serialize</span>(<span style="color:#66d9ef">new</span> Object()));
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// InputStream inputStream = connection.getInputStream(); 读inputStream;</span>
</span></span><span style="display:flex;"><span>                code <span style="color:#f92672">=</span> connection.<span style="color:#a6e22e">getResponseCode</span>();
</span></span><span style="display:flex;"><span>                LOG.<span style="color:#a6e22e">debug</span>(<span style="color:#e6db74">&#34;post {} {} {}&#34;</span>, <span style="color:#66d9ef">new</span> Object<span style="color:#f92672">[]</span>{url, connection.<span style="color:#a6e22e">getResponseCode</span>(), response});
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                LOG.<span style="color:#a6e22e">debug</span>(<span style="color:#e6db74">&#34;can&#39;t connect to {}&#34;</span> <span style="color:#f92672">+</span> url);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            LOG.<span style="color:#a6e22e">debug</span>(<span style="color:#e6db74">&#34;post {} failed {} {}&#34;</span>, <span style="color:#66d9ef">new</span> Object<span style="color:#f92672">[]</span>{url, Integer.<span style="color:#a6e22e">valueOf</span>(code), e});
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">finally</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (connection <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                    connection.<span style="color:#a6e22e">getInputStream</span>().<span style="color:#a6e22e">close</span>();
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// disconnect可能释放底层连接，长连接场景下不需要调用下面的代码</span>
</span></span><span style="display:flex;"><span>                    connection.<span style="color:#a6e22e">disconnect</span>();
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>                    LOG.<span style="color:#a6e22e">debug</span>(<span style="color:#e6db74">&#34;close connection failed... &#34;</span> <span style="color:#f92672">+</span> url, e);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">writeContent</span>(HttpURLConnection connection, String content) {
</span></span><span style="display:flex;"><span>        OutputStreamWriter out <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            connection.<span style="color:#a6e22e">setDoOutput</span>(<span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>            out <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> OutputStreamWriter(connection.<span style="color:#a6e22e">getOutputStream</span>(), Charset.<span style="color:#a6e22e">forName</span>(<span style="color:#e6db74">&#34;utf-8&#34;</span>));
</span></span><span style="display:flex;"><span>            out.<span style="color:#a6e22e">write</span>(content);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            LOG.<span style="color:#a6e22e">debug</span>(<span style="color:#e6db74">&#34;write content to {} failed {}&#34;</span>, <span style="color:#66d9ef">new</span> Object<span style="color:#f92672">[]</span>{connection.<span style="color:#a6e22e">getURL</span>(), e});
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">finally</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (out <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                    out.<span style="color:#a6e22e">close</span>();
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>                    LOG.<span style="color:#a6e22e">debug</span>(<span style="color:#e6db74">&#34;close connection failed... &#34;</span> <span style="color:#f92672">+</span> connection.<span style="color:#a6e22e">getURL</span>(), e);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>几个注意点：</p>
<ul>
<li>短连接需要增加： <code>connection.setRequestProperty(&quot;connection&quot;, &quot;close&quot;);</code></li>
<li>长连接不要有<code>connection.disconnect();</code>，只需要将connection的inputStream和outputStream关闭即可。调用该代码可能导致socket断开，达不到长连接的效果。</li>
</ul>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="/posts/arthas/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Arthas</span>
    </a>
    
    
    <a href="/posts/opentelemetry-trace/" class="navigation-next">
      <span class="navigation-tittle">Opentelemetry是怎么做链路追踪的</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  


</article>


  </div>
<style>
  .content.container {
        width: 100%;
        max-width: none;
        height: calc(100vh - var(--sidebar-height, 49px));
        border: none;
        display: block;
        overflow-y: auto;
        box-sizing: border-box;
        margin-left: 0;
        margin-right: 0;
  }

  body:not(.type-iframe) .content.container {
        padding-left: max(1.5rem, calc((100% - var(--content-max-width, 38rem)) / 2));
        padding-right: max(1.5rem, calc((100% - var(--content-max-width, 38rem)) / 2));
  }
</style>
<script>
    (function () {
        var contentSelector = '.content.container';
        var rafId = 0;
        var resizeDebounceTimer = 0;
        var pendingHashScroll = false;

        function getHashTarget() {
            var hash = window.location.hash;
            var targetId = '';

            if (!hash || hash === '#') {
                return null;
            }

            targetId = hash.slice(1);
            try {
                targetId = decodeURIComponent(targetId);
            } catch (e) {
                
            }

            return document.getElementById(targetId);
        }

        function scrollToHashTarget() {
            var target = getHashTarget();
            if (!target) {
                return;
            }
            try {
                target.scrollIntoView({ block: 'start', inline: 'nearest' });
            } catch (e) {
                target.scrollIntoView(true);
            }
        }

        function applyPendingHashScroll() {
            if (!pendingHashScroll) {
                return;
            }
            pendingHashScroll = false;
            scrollToHashTarget();
        }

        function resizeContentHeight() {
            var content = document.querySelector(contentSelector);
            if (!content) {
                return;
            }
            var rect = content.getBoundingClientRect();
            var available = window.innerHeight - rect.top;
            if (available < 0) {
                available = 0;
            }
            content.style.height = available + 'px';
            applyPendingHashScroll();
        }

        function scheduleResize() {
            if (rafId) {
                return;
            }
            rafId = window.requestAnimationFrame(function () {
                rafId = 0;
                resizeContentHeight();
            });
        }

        function scheduleResizeDebounced(delay) {
            window.clearTimeout(resizeDebounceTimer);
            resizeDebounceTimer = window.setTimeout(scheduleResize, delay || 120);
        }

        function requestHashScroll() {
            if (!window.location.hash || window.location.hash === '#') {
                return;
            }
            pendingHashScroll = true;
            scheduleResize();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function () {
                scheduleResize();
                requestHashScroll();
            }, { once: true });
        } else {
            scheduleResize();
            requestHashScroll();
        }

        window.addEventListener('load', function () {
            scheduleResize();
            requestHashScroll();
        });
        window.addEventListener('pageshow', function () {
            scheduleResize();
            requestHashScroll();
        });
        window.addEventListener('hashchange', requestHashScroll);
        window.addEventListener('resize', function () {
            scheduleResizeDebounced(120);
        });

        var menuToggle = document.getElementById('menuToggle');
        if (menuToggle) {
            menuToggle.addEventListener('change', function () {
                scheduleResize();
                window.setTimeout(scheduleResize, 250);
            });
        }
    })();
</script>
  
    



<script defer src="/js/all.js" crossorigin="anonymous"></script>

    
    
    <script src="/js/highlight.min.js"></script>
    <script src="/js/languages/dos.min.js"></script>
        
    <script type="text/javascript">
        
        hljs.highlightAll();
    </script>
    

<style>
    .code-block-wrapper {
        position: relative;
    }
    .copy-code-button {
        position: absolute;
        top: 8px;
        right: 8px;
        padding: 6px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.3s, background 0.3s;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .copy-code-button svg {
        width: 16px;
        height: 16px;
        fill: #fff;
        transition: fill 0.3s;
    }
    .code-block-wrapper:hover .copy-code-button {
        opacity: 1;
    }
    .copy-code-button:hover {
        background: rgba(255, 255, 255, 0.2);
    }
    .copy-code-button.copied {
        background: rgba(46, 160, 67, 0.8);
        border-color: rgba(46, 160, 67, 1);
    }
    .copy-code-button.copied svg {
        fill: #fff;
    }
</style>
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
        
        document.querySelectorAll('pre code').forEach(function(codeBlock) {
            var pre = codeBlock.parentNode;
            
            
            if (pre.parentNode.classList.contains('code-block-wrapper')) {
                return;
            }
            
            
            var wrapper = document.createElement('div');
            wrapper.className = 'code-block-wrapper';
            pre.parentNode.insertBefore(wrapper, pre);
            wrapper.appendChild(pre);
            
            
            var button = document.createElement('button');
            button.className = 'copy-code-button';
            button.innerHTML = '<svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path></svg>';
            button.setAttribute('aria-label', '复制代码');
            button.setAttribute('title', '复制代码');
            
            var copyIcon = '<svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path></svg>';
            var checkIcon = '<svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16"><path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path></svg>';
            
            
            button.addEventListener('click', function() {
                var code = codeBlock.textContent;
                navigator.clipboard.writeText(code).then(function() {
                    button.innerHTML = checkIcon;
                    button.classList.add('copied');
                    button.setAttribute('aria-label', '已复制');
                    button.setAttribute('title', '已复制');
                    setTimeout(function() {
                        button.innerHTML = copyIcon;
                        button.classList.remove('copied');
                        button.setAttribute('aria-label', '复制代码');
                        button.setAttribute('title', '复制代码');
                    }, 2000);
                }).catch(function(err) {
                    console.error('复制失败:', err);
                });
            });
            
            wrapper.appendChild(button);
        });
    });
</script>




    



</body>

</html>
