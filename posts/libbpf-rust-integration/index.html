<!DOCTYPE html>
<html lang="zh-CN">

    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    
    <link rel="canonical" href="https://www.arloor.com/posts/libbpf-rust-integration/">
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.157.0">

    
    
    

<title>在Rust项目中集成libbpf-rs • ARLOOR</title>
<meta name="description" content="今天，你学习了吗">
<meta name="keywords" content="刘港欢, arloor, moontell">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="在Rust项目中集成libbpf-rs">
  <meta name="twitter:description" content="前面已经有两篇博客记录了ebpf的一些知识，这篇则是实操。作为一个对C语言和Rust有一定了解的选手，我选择使用 libbpf-rs 开发ebpf应用，这就记录下我在Rust项目中集成 libbpf-rs 的过程。">
      <meta name="twitter:site" content="@njulgh">

<meta property="og:url" content="https://www.arloor.com/posts/libbpf-rust-integration/">
  <meta property="og:site_name" content="ARLOOR">
  <meta property="og:title" content="在Rust项目中集成libbpf-rs">
  <meta property="og:description" content="前面已经有两篇博客记录了ebpf的一些知识，这篇则是实操。作为一个对C语言和Rust有一定了解的选手，我选择使用 libbpf-rs 开发ebpf应用，这就记录下我在Rust项目中集成 libbpf-rs 的过程。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-20T11:47:53+08:00">
    <meta property="article:modified_time" content="2024-04-20T11:47:53+08:00">
    <meta property="article:tag" content="Ebpf">
    <meta property="article:tag" content="Rust">


    





<link rel="stylesheet" href="/styles/atom-one-dark.min.css">








<link rel="stylesheet" href="/scss/hyde-hyde.debf1b963c1830f6b9b96ee48c2b4a22c31c7c3885a87bed290c0e198fc6a08d.css" integrity="sha256-3r8bljwYMPa5uW7kjCtKIsMcfDiFqHvtKQwOGY/GoI0=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">




<link rel="stylesheet" href="/scss/hugo-toc.6b7222b4ddd3cebd47d144a2e37ade6cbbb64f47e31d8feac655896156ade206.css" integrity="sha256-a3IitN3Tzr1H0USi43rebLu2T0fjHY/qxlWJYVat4gY=">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    

</head>



<body class="  ">
  
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="/">
          
          ARLOOR
          
        </a>
      </span>
      <a href="/">
        
        
        <div class="author-image">
          <img src="/img/head.jpeg" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
        
      </a>
      
      <p class="site__description">
         都是瞎写的 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">ARLOOR</label>
      <div class="menu-content menu-content--mobile">
        <div class="show-in-small">
          <a href="/">
            
            
            <div class="author-image">
              <img src="/img/head.jpeg" alt="Author Image"
                class="img--circle img--headshot element--center">
            </div>
            
            
          </a>
        </div>
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>文章</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/">
						<span>分类</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>关于我</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/grafana-iframe">
						<span>Grafana</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/net-iframe">
						<span>网速监控</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/nat">
						<span>NAT规则</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/stock">
						<span>股票监控</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://x.com/njulgh" rel="me" target="_blank"><i class="fa-brands fa-x-twitter fa-lg"></i></a>
	
	
	
	
	
	<a href="https://github.com/arloor" rel="me" target="_blank"><i class="fa-brands fa-github fa-lg"></i></a>
	
	
	
	
	
	
	
	
	
	
	
	
	
	<a href="https://t.me/never_contact_me" rel="me" target="_blank"><i class="fa-brands fa-telegram fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="mailto:admin@arloor.com" rel="me" target="_blank"><i class="fa-solid fa-at fa-lg"></i></a>
	
	
	
	
</section>
      </div>
    </div>
    <div class="menu-content menu-content--desktop">
      <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>文章</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/">
						<span>分类</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>关于我</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/grafana-iframe">
						<span>Grafana</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/net-iframe">
						<span>网速监控</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/nat">
						<span>NAT规则</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/stock">
						<span>股票监控</span>
					</a>
				</li>
			 
		
	</ul>
</div>

    </div>
    <div class="social-wrap social-wrap--desktop">
      <section class="social">
	
	<a href="https://x.com/njulgh" rel="me" target="_blank"><i class="fa-brands fa-x-twitter fa-lg"></i></a>
	
	
	
	
	
	<a href="https://github.com/arloor" rel="me" target="_blank"><i class="fa-brands fa-github fa-lg"></i></a>
	
	
	
	
	
	
	
	
	
	
	
	
	
	<a href="https://t.me/never_contact_me" rel="me" target="_blank"><i class="fa-brands fa-telegram fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="mailto:admin@arloor.com" rel="me" target="_blank"><i class="fa-solid fa-at fa-lg"></i></a>
	
	
	
	
</section>
    </div>
    
<div class="copyright">
  &copy; 2026 arloor
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>


<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/arloor/hyde-arloor">hyde-arloor</a>.
</div>


  </div>
</div>

  <div class="content container">
    
    
<article>
  <header>
    <h1>在Rust项目中集成libbpf-rs</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Apr 20, 2024
    
    
    
      
      
          in
          
          
              <a class="badge badge-category" href="/categories/undefined">UNDEFINED</a>
              
          
      
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/ebpf">ebpf</a>
           
      
          <a class="badge badge-tag" href="/tags/rust">rust</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 5 min read
</div>


  </header>
  
  
  
    <div class="toc-wrapper">
      <input type="checkbox" id="tocToggle">
      <label for="tocToggle">Table of Content</label>
      
          <nav id="TableOfContents">
  <ul>
    <li><a href="#项目地址">项目地址</a></li>
    <li><a href="#安装依赖">安装依赖</a></li>
    <li><a href="#生成vmlinuxh">生成vmlinux.h</a></li>
    <li><a href="#rust-lib项目搭建">rust lib项目搭建</a>
      <ul>
        <li><a href="#总体文件结构">总体文件结构</a></li>
        <li><a href="#编写-xxxbpfc生成-xxxskelrs">编写 xxx.bpf.c，生成 xxx.skel.rs</a></li>
        <li><a href="#编写librs以作为其他项目的依赖">编写lib.rs,以作为其他项目的依赖</a></li>
        <li><a href="#编写example1rs">编写example1.rs</a></li>
        <li><a href="#测试">测试</a></li>
        <li><a href="#查看系统当前有哪些ebpf程序">查看系统当前有哪些ebpf程序</a></li>
      </ul>
    </li>
    <li><a href="#进阶">进阶</a>
      <ul>
        <li><a href="#docker运行">docker运行</a></li>
        <li><a href="#静态链接">静态链接</a></li>
      </ul>
    </li>
  </ul>
</nav>
      
    </div>
  
  
  <div class="post">
    <p>前面已经有两篇博客记录了ebpf的一些知识，这篇则是实操。作为一个对C语言和Rust有一定了解的选手，我选择使用 <code>libbpf-rs</code> 开发ebpf应用，这就记录下我在Rust项目中集成 <code>libbpf-rs</code> 的过程。</p>
<h2 id="项目地址">项目地址</h2>
<p><a href="https://github.com/arloor/bpf_rs_hub">bpf_rs_hub</a></p>
<h2 id="安装依赖">安装依赖</h2>
<ol>
<li>Clang编译器。至少需要Clang10，CO-RE需要Clang11或Clang12</li>
<li>libbpf库</li>
<li>bpftool可执行性文件，用来生成vmlinux.h和xx_skel.h</li>
<li>zlib (libz-dev or zlib-devel ) 和 libelf (libelf-dev or elfutils-libelf-devel )</li>
<li>pkg-config: libbpf-rs使用pkg-config来查找libbpf库</li>
</ol>
<p><strong>Ubuntu 22.04/Debain 12安装：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>apt-get install -y libbpf-dev zlib1g-dev libelf-dev pkg-config clang bpftool make
</span></span></code></pre></div><p><strong>centos stream 9 安装：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install -y libbpf zlib-devel elfutils-libelf-devel pkgconf-pkg-config clang bpftool make gettext-devel automake
</span></span></code></pre></div><h2 id="生成vmlinuxh">生成vmlinux.h</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bpftool btf dump file /sys/kernel/btf/vmlinux format c &gt; vmlinux.h
</span></span></code></pre></div><p>一些简单的ebpf程序可以不依赖vmlinux.h。</p>
<blockquote>
<p>也可以不依赖手动生成的vmlinux.h，而是直接将 libbpf-rs 下的 <a href="https://github.com/libbpf/libbpf-rs/tree/master/vmlinux">vmlinux模块</a> 作为build dependency，这样可以避免手动生成vmlinux.h的麻烦。后面的详细实操就没有生成vmlinux.h</p>
</blockquote>
<h2 id="rust-lib项目搭建">rust lib项目搭建</h2>
<h3 id="总体文件结构">总体文件结构</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>├── Cargo.lock
</span></span><span style="display:flex;"><span>├── Cargo.toml
</span></span><span style="display:flex;"><span>├── build.rs
</span></span><span style="display:flex;"><span>├── examples
</span></span><span style="display:flex;"><span>│   └── example1.rs
</span></span><span style="display:flex;"><span>└── src
</span></span><span style="display:flex;"><span>    ├── bpf
</span></span><span style="display:flex;"><span>    │   ├── program.bpf.c
</span></span><span style="display:flex;"><span>    │   └── program.skel.rs
</span></span><span style="display:flex;"><span>    └── lib.rs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4</span> directories, <span style="color:#ae81ff">7</span> files
</span></span></code></pre></div><h3 id="编写-xxxbpfc生成-xxxskelrs">编写 xxx.bpf.c，生成 xxx.skel.rs</h3>
<p>以最简单的 <code>socket filter</code> 统计网卡上行流量为例:</p>
<p><strong>program.bpf.c：</strong></p>
<blockquote>
<p>如果想在c语言文件中进行符号跳转，可以安装微软的 C/C++ 插件 <code>ms-vscode.cpptools</code>，整体体验还是不错的，bpf的helper函数也能跳转。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;vmlinux.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;bpf/bpf_core_read.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;bpf/bpf_tracing.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// copy from #include &lt;linux/if_ether.h&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define ETH_HLEN	14		</span><span style="color:#75715e">/* Total octets in header.	 */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// copy from  &lt;linux/if_packet.h&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define PACKET_OUTGOING		4		</span><span style="color:#75715e">/* Outgoing of any type */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define IP_PROTO_OFF offsetof(struct iphdr, protocol)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define IP_DEST_OFF offsetof(struct iphdr, daddr)
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">__uint</span>(type, BPF_MAP_TYPE_ARRAY);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">__uint</span>(max_entries, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">__type</span>(key, u32);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">__type</span>(value, u64);
</span></span><span style="display:flex;"><span>} map <span style="color:#a6e22e">SEC</span>(<span style="color:#e6db74">&#34;.maps&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Track size of outgoing ICMP and UDP packets
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SEC</span>(<span style="color:#e6db74">&#34;socket&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">bpf_program</span>(<span style="color:#66d9ef">struct</span> __sk_buff <span style="color:#f92672">*</span>skb) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Only outgoing packets
</span></span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (skb<span style="color:#f92672">-&gt;</span>pkt_type <span style="color:#f92672">!=</span> PACKET_OUTGOING) <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    __u32 proto <span style="color:#f92672">=</span> IPPROTO_IP;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>value <span style="color:#f92672">=</span> <span style="color:#a6e22e">bpf_map_lookup_elem</span>(<span style="color:#f92672">&amp;</span>map, <span style="color:#f92672">&amp;</span>proto);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (value) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">__sync_fetch_and_add</span>(value, skb<span style="color:#f92672">-&gt;</span>len);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">char</span> _license[] <span style="color:#a6e22e">SEC</span>(<span style="color:#e6db74">&#34;license&#34;</span>) <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;GPL&#34;</span>;
</span></span></code></pre></div><p><strong>Cargo.toml：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span>[<span style="color:#a6e22e">package</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">name</span> = <span style="color:#e6db74">&#34;bpf_socket_filter&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">version</span> = <span style="color:#e6db74">&#34;0.1.0&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">authors</span> = [<span style="color:#e6db74">&#34;arloor &lt;admin@arloor.com&gt;&#34;</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">edition</span> = <span style="color:#e6db74">&#34;2021&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">lib</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">path</span> = <span style="color:#e6db74">&#34;src/lib.rs&#34;</span> <span style="color:#75715e"># 库文件的路径</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[[<span style="color:#a6e22e">example</span>]]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">name</span> = <span style="color:#e6db74">&#34;example1&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">path</span> = <span style="color:#e6db74">&#34;examples/example1.rs&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">dependencies</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">libc</span> = <span style="color:#e6db74">&#34;0.2.98&#34;</span>           <span style="color:#75715e"># Raw FFI bindings to platform libraries like libc</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">libbpf-rs</span> = <span style="color:#e6db74">&#34;0.23.0&#34;</span>      <span style="color:#75715e"># libbpf-rs is a safe, idiomatic, and opinionated wrapper around libbpf-sys</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">plain</span> = <span style="color:#e6db74">&#34;0.2.3&#34;</span>           <span style="color:#75715e"># A small Rust library that allows users to reinterpret data of certain types safely</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pnet</span>=<span style="color:#e6db74">&#34;0.34&#34;</span>             <span style="color:#75715e"># Rust library for low level networking using the pcap library</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">log</span>=<span style="color:#e6db74">&#34;0.4&#34;</span>               <span style="color:#75715e"># A lightweight logging facade for Rust</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">build-dependencies</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">libbpf-cargo</span> = <span style="color:#e6db74">&#34;0.23.0&#34;</span>   <span style="color:#75715e"># Cargo plugin to build bpf programs</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">vmlinux</span> = { <span style="color:#a6e22e">git</span> = <span style="color:#e6db74">&#34;https://github.com/libbpf/libbpf-rs.git&#34;</span>, <span style="color:#a6e22e">branch</span> = <span style="color:#e6db74">&#34;master&#34;</span> } <span style="color:#75715e">#使用远程的vmlinux.h 配合build.rs使用</span>
</span></span></code></pre></div><p><strong>build.rs</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">use</span> std::env;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> std::path::PathBuf;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> libbpf_cargo::SkeletonBuilder;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">SRC</span>: <span style="color:#66d9ef">&amp;</span><span style="color:#66d9ef">str</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;src/bpf/program.bpf.c&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> out <span style="color:#f92672">=</span> PathBuf::from(
</span></span><span style="display:flex;"><span>        env::var_os(<span style="color:#e6db74">&#34;CARGO_MANIFEST_DIR&#34;</span>).expect(<span style="color:#e6db74">&#34;CARGO_MANIFEST_DIR must be set in build script&#34;</span>),
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    .join(<span style="color:#e6db74">&#34;src&#34;</span>)
</span></span><span style="display:flex;"><span>    .join(<span style="color:#e6db74">&#34;bpf&#34;</span>)
</span></span><span style="display:flex;"><span>    .join(<span style="color:#e6db74">&#34;program.skel.rs&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> builder <span style="color:#f92672">=</span> SkeletonBuilder::new();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> builder <span style="color:#f92672">=</span> builder.source(<span style="color:#66d9ef">SRC</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 不依赖本地的vmlinux.h，而是使用libbpf-bootstrap项目提供的vmlinux.h，详见build-dependencies
</span></span></span><span style="display:flex;"><span>    <span style="color:#75715e">// builder.clang_args([&#34;-I.&#34;]);
</span></span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">use</span> std::ffi::OsStr;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> arch <span style="color:#f92672">=</span> env::var(<span style="color:#e6db74">&#34;CARGO_CFG_TARGET_ARCH&#34;</span>)
</span></span><span style="display:flex;"><span>        .expect(<span style="color:#e6db74">&#34;CARGO_CFG_TARGET_ARCH must be set in build script&#34;</span>);
</span></span><span style="display:flex;"><span>        builder.clang_args([
</span></span><span style="display:flex;"><span>            OsStr::new(<span style="color:#e6db74">&#34;-I&#34;</span>),
</span></span><span style="display:flex;"><span>            vmlinux::include_path_root().join(arch).as_os_str(),
</span></span><span style="display:flex;"><span>        ]);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    builder.build_and_generate(<span style="color:#f92672">&amp;</span>out).unwrap();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">println!</span>(<span style="color:#e6db74">&#34;cargo:rerun-if-changed=</span><span style="color:#e6db74">{SRC}</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>运行cargo build时，libbpf-cargo插件将会根据build.rs生成的program.skel.rs文件，包含了所有的bpf map和bpf program。</p>
<h3 id="编写librs以作为其他项目的依赖">编写lib.rs,以作为其他项目的依赖</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">#![deny(warnings)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> libc::{
</span></span><span style="display:flex;"><span>    bind, close, if_nametoindex, sockaddr_ll, socket, <span style="color:#66d9ef">AF_PACKET</span>, <span style="color:#66d9ef">PF_PACKET</span>, <span style="color:#66d9ef">SOCK_CLOEXEC</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">SOCK_NONBLOCK</span>, <span style="color:#66d9ef">SOCK_RAW</span>,
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> std::os::fd::AsRawFd;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> std::os::unix::io::RawFd;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> std::{ffi::CString, os::fd::AsFd};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[path = </span><span style="color:#e6db74">&#34;bpf/program.skel.rs&#34;</span><span style="color:#75715e">]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">mod</span> prog;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> prog::<span style="color:#f92672">*</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> libbpf_rs::skel::{OpenSkel, SkelBuilder};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> libbpf_rs::MapFlags;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> pnet::datalink;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> std::mem::size_of_val;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> log::{info, warn};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">SocketFilter</span> {
</span></span><span style="display:flex;"><span>    skel: <span style="color:#a6e22e">ProgramSkel</span><span style="color:#f92672">&lt;</span>&#39;static<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span> SocketFilter {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">get_value</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">u64</span> {
</span></span><span style="display:flex;"><span>        get_value(<span style="color:#f92672">&amp;</span>self.skel)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span> Default <span style="color:#66d9ef">for</span> SocketFilter {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">default</span>() -&gt; <span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>        bump_memlock_rlimit().expect(<span style="color:#e6db74">&#34;Failed to increase rlimit&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> skel <span style="color:#f92672">=</span> open_and_load_socket_filter_prog();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> all_interfaces <span style="color:#f92672">=</span> datalink::interfaces();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 遍历接口列表
</span></span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> iface <span style="color:#66d9ef">in</span> all_interfaces {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> iface.name.starts_with(<span style="color:#e6db74">&#34;lo&#34;</span>)<span style="color:#f92672">||</span>iface.name.starts_with(<span style="color:#e6db74">&#34;podman&#34;</span>)<span style="color:#f92672">||</span>iface.name.starts_with(<span style="color:#e6db74">&#34;veth&#34;</span>)<span style="color:#f92672">||</span>iface.name.starts_with(<span style="color:#e6db74">&#34;flannel&#34;</span>)<span style="color:#f92672">||</span>iface.name.starts_with(<span style="color:#e6db74">&#34;cni0&#34;</span>)<span style="color:#f92672">||</span>iface.name.starts_with(<span style="color:#e6db74">&#34;utun&#34;</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">info!</span>(<span style="color:#e6db74">&#34;load bpf socket filter for Interface: {}&#34;</span>, iface.name);
</span></span><span style="display:flex;"><span>            set_socket_opt_bpf(<span style="color:#f92672">&amp;</span>skel, iface.name.as_str());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        SocketFilter { skel }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">open_and_load_socket_filter_prog</span>() -&gt; <span style="color:#a6e22e">ProgramSkel</span><span style="color:#f92672">&lt;</span>&#39;static<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> builder <span style="color:#f92672">=</span> ProgramSkelBuilder::default();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> open_skel <span style="color:#f92672">=</span> builder.open().expect(<span style="color:#e6db74">&#34;Failed to open BPF program&#34;</span>);
</span></span><span style="display:flex;"><span>    open_skel.load().expect(<span style="color:#e6db74">&#34;Failed to load BPF program&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">DynError</span> <span style="color:#f92672">=</span> Box<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">dyn</span> std::error::Error<span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">bump_memlock_rlimit</span>() -&gt; Result<span style="color:#f92672">&lt;</span>(),DynError<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> rlimit <span style="color:#f92672">=</span> libc::rlimit {
</span></span><span style="display:flex;"><span>        rlim_cur: <span style="color:#ae81ff">128</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">20</span>,
</span></span><span style="display:flex;"><span>        rlim_max: <span style="color:#ae81ff">128</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">20</span>,
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">unsafe</span> { libc::setrlimit(libc::<span style="color:#66d9ef">RLIMIT_MEMLOCK</span>, <span style="color:#f92672">&amp;</span>rlimit) } <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">warn!</span>(<span style="color:#e6db74">&#34;Failed to increase rlimit&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Ok(())
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">set_socket_opt_bpf</span>(skel: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">ProgramSkel</span><span style="color:#f92672">&lt;</span>&#39;static<span style="color:#f92672">&gt;</span>, name: <span style="color:#66d9ef">&amp;</span><span style="color:#66d9ef">str</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsafe</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> sock <span style="color:#f92672">=</span> open_raw_sock(name).expect(<span style="color:#e6db74">&#34;Failed to open raw socket&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> prog_fd <span style="color:#f92672">=</span> skel.progs().bpf_program().as_fd().as_raw_fd();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> value <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>prog_fd <span style="color:#66d9ef">as</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">i32</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> option_len <span style="color:#f92672">=</span> size_of_val(<span style="color:#f92672">&amp;</span>prog_fd) <span style="color:#66d9ef">as</span> libc::socklen_t;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> sockopt <span style="color:#f92672">=</span> libc::setsockopt(
</span></span><span style="display:flex;"><span>            sock,
</span></span><span style="display:flex;"><span>            libc::<span style="color:#66d9ef">SOL_SOCKET</span>,
</span></span><span style="display:flex;"><span>            libc::<span style="color:#66d9ef">SO_ATTACH_BPF</span>,
</span></span><span style="display:flex;"><span>            value <span style="color:#66d9ef">as</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">const</span> libc::c_void,
</span></span><span style="display:flex;"><span>            option_len,
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">assert_eq!</span>(sockopt, <span style="color:#ae81ff">0</span>, <span style="color:#e6db74">&#34;Failed to set socket option&#34;</span>);
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">get_value</span>(skel: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">ProgramSkel</span><span style="color:#f92672">&lt;</span>&#39;static<span style="color:#f92672">&gt;</span>) -&gt; <span style="color:#66d9ef">u64</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> maps <span style="color:#f92672">=</span> skel.maps();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> map <span style="color:#f92672">=</span> maps.map();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> key <span style="color:#f92672">=</span> <span style="color:#66d9ef">unsafe</span> { plain::as_bytes(<span style="color:#f92672">&amp;</span>(libc::<span style="color:#66d9ef">IPPROTO_IP</span> <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">u32</span>)) };
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> value: <span style="color:#66d9ef">u64</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Ok(Some(buf)) <span style="color:#f92672">=</span> map.lookup(key, MapFlags::<span style="color:#66d9ef">ANY</span>) {
</span></span><span style="display:flex;"><span>        plain::copy_from_bytes(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> value, <span style="color:#f92672">&amp;</span>buf).expect(<span style="color:#e6db74">&#34;Invalid buffer&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    value
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">open_raw_sock</span>(name: <span style="color:#66d9ef">&amp;</span><span style="color:#66d9ef">str</span>) -&gt; Result<span style="color:#f92672">&lt;</span>RawFd, String<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsafe</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> protocol <span style="color:#f92672">=</span> (libc::<span style="color:#66d9ef">ETH_P_ALL</span> <span style="color:#66d9ef">as</span> libc::c_short).to_be() <span style="color:#66d9ef">as</span> libc::c_int;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> sock <span style="color:#f92672">=</span> socket(<span style="color:#66d9ef">PF_PACKET</span>, <span style="color:#66d9ef">SOCK_RAW</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">SOCK_NONBLOCK</span> <span style="color:#f92672">|</span> <span style="color:#66d9ef">SOCK_CLOEXEC</span>, protocol);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> sock <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> Err(<span style="color:#e6db74">&#34;Failed to create raw socket&#34;</span>.to_string());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> name_cstring <span style="color:#f92672">=</span> CString::new(name).unwrap();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> sll <span style="color:#f92672">=</span> sockaddr_ll {
</span></span><span style="display:flex;"><span>            sll_family: <span style="color:#a6e22e">AF_PACKET</span> <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">u16</span>,
</span></span><span style="display:flex;"><span>            sll_protocol: <span style="color:#a6e22e">protocol</span> <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">u16</span>,
</span></span><span style="display:flex;"><span>            sll_ifindex: <span style="color:#a6e22e">if_nametoindex</span>(name_cstring.as_ptr()) <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">i32</span>,
</span></span><span style="display:flex;"><span>            sll_hatype: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>            sll_pkttype: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>            sll_halen: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>            sll_addr: [<span style="color:#ae81ff">0</span>; <span style="color:#ae81ff">8</span>],
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> bind(
</span></span><span style="display:flex;"><span>            sock,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&amp;</span>sll <span style="color:#66d9ef">as</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">const</span> _ <span style="color:#66d9ef">as</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">const</span> _,
</span></span><span style="display:flex;"><span>            std::mem::size_of::<span style="color:#f92672">&lt;</span>sockaddr_ll<span style="color:#f92672">&gt;</span>() <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">u32</span>,
</span></span><span style="display:flex;"><span>        ) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> err <span style="color:#f92672">=</span> CString::new(<span style="color:#e6db74">&#34;Failed to bind to interface: &#34;</span>.to_string() <span style="color:#f92672">+</span> name).unwrap();
</span></span><span style="display:flex;"><span>            close(sock);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> Err(err.to_str().unwrap().to_string()
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;: &#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">+</span> <span style="color:#f92672">&amp;</span>std::io::Error::last_os_error().to_string());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Ok(sock)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="编写example1rs">编写example1.rs</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">use</span> std::{thread::sleep, time::Duration};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> bpf_socket_filter <span style="color:#66d9ef">as</span> socket_filter;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> socket_filter <span style="color:#f92672">=</span> socket_filter::SocketFilter::default();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">loop</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> value <span style="color:#f92672">=</span> socket_filter.get_value();
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">println!</span>(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>,value);
</span></span><span style="display:flex;"><span>        sleep(Duration::from_secs(<span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="测试">测试</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cargo run --example example1
</span></span></code></pre></div><h3 id="查看系统当前有哪些ebpf程序">查看系统当前有哪些ebpf程序</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bpftool prog show
</span></span></code></pre></div><h2 id="进阶">进阶</h2>
<h3 id="docker运行">docker运行</h3>
<p>需要增加 <code>--privileged</code>, 参考<a href="https://andreybleme.com/2022-05-22/running-ebpf-programs-on-docker-containers/">running-ebpf-programs-on-docker-containers</a></p>
<h3 id="静态链接">静态链接</h3>
<p><strong>1. 静态链接libbpf、zlib、libelf</strong></p>
<p><code>libbpf-rs</code> 提供了 <code>vendored</code> 特性，自动在运行时编译libbpf、zlib、libelf的静态库，从而可以静态链接到生成的可执行文件中。在Cargo.toml中激活：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span>[<span style="color:#a6e22e">dependencies</span>.<span style="color:#a6e22e">libbpf-rs</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">version</span> = <span style="color:#e6db74">&#34;0.23.0&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">features</span> = [<span style="color:#e6db74">&#34;vendored&#34;</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">default-features</span> = <span style="color:#66d9ef">false</span>
</span></span></code></pre></div><p><code>vendored</code> 特性编译时需要执行<a href="https://github.com/libbpf/libbpf-sys/blob/master/build.rs">libbpf-sys的build.rs</a>，需要下面的这些包，请根据发行版自行安装</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># centos # 使用 yum whatprovides xxx查询到具体的package</span>
</span></span><span style="display:flex;"><span>yum install -y autoconf gettext-devel flex bison gawk make pkg-config automake
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ubuntu # 使用 apt-file search xxx查询到具体的package</span>
</span></span><span style="display:flex;"><span>apt-get install -y autoconf autopoint flex bison gawk make pkg-config automake
</span></span></code></pre></div><p><strong>2. 生成静态链接的 gnu 二进制文件</strong></p>
<p>参考<a href="https://doc.rust-lang.org/reference/linkage.html">Rust Linkage</a>和<a href="https://github.com/libbpf/libbpf-rs/pull/498">VENDORIZE: add feature vendored</a>，执行以下命令即可：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>RUSTFLAGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-C target-feature=+crt-static&#34;</span> cargo build --release --target x86_64-unknown-linux-gnu
</span></span></code></pre></div><p>注意：</p>
<ol>
<li>libbpf-rs静态链接仅支持gnu，<strong>不支持musl</strong></li>
<li><code>--target x86_64-unknown-linux-gnu</code> 不能省略</li>
<li>可执行文件在 <code>/target/x86_64-unknown-linux-gnu/release/</code></li>
</ol>
<p>如果报错：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/usr/bin/ld: cannot find -lm
</span></span><span style="display:flex;"><span>/usr/bin/ld: cannot find -lc
</span></span></code></pre></div><p>说明系统上缺少了一些静态库，安装即可。</p>
<p>以我的redhat9开发机为例，缺失的是 <code>glibc-static</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># search from https://pkgs.org/search/?q=libc.a</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># centos 9</span>
</span></span><span style="display:flex;"><span>dnf --enablerepo<span style="color:#f92672">=</span>crb install glibc-static
</span></span><span style="display:flex;"><span><span style="color:#75715e"># redhat9</span>
</span></span><span style="display:flex;"><span>subscription-manager repos --enable codeready-builder-for-rhel-9-x86_64-rpms <span style="color:#75715e"># https://access.redhat.com/articles/4348511</span>
</span></span><span style="display:flex;"><span>yum install -y glibc-static <span style="color:#75715e"># yum whatprovides &#34;*/libc.a&#34;</span>
</span></span></code></pre></div><p>以ubuntu为例，缺失的是 <code>libc6-dev</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>apt install -y libc6-dev
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ apt update <span style="color:#f92672">&amp;&amp;</span> apt-get install -y apt-file <span style="color:#f92672">&amp;&amp;</span> apt-file update <span style="color:#f92672">&amp;&amp;</span> apt-file search libc.a | grep <span style="color:#e6db74">&#34;libc6-dev:&#34;</span>
</span></span><span style="display:flex;"><span>libc6-dev: /usr/lib/x86_64-linux-gnu/libc.a
</span></span><span style="display:flex;"><span>$ apt-file search libm.a | grep <span style="color:#e6db74">&#34;libc6-dev:&#34;</span>
</span></span><span style="display:flex;"><span>libc6-dev: /usr/lib/x86_64-linux-gnu/libm.a
</span></span></code></pre></div>
  </div>
  

<div class="navigation navigation-single">
    
    <a href="/posts/libbpf-bootstrap-learn/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">libbpf-bootstrap学习</span>
    </a>
    
    
    <a href="/posts/notion/java%E8%99%9A%E6%8B%9F%E7%BA%BF%E7%A8%8B/" class="navigation-next">
      <span class="navigation-tittle">Java虚拟线程</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  


</article>


  </div>
<style>
  .content.container {
        width: 100%;
        max-width: none;
        height: calc(100vh - var(--sidebar-height, 49px));
        border: none;
        display: block;
        overflow-y: auto;
        box-sizing: border-box;
        margin-left: 0;
        margin-right: 0;
  }

  body:not(.type-iframe) .content.container {
        padding-left: max(1.5rem, calc((100% - var(--content-max-width, 38rem)) / 2));
        padding-right: max(1.5rem, calc((100% - var(--content-max-width, 38rem)) / 2));
  }
</style>
<script>
    (function () {
        var contentSelector = '.content.container';
        var rafId = 0;
        var resizeDebounceTimer = 0;
        var pendingHashScroll = false;

        function getHashTarget() {
            var hash = window.location.hash;
            var targetId = '';

            if (!hash || hash === '#') {
                return null;
            }

            targetId = hash.slice(1);
            try {
                targetId = decodeURIComponent(targetId);
            } catch (e) {
                
            }

            return document.getElementById(targetId);
        }

        function scrollToHashTarget() {
            var target = getHashTarget();
            if (!target) {
                return;
            }
            try {
                target.scrollIntoView({ block: 'start', inline: 'nearest' });
            } catch (e) {
                target.scrollIntoView(true);
            }
        }

        function applyPendingHashScroll() {
            if (!pendingHashScroll) {
                return;
            }
            pendingHashScroll = false;
            scrollToHashTarget();
        }

        function resizeContentHeight() {
            var content = document.querySelector(contentSelector);
            if (!content) {
                return;
            }
            var rect = content.getBoundingClientRect();
            var available = window.innerHeight - rect.top;
            if (available < 0) {
                available = 0;
            }
            content.style.height = available + 'px';
            applyPendingHashScroll();
        }

        function scheduleResize() {
            if (rafId) {
                return;
            }
            rafId = window.requestAnimationFrame(function () {
                rafId = 0;
                resizeContentHeight();
            });
        }

        function scheduleResizeDebounced(delay) {
            window.clearTimeout(resizeDebounceTimer);
            resizeDebounceTimer = window.setTimeout(scheduleResize, delay || 120);
        }

        function requestHashScroll() {
            if (!window.location.hash || window.location.hash === '#') {
                return;
            }
            pendingHashScroll = true;
            scheduleResize();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function () {
                scheduleResize();
                requestHashScroll();
            }, { once: true });
        } else {
            scheduleResize();
            requestHashScroll();
        }

        window.addEventListener('load', function () {
            scheduleResize();
            requestHashScroll();
        });
        window.addEventListener('pageshow', function () {
            scheduleResize();
            requestHashScroll();
        });
        window.addEventListener('hashchange', requestHashScroll);
        window.addEventListener('resize', function () {
            scheduleResizeDebounced(120);
        });

        var menuToggle = document.getElementById('menuToggle');
        if (menuToggle) {
            menuToggle.addEventListener('change', function () {
                scheduleResize();
                window.setTimeout(scheduleResize, 250);
            });
        }
    })();
</script>
  
    



<script defer src="/js/all.js" crossorigin="anonymous"></script>

    
    
    <script src="/js/highlight.min.js"></script>
    <script src="/js/languages/dos.min.js"></script>
        
    <script type="text/javascript">
        
        hljs.highlightAll();
    </script>
    

<style>
    .code-block-wrapper {
        position: relative;
    }
    .copy-code-button {
        position: absolute;
        top: 8px;
        right: 8px;
        padding: 6px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.3s, background 0.3s;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .copy-code-button svg {
        width: 16px;
        height: 16px;
        fill: #fff;
        transition: fill 0.3s;
    }
    .code-block-wrapper:hover .copy-code-button {
        opacity: 1;
    }
    .copy-code-button:hover {
        background: rgba(255, 255, 255, 0.2);
    }
    .copy-code-button.copied {
        background: rgba(46, 160, 67, 0.8);
        border-color: rgba(46, 160, 67, 1);
    }
    .copy-code-button.copied svg {
        fill: #fff;
    }
</style>
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
        
        document.querySelectorAll('pre code').forEach(function(codeBlock) {
            var pre = codeBlock.parentNode;
            
            
            if (pre.parentNode.classList.contains('code-block-wrapper')) {
                return;
            }
            
            
            var wrapper = document.createElement('div');
            wrapper.className = 'code-block-wrapper';
            pre.parentNode.insertBefore(wrapper, pre);
            wrapper.appendChild(pre);
            
            
            var button = document.createElement('button');
            button.className = 'copy-code-button';
            button.innerHTML = '<svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path></svg>';
            button.setAttribute('aria-label', '复制代码');
            button.setAttribute('title', '复制代码');
            
            var copyIcon = '<svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path></svg>';
            var checkIcon = '<svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16"><path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path></svg>';
            
            
            button.addEventListener('click', function() {
                var code = codeBlock.textContent;
                navigator.clipboard.writeText(code).then(function() {
                    button.innerHTML = checkIcon;
                    button.classList.add('copied');
                    button.setAttribute('aria-label', '已复制');
                    button.setAttribute('title', '已复制');
                    setTimeout(function() {
                        button.innerHTML = copyIcon;
                        button.classList.remove('copied');
                        button.setAttribute('aria-label', '复制代码');
                        button.setAttribute('title', '复制代码');
                    }, 2000);
                }).catch(function(err) {
                    console.error('复制失败:', err);
                });
            });
            
            wrapper.appendChild(button);
        });
    });
</script>




    



</body>

</html>
