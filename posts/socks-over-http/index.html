<!DOCTYPE html>
<html lang="zh-CN">

    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    
    <link rel="canonical" href="https://www.arloor.com/posts/socks-over-http/">
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.157.0">

    
    
    

<title>Sogoâ€”ä½¿ç”¨httpåè®®è¿›è¡Œæ··æ·†/ä¼ªè£…çš„socks5ä»£ç† â€¢ ARLOOR</title>
<meta name="description" content="ä»Šå¤©ï¼Œä½ å­¦ä¹ äº†å—">
<meta name="keywords" content="åˆ˜æ¸¯æ¬¢, arloor, moontell">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Sogoâ€”ä½¿ç”¨httpåè®®è¿›è¡Œæ··æ·†/ä¼ªè£…çš„socks5ä»£ç†">
  <meta name="twitter:description" content="ä¹‹å‰å†™äº†ä¸€ä¸ªhttpä»£ç†ï¼Œç”¨èµ·æ¥ä¹Ÿæ˜¯ååˆ†åœ°èˆ’æœï¼Œä½†æ˜¯æœ‰å‡ ä¸ªç‚¹è¿˜æ˜¯æœ‰äº›é—æ†¾çš„ï¼š
httpä»£ç†åªèƒ½ä»£ç†httpåè®®ï¼Œç›¸æ¯”socks5ä»£ç†ä¸å¤Ÿé€šç”¨ã€‚ã€‚ nettyæ˜¯ä¸ªå¥½æ¡†æ¶ï¼Œä½†æ˜¯javaå ç”¨å†…å­˜æ˜¯çœŸçš„å¤šã€‚ã€‚ æ‰€ä»¥ï¼Œæˆ‘åˆå†™äº†ä¸€ä¸ªsocks5ä»£ç†ï¼Œèµ·åå«sogoã€‚
sogoæœ¬èº«åŒ…å«sogo(client)å’Œsogo-serverã€‚å¦‚æœæŠŠsogoå’Œsogo-serverçœ‹æˆä¸€ä¸ªæ•´ä½“ï¼Œä¸€ä¸ªé»‘ç›’ï¼Œè¿™ä¸ªæ•´ä½“å°±æ˜¯ä¸€ä¸ªsocks5ä»£ç†ã€‚sogo(client)ä¸æœ¬åœ°ç”µè„‘äº¤äº’ï¼›sogo-serverä¸ç›®æ ‡ç½‘ç«™äº¤äº’ï¼›sogo(client)å’Œsogo-serverä¹‹é—´çš„äº¤äº’å°±æ˜¯httpåè®®åŒ…è£¹payloadè¿›è¡Œé€šä¿¡ã€‚">
      <meta name="twitter:site" content="@njulgh">

<meta property="og:url" content="https://www.arloor.com/posts/socks-over-http/">
  <meta property="og:site_name" content="ARLOOR">
  <meta property="og:title" content="Sogoâ€”ä½¿ç”¨httpåè®®è¿›è¡Œæ··æ·†/ä¼ªè£…çš„socks5ä»£ç†">
  <meta property="og:description" content="ä¹‹å‰å†™äº†ä¸€ä¸ªhttpä»£ç†ï¼Œç”¨èµ·æ¥ä¹Ÿæ˜¯ååˆ†åœ°èˆ’æœï¼Œä½†æ˜¯æœ‰å‡ ä¸ªç‚¹è¿˜æ˜¯æœ‰äº›é—æ†¾çš„ï¼š
httpä»£ç†åªèƒ½ä»£ç†httpåè®®ï¼Œç›¸æ¯”socks5ä»£ç†ä¸å¤Ÿé€šç”¨ã€‚ã€‚ nettyæ˜¯ä¸ªå¥½æ¡†æ¶ï¼Œä½†æ˜¯javaå ç”¨å†…å­˜æ˜¯çœŸçš„å¤šã€‚ã€‚ æ‰€ä»¥ï¼Œæˆ‘åˆå†™äº†ä¸€ä¸ªsocks5ä»£ç†ï¼Œèµ·åå«sogoã€‚
sogoæœ¬èº«åŒ…å«sogo(client)å’Œsogo-serverã€‚å¦‚æœæŠŠsogoå’Œsogo-serverçœ‹æˆä¸€ä¸ªæ•´ä½“ï¼Œä¸€ä¸ªé»‘ç›’ï¼Œè¿™ä¸ªæ•´ä½“å°±æ˜¯ä¸€ä¸ªsocks5ä»£ç†ã€‚sogo(client)ä¸æœ¬åœ°ç”µè„‘äº¤äº’ï¼›sogo-serverä¸ç›®æ ‡ç½‘ç«™äº¤äº’ï¼›sogo(client)å’Œsogo-serverä¹‹é—´çš„äº¤äº’å°±æ˜¯httpåè®®åŒ…è£¹payloadè¿›è¡Œé€šä¿¡ã€‚">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2019-04-10T14:24:10+08:00">
    <meta property="article:modified_time" content="2019-04-10T14:24:10+08:00">
    <meta property="article:tag" content="Undefined">


    





<link rel="stylesheet" href="/styles/atom-one-dark.min.css">








<link rel="stylesheet" href="/scss/hyde-hyde.debf1b963c1830f6b9b96ee48c2b4a22c31c7c3885a87bed290c0e198fc6a08d.css" integrity="sha256-3r8bljwYMPa5uW7kjCtKIsMcfDiFqHvtKQwOGY/GoI0=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">




<link rel="stylesheet" href="/scss/hugo-toc.6b7222b4ddd3cebd47d144a2e37ade6cbbb64f47e31d8feac655896156ade206.css" integrity="sha256-a3IitN3Tzr1H0USi43rebLu2T0fjHY/qxlWJYVat4gY=">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    

</head>



<body class="  ">
  
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="/">
          
          ARLOOR
          
        </a>
      </span>
      <a href="/">
        
        
        <div class="author-image">
          <img src="/img/head.jpeg" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
        
      </a>
      
      <p class="site__description">
         éƒ½æ˜¯çå†™çš„ 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">ARLOOR</label>
      <div class="menu-content menu-content--mobile">
        <div class="show-in-small">
          <a href="/">
            
            
            <div class="author-image">
              <img src="/img/head.jpeg" alt="Author Image"
                class="img--circle img--headshot element--center">
            </div>
            
            
          </a>
        </div>
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>æ–‡ç« </span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/">
						<span>åˆ†ç±»</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>å…³äºæˆ‘</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/grafana-iframe">
						<span>Grafana</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/net-iframe">
						<span>ç½‘é€Ÿç›‘æ§</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/nat">
						<span>NATè§„åˆ™</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/stock">
						<span>è‚¡ç¥¨ç›‘æ§</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://x.com/njulgh" rel="me" target="_blank"><i class="fa-brands fa-x-twitter fa-lg"></i></a>
	
	
	
	
	
	<a href="https://github.com/arloor" rel="me" target="_blank"><i class="fa-brands fa-github fa-lg"></i></a>
	
	
	
	
	
	
	
	
	
	
	
	
	
	<a href="https://t.me/never_contact_me" rel="me" target="_blank"><i class="fa-brands fa-telegram fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="mailto:admin@arloor.com" rel="me" target="_blank"><i class="fa-solid fa-at fa-lg"></i></a>
	
	
	
	
</section>
      </div>
    </div>
    <div class="menu-content menu-content--desktop">
      <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>æ–‡ç« </span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/">
						<span>åˆ†ç±»</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>å…³äºæˆ‘</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/grafana-iframe">
						<span>Grafana</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/net-iframe">
						<span>ç½‘é€Ÿç›‘æ§</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/nat">
						<span>NATè§„åˆ™</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/stock">
						<span>è‚¡ç¥¨ç›‘æ§</span>
					</a>
				</li>
			 
		
	</ul>
</div>

    </div>
    <div class="social-wrap social-wrap--desktop">
      <section class="social">
	
	<a href="https://x.com/njulgh" rel="me" target="_blank"><i class="fa-brands fa-x-twitter fa-lg"></i></a>
	
	
	
	
	
	<a href="https://github.com/arloor" rel="me" target="_blank"><i class="fa-brands fa-github fa-lg"></i></a>
	
	
	
	
	
	
	
	
	
	
	
	
	
	<a href="https://t.me/never_contact_me" rel="me" target="_blank"><i class="fa-brands fa-telegram fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="mailto:admin@arloor.com" rel="me" target="_blank"><i class="fa-solid fa-at fa-lg"></i></a>
	
	
	
	
</section>
    </div>
    
<div class="copyright">
  &copy; 2026 arloor
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>


<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> â¤ï¸ <a href="https://github.com/arloor/hyde-arloor">hyde-arloor</a>.
</div>


  </div>
</div>

  <div class="content container">
    
    
<article>
  <header>
    <h1>Sogoâ€”ä½¿ç”¨httpåè®®è¿›è¡Œæ··æ·†/ä¼ªè£…çš„socks5ä»£ç†</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Apr 10, 2019
    
    
    
      
      
          in
          
          
              <a class="badge badge-category" href="/categories/undefined">UNDEFINED</a>
              
          
      
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/undefined">undefined</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 14 min read
</div>


  </header>
  
  
  
    <div class="toc-wrapper">
      <input type="checkbox" id="tocToggle">
      <label for="tocToggle">Table of Content</label>
      
          <nav id="TableOfContents">
  <ul>
    <li><a href="#ç‰¹æ€§">ç‰¹æ€§</a></li>
    <li><a href="#å¤„ç†socks5æ¡æ‰‹å¯¹socks5åè®®çš„å®ç°">å¤„ç†socks5æ¡æ‰‹â€”â€”å¯¹socks5åè®®çš„å®ç°</a></li>
    <li><a href="#ä½¿ç”¨httpåŒ…è£¹payload">ä½¿ç”¨httpåŒ…è£¹payload</a></li>
    <li><a href="#è§£åŒ…ä¼ªè£…å¥½çš„è¯·æ±‚å“åº”">è§£åŒ…ä¼ªè£…å¥½çš„è¯·æ±‚ã€å“åº”</a></li>
    <li><a href="#ä¼ªè£…sogo-server80ä¸ºå…¶ä»–httpç½‘ç«™">ä¼ªè£…sogo-server:80ä¸ºå…¶ä»–httpç½‘ç«™</a></li>
    <li><a href="#linuxä¸ŠæœåŠ¡ç«¯éƒ¨ç½²">linuxä¸ŠæœåŠ¡ç«¯éƒ¨ç½²</a></li>
    <li><a href="#linuxä¸Šå®¢æˆ·ç«¯å®‰è£…javaç‰ˆ">linuxä¸Šå®¢æˆ·ç«¯å®‰è£…ï¼ˆjavaç‰ˆï¼‰</a></li>
    <li><a href="#linuxä¸Šå®¢æˆ·ç«¯å®‰è£…è¿‡æ—¶">linuxä¸Šå®¢æˆ·ç«¯å®‰è£…ï¼ˆè¿‡æ—¶ï¼‰</a></li>
    <li><a href="#windowså®¢æˆ·ç«¯å®‰è£…">windowså®¢æˆ·ç«¯å®‰è£…</a></li>
    <li><a href="#å†™sogoæœ‰æ„Ÿ">å†™Sogoæœ‰æ„Ÿ</a></li>
    <li><a href="#ç»´æŠ¤æ—¥å¿—">ç»´æŠ¤æ—¥å¿—</a>
      <ul>
        <li><a href="#1å› byteæœªå¤ç”¨å¯¼è‡´é¢‘ç¹gcä»è€Œcpuå ç”¨å¤¸å¼ ">1.å› []byteæœªå¤ç”¨ï¼Œå¯¼è‡´é¢‘ç¹GCï¼Œä»è€Œcpuå ç”¨å¤¸å¼ </a></li>
        <li><a href="#2å› ä¸ºé¢‘ç¹å†™å…¥æ—¥å¿—æ–‡ä»¶å¯¼è‡´cpu-iowaitè¿‡é«˜">2.å› ä¸ºé¢‘ç¹å†™å…¥æ—¥å¿—æ–‡ä»¶ï¼Œå¯¼è‡´cpu iowaitè¿‡é«˜</a></li>
        <li><a href="#3æŠ¥é”™too-many-open-files">3.æŠ¥é”™ï¼štoo many open files</a></li>
      </ul>
    </li>
  </ul>
</nav>
      
    </div>
  
  
  <div class="post">
    <p>ä¹‹å‰å†™äº†ä¸€ä¸ªhttpä»£ç†ï¼Œç”¨èµ·æ¥ä¹Ÿæ˜¯ååˆ†åœ°èˆ’æœï¼Œä½†æ˜¯æœ‰å‡ ä¸ªç‚¹è¿˜æ˜¯æœ‰äº›é—æ†¾çš„ï¼š</p>
<ul>
<li>httpä»£ç†åªèƒ½ä»£ç†httpåè®®ï¼Œç›¸æ¯”socks5ä»£ç†ä¸å¤Ÿé€šç”¨ã€‚ã€‚</li>
<li>nettyæ˜¯ä¸ªå¥½æ¡†æ¶ï¼Œä½†æ˜¯javaå ç”¨å†…å­˜æ˜¯çœŸçš„å¤šã€‚ã€‚</li>
</ul>
<p>æ‰€ä»¥ï¼Œæˆ‘åˆå†™äº†ä¸€ä¸ªsocks5ä»£ç†ï¼Œèµ·åå«<a href="https://github.com/arloor/sogo">sogo</a>ã€‚</p>
<p>sogoæœ¬èº«åŒ…å«sogo(client)å’Œsogo-serverã€‚å¦‚æœæŠŠsogoå’Œsogo-serverçœ‹æˆä¸€ä¸ªæ•´ä½“ï¼Œä¸€ä¸ªé»‘ç›’ï¼Œè¿™ä¸ªæ•´ä½“å°±æ˜¯ä¸€ä¸ªsocks5ä»£ç†ã€‚sogo(client)ä¸æœ¬åœ°ç”µè„‘äº¤äº’ï¼›sogo-serverä¸ç›®æ ‡ç½‘ç«™äº¤äº’ï¼›sogo(client)å’Œsogo-serverä¹‹é—´çš„äº¤äº’å°±æ˜¯httpåè®®åŒ…è£¹payloadè¿›è¡Œé€šä¿¡ã€‚</p>
<h2 id="ç‰¹æ€§">ç‰¹æ€§</h2>
<p>sogoé¡¹ç›®æœ€å¥½çš„ä¸¤ä¸ªç‰¹æ€§å¦‚ä¸‹ï¼š</p>
<ol>
<li>ä½¿ç”¨httpåŒ…è£¹payload(æœ‰æ„ä¹‰çš„æ•°æ®)ã€‚</li>
<li>å°†sogo-serveræ‰€åœ¨çš„ip:ç«¯å£ä¼ªè£…æˆä¸€ä¸ªhttpç½‘ç«™ã€‚</li>
</ol>
<p>æ•ˆç”¨ã€åšå›ºã€ç¾è§‚â€”â€”å¯¹è½¯ä»¶äº§å“çš„ä¸‰ä¸ªè¦æ±‚ã€‚ä¸Šé¢ä¸¤ä¸ªç‰¹æ€§ï¼Œæ—¢å¯ä»¥è¯´æ˜¯åšå›ºï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯ç¾è§‚ï¼Œè‡³äºæ•ˆç”¨å°±ä¸ç”¨è¯´äº†ï¼Œåœ¨è¿™é‡Œè°ˆåšå›ºå’Œç¾è§‚çš„å‰æå°±æ˜¯æ•ˆç”¨è¢«å®Œæ•´åœ°å®ç°ã€‚ç”¨é€šä¿—åœ°è¯æ¥è¯´ï¼Œè¿™ä¸ªä»£ç†çš„åšå›ºå’Œç¾è§‚å°±æ˜¯ï¼šä¼ªè£…ã€é˜²æ­¢è¢«è¯†åˆ«ã€‚</p>
<h2 id="å¤„ç†socks5æ¡æ‰‹å¯¹socks5åè®®çš„å®ç°">å¤„ç†socks5æ¡æ‰‹â€”â€”å¯¹socks5åè®®çš„å®ç°</h2>
<p>sogo(client)ä¸æœ¬åœ°ç”µè„‘äº¤äº’ï¼Œå› æ­¤éœ€è¦å®ç°socks5åè®®ï¼Œä¸æœ¬åœ°ç”¨æˆ·ï¼ˆæ¯”å¦‚chromeï¼‰æ¡æ‰‹åå•†ã€‚</p>
<p>ä¸€ä¸ªå…¸å‹çš„sock5æ¡æ‰‹çš„é¡ºåºï¼š</p>
<ol>
<li>clientï¼š0x05 0x01 0x00</li>
<li>proxy: 0x05 0x00</li>
<li>client: 0x05 0x01 0x00 0x01 ip1 ip2 ip3 ip4 0x00 0x50</li>
<li>proxy: 0x05 0x00 0x00 0x01 0x00 0x00 0x00 0x00 0x10 0x10</li>
<li>proxyç›²è½¬å‘clientä¸serverä¹‹é—´çš„æµé‡</li>
</ol>
<p>è¿™ä¸€éƒ¨åˆ†ä»£ç è§å¦‚ä¸‹ä¸¤ä¸ªå‡½æ•°ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">//file: sogo/main.go</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//è¯» 5 1 0 å†™å› 5 0</span>
</span></span><span style="display:flex;"><span>func <span style="color:#a6e22e">handshake</span>(clientCon net.<span style="color:#a6e22e">Conn</span>) error {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> buf <span style="color:#f92672">=</span> make(<span style="color:#f92672">[]</span><span style="color:#66d9ef">byte</span>, 300)
</span></span><span style="display:flex;"><span>	numRead, err :<span style="color:#f92672">=</span> clientCon.<span style="color:#a6e22e">Read</span>(buf)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> nil {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> err
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> numRead <span style="color:#f92672">==</span> 3 <span style="color:#f92672">&amp;&amp;</span> buf<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> 0X05 <span style="color:#f92672">&amp;&amp;</span> buf<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> 0X01 <span style="color:#f92672">&amp;&amp;</span> buf<span style="color:#f92672">[</span>2<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> 0X00 {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> mio.<span style="color:#a6e22e">WriteAll</span>(clientCon, <span style="color:#f92672">[]</span><span style="color:#66d9ef">byte</span>{0x05, 0x00})
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		log.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%d&#34;</span>, buf<span style="color:#f92672">[</span>:numRead<span style="color:#f92672">]</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> mio.<span style="color:#a6e22e">WriteAll</span>(clientCon, <span style="color:#f92672">[]</span><span style="color:#66d9ef">byte</span>{0x05, 0x00})
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>func <span style="color:#a6e22e">getTargetAddr</span>(clientCon net.<span style="color:#a6e22e">Conn</span>) (string, error) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> buf <span style="color:#f92672">=</span> make(<span style="color:#f92672">[]</span><span style="color:#66d9ef">byte</span>, 1024)
</span></span><span style="display:flex;"><span>	numRead, err :<span style="color:#f92672">=</span> clientCon.<span style="color:#a6e22e">Read</span>(buf)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> nil {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, err
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> numRead <span style="color:#f92672">&gt;</span> 3 <span style="color:#f92672">&amp;&amp;</span> buf<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> 0X05 <span style="color:#f92672">&amp;&amp;</span> buf<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> 0X01 <span style="color:#f92672">&amp;&amp;</span> buf<span style="color:#f92672">[</span>2<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> 0X00 {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> buf<span style="color:#f92672">[</span>3<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> 3 {
</span></span><span style="display:flex;"><span>			log.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;ç›®çš„åœ°å€ç±»å‹:%d åŸŸåé•¿åº¦:%d ç›®æ ‡åŸŸå:%s ç›®æ ‡ç«¯å£:%s&#34;</span>, buf<span style="color:#f92672">[</span>3<span style="color:#f92672">]</span>, buf<span style="color:#f92672">[</span>4<span style="color:#f92672">]</span>, buf<span style="color:#f92672">[</span>5:5<span style="color:#f92672">+</span>buf<span style="color:#f92672">[</span>4<span style="color:#f92672">]]</span>, strconv.<span style="color:#a6e22e">Itoa</span>(<span style="color:#66d9ef">int</span>(binary.<span style="color:#a6e22e">BigEndian</span>.<span style="color:#a6e22e">Uint16</span>(buf<span style="color:#f92672">[</span>5<span style="color:#f92672">+</span>buf<span style="color:#f92672">[</span>4<span style="color:#f92672">]</span>:7<span style="color:#f92672">+</span>buf<span style="color:#f92672">[</span>4<span style="color:#f92672">]]</span>))))
</span></span><span style="display:flex;"><span>			writeErr :<span style="color:#f92672">=</span> mio.<span style="color:#a6e22e">WriteAll</span>(clientCon, <span style="color:#f92672">[]</span><span style="color:#66d9ef">byte</span>{0x05, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x10, 0x10})
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> string(buf<span style="color:#f92672">[</span>5:5<span style="color:#f92672">+</span>buf<span style="color:#f92672">[</span>4<span style="color:#f92672">]]</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;:&#34;</span> <span style="color:#f92672">+</span> strconv.<span style="color:#a6e22e">Itoa</span>(<span style="color:#66d9ef">int</span>(binary.<span style="color:#a6e22e">BigEndian</span>.<span style="color:#a6e22e">Uint16</span>(buf<span style="color:#f92672">[</span>5<span style="color:#f92672">+</span>buf<span style="color:#f92672">[</span>4<span style="color:#f92672">]</span>:7<span style="color:#f92672">+</span>buf<span style="color:#f92672">[</span>4<span style="color:#f92672">]]</span>))), writeErr
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> buf<span style="color:#f92672">[</span>3<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> 1 {
</span></span><span style="display:flex;"><span>			log.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;ç›®çš„åœ°å€ç±»å‹:%d  ç›®æ ‡åŸŸå:%s ç›®æ ‡ç«¯å£:%s&#34;</span>, buf<span style="color:#f92672">[</span>3<span style="color:#f92672">]</span>, net.<span style="color:#a6e22e">IPv4</span>(buf<span style="color:#f92672">[</span>4<span style="color:#f92672">]</span>, buf<span style="color:#f92672">[</span>5<span style="color:#f92672">]</span>, buf<span style="color:#f92672">[</span>6<span style="color:#f92672">]</span>, buf<span style="color:#f92672">[</span>7<span style="color:#f92672">]</span>).<span style="color:#a6e22e">String</span>(), strconv.<span style="color:#a6e22e">Itoa</span>(<span style="color:#66d9ef">int</span>(binary.<span style="color:#a6e22e">BigEndian</span>.<span style="color:#a6e22e">Uint16</span>(buf<span style="color:#f92672">[</span>8:10<span style="color:#f92672">]</span>))))
</span></span><span style="display:flex;"><span>			writeErr :<span style="color:#f92672">=</span> mio.<span style="color:#a6e22e">WriteAll</span>(clientCon, <span style="color:#f92672">[]</span><span style="color:#66d9ef">byte</span>{0x05, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x10, 0x10})
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> net.<span style="color:#a6e22e">IPv4</span>(buf<span style="color:#f92672">[</span>4<span style="color:#f92672">]</span>, buf<span style="color:#f92672">[</span>5<span style="color:#f92672">]</span>, buf<span style="color:#f92672">[</span>6<span style="color:#f92672">]</span>, buf<span style="color:#f92672">[</span>7<span style="color:#f92672">]</span>).<span style="color:#a6e22e">String</span>() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;:&#34;</span> <span style="color:#f92672">+</span> strconv.<span style="color:#a6e22e">Itoa</span>(<span style="color:#66d9ef">int</span>(binary.<span style="color:#a6e22e">BigEndian</span>.<span style="color:#a6e22e">Uint16</span>(buf<span style="color:#f92672">[</span>8:10<span style="color:#f92672">]</span>))), writeErr
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, errors.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;ä¸èƒ½å¤„ç†ipv6&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, errors.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;ä¸èƒ½å¤„ç†éCONNECTè¯·æ±‚&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å®Œæˆhandshake, getTargetAddr ä¹‹åï¼Œchromeå°±ä¼šå‘é€çœŸå®çš„httpè¯·æ±‚äº†ï¼Œsogo(client) è¦åšçš„å°±æ˜¯å°†è¿™éƒ¨åˆ†httpè¯·æ±‚è¿›è¡ŒåŠ å¯†ï¼Œç„¶ååŠ ä¸Šhttpè¯·æ±‚çš„å¤´ï¼Œå‘é€åˆ°sogo-serverã€‚</p>
<h2 id="ä½¿ç”¨httpåŒ…è£¹payload">ä½¿ç”¨httpåŒ…è£¹payload</h2>
<p>ç¬¬ä¸€éƒ¨åˆ†ï¼šå¦‚ä½•å°†çœŸå®çš„httpè¯·æ±‚ï¼Œå†è¿›è¡ŒåŠ å¯†ï¼Œæœ€ååŠ ä¸Šå‡çš„httpè¯·æ±‚å¤´ï¼Œå˜æˆä¼ªè£…å¥½çš„httpè¯·æ±‚ï¼Œå‘é€ç»™sogo-serverã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">//file: sogo/mio/prefix.go</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> fakeHost <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;qtgwuehaoisdhuaishdaisuhdasiuhlassjd.com&#34;</span>  <span style="color:#75715e">//è™šå‡host</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>func <span style="color:#a6e22e">AppendHttpRequestPrefix</span>(buf <span style="color:#f92672">[]</span><span style="color:#66d9ef">byte</span>, addr string) <span style="color:#f92672">[]</span><span style="color:#66d9ef">byte</span> {
</span></span><span style="display:flex;"><span>	Simple(<span style="color:#f92672">&amp;</span>buf, len(buf))<span style="color:#75715e">//å¯¹çœŸå®çš„httpè¯·æ±‚çš„ç®€å•åŠ å¯†</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// æ¼”ç¤ºbase64ç¼–ç </span>
</span></span><span style="display:flex;"><span>	addrBase64 :<span style="color:#f92672">=</span> base64.<span style="color:#a6e22e">NewEncoding</span>(<span style="color:#e6db74">&#34;abcdefghijpqrzABCKLMNOkDEFGHIJl345678mnoPQRSTUVstuvwxyWXYZ0129+/&#34;</span>).<span style="color:#a6e22e">EncodeToString</span>(<span style="color:#f92672">[]</span><span style="color:#66d9ef">byte</span>(addr))
</span></span><span style="display:flex;"><span>	buf <span style="color:#f92672">=</span> append(<span style="color:#f92672">[]</span><span style="color:#66d9ef">byte</span>(<span style="color:#e6db74">&#34;POST /target?at=&#34;</span><span style="color:#f92672">+</span>addrBase64<span style="color:#f92672">+</span><span style="color:#e6db74">&#34; HTTP/1.1\r\nHost: &#34;</span><span style="color:#f92672">+</span>fakeHost<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;\r\nAccept: */*\r\nContent-Type: text/plain\r\naccept-encoding: gzip, deflate\r\ncontent-length: &#34;</span><span style="color:#f92672">+</span>strconv.<span style="color:#a6e22e">Itoa</span>(len(buf))<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;\r\n\r\n&#34;</span>), buf...)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> buf
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>åŒ…è£¹å®Œæ¯•ä¹‹åè¿”å›çš„[]byteå°±å¯ä»¥å‘é€ç»™sogo-serveräº†ã€‚</p>
<p>ç¬¬äºŒéƒ¨åˆ†ï¼šå°†sogo-serverä»ç›®æ ‡ç½‘ç«™è·å¾—çš„çœŸå®å“åº”è¿›è¡Œç®€å•åŠ å¯†ï¼ŒåŒ…è£¹httpå“åº”å¤´ï¼Œå‘é€ç»™sogo(client)ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">//file: sogo-server/mio/prefix.go</span>
</span></span><span style="display:flex;"><span>func <span style="color:#a6e22e">AppendHttpResponsePrefix</span>(buf <span style="color:#f92672">[]</span><span style="color:#66d9ef">byte</span>) <span style="color:#f92672">[]</span><span style="color:#66d9ef">byte</span> {
</span></span><span style="display:flex;"><span>	Simple(<span style="color:#f92672">&amp;</span>buf, len(buf))
</span></span><span style="display:flex;"><span>	buf <span style="color:#f92672">=</span> append(<span style="color:#f92672">[]</span><span style="color:#66d9ef">byte</span>(<span style="color:#e6db74">&#34;HTTP/1.1 200 OK\r\nContent-Type: text/plain; charset=utf-8\r\nContent-Length: &#34;</span><span style="color:#f92672">+</span>strconv.<span style="color:#a6e22e">Itoa</span>(len(buf))<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;\r\n\r\n&#34;</span>), buf...)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> buf
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>åŒ…è£¹å®Œæ¯•ä¹‹åè¿”å›çš„[]byteå°±å¯ä»¥å‘é€ç»™sogo(client)äº†ã€‚</p>
<h2 id="è§£åŒ…ä¼ªè£…å¥½çš„è¯·æ±‚å“åº”">è§£åŒ…ä¼ªè£…å¥½çš„è¯·æ±‚ã€å“åº”</h2>
<p>å…ˆçœ‹ä»¥ä¸‹ä¼ªè£…å¥½çš„è¯·æ±‚çš„æ ·å­ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>POST /target?at<span style="color:#f92672">={</span>targetAddrBase64<span style="color:#f92672">}</span> HTTP/1.1
</span></span><span style="display:flex;"><span>Host: <span style="color:#f92672">{</span>fakehost<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>Accept: */*
</span></span><span style="display:flex;"><span>Content-Type: text/plain
</span></span><span style="display:flex;"><span>accept-encoding: gzip, deflate
</span></span><span style="display:flex;"><span>content-length: <span style="color:#f92672">{</span>content-length<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>payload-after-crypto<span style="color:#f92672">}</span>
</span></span></code></pre></div><p>sogo-serveræ‹¿åˆ°è¿™ä¸ªä¼ªè£…å¥½çš„è¯·æ±‚ï¼Œè¦åšçš„äº‹æœ‰ï¼š</p>
<ol>
<li>è·å–{targetAddrBase64}ï¼Œæ‹¿åˆ°çœŸå®çš„ç›®æ ‡ç½‘ç«™åœ°å€</li>
<li>è·å–è¯·æ±‚å¤´çš„Hostå­—æ®µï¼Œå¦‚æœä¸æ˜¯å®šä¹‰å¥½çš„fakehostï¼Œåˆ™è¯´æ˜æ˜¯ç›´æ¥è®¿é—®sogo-serverï¼Œè¿™æ—¶sogo-serverå°±æ˜¯ä¸ªåˆ°æ··æ·†ç½‘ç«™çš„åå‘ä»£ç†ï¼ˆè¿™å°±æ˜¯ä¹‹å‰æåˆ°çš„ç¬¬äºŒä¸ªç‰¹æ€§ã€‚ä¸‹é¢å°†ä¼šè¯¦ç»†è§£é‡Šå¦‚ä½•å®ç°</li>
<li>è·å–{content-length}ï¼Œæ ¹æ®è¿™ä¸ªcontent-lengthç¡®å®špayloadéƒ¨åˆ†çš„é•¿åº¦ã€‚</li>
<li>è¯»å–æŒ‡å®šé•¿åº¦çš„payloadï¼Œè§£å¯†ï¼Œå¹¶åˆ›å»ºåˆ°targetAddrçš„è¿æ¥ï¼Œè½¬å‘è‡³targetAddr</li>
</ol>
<p>è¿™äº›æ­¥éª¤å¾ˆæ˜ç¡®å§ã€‚å…¶å®æœ‰ä¸€äº›ç»†èŠ‚ï¼ŒæŒºéº»çƒ¦çš„ã€‚</p>
<p>tcpæ˜¯é¢å‘æµçš„åè®®ï¼Œä¹Ÿå°±æ˜¯ä¼šæœ‰å¾ˆå¤šä¸ªè¿ç»­çš„ä¸Šé¢çš„ç‰‡æ®µï¼Œè¦åˆç†åˆ’åˆ†å‡ºè¿™äº›ç‰‡æ®µã€‚æœ‰äº›äººç§°è¿™ä¸ªä¸ºè§£å†³â€œtcpç²˜åŒ…â€ï¼Œè°·æ­Œtcpç²˜åŒ…å°±èƒ½æœåˆ°å¦‚ä½•å®ç°è¿™ä¸ªéœ€æ±‚ã€‚ä½†æ˜¯æ³¨æ„ï¼Œä¸è¦ç§°è¿™ä¸ªä¸ºâ€œtcpç²˜åŒ…â€ï¼Œåˆ«äººä¼šè¯´tcpæ˜¯é¢å‘æµçš„åè®®ï¼Œå“ªæ¥ä»€ä¹ˆåŒ…ï¼Œä½ çŸ¥è¯†ä½“ç³»æœ‰é—®é¢˜ï¼Œä½ çœ‹è¿‡tcpåè®®æ²¡æœ‰ã€‚è¿™äº›è¯éƒ½æ˜¯çŸ¥ä¹ä¸ŠæŸä¸€é—®é¢˜çš„ç­”æ¡ˆè¯´çš„ã€‚æ‰€ä»¥ï¼Œåˆ«è¯´â€œtcpç²˜åŒ…â€ï¼Œä½†æ˜¯å¯ä»¥ç”¨è¿™ä¸ªå…³é”®è¯å»æœç´¢å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>å¦‚æœï¼Œç°åœ¨ä½ çœ‹äº†å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå…¶å®å°±æ˜¯ä¸€å¥è¯ï¼Œåœ¨tcpä¸Šå±‚å®šä¹‰è‡ªå·±çš„åº”ç”¨å±‚åè®®ï¼šä¹Ÿå°±æ˜¯tcpæŠ¥æ–‡çš„æ ¼å¼ã€‚httpè¿™ä¸ªåº”ç”¨å±‚åè®®å°±æ˜¯ä¸€ç§tcpæŠ¥æ–‡çš„ä¸€ç§å®šä¹‰ã€‚</p>
<p>æˆ‘ä»¬çš„ä¼ªè£…å¥½çš„æŠ¥æ–‡å°±æ˜¯httpåè®®ï¼Œæ‰€ä»¥è¦åšçš„å°±æ˜¯å®ç°è‡ªå·±çš„httpè¯·æ±‚è§£æå™¨ï¼Œè·å–æˆ‘ä»¬å…³å¿ƒçš„ä¿¡æ¯ã€‚</p>
<p>sogoçš„httpè¯·æ±‚è§£æå™¨ï¼Œåœ¨ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">//file sogo-server/server.go</span>
</span></span><span style="display:flex;"><span>func <span style="color:#a6e22e">read</span>(clientConn net.<span style="color:#a6e22e">Conn</span>, redundancy <span style="color:#f92672">[]</span><span style="color:#66d9ef">byte</span>) (payload, redundancyRetain <span style="color:#f92672">[]</span><span style="color:#66d9ef">byte</span>, target string, readErr error)
</span></span></code></pre></div><p>è¿™ä¸€éƒ¨åˆ†æœ‰ç‚¹ç¹æ‚ã€‚ã€‚ä¸å¤šè§£é‡Šï¼Œè‡ªå·±çœ‹ä»£ç å§ã€‚</p>
<h2 id="ä¼ªè£…sogo-server80ä¸ºå…¶ä»–httpç½‘ç«™">ä¼ªè£…sogo-server:80ä¸ºå…¶ä»–httpç½‘ç«™</h2>
<p>è¿™ä¸€éƒ¨åˆ†å°±æ˜¯ç¬¬äºŒç‰¹æ€§ï¼šå°†sogo-serveræ‰€åœ¨çš„ip:ç«¯å£ä¼ªè£…æˆä¸€ä¸ªhttpç½‘ç«™ã€‚</p>
<p>ä¸Šä¸€èŠ‚ï¼Œæˆ‘ä»¬æåˆ° {fakehost}ã€‚æˆ‘ä»¬æ•…æ„å°†{fakehost}å®šä¹‰ä¸ºä¸€ä¸ªå¤æ‚ã€å¾ˆé•¿çš„åŸŸåã€‚æˆ‘ä»¬ä¼ªè£…çš„è¯·æ±‚ï¼Œéƒ½ä¼šå¸¦æœ‰å¦‚ä¸‹è¯·æ±‚å¤´</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Host: <span style="color:#f92672">{</span>fakehost<span style="color:#f92672">}</span>
</span></span></code></pre></div><p>å¦‚æœï¼Œhttpè¯·æ±‚çš„Hostä¸æ˜¯è¿™ä¸ª{fakehost}åˆ™è¯´æ˜è¿™ä¸æ˜¯ä¸€ä¸ªç»sogo(client)çš„è¯·æ±‚ï¼Œè€Œæ˜¯ç›´æ¥è¯·æ±‚äº†sogo-serverã€‚ä¹Ÿå°±æ˜¯ï¼Œæœ‰äººæ¥å—…æ¢å•¦ï¼</p>
<p>å¯¹è¿™ç§ï¼Œæˆ‘ä»¬å°±ä¼šå°†è¯¥è¯·æ±‚ï¼ŒåŸå°ä¸åŠ¨åœ°è½¬åˆ°ä¼ªè£…ç«™ã€‚ï¼ˆå…¶å®è¿˜æ˜¯æœ‰ç‚¹ä¿®æ”¹çš„ï¼Œä½†è¿™æ˜¯ç»†èŠ‚ï¼Œçœ‹ä»£ç å§ï¼‰æ‰€ä»¥ï¼Œç›´æ¥è®¿é—®sogo-server-ip:80 å°±æ˜¯è®¿é—®ä¼ªè£…ç«™ï¼š80ã€‚</p>
<h2 id="linuxä¸ŠæœåŠ¡ç«¯éƒ¨ç½²">linuxä¸ŠæœåŠ¡ç«¯éƒ¨ç½²</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install -y wget
</span></span><span style="display:flex;"><span>wget https://github.com/arloor/sogo/releases/download/v1.0/sogo-server
</span></span><span style="display:flex;"><span>wget https://github.com/arloor/sogo/releases/download/v1.0/sogo-server.json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>chmod +x sogo-server
</span></span><span style="display:flex;"><span>mv -f sogo-server /usr/local/bin/
</span></span><span style="display:flex;"><span>mv -f sogo-server.json /usr/local/bin/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#åˆ›å»ºservice</span>
</span></span><span style="display:flex;"><span>cat &gt; /lib/systemd/system/sogo-server.service <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=sogo-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Wants=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Type=simple
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WorkingDirectory=/root/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/usr/local/bin/sogo-server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitNOFILE=100000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=always
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RestartSec=5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>service  sogo-server start
</span></span><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable sogo-server
</span></span></code></pre></div><h2 id="linuxä¸Šå®¢æˆ·ç«¯å®‰è£…javaç‰ˆ">linuxä¸Šå®¢æˆ·ç«¯å®‰è£…ï¼ˆjavaç‰ˆï¼‰</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget --no-check-certificate --no-cookies --header <span style="color:#e6db74">&#34;Cookie: oraclelicense=accept-securebackup-cookie&#34;</span> http://download.oracle.com/otn-pub/java/jdk/8u131-b11/d54c1d3a095b4ff2b6607d096fa80163/jdk-8u131-linux-x64.rpm
</span></span><span style="display:flex;"><span><span style="color:#75715e">#wget http://repo-1252282974.cossh.myqcloud.com/jdk-8u131-linux-x64.rpm #ä½¿ç”¨è…¾è®¯äº‘å¯¹è±¡å­˜å‚¨</span>
</span></span><span style="display:flex;"><span>rpm -ivh jdk-8u131-linux-x64.rpm
</span></span><span style="display:flex;"><span>rm -f jdk-8u131-linux-x64.rpm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mkdir socks5
</span></span><span style="display:flex;"><span>cd socks5
</span></span><span style="display:flex;"><span>wget http://repo-1252282974.cossh.myqcloud.com/sogo.jar
</span></span><span style="display:flex;"><span>wget http://repo-1252282974.cossh.myqcloud.com/sogo.json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#åˆ›å»ºservice</span>
</span></span><span style="display:flex;"><span>cat &gt; /lib/systemd/system/sogo.service <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=ä¸€ä¸ªsocks5ä»£ç†
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=always
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WorkingDirectory=/root/socks5
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/usr/bin/java -jar /root/socks5/sogo.jar -c /root/socks5/sogo.json
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LimitNOFILE=100000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=always
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RestartSec=2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable sogo
</span></span><span style="display:flex;"><span>systemctl start sogo
</span></span><span style="display:flex;"><span><span style="color:#75715e">#vim /etc/hosts #é…ç½®proxy1 proxy2</span>
</span></span></code></pre></div><h2 id="linuxä¸Šå®¢æˆ·ç«¯å®‰è£…è¿‡æ—¶">linuxä¸Šå®¢æˆ·ç«¯å®‰è£…ï¼ˆè¿‡æ—¶ï¼‰</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># å›½å†…æœºå™¨ä¸‹é¢ä¸¤ä¸ªwgetä¼šå¾ˆæ…¢ï¼Œè€ƒè™‘æœ¬åœ°ä¸‹è½½å†ä¸Šä¼ åˆ°æœåŠ¡å™¨å§</span>
</span></span><span style="display:flex;"><span>wget https://github.com/arloor/sogo/releases/download/v1.0/sogo.json
</span></span><span style="display:flex;"><span>wget https://github.com/arloor/sogo/releases/download/v1.0/sogo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>chmod +x sogo
</span></span><span style="display:flex;"><span>mv -f sogo /usr/local/bin/
</span></span><span style="display:flex;"><span>mv -f sogo.json /usr/local/bin/
</span></span><span style="display:flex;"><span>kill -9 <span style="color:#66d9ef">$(</span>ps -aux|grep -v <span style="color:#e6db74">&#34;grep&#34;</span>|grep sogo|awk <span style="color:#e6db74">&#39;$1!=&#34;&#34;{print $2}&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>ulimit -n <span style="color:#ae81ff">65536</span> <span style="color:#75715e">#è®¾ç½®è¿›ç¨‹æœ€å¤šæ‰“å¼€æ–‡ä»¶æ•°é‡ï¼Œé˜²æ­¢ too many openfilesé”™è¯¯ï¼ˆå¤ªå¤šè¿æ¥</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è¿è¡Œå‰ï¼Œå…ˆä¿®æ”¹/usr/local/bin/sogo.json</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>sogo &amp;<span style="color:#f92672">)</span> <span style="color:#75715e">#ä»¥ /usr/local/bin/sogo.json ä¸ºé…ç½®æ–‡ä»¶  è¯¥é…ç½®ä¸‹ï¼ŒæœåŠ¡ç«¯åœ°å€è¢«è®¾ç½®ä¸ºproxy</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#(sogo -c path &amp;)  #ä»¥pathæŒ‡å‘çš„æ–‡ä»¶ä¸ºé…ç½®æ–‡ä»¶</span>
</span></span></code></pre></div><h2 id="windowså®¢æˆ·ç«¯å®‰è£…">windowså®¢æˆ·ç«¯å®‰è£…</h2>
<p>åˆ°<a href="https://github.com/arloor/sogo/releases/tag/v1.0">Release</a>ä¸‹è½½<code>sogo.exe</code>å’Œ<code>sogo.json</code>ã€‚</p>
<p>sogo.jsonå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;ClientPort&#34;</span>: <span style="color:#ae81ff">8888</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;Use&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;Servers&#34;</span>: [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;ProxyAddr&#34;</span>: <span style="color:#e6db74">&#34;proxy&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;ProxyPort&#34;</span>: <span style="color:#ae81ff">80</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;UserName&#34;</span>: <span style="color:#e6db74">&#34;a&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;Password&#34;</span>: <span style="color:#e6db74">&#34;b&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;Dev&#34;</span>:<span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å…ˆä¿®æ”¹<code>ProxyAddr</code>ä¸ºæœåŠ¡ç«¯å®‰è£…çš„åœ°å€å³å¯ã€‚å…¶ä»–é…ç½®é¡¹æ˜¯é«˜çº§åŠŸèƒ½ï¼Œä¾‹å¦‚å¤šæœåŠ¡å™¨ç®¡ç†ï¼Œå¤šç”¨æˆ·ç®¡ç†ï¼ˆç”¨æˆ·è®¤è¯ï¼‰ç­‰ç­‰ã€‚</p>
<blockquote>
<p>shadowsocksæ˜¯æ²¡æœ‰å¤šç”¨æˆ·ç®¡ç†çš„ï¼Œssæ¯ä¸ªç«¯å£å¯¹åº”ä¸€ä¸ªç”¨æˆ·ã€‚sogoåˆ™ä½¿ç”¨ç”¨æˆ·å+å¯†ç è®¤è¯ï¼Œä½¿å¤šä¸ªç”¨æˆ·ä½¿ç”¨åŒä¸€ä¸ªæœåŠ¡å™¨ç«¯å£ã€‚</p>
</blockquote>
<p>ä¿®æ”¹å¥½ä¹‹åï¼ŒåŒå‡»<code>sogo.exe</code>ï¼Œè¿™æ—¶ä¼šå‘ç°è¯¥ç›®å½•ä¸‹å¤šäº†ä¸€ä¸ª sogo_8888.log çš„æ–‡ä»¶ï¼Œè¿™å°±è¯´æ˜ï¼Œåœ¨æœ¬åœ°çš„8888ç«¯å£å¯åŠ¨å¥½äº†è¿™ä¸ªsock5ä»£ç†ã€‚ï¼ˆæ²¡æœ‰ç•Œé¢å“¦ã€‚</p>
<h2 id="å†™sogoæœ‰æ„Ÿ">å†™Sogoæœ‰æ„Ÿ</h2>
<p>sogoä»£ç ä¸å¤šï¼Œå¯¹goè¯­è¨€ã€ç½‘ç»œç¼–ç¨‹æ„Ÿå…´è¶£çš„äººå¯ä»¥çœ‹çœ‹ã€‚è¿™ç¯‡åšå®¢æ¢³ç†äº†ä¸€ä¸‹sogoçš„å®ç°åŸç†ï¼Œæ€»ä¹‹ï¼Œsogoæ˜¯ä¸€ä¸ªä¼˜é›…çš„ä»£ç†ã€‚</p>
<p>æœºç¼˜å·§åˆä¹‹ä¸‹ï¼Œsogoåˆšå¥½æ»¡è¶³äº†ä¸€å®¶å…¬å¸ä¸šåŠ¡çš„éœ€è¦ï¼Œäºæ˜¯åˆšåˆšå†™å¥½å°±æŠ•å…¥äº†ä½¿ç”¨ã€‚</p>
<img src="/img/earn-money-start.jpg" alt="" width="500px" style="max-width: 100%;">

<p>å°±æ˜¯è¿™æ ·ï¼Œsogoæ„å¤–åœ°æˆä¸ºæˆ‘çš„ç¬¬ä¸€ä¸ªâ€œæœ‰åˆ«äººæ„¿æ„ç”¨â€çš„ä½œå“ï¼Œå¹¶ä¸”æ”¶åˆ°äº†å®é™…çš„å›æŠ¥ã€‚ä»åæ¥çš„äº†è§£æ¥çœ‹ï¼Œsogoè§£å†³äº†ä»–ä»¬ä¸šåŠ¡çš„é‡å¤§ç—›ç‚¹ã€‚ä»–ä»¬çš„è½¯ä»¶æ˜¯ç¬¬ä¸‰æ–¹telegramï¼Œç”¨äºèŠå¤©æŒ–çŸ¿ï¼ˆæˆ‘ä¸æ‡‚ï¼‰ï¼Œå¹¶ä¸”å†…éƒ¨å°è£…socks5ä»£ç†çš„é…ç½®æ¥è¿æ¥ç”µæŠ¥æœåŠ¡å™¨ï¼Œä»è€Œå…å»ç”¨æˆ·è‡ªå·±å¯»æ‰¾ç”µæŠ¥ä»£ç†ã€‚ä¹‹å‰éƒ½æ˜¯ä½¿ç”¨ç½‘ä¸Šæ‰¾çš„å…¬å¼€socks5ä»£ç†éš”å‡ å¤©å°±æŒ‚å®Œã€‚ç¿»çœ‹ä»–ä»¬çš„ç¾¤ç»„é€šçŸ¥ï¼Œå¥½å¤šæ¡éƒ½æ˜¯è¯´ï¼Œâ€œè¿æ¥æœåŠ¡å™¨æœ‰é—®é¢˜ï¼Œæ­£åœ¨è§£å†³ï¼ŒæŠ±æ­‰â€ï¼Œç›´åˆ°æœ‰äº†sogoï¼å¯ä»¥è¯´sogoç°åœ¨æ˜¯ä»–ä»¬è¿™ä¸ªè½¯ä»¶å¾ˆé‡è¦çš„ä¸€ä¸ªåŸºç¡€è®¾æ–½ã€‚ï¼ˆä¸å¹èƒ½æ­»å—ï¼Ÿ</p>
<p>æ‰€ä»¥å‘€ï¼Œé’±è¦å°‘äº†ã€‚ä¸è¿‡æœ¬æ¥å°±æ²¡æƒ³èµšé’±ï¼Œæœ‰æ€»æ¯”æ²¡æœ‰å¥½å¯¹å§ã€‚å¦ä¸€æ–¹é¢ï¼Œè¿™ä¹Ÿæ˜¯å¯¹æˆ‘çš„æŠ€æœ¯èƒ½åŠ›çš„è®¤å¯ã€‚å—¯ï¼Œè¿™æ‰æ˜¯æœ€é‡è¦çš„å§ï¼ŒæŒºçˆ½çš„ã€‚ä»¥å‰å†™çš„ä¸œè¥¿æ²¡äººç”¨ï¼Œåæ¥å†™çš„ä¸œè¥¿è‡ªå·±ç”¨ï¼Œç°åœ¨å†™çš„ä¸œè¥¿åˆ«äººä¹°æ¥ç”¨ï¼Œå¢ƒç•Œå°±ä¸ä¸€æ ·å•¦ã€‚ç”¨ä¸‰ä¸ªè¯æ¦‚æ‹¬ä¸€ä¸‹è¿™æ®µç»å†å§ï¼šæœºç¼˜å·§åˆğŸ˜±ã€é’±è¦å°‘äº†ğŸ˜­ã€å¾—åˆ°è®¤å¯ğŸ˜„ã€‚</p>
<img src="/img/talk-about-payment.jpg" alt="" width="500px" style="max-width: 100%;">

<p>æ”¾ä¸€å¼ æœåŠ¡å™¨çš„è¿è¡ŒçŠ¶å†µç›‘æ§è¯æ˜ä¸€ä¸‹æœ‰äººç”¨ğŸ˜‚ã€‚å¦‚ä¸‹å›¾çš„ç›‘æ§æ‰€ç¤ºï¼ŒæœåŠ¡å™¨çš„å¸¦å®½å’Œtcpè¿æ¥æ•°é‡éƒ½ä¿æŒåœ¨ç¨³å®šçš„æ°´å¹³ã€‚tcpè¿æ¥æ•°è¾ƒå¤šï¼Œä½†æ˜¯å¸¦å®½ä¸å¤§ï¼Œè¿™ä¹Ÿç¬¦åˆæ–‡å­—å†…å®¹ä¼ è¾“çš„ä½¿ç”¨åœºæ™¯ã€‚</p>
<p><img src="/img/monitor-aliyun.png" alt=""></p>
<p>24å°æ—¶çš„å¸¦å®½å ç”¨å¦‚ä¸‹ï¼Œå¤œæ·±äººé™çš„æ—¶å€™æœ€ä½ï¼Œå¯ä»¥è¯´å¾ˆçœŸå®äº†</p>
<p><img src="/img/bandwagon-daikuan.jpg" alt=""></p>
<p>åºŸè¯è¯´å¾—å¤Ÿå•¦ï¼Œæœ€åæ¥å¬å¬æ­Œå§ã€‚ Something just like this ğŸ˜</p>


<div class="iframe-container">
    <iframe src="https://www.youtube.com/embed/-SgyhUdJ_TY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</div>
<h2 id="ç»´æŠ¤æ—¥å¿—">ç»´æŠ¤æ—¥å¿—</h2>
<h3 id="1å› byteæœªå¤ç”¨å¯¼è‡´é¢‘ç¹gcä»è€Œcpuå ç”¨å¤¸å¼ ">1.å› []byteæœªå¤ç”¨ï¼Œå¯¼è‡´é¢‘ç¹GCï¼Œä»è€Œcpuå ç”¨å¤¸å¼ </h3>
<p>åœ¨å¸¦å®½è¾¾åˆ°50Mæ—¶ï¼Œcpuå ç”¨è¾¾åˆ°å¤¸å¼ çš„50%ã€‚æƒ³æƒ³å®ç°ï¼Œå°±çŸ¥é“æ—¶å†…å­˜æ²¡æœ‰å¤ç”¨å¯¼è‡´é¢‘ç¹GCï¼Œæ‰€ä»¥å°±æƒ³å¼„ä¸ªå†…å­˜æ± å‡ºæ¥ï¼Œæœ¬æ¥æƒ³è‡ªå·±å®ç°ï¼Œåæ¥å‘ç°GOè¯­è¨€æœ‰sync.poolæ»¡è¶³è¿™ä¸ªä¸´æ—¶å¯¹è±¡æ± çš„éœ€æ±‚ã€‚</p>
<h3 id="2å› ä¸ºé¢‘ç¹å†™å…¥æ—¥å¿—æ–‡ä»¶å¯¼è‡´cpu-iowaitè¿‡é«˜">2.å› ä¸ºé¢‘ç¹å†™å…¥æ—¥å¿—æ–‡ä»¶ï¼Œå¯¼è‡´cpu iowaitè¿‡é«˜</h3>
<p>ä»ç›‘æ§æ¥çœ‹ï¼Œcpuå ç”¨è¾¾åˆ°å¤¸å¼ çš„90%ï¼Œä½¿ç”¨topå‘½ä»¤çœ‹åˆ°cpuçš„iowaitæœ‰70%å¤šã€‚</p>
<p>iowaitæ˜¯cpuç­‰å¾…ioçš„æ—¶é—´å æ¯”ï¼Œsogoåº”ç”¨æ˜¯ç½‘ç»œIOï¼Œä¸€èˆ¬ä¸ä¼šæœ‰ç£ç›˜IOï¼Œå”¯ä¸€æœ‰å¯èƒ½çš„åªæœ‰å†™å…¥æ—¥å¿—æ–‡ä»¶ã€‚åœ¨å…³é—­æ—¥å¿—è®°å½•ä¹‹åï¼Œcpu iowaité™ä½è‡³0ï¼Œé—®é¢˜è§£å†³ã€‚</p>
<p>ä¸€äº›æ’æŸ¥iowaitå ç”¨é«˜çš„æ–¹æ³•ï¼š</p>
<h4 id="æŸ¥æ‰¾å“ªä¸ªç¡¬ç›˜æ­£åœ¨è¢«å†™å…¥">æŸ¥æ‰¾å“ªä¸ªç¡¬ç›˜æ­£åœ¨è¢«å†™å…¥</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@coolnull ~<span style="color:#f92672">]</span><span style="color:#75715e"># iostat -x 2 5</span>
</span></span><span style="display:flex;"><span> avg-cpu: %user %nice %system %iowait %steal %idle
</span></span><span style="display:flex;"><span>  3.66 0.00 47.64 48.69 0.00 0.00
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> Device: rrqm/s wrqm/s r/s w/s rkB/s wkB/s avgrq-sz avgqu-sz await r_await w_await svctm %util
</span></span><span style="display:flex;"><span> sda 44.50 39.27 117.28 29.32 11220.94 13126.70 332.17 65.77 462.79 9.80 2274.71 7.60 111.41
</span></span><span style="display:flex;"><span> dm-0 0.00 0.00 83.25 9.95 10515.18 4295.29 317.84 57.01 648.54 16.73 5935.79 11.48 107.02
</span></span><span style="display:flex;"><span> dm-1 0.00 0.00 57.07 40.84 228.27 163.35 8.00 93.84 979.61 13.94 2329.08 10.93 107.02
</span></span></code></pre></div><p>ä¸Šè¿°ç¤ºä¾‹çš„iostatå‘½ä»¤å°†æ¯2ç§’æ‰“å°å‡ºæŠ¥å‘Šï¼Œå…±æ‰“å°5æ¬¡ï¼›-xå‚æ•°å‘Šè¯‰iostataæ‰“å°å‡ºæ›´è¯¦å°½çš„æŠ¥å‘Š</p>
<p>iostatæ‰“å°å‡ºçš„ç¬¬1ä¸ªæŠ¥å‘Šï¼Œæ•°å€¼æ˜¯åŸºäºæœ€åä¸€æ¬¡ç³»ç»Ÿå¯åŠ¨çš„æ—¶é—´ç»Ÿè®¡çš„ï¼›åŸºäºè¿™ä¸ªåŸå› ï¼Œåœ¨å¤§éƒ¨ä»½æƒ…å†µä¸‹ï¼Œiostatæ‰“å°å‡ºçš„ç¬¬1ä¸ªæŠ¥å‘Šåº”è¯¥è¢«å¿½ç•¥ã€‚æ¯ä¸ªå­æŠ¥å‘Šéƒ½æ˜¯åŸºäºä¸Š1æ¬¡çš„æŠ¥å‘Šã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çš„å‘½ä»¤å°†æ‰“å°5æ¬¡æŠ¥å‘Šï¼Œç¬¬2ä»½æŠ¥å‘Šå°±æ˜¯ä»ç¬¬1ä»½æŠ¥å‘Šå¼€å§‹åçš„ç¡¬ç›˜æ•°æ®ï¼Œç¬¬3ä»½æŠ¥å‘ŠåŸºäºç¬¬2ä»½ï¼Œä¾æ­¤ç±»æ¨ã€‚</p>
<p>ä¸Šè¿°ç¤ºä¾‹ï¼Œsdaç›˜çš„%utilizedè¾¾åˆ°äº†111.41%ã€‚è¿™è¡¨ç¤ºå¼•èµ·I/Oæ…¢çš„è¿›ç¨‹åœ¨å†™å…¥sdaç›˜ã€‚å› ä¸ºæˆ‘è¿™ä¸ªæµ‹è¯•å®ä¾‹ä¸­åªæœ‰1ä¸ªç¡¬ç›˜ï¼Œä½†å¯¹äºæœ‰å¤šç¡¬ç›˜çš„æœåŠ¡å™¨æ¥è¯´ï¼Œè¿™å¯ä»¥ç¼©å°åœ¨ä½¿ç”¨I/Oçš„è¿›ç¨‹èŒƒå›´ã€‚</p>
<p>é™¤äº†iostatçš„%utilizedèƒ½æä¾›ä¸°å¯Œçš„ä¿¡æ¯å¤–ï¼Œåƒrrqm/sã€wrqm/sè¿™äº›æ¯ç§’è¯»ã€å†™çš„è¯·æ±‚æ•°ï¼Œr/sã€w/sæ¯ç§’è¯»å†™æ•°ä¹Ÿå¾ˆæœ‰ç”¨ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çš„ç¨‹åºçœ‹èµ·æ¥è¯»å†™å¾ˆç¹é‡çš„ä¿¡æ¯ä¹Ÿèƒ½å¸®åŠ©æˆ‘ä»¬ç¡®å®šè¿™ä¸ªè®¨äººåŒçš„è¿›ç¨‹ã€‚</p>
<h4 id="æŸ¥æ‰¾å¼•èµ·é«˜ioçš„è¿›ç¨‹">æŸ¥æ‰¾å¼•èµ·é«˜I/Oçš„è¿›ç¨‹</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@coolnull ~<span style="color:#f92672">]</span><span style="color:#75715e"># iotop</span>
</span></span><span style="display:flex;"><span> Total DISK READ: 8.00 M/s | Total DISK WRITE: 20.36 M/s
</span></span><span style="display:flex;"><span>  TID PRIO USER DISK READ DISK WRITE SWAPIN IO&gt; COMMAND
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">15758</span> be/4 root 7.99 M/s 8.01 M/s 0.00 % 61.97 % bonnie++ -n <span style="color:#ae81ff">0</span> -u <span style="color:#ae81ff">0</span> -r <span style="color:#ae81ff">239</span> -s <span style="color:#ae81ff">478</span> -f -b -d /tmp
</span></span></code></pre></div><p>æŸ¥çœ‹å“ªä¸ªè¿›ç¨‹ä½¿ç”¨ç¡¬ç›˜æœ€å¤šçš„æœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯ä½¿ç”¨iotopå‘½ä»¤ã€‚é€šè¿‡æŸ¥çœ‹æ•°æ®ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“å°±èƒ½ç¡®å®šæ˜¯bonnie++è¿™ä¸ªè¿›ç¨‹å¼•èµ·æˆ‘ä»¬æœºå™¨é«˜I/O</p>
<p>è™½ç„¶iotopå¥½ç”¨ï¼Œä½†é»˜è®¤ä¸»æµçš„linuxå‘è¡Œç‰ˆä¸­æ˜¯æ²¡æœ‰å®‰è£…çš„ï¼›å¹¶ä¸”æˆ‘ä¸ªäººä¹Ÿä¸æ¨èä¾èµ–é»˜è®¤ç³»ç»Ÿæ²¡æœ‰å®‰è£…çš„å‘½ä»¤ã€‚ç³»ç»Ÿç®¡ç†å‘˜æ€»æ˜¯ä¼šç¢°åˆ°è¿™æ ·çš„æƒ…å†µï¼Œä»–ä»¬æ²¡åŠæ³•åœ¨çŸ­æ—¶é—´å†…ç®€å•åœ°å®‰è£…è¿™äº›éé»˜è®¤åŒ…ã€‚</p>
<p>å¦‚æœiotopæ²¡åŠæ³•ç”¨ï¼Œä»¥ä¸‹çš„æ­¥èšè¿˜æ˜¯å¯ä»¥å¸®åŠ©ä½ ç¼©å°è¿™äº›è®¨äººåŒè¿›ç¨‹çš„èŒƒå›´</p>
<h4 id="è¿›ç¨‹çŠ¶æ€åˆ—è¡¨">è¿›ç¨‹çŠ¶æ€åˆ—è¡¨</h4>
<p>pså‘½ä»¤èƒ½æ‰“å°å‡ºå†…å­˜ï¼Œcpuçš„æƒ…å†µä½†æ²¡åŠæ³•æ‰“å°å‡ºç¡¬ç›˜I/Oçš„æƒ…å†µã€‚è™½ç„¶psæ²¡åŠæ³•æ‰“å°å‡ºI/Oçš„æƒ…å†µï¼Œä½†å®ƒå¯ä»¥æ˜¾ç¤ºå‡ºè¿›ç¨‹æ˜¯å¦åœ¨ç­‰å¾…I/Oã€‚</p>
<p>The ps state field provides the processes current state; below is a list of states from the man page.
psçŠ¶æ€åˆ—æä¾›äº†è¿›ç¨‹å½“å‰çš„çŠ¶æ€ï¼Œä»¥ä¸‹ä»man psä¸Šè·å–çš„è¿›ç¨‹statåˆ—è¡¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>PROCESS STATE CODES
</span></span><span style="display:flex;"><span> D uninterruptible sleep <span style="color:#f92672">(</span>usually IO<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> R running or runnable <span style="color:#f92672">(</span>on run queue<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> S interruptible sleep <span style="color:#f92672">(</span>waiting <span style="color:#66d9ef">for</span> an event to complete<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> T stopped, either by a job control signal or because it is being traced.
</span></span><span style="display:flex;"><span> W paging <span style="color:#f92672">(</span>not valid since the 2.6.xx kernel<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> X dead <span style="color:#f92672">(</span>should never be seen<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> Z defunct <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;zombie&#34;</span><span style="color:#f92672">)</span> process, terminated but not reaped by its parent.
</span></span></code></pre></div><p>ç­‰å¾…I/Oçš„è¿›ç¨‹é€šè¿‡å¤„äºuninterruptible sleepæˆ–DçŠ¶æ€ï¼›é€šè¿‡ç»™å‡ºè¿™äº›ä¿¡æ¯æˆ‘ä»¬å°±å¯ä»¥ç®€å•çš„æŸ¥æ‰¾å‡ºå¤„åœ¨waitçŠ¶æ€çš„è¿›ç¨‹</p>
<p>ç¤ºä¾‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@coolnull ~<span style="color:#f92672">]</span><span style="color:#75715e"># for x in `seq 1 1 10`; do ps -eo state,pid,cmd | grep &#34;^D&#34;; echo &#34;----&#34;; sleep 5; done</span>
</span></span><span style="display:flex;"><span> D <span style="color:#ae81ff">248</span> <span style="color:#f92672">[</span>jbd2/dm-0-8<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span> D <span style="color:#ae81ff">16528</span> bonnie++ -n <span style="color:#ae81ff">0</span> -u <span style="color:#ae81ff">0</span> -r <span style="color:#ae81ff">239</span> -s <span style="color:#ae81ff">478</span> -f -b -d /tmp
</span></span><span style="display:flex;"><span> ----
</span></span><span style="display:flex;"><span> D <span style="color:#ae81ff">22</span> <span style="color:#f92672">[</span>kswapd0<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span> D <span style="color:#ae81ff">16528</span> bonnie++ -n <span style="color:#ae81ff">0</span> -u <span style="color:#ae81ff">0</span> -r <span style="color:#ae81ff">239</span> -s <span style="color:#ae81ff">478</span> -f -b -d /tmp
</span></span><span style="display:flex;"><span> ----
</span></span><span style="display:flex;"><span> D <span style="color:#ae81ff">22</span> <span style="color:#f92672">[</span>kswapd0<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span> D <span style="color:#ae81ff">16528</span> bonnie++ -n <span style="color:#ae81ff">0</span> -u <span style="color:#ae81ff">0</span> -r <span style="color:#ae81ff">239</span> -s <span style="color:#ae81ff">478</span> -f -b -d /tmp
</span></span><span style="display:flex;"><span> ----
</span></span><span style="display:flex;"><span> D <span style="color:#ae81ff">22</span> <span style="color:#f92672">[</span>kswapd0<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span> D <span style="color:#ae81ff">16528</span> bonnie++ -n <span style="color:#ae81ff">0</span> -u <span style="color:#ae81ff">0</span> -r <span style="color:#ae81ff">239</span> -s <span style="color:#ae81ff">478</span> -f -b -d /tmp
</span></span><span style="display:flex;"><span> ----
</span></span><span style="display:flex;"><span> D <span style="color:#ae81ff">16528</span> bonnie++ -n <span style="color:#ae81ff">0</span> -u <span style="color:#ae81ff">0</span> -r <span style="color:#ae81ff">239</span> -s <span style="color:#ae81ff">478</span> -f -b -d /tmp
</span></span><span style="display:flex;"><span> ----
</span></span></code></pre></div><p>ä¸Šè¿°å‘½ä»¤ä¼šæ¯5ç§’å¾ªç¯æ‰“å°å‡ºä½äºDçŠ¶æ€çš„è¿›ç¨‹ï¼Œå…±æ‰“å°10æ¬¡</p>
<p>ä»ä¸Šé¢çš„è¾“å‡ºå¯ä»¥çœ‹å‡ºbonnie++ï¼Œpid 16528æ¯”å…¶å®ƒè¿›ç¨‹æ›´åŠ å ç”¨I/Oã€‚ä»è¿™ç‚¹ï¼Œbonnie++çœ‹èµ·æ¥æ›´æœ‰å¯èƒ½å¼•èµ·I/O Waitã€‚ä½†ä»…å‡­è¿›ç¨‹å¤„äºuninterruptible sleep stateèªŠï¼Œè¿˜ä¸èƒ½å®Œå…¨ç¡®å®šå°±æ˜¯è¿™å¼•èµ·çš„I/O waitã€‚</p>
<p>ä¸ºäº†å¸®åŠ©è‚¯å®šæˆ‘ä»¬çš„æ€€ç–‘ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨/procæ–‡ä»¶ç³»ç»Ÿã€‚åœ¨è¿™ä¸ªè¿›ç¨‹ç›®å½•é‡Œï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªioæ–‡ä»¶ï¼Œé‡Œé¢çš„æ•°å€¼è·Ÿiotopå‘½ä»¤è·å–çš„I/Oæ•°å€¼ä¸€æ ·ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@coolnull ~<span style="color:#f92672">]</span><span style="color:#75715e"># cat /proc/16528/io</span>
</span></span><span style="display:flex;"><span> rchar: <span style="color:#ae81ff">48752567</span>
</span></span><span style="display:flex;"><span> wchar: <span style="color:#ae81ff">549961789</span>
</span></span><span style="display:flex;"><span> syscr: <span style="color:#ae81ff">5967</span>
</span></span><span style="display:flex;"><span> syscw: <span style="color:#ae81ff">67138</span>
</span></span><span style="display:flex;"><span> read_bytes: <span style="color:#ae81ff">49020928</span>
</span></span><span style="display:flex;"><span> write_bytes: <span style="color:#ae81ff">549961728</span>
</span></span><span style="display:flex;"><span> cancelled_write_bytes: <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>read_byteså’Œwrite_byteså°±è¿™ä¸ªè¿›ç¨‹è¯»å†™ç¡¬ç›˜çš„å­—èŠ‚æ•°ã€‚åœ¨è¿™é‡Œï¼Œbonnie++å·²ç»è¯»å–äº†46MBï¼Œå†™å…¥524MBçš„æ•°æ®ã€‚å¯¹å¾ˆå¤šè¿›ç¨‹ï¼Œè¿™å¯èƒ½ä¸æ˜¯å¾ˆå¤šï¼Œä½†åœ¨æˆ‘ä»¬è¿™ä¸ªå®ä¾‹è¿™è¶³å¤Ÿå¼•èµ·é«˜i/o waitã€‚</p>
<h4 id="æŸ¥æ‰¾å“ªä¸ªæ–‡ä»¶åœ¨è¢«ç¹é‡åœ°å†™å…¥">æŸ¥æ‰¾å“ªä¸ªæ–‡ä»¶åœ¨è¢«ç¹é‡åœ°å†™å…¥</h4>
<p>lsofå‘½ä»¤ä¼šä¸ºä½ å±•ç¤ºæŒ‡å®šè¿›ç¨‹æ‰“å¼€çš„æ‰€æœ‰æ–‡ä»¶æˆ–ä¾èµ–æä¾›é€‰é¡¹çš„æ‰€æœ‰è¿›ç¨‹ã€‚ä»è¿™ä¸ªåˆ—è¡¨ï¼Œäººä»¬å¯ä»¥æ ¹æ®æ–‡ä»¶çš„å¤§å°å’Œ/proc ioæ–‡ä»¶é‡Œå‡ºç°çš„æ¬¡æ•°åšå‡ºæœ‰ç”¨çš„çŒœæµ‹ï¼Œå“ªä¸ªæ–‡ä»¶æ­£åœ¨è¢«é¢‘ç¹åœ°å†™å…¥ã€‚</p>
<p>ä¸ºäº†å‡å°‘è¾“å‡ºçš„å†…å®¹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨-p é€‰é¡¹æ¥åªæ‰“å°æŒ‡å®šè¿›ç¨‹idæ‰“å¼€çš„æ–‡ä»¶</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@coolnull ~<span style="color:#f92672">]</span><span style="color:#75715e"># lsof -p 16528</span>
</span></span><span style="display:flex;"><span> COMMAND PID USER FD TYPE DEVICE SIZE/OFF NODE NAME
</span></span><span style="display:flex;"><span> bonnie++ <span style="color:#ae81ff">16528</span> root cwd DIR 252,0 <span style="color:#ae81ff">4096</span> <span style="color:#ae81ff">130597</span> /tmp
</span></span><span style="display:flex;"><span> &lt;truncated&gt;
</span></span><span style="display:flex;"><span> bonnie++ <span style="color:#ae81ff">16528</span> root 8u REG 252,0 <span style="color:#ae81ff">501219328</span> <span style="color:#ae81ff">131869</span> /tmp/Bonnie.16528
</span></span><span style="display:flex;"><span> bonnie++ <span style="color:#ae81ff">16528</span> root 9u REG 252,0 <span style="color:#ae81ff">501219328</span> <span style="color:#ae81ff">131869</span> /tmp/Bonnie.16528
</span></span><span style="display:flex;"><span> bonnie++ <span style="color:#ae81ff">16528</span> root 10u REG 252,0 <span style="color:#ae81ff">501219328</span> <span style="color:#ae81ff">131869</span> /tmp/Bonnie.16528
</span></span><span style="display:flex;"><span> bonnie++ <span style="color:#ae81ff">16528</span> root 11u REG 252,0 <span style="color:#ae81ff">501219328</span> <span style="color:#ae81ff">131869</span> /tmp/Bonnie.16528
</span></span><span style="display:flex;"><span> bonnie++ <span style="color:#ae81ff">16528</span> root 12u REG 252,0 <span style="color:#ae81ff">501219328</span> <span style="color:#ae81ff">131869</span> &lt;strong&gt;/tmp/Bonnie.16528
</span></span></code></pre></div><h3 id="3æŠ¥é”™too-many-open-files">3.æŠ¥é”™ï¼štoo many open files</h3>
<p>é”™è¯¯æ—¥å¿—å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Socket accept error: accept tcp <span style="color:#f92672">[</span>::<span style="color:#f92672">]</span>:80: accept4: too many open files;
</span></span></code></pre></div><p>too many open files(æ‰“å¼€çš„æ–‡ä»¶è¿‡å¤š)æ˜¯Linuxç³»ç»Ÿä¸­å¸¸è§çš„é”™è¯¯ï¼Œä»å­—é¢æ„æ€ä¸Šçœ‹å°±æ˜¯è¯´ç¨‹åºæ‰“å¼€çš„æ–‡ä»¶æ•°è¿‡å¤šï¼Œä¸è¿‡è¿™é‡Œçš„filesä¸å•æ˜¯æ–‡ä»¶çš„æ„æ€ï¼Œä¹ŸåŒ…æ‹¬æ‰“å¼€çš„é€šè®¯é“¾æ¥(æ¯”å¦‚socket)ï¼Œæ­£åœ¨ç›‘å¬çš„ç«¯å£ç­‰ç­‰ï¼Œæ‰€ä»¥æœ‰æ—¶å€™ä¹Ÿå¯ä»¥å«åšå¥æŸ„(handle)ï¼Œè¿™ä¸ªé”™è¯¯é€šå¸¸ä¹Ÿå¯ä»¥å«åšå¥æŸ„æ•°è¶…å‡ºç³»ç»Ÿé™åˆ¶ã€‚</p>
<p>å¼•èµ·çš„åŸå› å°±æ˜¯è¿›ç¨‹åœ¨æŸä¸ªæ—¶åˆ»æ‰“å¼€äº†è¶…è¿‡shellä¼šè¯é™åˆ¶çš„æ–‡ä»¶æ•°é‡ä»¥åŠé€šè®¯é“¾æ¥æ•°ï¼Œé€šè¿‡å‘½ä»¤<code>ulimit -a</code>å¯ä»¥æŸ¥çœ‹å½“å‰shellä¼šè¯è®¾ç½®çš„æœ€å¤§å¥æŸ„æ•°æ˜¯å¤šå°‘</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># ulimit -a</span>
</span></span><span style="display:flex;"><span>core file size          <span style="color:#f92672">(</span>blocks, -c<span style="color:#f92672">)</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>data seg size           <span style="color:#f92672">(</span>kbytes, -d<span style="color:#f92672">)</span> unlimited
</span></span><span style="display:flex;"><span>scheduling priority             <span style="color:#f92672">(</span>-e<span style="color:#f92672">)</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>file size               <span style="color:#f92672">(</span>blocks, -f<span style="color:#f92672">)</span> unlimited
</span></span><span style="display:flex;"><span>pending signals                 <span style="color:#f92672">(</span>-i<span style="color:#f92672">)</span> <span style="color:#ae81ff">14732</span>
</span></span><span style="display:flex;"><span>max locked memory       <span style="color:#f92672">(</span>kbytes, -l<span style="color:#f92672">)</span> <span style="color:#ae81ff">64</span>
</span></span><span style="display:flex;"><span>max memory size         <span style="color:#f92672">(</span>kbytes, -m<span style="color:#f92672">)</span> unlimited
</span></span><span style="display:flex;"><span>open files                      <span style="color:#f92672">(</span>-n<span style="color:#f92672">)</span> <span style="color:#ae81ff">1024</span>  <span style="color:#75715e">#å¤ªå°äº†ï¼Œå¯ä»¥ç›´æ¥æ”¹åˆ°65536</span>
</span></span><span style="display:flex;"><span>pipe size            <span style="color:#f92672">(</span><span style="color:#ae81ff">512</span> bytes, -p<span style="color:#f92672">)</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>POSIX message queues     <span style="color:#f92672">(</span>bytes, -q<span style="color:#f92672">)</span> <span style="color:#ae81ff">819200</span>
</span></span><span style="display:flex;"><span>real-time priority              <span style="color:#f92672">(</span>-r<span style="color:#f92672">)</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>stack size              <span style="color:#f92672">(</span>kbytes, -s<span style="color:#f92672">)</span> <span style="color:#ae81ff">10240</span>
</span></span><span style="display:flex;"><span>cpu time               <span style="color:#f92672">(</span>seconds, -t<span style="color:#f92672">)</span> unlimited
</span></span><span style="display:flex;"><span>max user processes              <span style="color:#f92672">(</span>-u<span style="color:#f92672">)</span> <span style="color:#ae81ff">1024</span>
</span></span><span style="display:flex;"><span>virtual memory          <span style="color:#f92672">(</span>kbytes, -v<span style="color:#f92672">)</span> unlimited
</span></span><span style="display:flex;"><span>file locks                      <span style="color:#f92672">(</span>-x<span style="color:#f92672">)</span> unlimited
</span></span></code></pre></div><p>open filesé‚£ä¸€è¡Œå°±ä»£è¡¨å½“å‰shellä¼šè¯ç›®å‰å…è®¸å•ä¸ªè¿›ç¨‹æ‰“å¼€çš„æœ€å¤§å¥æŸ„æ•°ï¼Œè¿™é‡Œæ˜¯1024ï¼Œè¿™ä¸ªå€¼å¯¹äºè¿™ä¸ªä½¿ç”¨åœºæ™¯å¤ªå°äº†ã€‚</p>
<p>ä½¿ç”¨å‘½ä»¤lsof -p è¿›ç¨‹idå¯ä»¥æŸ¥çœ‹å•ä¸ªè¿›ç¨‹æ‰€æœ‰æ‰“å¼€çš„æ–‡ä»¶è¯¦æƒ…ï¼Œä½¿ç”¨å‘½ä»¤lsof -p è¿›ç¨‹id | wc -lå¯ä»¥ç»Ÿè®¡è¿›ç¨‹æ‰“å¼€äº†å¤šå°‘æ–‡ä»¶ï¼šï¼ˆPSï¼šä½¿ç”¨lsof -i:80|wc -lå¯ä»¥æŸ¥çœ‹80ç«¯å£æœ‰å¤šå°‘ä¸ªè¿æ¥ï¼‰</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>lsof -p <span style="color:#66d9ef">$(</span>ps -aux|grep -v <span style="color:#e6db74">&#34;grep&#34;</span>|grep sogo|awk <span style="color:#e6db74">&#39;$1!=&#34;&#34;{print $2}&#39;</span><span style="color:#66d9ef">)</span>|wc -l
</span></span><span style="display:flex;"><span><span style="color:#75715e">#1610</span>
</span></span><span style="display:flex;"><span>lsof -i:80|wc -l
</span></span><span style="display:flex;"><span><span style="color:#75715e">#337</span>
</span></span></code></pre></div><p>é—®é¢˜å®šä½åˆ°è¿™ä¸ªlimitè¿‡ä½ï¼Œè§£å†³è‡ªç„¶å°±æ˜¯å¢åŠ è¿™ä¸ªlimitã€‚æœ€æœ€ç®€å•çš„æ–¹æ³•æ˜¯æ‰§è¡Œä»¥ä¸‹è„šæœ¬ï¼Œå¢åŠ å½“å‰shellå’Œå®ƒçš„å­è¿›ç¨‹çš„limitï¼Œç„¶åé‡å¯è¿›ç¨‹ã€‚</p>
<pre tabindex="0"><code>ulimit -n 65536
</code></pre><blockquote>
<p>ä½œä¸ºä¸´æ—¶é™åˆ¶ï¼Œulimit å¯ä»¥ä½œç”¨äºé€šè¿‡ä½¿ç”¨å…¶å‘½ä»¤ç™»å½•çš„ shell ä¼šè¯ï¼Œåœ¨ä¼šè¯ç»ˆæ­¢æ—¶ä¾¿ç»“æŸé™åˆ¶ï¼Œå¹¶ä¸å½±å“äºå…¶ä»– shell ä¼šè¯ã€‚è€Œå¯¹äºé•¿æœŸçš„å›ºå®šé™åˆ¶ï¼Œulimit å‘½ä»¤è¯­å¥åˆå¯ä»¥è¢«æ·»åŠ åˆ°ç”±ç™»å½• shell è¯»å–çš„æ–‡ä»¶ä¸­ï¼Œä½œç”¨äºç‰¹å®šçš„ shell ç”¨æˆ·ã€‚å‰é¢å¤šæ¬¡æåˆ°shellä¼šè¯ï¼Œulimitçš„å½±å“èŒƒå›´æ˜¯ï¼Œè¾“å…¥ulimitå‘½ä»¤ä¹‹åçš„å‘½ä»¤ï¼Œä¹Ÿå°±æ˜¯å¯¹å½“å‰shellå’Œå½“å‰shellçš„å­è¿›ç¨‹ç”Ÿæ•ˆï¼Œå¯¹å…¶å®ƒshellä¸äº§ç”Ÿå½±å“ã€‚</p>
</blockquote>
<p>é‡å¯è¿›ç¨‹åï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼ŒæŸ¥çœ‹æ–°çš„limitæ˜¯å¦å¯¹æ–°è¿›ç¨‹ç”Ÿæ•ˆ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat /proc/$pid/limits|grep open
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Max open files            65536                65536                files</span>
</span></span></code></pre></div><p>å¦ä¸€ç§ï¼Œé€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶æ¥ä¿®æ”¹limitï¼Œåœ¨é‡å¯åä¸ä¼šå¤±æ•ˆï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vim /etc/security/limits.conf  
</span></span><span style="display:flex;"><span><span style="color:#75715e">#åœ¨æœ€ååŠ å…¥  </span>
</span></span><span style="display:flex;"><span>* soft nofile <span style="color:#ae81ff">65536</span>  
</span></span><span style="display:flex;"><span>* hard nofile <span style="color:#ae81ff">65536</span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e">#æˆ–è€…åªåŠ å…¥ï¼š</span>
</span></span><span style="display:flex;"><span>* - nofile <span style="color:#ae81ff">65536</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ˜Ÿå·è¡¨ç¤ºæ‰€æœ‰ç”¨æˆ·ï¼Œä¹Ÿå¯ä»¥å†™ç”¨æˆ·åï¼Œå¯¹å•ç‹¬ç”¨æˆ·ç”Ÿæ•ˆ</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æœ‰hardå’Œsoftä¸¤ä¸ªé™åˆ¶ï¼Œ- è¡¨ç¤ºåŒæ—¶è®¾ç½®</span>
</span></span></code></pre></div><p>confæ–‡ä»¶ä¿®æ”¹å®Œæˆåï¼Œå¯åŠ¨æ–°çš„shellä¼šè¯ï¼ˆé‡æ–°sshä¸Šå»ï¼‰ï¼Œè¿™äº›limitå¯¹æ–°çš„shellä¼šè¯å°±ç”Ÿæ•ˆäº†ï¼Œä¸éœ€è¦é‡å¯æœºå™¨å“¦ï¼ˆéœ€è¦é‡æ–°ç™»é™†shellï¼‰</p>
  </div>
  

<div class="navigation navigation-single">
    
    <a href="/posts/responsive-embedded-iframe-hugo-youtueb-vedio/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">å“åº”å¼iframe 16:9â€”hugoåšå®¢åµŒå…¥youtubeè§†é¢‘</span>
    </a>
    
    
    <a href="/posts/use-sync-pool-go/" class="navigation-next">
      <span class="navigation-tittle">goä½¿ç”¨sync.poolå®ç°å¤ç”¨[]byteâ€”â€”é™ä½IOå¯†é›†åº”ç”¨çš„GCé¢‘ç‡</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  


</article>


  </div>
<style>
  .content.container {
        width: 100%;
        max-width: none;
        height: calc(100vh - var(--sidebar-height, 49px));
        border: none;
        display: block;
        overflow-y: auto;
        box-sizing: border-box;
        margin-left: 0;
        margin-right: 0;
  }

  body:not(.type-iframe) .content.container {
        padding-left: max(1.5rem, calc((100% - var(--content-max-width, 38rem)) / 2));
        padding-right: max(1.5rem, calc((100% - var(--content-max-width, 38rem)) / 2));
  }
</style>
<script>
    (function () {
        var contentSelector = '.content.container';
        var rafId = 0;
        var resizeDebounceTimer = 0;
        var pendingHashScroll = false;

        function getHashTarget() {
            var hash = window.location.hash;
            var targetId = '';

            if (!hash || hash === '#') {
                return null;
            }

            targetId = hash.slice(1);
            try {
                targetId = decodeURIComponent(targetId);
            } catch (e) {
                
            }

            return document.getElementById(targetId);
        }

        function scrollToHashTarget() {
            var target = getHashTarget();
            if (!target) {
                return;
            }
            try {
                target.scrollIntoView({ block: 'start', inline: 'nearest' });
            } catch (e) {
                target.scrollIntoView(true);
            }
        }

        function applyPendingHashScroll() {
            if (!pendingHashScroll) {
                return;
            }
            pendingHashScroll = false;
            scrollToHashTarget();
        }

        function resizeContentHeight() {
            var content = document.querySelector(contentSelector);
            if (!content) {
                return;
            }
            var rect = content.getBoundingClientRect();
            var available = window.innerHeight - rect.top;
            if (available < 0) {
                available = 0;
            }
            content.style.height = available + 'px';
            applyPendingHashScroll();
        }

        function scheduleResize() {
            if (rafId) {
                return;
            }
            rafId = window.requestAnimationFrame(function () {
                rafId = 0;
                resizeContentHeight();
            });
        }

        function scheduleResizeDebounced(delay) {
            window.clearTimeout(resizeDebounceTimer);
            resizeDebounceTimer = window.setTimeout(scheduleResize, delay || 120);
        }

        function requestHashScroll() {
            if (!window.location.hash || window.location.hash === '#') {
                return;
            }
            pendingHashScroll = true;
            scheduleResize();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function () {
                scheduleResize();
                requestHashScroll();
            }, { once: true });
        } else {
            scheduleResize();
            requestHashScroll();
        }

        window.addEventListener('load', function () {
            scheduleResize();
            requestHashScroll();
        });
        window.addEventListener('pageshow', function () {
            scheduleResize();
            requestHashScroll();
        });
        window.addEventListener('hashchange', requestHashScroll);
        window.addEventListener('resize', function () {
            scheduleResizeDebounced(120);
        });

        var menuToggle = document.getElementById('menuToggle');
        if (menuToggle) {
            menuToggle.addEventListener('change', function () {
                scheduleResize();
                window.setTimeout(scheduleResize, 250);
            });
        }
    })();
</script>
  
    



<script defer src="/js/all.js" crossorigin="anonymous"></script>

    
    
    <script src="/js/highlight.min.js"></script>
    <script src="/js/languages/dos.min.js"></script>
        
    <script type="text/javascript">
        
        hljs.highlightAll();
    </script>
    

<style>
    .code-block-wrapper {
        position: relative;
    }
    .copy-code-button {
        position: absolute;
        top: 8px;
        right: 8px;
        padding: 6px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.3s, background 0.3s;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .copy-code-button svg {
        width: 16px;
        height: 16px;
        fill: #fff;
        transition: fill 0.3s;
    }
    .code-block-wrapper:hover .copy-code-button {
        opacity: 1;
    }
    .copy-code-button:hover {
        background: rgba(255, 255, 255, 0.2);
    }
    .copy-code-button.copied {
        background: rgba(46, 160, 67, 0.8);
        border-color: rgba(46, 160, 67, 1);
    }
    .copy-code-button.copied svg {
        fill: #fff;
    }
</style>
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
        
        document.querySelectorAll('pre code').forEach(function(codeBlock) {
            var pre = codeBlock.parentNode;
            
            
            if (pre.parentNode.classList.contains('code-block-wrapper')) {
                return;
            }
            
            
            var wrapper = document.createElement('div');
            wrapper.className = 'code-block-wrapper';
            pre.parentNode.insertBefore(wrapper, pre);
            wrapper.appendChild(pre);
            
            
            var button = document.createElement('button');
            button.className = 'copy-code-button';
            button.innerHTML = '<svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path></svg>';
            button.setAttribute('aria-label', 'å¤åˆ¶ä»£ç ');
            button.setAttribute('title', 'å¤åˆ¶ä»£ç ');
            
            var copyIcon = '<svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path></svg>';
            var checkIcon = '<svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16"><path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path></svg>';
            
            
            button.addEventListener('click', function() {
                var code = codeBlock.textContent;
                navigator.clipboard.writeText(code).then(function() {
                    button.innerHTML = checkIcon;
                    button.classList.add('copied');
                    button.setAttribute('aria-label', 'å·²å¤åˆ¶');
                    button.setAttribute('title', 'å·²å¤åˆ¶');
                    setTimeout(function() {
                        button.innerHTML = copyIcon;
                        button.classList.remove('copied');
                        button.setAttribute('aria-label', 'å¤åˆ¶ä»£ç ');
                        button.setAttribute('title', 'å¤åˆ¶ä»£ç ');
                    }, 2000);
                }).catch(function(err) {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                });
            });
            
            wrapper.appendChild(button);
        });
    });
</script>




    



</body>

</html>
