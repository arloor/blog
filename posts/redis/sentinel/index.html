<!DOCTYPE html>
<html lang="zh-CN">

    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    
    <link rel="canonical" href="https://www.arloor.com/posts/redis/sentinel/">
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.157.0">

    
    
    

<title>Rediså“¨å…µå®ç°-sentinel.c â€¢ ARLOOR</title>
<meta name="description" content="ä»Šå¤©ï¼Œä½ å­¦ä¹ äº†å—">
<meta name="keywords" content="åˆ˜æ¸¯æ¬¢, arloor, moontell">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Rediså“¨å…µå®ç°-sentinel.c">
  <meta name="twitter:description" content="è¿™ä¸€ç¯‡è®°å½•ä¸€ä¸‹sentinelçš„æ–‡æ¡£å’Œå®ç°ã€‚çœŸçš„æ˜¯å¥½é•¿çš„ä¸€ç¯‡æ–‡ç« ğŸ˜‚">
      <meta name="twitter:site" content="@njulgh">

<meta property="og:url" content="https://www.arloor.com/posts/redis/sentinel/">
  <meta property="og:site_name" content="ARLOOR">
  <meta property="og:title" content="Rediså“¨å…µå®ç°-sentinel.c">
  <meta property="og:description" content="è¿™ä¸€ç¯‡è®°å½•ä¸€ä¸‹sentinelçš„æ–‡æ¡£å’Œå®ç°ã€‚çœŸçš„æ˜¯å¥½é•¿çš„ä¸€ç¯‡æ–‡ç« ğŸ˜‚">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2019-09-12T18:25:31+08:00">
    <meta property="article:modified_time" content="2019-09-12T18:25:31+08:00">
    <meta property="article:tag" content="Redis">


    





<link rel="stylesheet" href="/styles/atom-one-dark.min.css">








<link rel="stylesheet" href="/scss/hyde-hyde.debf1b963c1830f6b9b96ee48c2b4a22c31c7c3885a87bed290c0e198fc6a08d.css" integrity="sha256-3r8bljwYMPa5uW7kjCtKIsMcfDiFqHvtKQwOGY/GoI0=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">




<link rel="stylesheet" href="/scss/hugo-toc.6b7222b4ddd3cebd47d144a2e37ade6cbbb64f47e31d8feac655896156ade206.css" integrity="sha256-a3IitN3Tzr1H0USi43rebLu2T0fjHY/qxlWJYVat4gY=">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    

</head>



<body class="  ">
  
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="/">
          
          ARLOOR
          
        </a>
      </span>
      <a href="/">
        
        
        <div class="author-image">
          <img src="/img/head.jpeg" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
        
      </a>
      
      <p class="site__description">
         éƒ½æ˜¯çå†™çš„ 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">ARLOOR</label>
      <div class="menu-content menu-content--mobile">
        <div class="show-in-small">
          <a href="/">
            
            
            <div class="author-image">
              <img src="/img/head.jpeg" alt="Author Image"
                class="img--circle img--headshot element--center">
            </div>
            
            
          </a>
        </div>
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>æ–‡ç« </span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/">
						<span>åˆ†ç±»</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>å…³äºæˆ‘</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/grafana-iframe">
						<span>Grafana</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/net-iframe">
						<span>ç½‘é€Ÿç›‘æ§</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/nat">
						<span>NATè§„åˆ™</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/stock">
						<span>è‚¡ç¥¨ç›‘æ§</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://x.com/njulgh" rel="me" target="_blank"><i class="fa-brands fa-x-twitter fa-lg"></i></a>
	
	
	
	
	
	<a href="https://github.com/arloor" rel="me" target="_blank"><i class="fa-brands fa-github fa-lg"></i></a>
	
	
	
	
	
	
	
	
	
	
	
	
	
	<a href="https://t.me/never_contact_me" rel="me" target="_blank"><i class="fa-brands fa-telegram fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="mailto:admin@arloor.com" rel="me" target="_blank"><i class="fa-solid fa-at fa-lg"></i></a>
	
	
	
	
</section>
      </div>
    </div>
    <div class="menu-content menu-content--desktop">
      <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>æ–‡ç« </span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/">
						<span>åˆ†ç±»</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>å…³äºæˆ‘</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/grafana-iframe">
						<span>Grafana</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/net-iframe">
						<span>ç½‘é€Ÿç›‘æ§</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/nat">
						<span>NATè§„åˆ™</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/stock">
						<span>è‚¡ç¥¨ç›‘æ§</span>
					</a>
				</li>
			 
		
	</ul>
</div>

    </div>
    <div class="social-wrap social-wrap--desktop">
      <section class="social">
	
	<a href="https://x.com/njulgh" rel="me" target="_blank"><i class="fa-brands fa-x-twitter fa-lg"></i></a>
	
	
	
	
	
	<a href="https://github.com/arloor" rel="me" target="_blank"><i class="fa-brands fa-github fa-lg"></i></a>
	
	
	
	
	
	
	
	
	
	
	
	
	
	<a href="https://t.me/never_contact_me" rel="me" target="_blank"><i class="fa-brands fa-telegram fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="mailto:admin@arloor.com" rel="me" target="_blank"><i class="fa-solid fa-at fa-lg"></i></a>
	
	
	
	
</section>
    </div>
    
<div class="copyright">
  &copy; 2026 arloor
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>


<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> â¤ï¸ <a href="https://github.com/arloor/hyde-arloor">hyde-arloor</a>.
</div>


  </div>
</div>

  <div class="content container">
    
    
<article>
  <header>
    <h1>Rediså“¨å…µå®ç°-sentinel.c</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Sep 12, 2019
    
    
    
      
      
          in
          
          
              <a class="badge badge-category" href="/categories/redis">REDIS</a>
              
          
      
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/redis">redis</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 18 min read
</div>


  </header>
  
  
  
    <div class="toc-wrapper">
      <input type="checkbox" id="tocToggle">
      <label for="tocToggle">Table of Content</label>
      
          <nav id="TableOfContents">
  <ul>
    <li><a href="#sentinelå·¥ä½œæµç¨‹">sentinelå·¥ä½œæµç¨‹</a></li>
    <li><a href="#æ¨¡æ‹Ÿsentinelæ•…éšœè¿ç§»è¿‡ç¨‹">æ¨¡æ‹Ÿsentinelæ•…éšœè¿ç§»è¿‡ç¨‹</a></li>
    <li><a href="#sdownäº‹ä»¶å’Œodownäº‹ä»¶">SDOWNäº‹ä»¶å’ŒODOWNäº‹ä»¶</a></li>
    <li><a href="#sentinelå’Œsalveè‡ªåŠ¨å‘ç°æœºåˆ¶">sentinelå’Œsalveè‡ªåŠ¨å‘ç°æœºåˆ¶</a></li>
    <li><a href="#sentinelä¸»åŠ¨é‡æ–°é…ç½®è¢«ç›‘æ§redisèŠ‚ç‚¹">sentinelä¸»åŠ¨é‡æ–°é…ç½®è¢«ç›‘æ§redisèŠ‚ç‚¹</a></li>
    <li><a href="#ä»èŠ‚ç‚¹é€‰ä¸¾åŠå…¶ä¼˜å…ˆçº§">ä»èŠ‚ç‚¹é€‰ä¸¾åŠå…¶ä¼˜å…ˆçº§</a></li>
    <li><a href="#é…ç½®çºªå…ƒepochs">é…ç½®çºªå…ƒï¼ˆepochsï¼‰</a></li>
    <li><a href="#é…ç½®ä¿¡æ¯ä¼ æ’­">é…ç½®ä¿¡æ¯ä¼ æ’­</a></li>
    <li><a href="#tiltæ¨¡å¼">TILTæ¨¡å¼</a></li>
  </ul>

  <ul>
    <li><a href="#tiltæ¨¡å¼å®ç°">TILTæ¨¡å¼å®ç°</a></li>
    <li><a href="#sentinelé€šçŸ¥å®ç°">Sentinelé€šçŸ¥å®ç°</a></li>
    <li><a href="#sentinelç›‘æ§å®ç°">Sentinelç›‘æ§å®ç°</a></li>
    <li><a href="#è‡ªåŠ¨æ•…éšœè¿ç§»å®ç°">è‡ªåŠ¨æ•…éšœè¿ç§»å®ç°</a></li>
  </ul>
</nav>
      
    </div>
  
  
  <div class="post">
    <p>è¿™ä¸€ç¯‡è®°å½•ä¸€ä¸‹sentinelçš„æ–‡æ¡£å’Œå®ç°ã€‚çœŸçš„æ˜¯å¥½é•¿çš„ä¸€ç¯‡æ–‡ç« ğŸ˜‚</p>
<h1 id="å®˜æ–¹æ–‡æ¡£">å®˜æ–¹æ–‡æ¡£</h1>
<p>sentinelæ˜¯rediså®˜æ–¹é«˜å¯ç”¨æ–¹æ¡ˆï¼Œä»å®è§‚è§’åº¦çœ‹ï¼Œsentinelæä¾›ä»¥ä¸‹èƒ½åŠ›ã€‚</p>
<ul>
<li><strong>ç›‘æ§</strong>ï¼š æŒç»­æ£€æµ‹ä¸»ä»èŠ‚ç‚¹æ˜¯å¦æ­£å¸¸å·¥ä½œ</li>
<li><strong>é€šçŸ¥</strong>ï¼š sentinelå¯ä»¥é€šè¿‡è°ƒç”¨notification_scriptå‘ç³»ç»Ÿç®¡ç†å‘˜æŠ¥å‘Šäº‹ä»¶</li>
<li><strong>è‡ªåŠ¨æ•…éšœè½¬ç§»</strong>ï¼š å¦‚æœä¸»èŠ‚ç‚¹ä¸èƒ½æ­£å¸¸å·¥ä½œï¼Œsentinelä¼šæå‡å…¶ä»–ä»èŠ‚ç‚¹ä¸ºä¸»èŠ‚ç‚¹ï¼Œå¹¶é€šçŸ¥å®¢æˆ·ç«¯æ–°ä¸»èŠ‚ç‚¹çš„åœ°å€ã€‚</li>
<li><strong>é…ç½®æä¾›</strong>ï¼šå‘ŠçŸ¥å®¢æˆ·ç«¯ä¸»èŠ‚ç‚¹çš„åœ°å€</li>
</ul>
<p>reids Sentinelä»¥é›†ç¾¤ã€åˆ†å¸ƒå¼çš„æ–¹å¼è¿è¡Œã€‚è¿™æ ·çš„å¥½å¤„ï¼š</p>
<ol>
<li>åªæœ‰å¤šä¸ªsentinelè®¤ä¸ºä¸»èŠ‚ç‚¹ä¸»è§‚ä¸‹çº¿ï¼Œè¯¥ä¸»èŠ‚ç‚¹æ‰ä¼šè¢«åˆ¤å®šå®¢è§‚ä¸‹çº¿â€”â€”é™ä½äº†è¯¯åˆ¤å‡ ç‡</li>
<li>å½“å•ä¸ªsentinelæ•…éšœæ—¶ï¼Œå…¶ä»–sentinelèŠ‚ç‚¹ä»èƒ½æ­£å¸¸è¿›è¡Œæ•…éšœè¿ç§»â€”â€”æ•…éšœè¿ç§»æ§åˆ¶ç³»ç»Ÿæœ¬èº«é¢ä¸´å•ç‚¹é—®é¢˜æ˜¯å¾ˆå‚»çš„ã€‚</li>
</ol>
<p>å¯åŠ¨sentinelå¿…é¡»è¦æä¾›é…ç½®æ–‡ä»¶ï¼Œè¯¥é…ç½®æ–‡ä»¶ä¼šè¢«sentinelè¿›ç¨‹é‡å†™ï¼Œæ‰€ä»¥è¦æä¾›å†™æƒé™ã€‚è‡³å°‘éœ€è¦ä¸‰å°sentinelå®ä¾‹æ‰èƒ½ä¿è¯å¥å£®æ€§(redisæä¾›äº†å‡ ç§æ¨èçš„éƒ¨ç½²æ–¹å¼)ã€‚é…ç½®æ–‡ä»¶ä»…éœ€è¦æŒ‡å®šè‡ªå·±ç›‘æ§çš„masterï¼ˆä»¬ï¼‰ï¼Œè€Œä¸éœ€è¦æŒ‡å®šç›¸å…³çš„slavesã€‚sentinelä¼šè‡ªåŠ¨åœ°è·å–slaveä¿¡æ¯ã€‚è¿™ä»½é…ç½®æ–‡ä»¶ä¼šåœ¨ä»èŠ‚ç‚¹æˆä¸ºä¸»èŠ‚ç‚¹æˆ–æ–°çš„sentinelè¢«å‘ç°æ—¶è¢«sentinelä¿®æ”¹ã€‚</p>
<h2 id="sentinelå·¥ä½œæµç¨‹">sentinelå·¥ä½œæµç¨‹</h2>
<ol>
<li>sentinelå¯åŠ¨ï¼ŒæŒ‡å®š<code>sentinel monitor &lt;master-group-name&gt; &lt;ip&gt; &lt;port&gt; &lt;quorum&gt;</code>â€”â€”quorumæ˜¯ä¸€ä¸ªæ•°å­—</li>
<li>å½“ä¸€ä¸ªsentinelå¾—çŸ¥æœ‰å¤§äºç­‰äºquorumä¸ªsentinelè®¤ä¸ºè¯¥ä¸»èŠ‚ç‚¹æ‰çº¿æ—¶ï¼Œè¯¥èŠ‚ç‚¹ä¼šå°è¯•è¿›è¡Œæ•…éšœè½¬ç§»ï¼ˆæå‡ä»èŠ‚ç‚¹ï¼‰</li>
<li>sentineléœ€è¦è¢«å¤§å¤šæ•°sentinelé€‰ä¸¾ä¸ºleaderåæ‰æœ‰æƒè¿›è¡Œæ•…éšœè¿ç§»â€”â€”ç½‘ç»œåˆ†åŒºæ—¶ï¼Œå°åˆ†åŒºçš„sentinelä¸å¯èƒ½æ‰§è¡Œæ•…éšœè¿ç§»/å¦‚æœå¤§å¤šæ•°sentinelä¸èƒ½é€šä¿¡ï¼Œåˆ™ä¸å¯èƒ½å‘ç”Ÿæ•…éšœè¿ç§»</li>
</ol>
<h2 id="æ¨¡æ‹Ÿsentinelæ•…éšœè¿ç§»è¿‡ç¨‹">æ¨¡æ‹Ÿsentinelæ•…éšœè¿ç§»è¿‡ç¨‹</h2>
<p>ä½¿ç”¨<code>redis-cli -p 6379 DEBUG sleep 30</code>æ¨¡æ‹Ÿä¸»èŠ‚ç‚¹å®•æœºä¸‰åç§’ã€‚ä¼šå‡ºç°ä»¥ä¸‹è¿‡ç¨‹</p>
<ol>
<li>æ¯ä¸ªsentineléƒ½åˆ¤å®šè¯¥ä¸»èŠ‚ç‚¹ä¸º+sdownï¼ˆä¸»è§‚å®•æœºï¼‰</li>
<li>æœ€ç»ˆè¯¥ä¸»è§‚å®•æœºè¢«ç¡®è®¤ä¸º+odownï¼ˆå®¢è§‚å®•æœºï¼‰â€”â€”å¤šä¸ªsentinelåˆ¤å®šå…¶ä¸ºä¸»è§‚å®•æœº</li>
<li>ä¸€ä¸ªsentinelè¢«å¤§éƒ¨åˆ†sentinelæŠ•ç¥¨æ¥æ‰§è¡Œæ•…éšœè¿ç§»</li>
<li>æ”¹sentinelæ‰§è¡Œæ•…éšœè¿ç§»</li>
</ol>
<h2 id="sdownäº‹ä»¶å’Œodownäº‹ä»¶">SDOWNäº‹ä»¶å’ŒODOWNäº‹ä»¶</h2>
<p>SDOWNæ˜¯ä¸»è§‚å®•æœºï¼Œå³sentinelè‡ªå·±è®¤ä¸ºæŸmasterå®•æœºã€‚<br>
ODWONæ˜¯å®¢è§‚å®•æœºï¼Œå³å¤§äºç­‰äºquorumä¸ªsentineléƒ½è®¤ä¸ºè¯¥masterå®•æœºâ€”â€”æ­¤æ—¶æ‰å¯æ•…éšœã€‚</p>
<p>åœ¨sentinelå‘masterå‘é€PINGåï¼Œè¶…è¿‡<code>is-master-down-after-milliseconds</code>æ¯«ç§’ä»æœªæ”¶åˆ°æœ‰æ•ˆçš„å“åº”ï¼ˆ+PONGã€-LOADINGã€-MASTERDOWNï¼‰ï¼Œåˆ™sentinelè®°å½•masterçš„çŠ¶æ€ä¸ºSDOWNã€‚</p>
<p>ä»SDOWNåˆ°ODOWNçŠ¶æ€çš„è½¬æ¢æ²¡æœ‰ä½¿ç”¨å¼ºä¸€è‡´æ€§åè®®ï¼Œè€Œæ˜¯ä¸€ç§gossipï¼ˆæµè¨€èœšè¯­ï¼‰åè®®â€”â€”åªè¦ä¸€ä¸ªsentinelè¢«è¶³å¤Ÿæ•°é‡çš„sentinelå‘ŠçŸ¥masterå¤„äºSDOWNï¼Œåˆ™è¯¥sentinelæ ‡è®°å…¶ä¸ºODOWNï¼Œå¹¶å¼€å§‹é€‰ä¸¾ä»è€Œæ‰§è¡Œæ•…éšœè¿ç§»ã€‚</p>
<p>ODOWNåªé€‚ç”¨äºmasterï¼Œè€Œslaveå’ŒsentinelèŠ‚ç‚¹è¿˜æœ‰SDOWNçŠ¶æ€ã€‚<strong>è¢«æ ‡è®°ä¸ºSDOWNçš„ä»èŠ‚ç‚¹ä¸ä¼šè¢«é€‰ä¸¾ä¸ºä¸»èŠ‚ç‚¹ã€‚</strong></p>
<h2 id="sentinelå’Œsalveè‡ªåŠ¨å‘ç°æœºåˆ¶">sentinelå’Œsalveè‡ªåŠ¨å‘ç°æœºåˆ¶</h2>
<p>é¦–å…ˆï¼Œsentinelä»…éœ€è¦é…ç½®ç›‘æµ‹çš„masterè€Œä¸éœ€è¦é…ç½®slavesï¼Œsentinelä¼šè‡ªåŠ¨çš„å‘masteræŸ¥è¯¢slaveä¿¡æ¯ã€‚</p>
<p>å…¶æ¬¡ï¼Œsentinelä¼šåˆ©ç”¨redisçš„å‘å¸ƒè®¢é˜…åŠŸèƒ½æ¥å®ç°è‡ªåŠ¨å‘ç°ã€‚æ‰€æœ‰çš„sentineléƒ½ä¼šè¿æ¥åˆ°æ‰€æœ‰masterå’Œslaveçš„<code> __sentinel__:hello</code>é¢‘é“ï¼Œæ¯ä¸¤åˆ†é’Ÿå‘å¸ƒä¸€æ¡å¸¦æœ‰ipã€portã€runidçš„æ¶ˆæ¯ã€‚æ‰€æœ‰sentineléƒ½ä¼šæ”¶åˆ°è¿™ä¸ªæ¶ˆæ¯ï¼Œè¿™ä¸ªæ¶ˆæ¯æºå¸¦ä¸»èŠ‚ç‚¹çš„é…ç½®ä¿¡æ¯ï¼Œå¦‚æœè‡ªèº«ä¿å­˜çš„masteré…ç½®ä¿¡æ¯æ—§äºæ”¶åˆ°çš„ï¼Œåˆ™ç«‹å³æ›´æ–°ã€‚å¦‚æœæ”¶åˆ°çš„sentinel helloæ¶ˆæ¯æºå¸¦çš„runidæˆ–åœ°å€ä¿¡æ¯å·²ç»å­˜åœ¨ï¼Œåˆ™åˆ é™¤è‡ªèº«ä¿å­˜çš„æ—§çš„sentinelï¼Œæ›¿æ¢ä¸ºæ–°çš„è¿™ä¸ªã€‚</p>
<p>æ³¨æ„ï¼šsentinelä¸ä¼šä¸»åŠ¨åˆ é™¤ï¼ˆforgetï¼‰è‡ªèº«ä¿å­˜çš„å…¶ä»–sentinelæˆ–slaveä¿¡æ¯ï¼Œéœ€è¦æ‰‹åŠ¨ä»¥30ç§’é—´éš”çš„æ–¹å¼å¯¹æ¯ä¸ªsentinelæ‰§è¡Œ<code>sentinel reset &lt;maste rname&gt;</code>ï¼Œè¯¦æƒ…è¯·è§redisæ–‡æ¡£ã€‚</p>
<h2 id="sentinelä¸»åŠ¨é‡æ–°é…ç½®è¢«ç›‘æ§redisèŠ‚ç‚¹">sentinelä¸»åŠ¨é‡æ–°é…ç½®è¢«ç›‘æ§redisèŠ‚ç‚¹</h2>
<p>ä¸»åŠ¨é‡æ–°é…ç½®çš„ä¸»è¦ç›®çš„æ˜¯çº æ­£redisä»èŠ‚ç‚¹çš„é”™è¯¯é…ç½®ã€‚å…·ä½“å¦‚ä¸‹ï¼š</p>
<ol>
<li>è®¤ä¸ºè‡ªå·±æ˜¯ä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ï¼ˆå‘ç”Ÿæ•…éšœè½¬ç§»ï¼Œè¢«é™çº§ä¸ºä»èŠ‚ç‚¹ï¼‰å°†ä¼šè¢«é‡é…ç½®ä¸ºæ‹·è´æ­£ç¡®çš„ä¸»èŠ‚ç‚¹ï¼ˆæˆä¸ºä»–çš„ä»èŠ‚ç‚¹ï¼‰</li>
<li>æ‹·è´æ—§ä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ï¼Œå°†ä¼šè¢«é‡æ–°é…ç½®ä¸ºæ‹·è´æ–°ä¸»èŠ‚ç‚¹ã€‚</li>
</ol>
<p>ä¸ºäº†é˜²æ­¢sentinelè¿‡æœŸçš„çŸ¥è¯†é”™è¯¯åœ°é…ç½®ä»èŠ‚ç‚¹ï¼Œåœ¨çœŸæ­£è¿›è¡Œé‡é…ç½®å‰ï¼Œä¼šç­‰å¾…ä¸€æ®µæ—¶é—´çœ‹çœ‹å…¶ä»–sentinelä¼šä¸ä¼šä¼ æ’­æ–°çš„é…ç½®ä¿¡æ¯ï¼Œä»¥ç¡®ä¿æœ¬sentinelæœ¬èº«ä¿¡æ¯è¶³å¤Ÿæ–°ã€‚</p>
<p>è¿™ç§é‡é…ç½®ä¿è¯äº†ä¸»ä»æ¶æ„åœ¨ç½‘ç»œåˆ†åŒºå‰åçš„å¥å£®æ€§ï¼š</p>
<ol>
<li>è¢«æ•…éšœè¿ç§»é™ä¸ºä»èŠ‚ç‚¹çš„æ—§ä¸»èŠ‚ç‚¹ä¼šé‡æ–°é…ç½®ä¸ºä»èŠ‚ç‚¹</li>
<li>ä»èŠ‚ç‚¹åœ¨ç½‘ç»œåˆ†åŒºæ¢å¤åï¼Œä¼šè¢«é‡æ–°é…ç½®ä¸ºæ‹·è´æ–°çš„ä¸»èŠ‚ç‚¹</li>
</ol>
<h2 id="ä»èŠ‚ç‚¹é€‰ä¸¾åŠå…¶ä¼˜å…ˆçº§">ä»èŠ‚ç‚¹é€‰ä¸¾åŠå…¶ä¼˜å…ˆçº§</h2>
<p>å½“sentinelç¡®è®¤masterä¸ºODOWNçŠ¶æ€ï¼Œä¸”è·å¾—å¤§å¤šæ•°sentinelæˆæƒæ¥æ‰§è¡Œæ•…éšœè¿ç§»æ—¶ï¼Œå°±ä¼šæŒ‘é€‰åˆé€‚çš„ä»èŠ‚ç‚¹æˆä¸ºä¸»èŠ‚ç‚¹ã€‚sentinelä¼šä»ä»¥ä¸‹å‡ ä¸ªç»´åº¦æŒ‘é€‰ï¼šï¼ˆè‹±æ–‡æ›´åˆ©äºç†è§£ï¼‰</p>
<ol>
<li>Disconnection time from the master.</li>
<li>Slave priority.</li>
<li>Replication offset processed. â€”â€”å¼‚æ­¥æ‹·è´æ¥æ”¶çš„æ•°æ®é‡</li>
<li>Run ID. ï¼ˆå½“ä¸»èŠ‚ç‚¹æŒ‚äº†ï¼Œä»èŠ‚ç‚¹çš„Run idå·²ç»å˜ä¸ºè‡ªå·±çš„ï¼Œè€Œä¸æ˜¯ä¸ä¸»èŠ‚ç‚¹ç›¸åŒï¼‰</li>
</ol>
<p>è¿™äº›ä¿¡æ¯éƒ½å¯ä»¥å¯¹slaveèŠ‚ç‚¹æ‰§è¡Œ<code>info replication</code>è¿›è¡ŒæŸ¥çœ‹ã€‚</p>
<ol>
<li>é¦–å…ˆ æ–­å¼€æ—¶é—´å¤§äºç‰¹å®šæ—¶é•¿çš„ä»èŠ‚ç‚¹æ²¡æœ‰èµ„æ ¼ã€‚</li>
<li>å…¶æ¬¡æ£€æŸ¥slave priorityï¼Œæ•°å­—å°çš„ä¼˜å…ˆã€‚ä¸º0åˆ™ä¸ä¼šè¢«é€‰æ‹©</li>
<li>å†å…¶æ¬¡ï¼Œreplication offsetå¤§çš„ä¼˜å…ˆã€‚</li>
<li>å¦‚æœä»¥ä¸Šéƒ½ç›¸åŒï¼Œåˆ™é€‰æ‹©runidå°çš„ä»èŠ‚ç‚¹â€”â€”è¿™æ ·å®‰æ’æ¯”éšæœºé€‰æ‹©ä¸€ä¸ªæ›´åŠ æœ‰ç§©åºã€‚</li>
</ol>
<h2 id="é…ç½®çºªå…ƒepochs">é…ç½®çºªå…ƒï¼ˆepochsï¼‰</h2>
<p>å½“ä¸€ä¸ªsentinelè¢«æˆæƒè¿›è¡Œæ•…éšœè¿ç§»æ—¶ï¼Œä»–ä¼šè·å¾—ä¸€ä¸ª<strong>configuration epoch</strong>ï¼Œç”¨äºæ ‡è®°é…ç½®ä¿¡æ¯çš„ç‰ˆæœ¬ã€‚â€”â€”æ¯ä¸€æ¬¡æ•…éšœè¿ç§»æ‰€ä½¿ç”¨çš„é…ç½®ä¿¡æ¯éƒ½å¯¹åº”ä¸€ä¸ªé…ç½®çºªå…ƒã€‚</p>
<p>æ•…éšœè¿ç§»å…·æœ‰è¿™æ ·ä¸€ä¸ªè§„åˆ™ï¼šå…¶ä»–sentinelä¼šç­‰å¾…è¢«æˆæƒçš„sentinel failover-timeoutçš„æ—¶é—´è¿›è¡Œæ•…éšœè¿ç§»ï¼Œä¹‹åè‡ªå·±æ‰ä¼šå°è¯•failoverã€‚è¿™ä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªsentinelåœ¨è¿›è¡Œæ•…éšœè¿ç§»ã€‚</p>
<h2 id="é…ç½®ä¿¡æ¯ä¼ æ’­">é…ç½®ä¿¡æ¯ä¼ æ’­</h2>
<p>sentinelä¼šåœ¨__sentinel__:hello é¢‘é“ä¸­ä¼ æ’­è‡ªå·±æŒæœ‰çš„é…ç½®ä¿¡æ¯å’Œé…ç½®çºªå…ƒï¼Œå‰æ–‡æåˆ°ï¼Œæ‰€æœ‰sentineléƒ½ä¼šè¿æ¥åˆ°ä¸»ä»èŠ‚ç‚¹çš„__sentinel__:helloã€‚æ›´æ–°çš„é…ç½®ä¿¡æ¯æœ‰æ›´æ–°çš„é…ç½®çºªå…ƒï¼Œå½“sentinelæ”¶åˆ°æ›´æ–°çš„é…ç½®çºªå…ƒæ—¶ï¼Œä¼šæ›´æ–°è‡ªå·±çš„é…ç½®ä¿¡æ¯ã€‚â€”â€”è¿™ç¡®ä¿äº†sentinelä»¬åªè®¤å¯ä¸€ä»½é…ç½®ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯åªè®¤å¯ä¸€ä¸ªä¸»èŠ‚ç‚¹ã€‚</p>
<p><strong>sentinelçš„é…ç½®ä¿¡æ¯ä¼šæºå¸¦é…ç½®çºªå…ƒä¸€åŒè¿›è¡ŒæŒä¹…åŒ–</strong>ï¼Œæ‰€ä»¥é‡å¯ä¸ä¼šä¸¢å¤±çŠ¶æ€</p>
<h2 id="tiltæ¨¡å¼">TILTæ¨¡å¼</h2>
<p>sentinelé‡åº¦ä¾èµ–è®¡ç®—æœºæ—¶é—´ï¼Œå› ä¸ºä»–ä¼šè®°å½•å„ç§æ—¶é—´ï¼Œä¾èµ–è¶…æ—¶æœºåˆ¶è¿›è¡Œå†³ç­–ã€‚å¦‚æœè®¡ç®—æœºæ—¶é—´å¼‚å¸¸æ”¹å˜ã€è®¡ç®—æœºè¿‡å¿™æˆ–è€…è¿›ç¨‹è¢«blockä¸€æ®µæ—¶é—´ï¼Œsentinelå¯èƒ½ä¼šå‡ºç°å¼‚å¸¸çš„è¡¨ç°ã€‚</p>
<p>TITLå°±æ˜¯åœ¨å‘ç”Ÿä¸Šè¿°æƒ…å†µæ—¶çš„ä¸€ç§ä¿æŠ¤çŠ¶æ€ã€‚sentinelä¼šè¿›è¡Œå‘¨æœŸä¸­æ–­ï¼Œæ¯åç§’è¿›è¡Œä¸€æ¬¡ï¼Œå› æ­¤ä¸¤æ¬¡ä¸­æ–­çš„é—´éš”å¤§çº¦ä¸º100msï¼Œå¦‚æœè¿™ä¸ªæ—¶é—´å·®ä¸ºè´Ÿï¼Œæˆ–è€…å¤ªå¤§ï¼ˆ&gt;=2ç§’ï¼‰ï¼Œå°±ä¼šè¿›å…¥TILTæ¨¡å¼ã€‚</p>
<p>åœ¨TILTæ¨¡å¼ä¸­ï¼Œsentinelä»ç„¶è¿›è¡Œç›‘æ§ï¼Œä½†ä¸ä¼šè¿›è¡Œæ“ä½œã€‚å› ä¸ºæ—¶é—´å˜å¾—ä¸å¯ä¿¡ï¼Œæ‰€ä»¥sentinelä¾èµ–æ—¶é—´çš„çŠ¶æ€ç›‘æ§ä¹Ÿä¸å†å¯ä¿¡ã€‚å¦‚æœæ¢å¤æ­£å¸¸è¶…è¿‡30sï¼ŒTITLæ¨¡å¼é€€å‡ºã€‚</p>
<h1 id="å®ç°">å®ç°</h1>
<p>å¦‚æœrediså®ä¾‹ä¸ºsentinelæ¨¡å¼ï¼Œåˆ™serverCronå‡½æ•°ä¼šæ‰§è¡ŒsentinelTimerå‡½æ•°ã€‚sentinelTimerå‡½æ•°å‘¨æœŸæ€§æ‰§è¡Œï¼Œåšä»¥ä¸‹å‡ ä»¶äº‹æƒ…ï¼š</p>
<ol>
<li>sentinelCheckTiltCondition()ï¼šåˆ¤æ–­ç³»ç»Ÿæ—¶é—´æ˜¯å¦å‡ºç°å¼‚å¸¸ï¼Œå†³å®šæ˜¯å¦è¿›å…¥TILTæ¨¡å¼</li>
<li>sentinelHandleDictOfRedisInstances(sentinel.masters)ï¼š
<ol>
<li>éå†æ‰€æœ‰èŠ‚ç‚¹ï¼Œhandleæ¯ä¸ªèŠ‚ç‚¹ï¼Œåˆ†ä¸ºmonitoringå’Œactingä¸¤éƒ¨åˆ†å·¥ä½œâ€”â€”å¦‚æœåœ¨TILTæ¨¡å¼ï¼Œåˆ™ä¸åšactingå·¥ä½œï¼›</li>
<li>å¦‚æœå½“å‰åœ¨TILTæ¨¡å¼ï¼Œä¸”ç³»ç»Ÿæ—¶é—´å›å¤æ­£å¸¸åˆ™é€€å‡ºTILTæ¨¡å¼ï¼›</li>
<li>å¦‚æœæŸä¸ªä¸»èŠ‚ç‚¹çš„failover_stateä¸ºSENTINEL_FAILOVER_STATE_UPDATE_CONFIGï¼Œåˆ™æ‰§è¡Œ+switch-masteräº‹ä»¶ã€‚</li>
</ol>
</li>
</ol>
<h2 id="tiltæ¨¡å¼å®ç°">TILTæ¨¡å¼å®ç°</h2>
<p>TILTæ¨¡å¼å°±åƒä¸€ä¸ªè‡ªåŠ¨å¼€å…³ï¼Œæ ¹æ®ç³»ç»Ÿæ—¶é—´æ˜¯å¦æ­£å¸¸å†³å®šæ˜¯å¦æ‰§è¡Œä¸»è§‚ä¸‹çº¿ã€å®¢è§‚ä¸‹çº¿ã€failoverè¿™äº›actingã€‚</p>
<p><strong>è¿›å…¥TILTæ¨¡å¼</strong></p>
<p>åˆ¤æ–­æ˜¯å¦è¿›å…¥TILTæ¨¡å¼åœ¨sentinelTimerå‡½æ•°å¼€å¤´çš„sentinelCheckTiltCondition();</p>
<pre tabindex="0"><code>    //deltaä¸ºå½“å‰æ—¶é—´ä¸ä¸Šæ¬¡æ—¶é—´ä¹‹å·®
    if (delta &lt; 0 || delta &gt; SENTINEL_TILT_TRIGGER) {
        sentinel.tilt = 1;
        sentinel.tilt_start_time = mstime();
        sentinelEvent(LL_WARNING,&#34;+tilt&#34;,NULL,&#34;#tilt mode entered&#34;);
    }
</code></pre><p>å¦‚æœdeltaä¸ºè´Ÿï¼Œæˆ–è€…è¿‡å¤§ï¼Œè¯´æ˜åœ¨ä¸¤æ¬¡sentinelTimerçš„æ‰§è¡Œé—´éš”ä¸­ï¼Œç³»ç»Ÿæ—¶é—´è¢«å¼‚å¸¸åœ°ä¿®æ”¹ï¼Œæ—¶é—´ä¸å†å¯ä¿¡ï¼Œè¿›å…¥TILTæ¨¡å¼ï¼Œåªåšç›‘æ§ï¼Œä¸åšacting</p>
<p><strong>é€€å‡ºTILTæ¨¡å¼</strong></p>
<p>åœ¨handleæ¯ä¸ªèŠ‚ç‚¹çš„actingéƒ¨åˆ†çš„å¼€å§‹ï¼Œéƒ½ä¼šæ£€æŸ¥æ˜¯å¦åœ¨TILTæ¨¡å¼ä¸­ï¼Œå¦‚æœåœ¨åˆ™åˆ¤æ–­èƒ½å¦é€€å‡ºã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (sentinel.tilt) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">mstime</span>()<span style="color:#f92672">-</span>sentinel.tilt_start_time <span style="color:#f92672">&lt;</span> SENTINEL_TILT_PERIOD) <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>        sentinel.tilt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sentinelEvent</span>(LL_WARNING,<span style="color:#e6db74">&#34;-tilt&#34;</span>,NULL,<span style="color:#e6db74">&#34;#tilt mode exited&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>å¦‚æœåœ¨è¿™é‡Œèƒ½å¤Ÿé€€å‡ºTILTæ¨¡å¼ï¼Œåˆ™ç»§ç»­æ‰§è¡Œå¯¹ç»™èŠ‚ç‚¹çš„actingéƒ¨åˆ†ã€‚</p>
<h2 id="sentinelé€šçŸ¥å®ç°">Sentinelé€šçŸ¥å®ç°</h2>
<p>Sentinelé€šçŸ¥ä¸»è¦é€šè¿‡å‘å¸ƒè®¢é˜…å’Œnotification_scriptså®ç°ã€‚å…¶å®ç°åœ¨</p>
<pre tabindex="0"><code>void sentinelEvent(int level, char *type, sentinelRedisInstance *ri,
                   const char *fmt, ...)
</code></pre><p>è¿™å¾ˆåƒä¸€ä¸ªlogå‡½æ•°çš„å£°æ˜ï¼Œlevelæœ‰LL_DEBUGã€LL_NOTICEã€LL_WARNINGç­‰ã€‚LL_WARNINGç­‰çº§çš„äº‹ä»¶ä¼šè°ƒç”¨notification_scriptsè¿›è¡Œé€šçŸ¥ï¼›éDEBUGç­‰çº§çš„äº‹ä»¶ä¼šé€šè¿‡åä¸ºtypeå‚æ•°çš„å‘å¸ƒè®¢é˜…é¢‘é“è¿›è¡Œé€šçŸ¥ã€‚</p>
<h2 id="sentinelç›‘æ§å®ç°">Sentinelç›‘æ§å®ç°</h2>
<p>Sentinelçš„ç›‘æ§å®ç°åœ¨<code>sentinelHandleRedisInstance</code>å‡½æ•°ï¼ˆhandleå•ä¸ªrediså®ä¾‹ï¼‰çš„monitoringéƒ¨åˆ†ã€‚</p>
<p>ä¸€ä¸ªsentinelå®ä¾‹åˆ°å…¶ä»–æ¯ä¸ªèŠ‚ç‚¹ï¼ˆmasterã€slaveã€sentinelï¼‰éƒ½æœ‰ä¸¤æ¡tcpè¿æ¥â€”â€”å‘½ä»¤ä¼ è¾“è¿æ¥å’Œå‘å¸ƒè®¢é˜…è¿æ¥ã€‚monitoringéƒ¨åˆ†é¦–å…ˆä¼šä¿®å¤è¯¥ä¸¤æ¡è¿æ¥ï¼Œå¦‚æœæ–­å¼€åˆ™é‡å»ºè¯¥ä¸¤æ¡è¿æ¥ã€‚</p>
<p>ç›‘æ§çš„å®ç°ä¸»è¦ä¾èµ–INFOã€PINGå‘½ä»¤å’Œå‘å¸ƒhelloæ¶ˆæ¯åˆ°<code>__sentinel__:hello</code>é¢‘é“ã€‚INFOã€PINGå‘½ä»¤é€šè¿‡å‘½ä»¤ä¼ è¾“è¿æ¥ï¼Œhelloæ¶ˆæ¯é€šè¿‡å‘å¸ƒè®¢é˜…è¿æ¥ã€‚æ‰€æœ‰è¿™äº›å‘½ä»¤éƒ½æ˜¯é€šè¿‡å¼‚æ­¥å›è°ƒçš„æ–¹å¼æ‰§è¡Œçš„ã€‚redisä¿æŒä¸€ä¸ªpending_commandså˜é‡æ¥è®¡ç®—å·²å‘å‡ºä½†æœªæ”¶åˆ°å“åº”çš„å‘½ä»¤æ•°é‡ã€‚å¦‚æœè¯¥æ•°é‡å¤ªå¤§ï¼Œåˆ™ä¸å†å‘é€æ–°çš„ç›‘æ§å‘½ä»¤</p>
<p><strong>PINGåŠå…¶å›è°ƒ</strong></p>
<p>PINGä¼šå‘é€ç»™æ‰€æœ‰rediså®ä¾‹ï¼ˆmasterã€slaveã€sentinelï¼‰ï¼Œå…¶é€šè¿‡<code>sentinelSendPing</code>å‡½æ•°å®ç°ã€‚ä»–ä¼šæ›´æ–°last_ping_timeä¸ºå½“å‰æ—¶é—´ï¼›åŒæ—¶ï¼Œå¦‚æœact_ping_timeä¸º0ï¼ˆæ„å‘³ç€æ”¶åˆ°äº†ä¸Šä¸€æ¬¡pingçš„pongï¼‰ï¼Œåˆ™ä¹Ÿæ›´æ–°act_ping_timeä¸ºå½“å‰æ—¶é—´ã€‚æ‰§è¡Œpingï¼Œpending_commandsä¼šç´¯åŠ ä¸€ã€‚</p>
<p>PINGå‘½ä»¤æ”¶åˆ°å“åº”çš„å›è°ƒå‡½æ•°ä¸º<code>sentinelPingReplyCallback</code>ã€‚å…¶ä¼šå¯¹pending_commandså‡ä¸€ï¼ŒåŒæ—¶æ›´æ–°last_pong_timeä¸ºå½“å‰æ—¶é—´ã€‚å¦‚æœå“åº”ä¸ºPONGã€LOADINGã€MASTERDOWNï¼Œåˆ™æ›´æ–°last_avail_timeä¸ºå½“å‰æ—¶é—´ï¼Œact_ping_timeä¸º0ã€‚å¦‚æœå“åº”ä¸ºBUSYï¼Œåˆ™æœ‰å¯èƒ½æ˜¯å…¶åœ¨æ‰§è¡Œè„šæœ¬ï¼Œsentinelä¼šå‘å…¶å‘é€<code>SCRIPT KILL</code>å‘½ä»¤ã€‚</p>
<p>ä¸Šé¢æˆ‘ä»¬æ¶‰åŠ act_ping_timeã€last_ping_timeã€last_pong_timeã€last_avail_timeè¿™äº›å˜é‡ã€‚è€Œmonitoringéƒ¨åˆ†å‘é€PINGå‘½ä»¤å°±åœ¨last_ping_timeå’Œlast_pong_timeè¿‡è€çš„æ—¶å€™ï¼š</p>
<pre tabindex="0"><code>    if ((now - ri-&gt;link-&gt;last_pong_time) &gt; ping_period &amp;&amp;
               (now - ri-&gt;link-&gt;last_ping_time) &gt; ping_period/2) {
        /* Send PING to all the three kinds of instances. */
        sentinelSendPing(ri);
    }
</code></pre><p><strong>INFOåŠå…¶å›è°ƒ</strong></p>
<p>INFOå‘½ä»¤ä¼šå‘é€ç»™masterå’ŒslaveèŠ‚ç‚¹ã€‚</p>
<p>å®ƒçš„å›è°ƒå‡½æ•°æ˜¯sentinelInfoReplyCallbackï¼Œå…¶ä¼šè§£æINFOçš„å“åº”ï¼Œå¹¶é€šè¿‡sentinelRefreshInstanceInfoï¼Œæ›´æ–°INFOå‘½ä»¤ç›®æ ‡èŠ‚ç‚¹åœ¨sentinelå†…å­˜ä¸­çš„çŠ¶æ€ï¼ŒåŒ…æ‹¬ä»¥ä¸‹ä¿¡æ¯ï¼š</p>
<ul>
<li>run_idâ€”â€”å¦‚æœrunidä¸ä¹‹å‰è®°å½•çš„ä¸åŒï¼Œåˆ™è®°å½•ä¸€æ¬¡+rebootäº‹ä»¶ï¼ˆLL_NOTICEï¼‰</li>
<li>slave0ã€slave1&hellip;.â€”â€”å¦‚æœæŸslaveæ˜¯æ–°å‘ç°çš„ï¼Œåˆ™åŠ å…¥ç›‘å¬åˆ—è¡¨ï¼Œå¹¶è®°å½•+slaveäº‹ä»¶ï¼ˆLL_NOTICEï¼‰</li>
<li>master_link_down_since_seconds</li>
<li>role:(master/slave)
<ul>
<li>å¦‚æœæ˜¯slaveåˆ™ç»§ç»­è¯»å–<code>master_host</code>ã€<code>master_port</code>ã€master_link_statusã€slave_priorityã€slave_repl_offset</li>
</ul>
</li>
</ul>
<p>è¯¥å›è°ƒå‡½æ•°è¿˜ä¼šåœ¨ç›®æ ‡èŠ‚ç‚¹roleå‘ç”Ÿå˜åŒ–æ—¶äº§ç”Ÿ+/-role-changeçš„äº‹ä»¶ï¼ˆä»…è®°å½•åˆ°æ—¥å¿—ï¼‰ã€‚</p>
<p>å¦‚æœå½“å‰ä¸åœ¨TILTæ¨¡å¼ï¼Œè¿˜ä¼šç»§ç»­æ‰§è¡Œä»¥ä¸‹ï¼š</p>
<ol>
<li>å¦‚æœä¹‹å‰è®°å½•è¯¥èŠ‚ç‚¹ä¸ºslaveï¼Œè€Œè¯¥INFOå“åº”æŠ¥å‘Šå…¶ä¸ºmasterã€‚ä¸”ä»–çš„ä¸»èŠ‚ç‚¹çš„SRI_FAILOVER_IN_PROGRESS flagè¢«è®¾ç½®ä¸”failover_stateä¸ºSENTINEL_FAILOVER_STATE_WAIT_PROMOTIONï¼Œåˆ™è¯´æ˜è¯¥ä»èŠ‚ç‚¹æˆåŠŸåœ°è¢«æå‡ä¸ºä¸»èŠ‚ç‚¹ã€‚æ­¤äº‹å°†failover_stateç½®ä¸ºSENTINEL_FAILOVER_STATE_RECONF_SLAVESã€‚åŒæ—¶è®°å½•+promoted-slaveå’Œâ€”â€”è¿™ä¸€æ®µçš„ä½œç”¨å°†åœ¨ä¸‹æ–‡çŠ¶æ€æœºéƒ¨åˆ†è§£é‡Šã€‚</li>
<li>å¦‚æœè¯¥slaveå¼‚å¸¸åœ°æŠ¥å‘Šè‡ªå·±æ˜¯ä¸»èŠ‚ç‚¹ï¼ˆæ²¡æœ‰sentinelè¿›è¡Œfailoveræå‡ä»–ï¼‰æˆ–æŠ¥å‘Šè‡ªå·±æ‹·è´çš„ä¸»èŠ‚ç‚¹ä¸åŒäºsentinelè®°å½•çš„ï¼Œåˆ™ä¿®æ­£è¯¥ä»èŠ‚ç‚¹çš„çŠ¶æ€ã€‚</li>
<li>å¤„ç†SRI_RECONF_SENT-&gt;SRI_RECONF_INPROG-&gt;SRI_RECONF_DONEçš„çŠ¶æ€è½¬æ¢</li>
</ol>
<p><strong>helloæ¶ˆæ¯çš„å‘å¸ƒä¸æ¶ˆè´¹</strong></p>
<p>helloæ¶ˆæ¯ä¼šå‘é€ç»™æ‰€æœ‰èŠ‚ç‚¹çš„<code>__sentinel__:hello</code>é¢‘é“ã€‚æ¶ˆæ¯æ ¼å¼ä¸ºï¼š</p>
<pre tabindex="0"><code>sentinel_ip,sentinel_port,sentinel_runid,current_epoch,
master_name,master_ip,master_port,master_config_epoch
</code></pre><p>å‘å¸ƒhelloæ¶ˆæ¯çš„å›è°ƒå‡½æ•°ä¸ºsentinelPublishReplyCallbackã€‚å…¶ä»…ä»…é€’å‡pending_commandsï¼Œå’Œæ›´æ–°last_pub_timeä¸ºå½“å‰æ—¶é—´ï¼ˆå¦‚æœå‘å¸ƒæˆåŠŸï¼‰ã€‚</p>
<p>helloæ¶ˆæ¯çš„æ¶ˆè´¹æ˜¯é€šè¿‡sentinelReceiveHelloMessageså‡½æ•°ï¼Œè¯¥å‡½æ•°æ˜¯SUBSCRIBEå‘½ä»¤çš„å›è°ƒå‡½æ•°ã€‚è¯¥å‡½æ•°åœ¨è§£æhelloæ¶ˆæ¯çš„8ä¸ªå­—æ®µåï¼Œä¼šåšå¦‚ä¸‹ï¼š</p>
<ol>
<li>å¢åŠ æ–°å‘ç°çš„sentinelæˆ–æ›´æ–°å·²æœ‰sentinelçš„åœ°å€ã€‚ï¼ˆå†³å®šæ›´æ–°è¿˜æ˜¯å¢åŠ æ˜¯åˆ¤æ–­runIDæ˜¯å¦æœ‰è®°å½•è¿‡ï¼‰</li>
<li>å¦‚æœhelloæ¶ˆæ¯ä¸­sentinelçš„current_epochå¤§äºæœ¬åœ°current_epoch,åˆ™æ›´æ–°æœ¬åœ°çš„ä¸ºhelloæ¶ˆæ¯ä¸­çš„current_epoch</li>
<li>å¦‚æœhelloæ¶ˆæ¯ä¸­master_config_epochå¤§äºæœ¬åœ°çš„è®°å½•ï¼Œåˆ™æ›´æ–°æœ¬åœ°çš„masteråœ°å€å’Œmaster_config_epochã€‚äº§ç”Ÿ+config-update-fromäº‹ä»¶å’Œ+switch-masteräº‹ä»¶ã€‚</li>
<li>æ›´æ–°last_hello_timeä¸ºå½“å‰æ—¶é—´</li>
</ol>
<p>æ¶ˆè´¹helloæ¶ˆæ¯çš„è¿‡ç¨‹å°±æ˜¯é…ç½®ä¼ æ’­çš„è¿‡ç¨‹ã€‚</p>
<h2 id="è‡ªåŠ¨æ•…éšœè¿ç§»å®ç°">è‡ªåŠ¨æ•…éšœè¿ç§»å®ç°</h2>
<p>è‡ªåŠ¨failoverçš„å®ç°åœ¨sentinelHandleRedisInstanceçš„actingéƒ¨åˆ†ï¼ŒåŒ…å«ï¼š</p>
<ul>
<li>ä¸»è§‚ä¸‹çº¿</li>
<li>å®¢è§‚ä¸‹çº¿</li>
<li>é€‰ä¸¾leader</li>
<li>æ‰§è¡Œfailover</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#75715e">/* ============== ACTING HALF ============= */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Every kind of instance */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sentinelCheckSubjectivelyDown</span>(ri);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Masters and slaves */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (ri<span style="color:#f92672">-&gt;</span>flags <span style="color:#f92672">&amp;</span> (SRI_MASTER<span style="color:#f92672">|</span>SRI_SLAVE)) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* Nothing so far. */</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Only masters */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (ri<span style="color:#f92672">-&gt;</span>flags <span style="color:#f92672">&amp;</span> SRI_MASTER) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//ä¸»è§‚ä¸‹çº¿çŠ¶æ€æ›´æ–°
</span></span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sentinelCheckObjectivelyDown</span>(ri);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">sentinelStartFailoverIfNeeded</span>(ri))
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//è¯¢é—®å…¶ä»–sentinelè¯¥masteræ˜¯å¦ä¸ºsdownï¼Œå¹¶å¯èƒ½ä¼´éšé€‰ä¸¾leader
</span></span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">sentinelAskMasterStateToOtherSentinels</span>(ri,SENTINEL_ASK_FORCED);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sentinelFailoverStateMachine</span>(ri);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sentinelAskMasterStateToOtherSentinels</span>(ri,SENTINEL_NO_FLAGS);
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p><strong>ä¸»è§‚ä¸‹çº¿çŠ¶æ€åˆ¤æ–­ä¸æ›´æ–°</strong></p>
<p>ä¸»è§‚ä¸‹çº¿çŠ¶æ€åˆ¤æ–­ä¸æ›´æ–°ä¼šå¯¹masterã€slaveå’Œsentinelè¿›è¡Œã€‚</p>
<p>ä¸»è§‚ä¸‹çº¿çŠ¶æ€çš„æ£€æµ‹å°±æ˜¯æ£€æµ‹å‡ ä¸ªæ—¶é—´å˜é‡æœ‰æ²¡æœ‰è¶…å‡ºé˜ˆå€¼ï¼Œå› ä¸ºæ˜¯â€œä¸»è§‚â€çš„å˜åŠ¨ï¼Œæ‰€ä»¥ä¸éœ€è¦ä¸å…¶ä»–sentinelåå•†ã€‚ä¼šäº§ç”Ÿ+sdownäº‹ä»¶å’Œ-sdownäº‹ä»¶ï¼ˆç¦»å¼€ä¸»è§‚ä¸‹çº¿çŠ¶æ€ï¼‰</p>
<p><strong>å®¢è§‚ä¸‹çº¿çŠ¶æ€åˆ¤æ–­ä¸æ›´æ–°</strong></p>
<p>sentinelä¼šéå†è‡ªå·±å†…å­˜ä¸­æ‰€æœ‰sentinelçš„SRI_MASTER_DOWNæ ‡è®°ï¼Œå¦‚æœè¯¥flagä¸º1ï¼Œåˆ™è®¡æ•°+1ï¼Œå¦‚æœè®¡æ•°å¤§äºquorumåˆ™è®¾ç½®ä¸ºä¸»è§‚ä¸‹çº¿çŠ¶æ€ã€‚ä¼šäº§ç”Ÿ+odownäº‹ä»¶å’Œ-odownäº‹ä»¶ï¼ˆç¦»å¼€å®¢è§‚ä¸‹çº¿çŠ¶æ€ï¼‰ã€‚</p>
<p><strong>æ£€æµ‹å¹¶å¼€å§‹failover</strong></p>
<p>æ£€æµ‹éƒ¨åˆ†åŒ…æ‹¬ä¸‰é¡¹å·¥ä½œï¼š</p>
<ol>
<li>Master must be in ODOWN condition.</li>
<li>No failover already in progress.</li>
<li>No failover already attempted recently.</li>
</ol>
<p>å¦‚æœæ»¡è¶³ä¸‰é¡¹æ¡ä»¶åˆ™æ‰§è¡ŒsentinelStartFailoverï¼Œè¯¥å‡½æ•°ä¼šåšå¦‚ä¸‹ï¼š</p>
<ol>
<li>è®¾ç½®flagï¼šSRI_FAILOVER_IN_PROGRESSï¼›</li>
<li>master-&gt;failover_epoch = ++sentinel.current_epoch; â€”â€”æ›´æ–°ä¸¤ä¸ªepochï¼Œè¯¥epochæ¯”å½“å‰é›†ç¾¤ç¨³å®šçš„epochå¤§</li>
<li>åŒæ—¶è®¾ç½®failover_stateä¸ºSENTINEL_FAILOVER_STATE_WAIT_STARTã€‚è¯¥failover_stateéšåè¿›å…¥ä¸€ä¸ªçŠ¶æ€æœºè¿›è¡ŒçŠ¶æ€è½¬æ¢ï¼ˆçœŸæ­£çš„failoverè¿‡ç¨‹ï¼‰ã€‚</li>
<li>äº§ç”Ÿ+new-epochå’Œ+try-failoveräº‹ä»¶</li>
</ol>
<p><strong>ä¸å…¶ä»–sentinelåå•†</strong></p>
<p>sentinelAskMasterStateToOtherSentinelså‘å…¶ä»–æ‰€æœ‰sentinelå‘é€IS-MASTER-DOWN-BY-ADDRã€‚å…¶è¯·æ±‚å’Œå“åº”æ ¼å¼å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>è¯·æ±‚ï¼šSENTINEL is-master-down-by-addr master_ip master_port sentinel_current_epoch sentinel_myid/*
å“åº”ï¼šdown state, leader, vote epoch.
</code></pre><p>è¯¥å‘½ä»¤çš„ä½œç”¨å…¶å®æœ‰ä¸¤éƒ¨åˆ†ï¼š</p>
<ul>
<li>ç›®æ ‡sentinelæ˜¯å¦è®¤ä¸ºè¯¥masterä¸ºsdown</li>
<li>å¦‚æœæºsentinelå¼€å§‹äº†failoverï¼Œåˆ™æœ€åä¸€ä¸ªå‚æ•°ä¸ä¸ºâ€œ*â€ï¼Œæ­¤æ—¶ä¼šè¿›è¡Œfailoverçš„leaderé€‰ä¸¾â€”â€”è¿™æ˜¯ä»å‘½åä¸­çœ‹ä¸å‡ºæ¥çš„ã€‚</li>
</ul>
<p>æˆ‘ä»¬çœ‹<code>sentinelCommand</code>ä¸­å¤„ç†<code>is-master-down-by-addr</code>å‘½ä»¤çš„æ¿€å‘é€‰ä¸¾leaderçš„ä»£ç ï¼›</p>
<pre tabindex="0"><code>        /* Vote for the master (or fetch the previous vote) if the request
         * includes a runid, otherwise the sender is not seeking for a vote. */
        if (ri &amp;&amp; ri-&gt;flags &amp; SRI_MASTER &amp;&amp; strcasecmp(c-&gt;argv[5]-&gt;ptr,&#34;*&#34;)) {
            leader = sentinelVoteLeader(ri,(uint64_t)req_epoch,
                                            c-&gt;argv[5]-&gt;ptr,
                                            &amp;leader_epoch);
        }
</code></pre><p>å¯ä»¥çœ‹åˆ°åˆ¤æ–­ç¬¬6ä¸ªå‚æ•°æ˜¯ä¸æ˜¯â€œ*â€ï¼Œå·²å†³å®šæ˜¯å¦è¿›è¡Œ<code>sentinelVoteLeader</code>ã€‚æˆ‘ä»¬å…ˆå°†sentinelVoteLeaderè§†ä¸ºä¸€ä¸ªé»‘ç›’ï¼Œä»…éœ€è¦çŸ¥é“ä»–ä¼šè¿”å›leaderä¿¡æ¯ã€‚</p>
<p>ç°åœ¨æ¥çœ‹æ”¶åˆ°å“åº”çš„å›è°ƒå‡½æ•°<code>sentinelReceiveIsMasterDownReply</code>ã€‚ä»–ä¼šåšä¸¤ä»¶äº‹ï¼š</p>
<ol>
<li>æ›´æ–°å†…å­˜ä¸­è¯¥sentinelå¯¹ç›®æ ‡masterçš„sdownçŠ¶æ€æ ‡è®°</li>
<li>æ›´æ–°å†…å­˜ä¸­è¯¥sentinelçš„é€‰ä¸¾ä¿¡æ¯ï¼šleaderä»¥åŠleader_epoch</li>
</ol>
<p><strong>sentinelFailoverStateMachine-æ‰§è¡Œfailoverçš„çŠ¶æ€æœº</strong></p>
<p>è¯¥çŠ¶æ€æœºçœŸæ­£è°ƒç”¨ä¸€äº›å‡½æ•°æ¥æ‰§è¡Œfailoverè¿‡ç¨‹ï¼ŒçŠ¶æ€è½¬æ¢å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span>(ri<span style="color:#f92672">-&gt;</span>failover_state) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> SENTINEL_FAILOVER_STATE_WAIT_START:
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">sentinelFailoverWaitStart</span>(ri);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> SENTINEL_FAILOVER_STATE_SELECT_SLAVE:
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">sentinelFailoverSelectSlave</span>(ri);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE:
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">sentinelFailoverSendSlaveOfNoOne</span>(ri);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> SENTINEL_FAILOVER_STATE_WAIT_PROMOTION:
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">sentinelFailoverWaitPromotion</span>(ri);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> SENTINEL_FAILOVER_STATE_RECONF_SLAVES:
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">sentinelFailoverReconfNextSlave</span>(ri);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>sentinelStartFailoverå‡½æ•°å°†failover_stateç½®ä¸ºSENTINEL_FAILOVER_STATE_WAIT_STARTï¼Œéšåè¿›è¡ŒçŠ¶æ€æœºã€‚</p>
<p>sentinelFailoverWaitStartä¼šç»Ÿè®¡å…¶ä»–sentinelçš„æŠ•ç¥¨ä¿¡æ¯ï¼Œåˆ¤æ–­è‡ªå·±æ˜¯å¦ä¸ºleaderï¼Œå¦‚æœæ˜¯åˆ™ç½®failover_stateä¸ºSENTINEL_FAILOVER_STATE_SELECT_SLAVEï¼Œè¿›å…¥çŠ¶æ€æœºä¸‹ä¸€æ­¥çŠ¶æ€ã€‚</p>
<p>sentinelFailoverSelectSlaveä¼šé€‰ä¸¾å‡ºä¸€ä¸ªslaveï¼Œé€‰ä¸¾è§„åˆ™ä¸Šæ–‡æœ‰é™ˆè¿°ã€‚</p>
<p>sentinelFailoverSendSlaveOfNoOneä¼šå¯¹è¯¥slaveå‘é€â€œSLAVEOF NO ONEâ€å‘½ä»¤ï¼Œè®©å…¶æˆä¸ºä¸€ä¸ªä¸»èŠ‚ç‚¹ã€‚</p>
<p>sentinelFailoverWaitPromotionå•çº¯ä¸ºä¸€ä¸ªè¶…æ—¶åˆ¤æ–­å‡½æ•°ï¼ŒSENTINEL_FAILOVER_STATE_WAIT_PROMOTION-&gt;SENTINEL_FAILOVER_STATE_RECONF_SLAVESçš„çŠ¶æ€è½¬æ¢åœ¨INFOå‘½ä»¤çš„å›è°ƒå‡½æ•°ä¸­æ‰§è¡Œï¼Œä¸Šæ–‡æœ‰é™ˆè¿°ã€‚</p>
<p>sentinelFailoverReconfNextSlaveåˆ™æ˜¯å‘å…¶ä»–slaveå‘é€â€œSLAVEOF new_masterâ€ã€‚</p>
<p><strong>ä»¥ä¸Šè¿‡ç¨‹çš„é¡ºåºâ€”â€”å€¼å¾—å…³æ³¨ä¸€ä¸‹</strong></p>
<p>sentinelåœ¨åˆ¤æ–­æ˜¯å¦odownæ—¶ä½¿ç”¨è‡ªå·±å†…å­˜ä¸­æ‰€ä¿å­˜çš„å…¶ä»–sentinelçš„ä¿¡æ¯ã€‚å®ç°ä¸­åœ¨ä¸€ä¸ªå‘¨æœŸä¸­ï¼Œæ˜¯å…ˆåˆ¤æ–­odownï¼Œè€Œåå‘é€<code>is-master-down-by-addr</code>è¦æ±‚æ›´æ–°å…¶ä»–sentinelçš„ä¿¡æ¯ã€‚ä¹Ÿå°±æ˜¯è¯´åˆ¤æ–­æ—¶ï¼Œä½¿ç”¨çš„æ˜¯é™ˆæ—§çš„ä¿¡æ¯ã€‚ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ</p>
<p>é¦–å…ˆæˆ‘ä»¬æ³¨æ„åˆ°ï¼Œis-master-down-by-addræ˜¯å¼‚æ­¥çš„ï¼Œä¹Ÿå°±æ˜¯ä¸æ˜¯å‘é€åé˜»å¡åœ°ç­‰å¾…æ›´æ–°ã€‚æ‰€ä»¥å…ˆå‘é€<code>is-master-down-by-addr</code>,è€Œåç«‹å³åˆ¤æ–­odownï¼Œå…¶ä½¿ç”¨çš„ä»ç„¶æ˜¯é™ˆæ—§çš„ä¿¡æ¯ã€‚</p>
<p>å…¶æ¬¡ï¼Œå› ä¸ºè¿™æ˜¯å®šæ—¶çš„ä»»åŠ¡ï¼Œæˆ‘ä»¬è¯¢é—®æ›´æ–°ä¹‹åï¼Œä¼šç­‰å¾…ä¸€ä¸ªæ—¶é—´é—´éš”ï¼Œè€Œåå¼€å§‹ä¸€æ¬¡æ–°çš„odownåˆ¤æ–­ï¼Œå› ä¸ºè¿™ä¸ªæ—¶é—´é—´éš”çš„å­˜åœ¨ï¼Œæ˜¯æœ‰å¯èƒ½ä½¿ç”¨æ–°çš„çŠ¶æ€ä¿¡æ¯çš„ã€‚</p>
<p>æœ€åï¼Œ<code>is-master-down-by-addr</code>ä¾èµ–æ˜¯å¦ä¸ºodownå†³å®šæ˜¯å¦éœ€è¦è¿›è¡Œleaderé€‰ä¸¾ï¼Œè¿™æ˜¯ä¸€ä¸ªç¡¬æ€§çš„ä¾èµ–ã€‚</p>
<p>ä»¥ä¸Šä¸‰ç‚¹å†³å®šäº†è¿™ä¸ªé¡ºåºã€‚</p>
<p><strong>failoverçš„leaderé€‰ä¸¾</strong></p>
<p>è¿™æ˜¯æœ€åä¸€ä¸ªéƒ¨åˆ†å•¦ã€‚</p>
<p>è¯·æ±‚æˆä¸ºleaderçš„sentinelå°†è‡ªå·±çš„epoch+1ï¼Œç„¶åæºå¸¦è‡ªå·±çš„runidå’Œepochå‘å…¶ä»–sentinelå‘é€<code>is-master-down-by-addr</code>ã€‚</p>
<p>å…¶ä»–sentinelä¼šæ‹¿ç€è¯¥runidå’Œepochå†³å®šæ˜¯å¦æŠŠç¥¨æŠ•ç»™ä»–ã€‚å…¶å®ç°åœ¨sentinelVoteLeaderã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sentinelVoteLeader</span>(sentinelRedisInstance <span style="color:#f92672">*</span>master, <span style="color:#66d9ef">uint64_t</span> req_epoch, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>req_runid, <span style="color:#66d9ef">uint64_t</span> <span style="color:#f92672">*</span>leader_epoch) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (req_epoch <span style="color:#f92672">&gt;</span> sentinel.current_epoch) {
</span></span><span style="display:flex;"><span>        sentinel.current_epoch <span style="color:#f92672">=</span> req_epoch;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sentinelFlushConfig</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sentinelEvent</span>(LL_WARNING,<span style="color:#e6db74">&#34;+new-epoch&#34;</span>,master,<span style="color:#e6db74">&#34;%llu&#34;</span>,
</span></span><span style="display:flex;"><span>            (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">long</span>) sentinel.current_epoch);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//å†³å®šæ˜¯å¦æŠ•ç»™ä»–
</span></span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (master<span style="color:#f92672">-&gt;</span>leader_epoch <span style="color:#f92672">&lt;</span> req_epoch <span style="color:#f92672">&amp;&amp;</span> sentinel.current_epoch <span style="color:#f92672">&lt;=</span> req_epoch)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sdsfree</span>(master<span style="color:#f92672">-&gt;</span>leader);
</span></span><span style="display:flex;"><span>        master<span style="color:#f92672">-&gt;</span>leader <span style="color:#f92672">=</span> <span style="color:#a6e22e">sdsnew</span>(req_runid);
</span></span><span style="display:flex;"><span>        master<span style="color:#f92672">-&gt;</span>leader_epoch <span style="color:#f92672">=</span> sentinel.current_epoch;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sentinelFlushConfig</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sentinelEvent</span>(LL_WARNING,<span style="color:#e6db74">&#34;+vote-for-leader&#34;</span>,master,<span style="color:#e6db74">&#34;%s %llu&#34;</span>,
</span></span><span style="display:flex;"><span>            master<span style="color:#f92672">-&gt;</span>leader, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">long</span>) master<span style="color:#f92672">-&gt;</span>leader_epoch);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* If we did not voted for ourselves, set the master failover start
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * time to now, in order to force a delay before we can start a
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * failover for the same master. */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strcasecmp</span>(master<span style="color:#f92672">-&gt;</span>leader,sentinel.myid))
</span></span><span style="display:flex;"><span>            master<span style="color:#f92672">-&gt;</span>failover_start_time <span style="color:#f92672">=</span> <span style="color:#a6e22e">mstime</span>()<span style="color:#f92672">+</span><span style="color:#a6e22e">rand</span>()<span style="color:#f92672">%</span>SENTINEL_MAX_DESYNC;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>leader_epoch <span style="color:#f92672">=</span> master<span style="color:#f92672">-&gt;</span>leader_epoch;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> master<span style="color:#f92672">-&gt;</span>leader <span style="color:#f92672">?</span> <span style="color:#a6e22e">sdsnew</span>(master<span style="color:#f92672">-&gt;</span>leader) <span style="color:#f92672">:</span> NULL;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å…ˆæ¥å…ˆå¾—ç¥¨ï¼ŒæŠ•ç¥¨ç»™ç¬¬ä¸€ä¸ªepochå¤§äºè‡ªå·±çš„sentinelã€‚</p>
  </div>
  

<div class="navigation navigation-single">
    
    <a href="/posts/redis/redis-persistence/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">RedisæŒä¹…åŒ–æœºåˆ¶-aof.cä¸rdb.c</span>
    </a>
    
    
    <a href="/posts/redis/redis-cluster/" class="navigation-next">
      <span class="navigation-tittle">Redis Clusterå®ç°</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  


</article>


  </div>
<style>
  .content.container {
        width: 100%;
        max-width: none;
        height: calc(100vh - var(--sidebar-height, 49px));
        border: none;
        display: block;
        overflow-y: auto;
        box-sizing: border-box;
        margin-left: 0;
        margin-right: 0;
  }

  body:not(.type-iframe) .content.container {
        padding-left: max(1.5rem, calc((100% - var(--content-max-width, 38rem)) / 2));
        padding-right: max(1.5rem, calc((100% - var(--content-max-width, 38rem)) / 2));
  }
</style>
<script>
    (function () {
        var contentSelector = '.content.container';
        var rafId = 0;
        var resizeDebounceTimer = 0;
        var pendingHashScroll = false;

        function getHashTarget() {
            var hash = window.location.hash;
            var targetId = '';

            if (!hash || hash === '#') {
                return null;
            }

            targetId = hash.slice(1);
            try {
                targetId = decodeURIComponent(targetId);
            } catch (e) {
                
            }

            return document.getElementById(targetId);
        }

        function scrollToHashTarget() {
            var target = getHashTarget();
            if (!target) {
                return;
            }
            try {
                target.scrollIntoView({ block: 'start', inline: 'nearest' });
            } catch (e) {
                target.scrollIntoView(true);
            }
        }

        function applyPendingHashScroll() {
            if (!pendingHashScroll) {
                return;
            }
            pendingHashScroll = false;
            scrollToHashTarget();
        }

        function resizeContentHeight() {
            var content = document.querySelector(contentSelector);
            if (!content) {
                return;
            }
            var rect = content.getBoundingClientRect();
            var available = window.innerHeight - rect.top;
            if (available < 0) {
                available = 0;
            }
            content.style.height = available + 'px';
            applyPendingHashScroll();
        }

        function scheduleResize() {
            if (rafId) {
                return;
            }
            rafId = window.requestAnimationFrame(function () {
                rafId = 0;
                resizeContentHeight();
            });
        }

        function scheduleResizeDebounced(delay) {
            window.clearTimeout(resizeDebounceTimer);
            resizeDebounceTimer = window.setTimeout(scheduleResize, delay || 120);
        }

        function requestHashScroll() {
            if (!window.location.hash || window.location.hash === '#') {
                return;
            }
            pendingHashScroll = true;
            scheduleResize();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function () {
                scheduleResize();
                requestHashScroll();
            }, { once: true });
        } else {
            scheduleResize();
            requestHashScroll();
        }

        window.addEventListener('load', function () {
            scheduleResize();
            requestHashScroll();
        });
        window.addEventListener('pageshow', function () {
            scheduleResize();
            requestHashScroll();
        });
        window.addEventListener('hashchange', requestHashScroll);
        window.addEventListener('resize', function () {
            scheduleResizeDebounced(120);
        });

        var menuToggle = document.getElementById('menuToggle');
        if (menuToggle) {
            menuToggle.addEventListener('change', function () {
                scheduleResize();
                window.setTimeout(scheduleResize, 250);
            });
        }
    })();
</script>
  
    



<script defer src="/js/all.js" crossorigin="anonymous"></script>

    
    
    <script src="/js/highlight.min.js"></script>
    <script src="/js/languages/dos.min.js"></script>
        
    <script type="text/javascript">
        
        hljs.highlightAll();
    </script>
    

<style>
    .code-block-wrapper {
        position: relative;
    }
    .copy-code-button {
        position: absolute;
        top: 8px;
        right: 8px;
        padding: 6px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.3s, background 0.3s;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .copy-code-button svg {
        width: 16px;
        height: 16px;
        fill: #fff;
        transition: fill 0.3s;
    }
    .code-block-wrapper:hover .copy-code-button {
        opacity: 1;
    }
    .copy-code-button:hover {
        background: rgba(255, 255, 255, 0.2);
    }
    .copy-code-button.copied {
        background: rgba(46, 160, 67, 0.8);
        border-color: rgba(46, 160, 67, 1);
    }
    .copy-code-button.copied svg {
        fill: #fff;
    }
</style>
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
        
        document.querySelectorAll('pre code').forEach(function(codeBlock) {
            var pre = codeBlock.parentNode;
            
            
            if (pre.parentNode.classList.contains('code-block-wrapper')) {
                return;
            }
            
            
            var wrapper = document.createElement('div');
            wrapper.className = 'code-block-wrapper';
            pre.parentNode.insertBefore(wrapper, pre);
            wrapper.appendChild(pre);
            
            
            var button = document.createElement('button');
            button.className = 'copy-code-button';
            button.innerHTML = '<svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path></svg>';
            button.setAttribute('aria-label', 'å¤åˆ¶ä»£ç ');
            button.setAttribute('title', 'å¤åˆ¶ä»£ç ');
            
            var copyIcon = '<svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path></svg>';
            var checkIcon = '<svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16"><path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path></svg>';
            
            
            button.addEventListener('click', function() {
                var code = codeBlock.textContent;
                navigator.clipboard.writeText(code).then(function() {
                    button.innerHTML = checkIcon;
                    button.classList.add('copied');
                    button.setAttribute('aria-label', 'å·²å¤åˆ¶');
                    button.setAttribute('title', 'å·²å¤åˆ¶');
                    setTimeout(function() {
                        button.innerHTML = copyIcon;
                        button.classList.remove('copied');
                        button.setAttribute('aria-label', 'å¤åˆ¶ä»£ç ');
                        button.setAttribute('title', 'å¤åˆ¶ä»£ç ');
                    }, 2000);
                }).catch(function(err) {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                });
            });
            
            wrapper.appendChild(button);
        });
    });
</script>




    



</body>

</html>
