<!DOCTYPE html>
<html lang="zh-CN">

    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    
    <link rel="canonical" href="https://www.arloor.com/posts/windows11-23h2-wsl2/">
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.157.0">

    
    
    

<title>Windows11 WSL2使用 • ARLOOR</title>
<meta name="description" content="今天，你学习了吗">
<meta name="keywords" content="刘港欢, arloor, moontell">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Windows11 WSL2使用">
  <meta name="twitter:description" content="wsl 全称是 windows 的 linux 子系统，可以理解为在你的 windows 电脑上提供一个 linux 的工作环境。
windows 虚拟化的基础知识 windows 功能 作用 其他 Hyper-V 微软自己的虚拟化工具 包含了“管理工具”和“平台”，其中“平台”包含“服务”和“虚拟机监控程序” Windows Subsystem for Linux WSL1，不是我们讨论的 WSL2 所需要的 Virtual Machine Platform 虚拟机平台（WSL2 的底层依赖） 看到说 Hyper-V 也依赖这个，但启用 Hyper-V 并不需要启用虚拟机平台，因此我觉得 Hyper-V 依赖的是“Hyper-V 虚拟机监控程序”吧 Windows Sandbox 一个隔离的桌面环境 我反正没用过，不了解 Windows 虚拟机监控程序平台 用于支持 vmware 等第三方虚拟机软件 虚拟机平台会一定程度上影响游戏性能，为了游戏性能，可以关闭虚拟机平台、Hyper-V。Windows 虚拟机监控程序平台、适用于 Linux 的 Windows 子系统我理解是不影响游戏性能的。参考用于在 Windows 11 中优化游戏性能的选项。 Hyper-V 和 vmware 等软件是冲突的，详见虚拟化应用程序无法与 Hyper-V、Device Guard 和 Credential Guard 协同工作 关闭虚拟机平台和 Hyper-V 虚拟机监控程序：">
      <meta name="twitter:site" content="@njulgh">

<meta property="og:url" content="https://www.arloor.com/posts/windows11-23h2-wsl2/">
  <meta property="og:site_name" content="ARLOOR">
  <meta property="og:title" content="Windows11 WSL2使用">
  <meta property="og:description" content="wsl 全称是 windows 的 linux 子系统，可以理解为在你的 windows 电脑上提供一个 linux 的工作环境。
windows 虚拟化的基础知识 windows 功能 作用 其他 Hyper-V 微软自己的虚拟化工具 包含了“管理工具”和“平台”，其中“平台”包含“服务”和“虚拟机监控程序” Windows Subsystem for Linux WSL1，不是我们讨论的 WSL2 所需要的 Virtual Machine Platform 虚拟机平台（WSL2 的底层依赖） 看到说 Hyper-V 也依赖这个，但启用 Hyper-V 并不需要启用虚拟机平台，因此我觉得 Hyper-V 依赖的是“Hyper-V 虚拟机监控程序”吧 Windows Sandbox 一个隔离的桌面环境 我反正没用过，不了解 Windows 虚拟机监控程序平台 用于支持 vmware 等第三方虚拟机软件 虚拟机平台会一定程度上影响游戏性能，为了游戏性能，可以关闭虚拟机平台、Hyper-V。Windows 虚拟机监控程序平台、适用于 Linux 的 Windows 子系统我理解是不影响游戏性能的。参考用于在 Windows 11 中优化游戏性能的选项。 Hyper-V 和 vmware 等软件是冲突的，详见虚拟化应用程序无法与 Hyper-V、Device Guard 和 Credential Guard 协同工作 关闭虚拟机平台和 Hyper-V 虚拟机监控程序：">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-09-22T13:45:23+08:00">
    <meta property="article:modified_time" content="2024-09-22T13:45:23+08:00">
    <meta property="article:tag" content="Windows">


    





<link rel="stylesheet" href="/styles/atom-one-dark.min.css">








<link rel="stylesheet" href="/scss/hyde-hyde.debf1b963c1830f6b9b96ee48c2b4a22c31c7c3885a87bed290c0e198fc6a08d.css" integrity="sha256-3r8bljwYMPa5uW7kjCtKIsMcfDiFqHvtKQwOGY/GoI0=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">




<link rel="stylesheet" href="/scss/hugo-toc.6b7222b4ddd3cebd47d144a2e37ade6cbbb64f47e31d8feac655896156ade206.css" integrity="sha256-a3IitN3Tzr1H0USi43rebLu2T0fjHY/qxlWJYVat4gY=">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    

</head>



<body class="  ">
  
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="/">
          
          ARLOOR
          
        </a>
      </span>
      <a href="/">
        
        
        <div class="author-image">
          <img src="/img/head.jpeg" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
        
      </a>
      
      <p class="site__description">
         都是瞎写的 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">ARLOOR</label>
      <div class="menu-content menu-content--mobile">
        <div class="show-in-small">
          <a href="/">
            
            
            <div class="author-image">
              <img src="/img/head.jpeg" alt="Author Image"
                class="img--circle img--headshot element--center">
            </div>
            
            
          </a>
        </div>
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>文章</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/">
						<span>分类</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>关于我</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/grafana-iframe">
						<span>Grafana</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/net-iframe">
						<span>网速监控</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/nat">
						<span>NAT规则</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/stock">
						<span>股票监控</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://x.com/njulgh" rel="me" target="_blank"><i class="fa-brands fa-x-twitter fa-lg"></i></a>
	
	
	
	
	
	<a href="https://github.com/arloor" rel="me" target="_blank"><i class="fa-brands fa-github fa-lg"></i></a>
	
	
	
	
	
	
	
	
	
	
	
	
	
	<a href="https://t.me/never_contact_me" rel="me" target="_blank"><i class="fa-brands fa-telegram fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="mailto:admin@arloor.com" rel="me" target="_blank"><i class="fa-solid fa-at fa-lg"></i></a>
	
	
	
	
</section>
      </div>
    </div>
    <div class="menu-content menu-content--desktop">
      <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>文章</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/">
						<span>分类</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>关于我</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/grafana-iframe">
						<span>Grafana</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/net-iframe">
						<span>网速监控</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/nat">
						<span>NAT规则</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/stock">
						<span>股票监控</span>
					</a>
				</li>
			 
		
	</ul>
</div>

    </div>
    <div class="social-wrap social-wrap--desktop">
      <section class="social">
	
	<a href="https://x.com/njulgh" rel="me" target="_blank"><i class="fa-brands fa-x-twitter fa-lg"></i></a>
	
	
	
	
	
	<a href="https://github.com/arloor" rel="me" target="_blank"><i class="fa-brands fa-github fa-lg"></i></a>
	
	
	
	
	
	
	
	
	
	
	
	
	
	<a href="https://t.me/never_contact_me" rel="me" target="_blank"><i class="fa-brands fa-telegram fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="mailto:admin@arloor.com" rel="me" target="_blank"><i class="fa-solid fa-at fa-lg"></i></a>
	
	
	
	
</section>
    </div>
    
<div class="copyright">
  &copy; 2026 arloor
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>


<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/arloor/hyde-arloor">hyde-arloor</a>.
</div>


  </div>
</div>

  <div class="content container">
    
    
<article>
  <header>
    <h1>Windows11 WSL2使用</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Sep 22, 2024
    
    
    
      
      
          in
          
          
              <a class="badge badge-category" href="/categories/undefined">UNDEFINED</a>
              
          
      
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/windows">windows</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 8 min read
</div>


  </header>
  
  
  
    <div class="toc-wrapper">
      <input type="checkbox" id="tocToggle">
      <label for="tocToggle">Table of Content</label>
      
          <nav id="TableOfContents">
  <ul>
    <li><a href="#windows-虚拟化的基础知识">windows 虚拟化的基础知识</a></li>
    <li><a href="#userprofilewslconfig">%userprofile%/.wslconfig</a></li>
    <li><a href="#安装-wsl2">安装 WSL2</a></li>
    <li><a href="#第一次启动">第一次启动</a></li>
    <li><a href="#其他设置">其他设置</a>
      <ul>
        <li><a href="#apt-设置代理">apt 设置代理</a></li>
        <li><a href="#apt-不更新某软件">apt 不更新某软件</a></li>
        <li><a href="#git-设置">git 设置</a></li>
        <li><a href="#安装-ca-证书">安装 ca 证书</a></li>
      </ul>
    </li>
    <li><a href="#docker-和-podman">docker 和 podman</a></li>
    <li><a href="#参考文档">参考文档</a></li>
    <li><a href="#内存释放太慢最不满意的一点">内存释放太慢，最不满意的一点</a></li>
    <li><a href="#让-wsl-一直在后台运行">让 wsl 一直在后台运行</a></li>
    <li><a href="#卸载发行版">卸载发行版</a></li>
    <li><a href="#wsl2-debian12-安装-openssh-server">WSL2 debian12 安装 openssh-server</a></li>
    <li><a href="#将-vhdx-文件移动到-d-盘">将 vhdx 文件移动到 D 盘</a></li>
    <li><a href="#安装-rhel10-作为-wsl">安装 rhel10 作为 WSL</a></li>
    <li><a href="#常见报错解决">常见报错解决</a>
      <ul>
        <li><a href="#0x80070422-wslservice-服务未启动">0x80070422 wslservice 服务未启动</a></li>
        <li><a href="#0x8004032d-虚拟机平台功能未启用">0x8004032d 虚拟机平台功能未启用</a></li>
        <li><a href="#端口被占用问题解决">端口被占用问题解决</a></li>
      </ul>
    </li>
  </ul>
</nav>
      
    </div>
  
  
  <div class="post">
    <p>wsl 全称是 windows 的 linux 子系统，可以理解为在你的 windows 电脑上提供一个 linux 的工作环境。</p>
<h2 id="windows-虚拟化的基础知识">windows 虚拟化的基础知识</h2>
<table>
  <thead>
      <tr>
          <th>windows 功能</th>
          <th>作用</th>
          <th>其他</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Hyper-V</td>
          <td>微软自己的虚拟化工具</td>
          <td>包含了“管理工具”和“平台”，其中“平台”包含“服务”和“虚拟机监控程序”</td>
      </tr>
      <tr>
          <td>Windows Subsystem for Linux</td>
          <td>WSL1，不是我们讨论的 WSL2 所需要的</td>
          <td></td>
      </tr>
      <tr>
          <td>Virtual Machine Platform</td>
          <td>虚拟机平台（WSL2 的底层依赖）</td>
          <td>看到说 Hyper-V 也依赖这个，但启用 Hyper-V 并不需要启用虚拟机平台，因此我觉得 Hyper-V 依赖的是“Hyper-V 虚拟机监控程序”吧</td>
      </tr>
      <tr>
          <td>Windows Sandbox</td>
          <td>一个隔离的桌面环境</td>
          <td>我反正没用过，不了解</td>
      </tr>
      <tr>
          <td>Windows 虚拟机监控程序平台</td>
          <td>用于支持 vmware 等第三方虚拟机软件</td>
          <td></td>
      </tr>
  </tbody>
</table>



<img src="/img/windows-feature-disable-virt.png" alt="" width="400px" style="max-width: 100%;">

<blockquote>
<ol>
<li>虚拟机平台会一定程度上影响游戏性能，为了游戏性能，可以关闭虚拟机平台、Hyper-V。Windows 虚拟机监控程序平台、适用于 Linux 的 Windows 子系统我理解是不影响游戏性能的。参考<a href="https://prod.support.services.microsoft.com/zh-cn/windows/%E7%94%A8%E4%BA%8E%E5%9C%A8-windows-11-%E4%B8%AD%E4%BC%98%E5%8C%96%E6%B8%B8%E6%88%8F%E6%80%A7%E8%83%BD%E7%9A%84%E9%80%89%E9%A1%B9-a255f612-2949-4373-a566-ff6f3f474613">用于在 Windows 11 中优化游戏性能的选项</a>。</li>
<li>Hyper-V 和 vmware 等软件是冲突的，详见<a href="https://learn.microsoft.com/zh-cn/troubleshoot/windows-client/application-management/virtualization-apps-not-work-with-hyper-v">虚拟化应用程序无法与 Hyper-V、Device Guard 和 Credential Guard 协同工作</a></li>
</ol>
</blockquote>
<p><strong>关闭虚拟机平台和 Hyper-V 虚拟机监控程序：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>dism.exe /online /disable-feature /featurename<span style="color:#960050;background-color:#1e0010">:</span>VirtualMachinePlatform /norestart
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 其实只要关闭 Microsoft-Hyper-V-Hypervisor 就行了</span>
</span></span><span style="display:flex;"><span>DISM /Online /Disable-Feature /FeatureName<span style="color:#960050;background-color:#1e0010">:</span>Microsoft-Hyper-V-All /NoRestart
</span></span><span style="display:flex;"><span>sc.exe config wslservice start= disabled
</span></span></code></pre></div><p><strong>开启虚拟机平台和 Hyper-V 虚拟机监控程序：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>dism.exe /online /enable-feature /featurename<span style="color:#960050;background-color:#1e0010">:</span>VirtualMachinePlatform /all /norestart
</span></span><span style="display:flex;"><span>DISM /Online /Enable-Feature /All /FeatureName<span style="color:#960050;background-color:#1e0010">:</span>Microsoft-Hyper-V-All /NoRestart
</span></span><span style="display:flex;"><span>sc.exe config wslservice start= demand
</span></span></code></pre></div><p><strong>查看所有 windows 功能</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>dism.exe /online /Get-Features
</span></span></code></pre></div><h2 id="userprofilewslconfig">%userprofile%/.wslconfig</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span>[<span style="color:#a6e22e">wsl2</span>]
</span></span><span style="display:flex;"><span><span style="color:#75715e"># networkingMode=bridged</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># vmSwitch=Home # 此处的名称和指定的虚拟网络交换机一致</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># dhcp=false # 禁用DHCP，在WSL2系统中通过设置Linux的静态IP实现获取IP</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">networkingMode</span> = <span style="color:#a6e22e">mirrored</span> <span style="color:#75715e"># 端口自动转发，Windows和WSL共享端口，都使用127.0.0.1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">dnsTunneling</span> = <span style="color:#66d9ef">true</span> <span style="color:#75715e"># WSL的DNS请求通过Windows转发</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">firewall</span> = <span style="color:#66d9ef">true</span> <span style="color:#75715e"># WSL同步Windows防火墙规则</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">autoProxy</span> = <span style="color:#66d9ef">true</span> <span style="color:#75715e"># Windows设置代理时自动同步给WSL，用于使用代理访问外网</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">experimental</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sparseVhd</span> = <span style="color:#66d9ef">true</span> <span style="color:#75715e"># 自动清理磁盘空间</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">autoMemoryReclaim</span> = <span style="color:#a6e22e">gradual</span> <span style="color:#75715e"># 可以在gradual 、dropcache 、disabled之间选择。 如果设置成gradual，需要设置kernelCommandLine以开启cgroupV2，否则docker会有问题</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">hostAddressLoopback</span> = <span style="color:#66d9ef">true</span> <span style="color:#75715e"># WSL2中访问Windows的localhost</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">wsl2</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">swap</span> = <span style="color:#ae81ff">0</span> <span style="color:#75715e"># 禁用swap，使用内存交换文件，不使用磁盘交换文件</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 开启cgroup v2，用于docker和autoMemoryReclaim = gradual共存</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kernelCommandLine</span> = <span style="color:#a6e22e">cgroup_no_v1</span>=<span style="color:#a6e22e">all</span> <span style="color:#a6e22e">systemd</span>.<span style="color:#a6e22e">unified_cgroup_hierarchy</span>=<span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>上面的配置启用了自动内存回收，不过仍然可以手动释放 page cache（在 wsl 中执行）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;sync; echo 3 &gt; /proc/sys/vm/drop_caches; touch /root/drop_caches_last_run&#34;</span> |tee /tmp/drop_caches
</span></span><span style="display:flex;"><span>install /tmp/drop_caches /usr/local/bin/loss
</span></span><span style="display:flex;"><span>loss
</span></span></code></pre></div><h2 id="安装-wsl2">安装 WSL2</h2>
<p>这里使用了 Debian12，因为我不喜欢 Ubuntu 的 Snap，而且 Debian12 的 wsl 发行版支持 ebpf。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># 启用VMP 虚拟机平台</span>
</span></span><span style="display:flex;"><span>dism.exe /online /enable-feature /featurename<span style="color:#960050;background-color:#1e0010">:</span>VirtualMachinePlatform /all /norestart
</span></span><span style="display:flex;"><span>echo you may need reboot to take effect
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启用wslservice</span>
</span></span><span style="display:flex;"><span>sc.exe config wslservice start= demand
</span></span><span style="display:flex;"><span>wsl --set-default-version <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>wsl -v
</span></span><span style="display:flex;"><span>wsl --list --online
</span></span><span style="display:flex;"><span>wsl --install -d Debian
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置默认root用户</span>
</span></span><span style="display:flex;"><span>debian config --default-user root
</span></span></code></pre></div><h2 id="第一次启动">第一次启动</h2>
<p>设置用户名和密码：</p>
<p><img src="/img/Snipaste_2024-09-21_16-56-02.png" alt=""></p>
<p>启用 systemd：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ! grep -q <span style="color:#e6db74">&#34;systemd=true&#34;</span> /etc/wsl.conf; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    cat <span style="color:#e6db74">&lt;&lt;EOF | tee /etc/wsl.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[boot]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">systemd = true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[user]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">default = root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span></code></pre></div><p>执行 <code>wsl --shutdown</code> 重启 wsl，然后就可以使用 systemd 了。</p>
<h2 id="其他设置">其他设置</h2>
<h3 id="apt-设置代理">apt 设置代理</h3>
<p>默认安装的 Debian 的默认源是官方源，国内比较慢，直接配置 apt 代理。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ! grep -q Acquire::http::Proxy /etc/apt/apt.conf.d/proxy.conf;<span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    cat <span style="color:#e6db74">&lt;&lt;EOF | tee /etc/apt/apt.conf.d/proxy.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Acquire::http::Proxy &#34;https://user:passwd@server:port/&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Acquire::https::Proxy &#34;https://user:passwd@server:port/&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 否则报错没有ca-certificates
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Acquire::https::Verify-Peer &#34;false&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span></code></pre></div><h3 id="apt-不更新某软件">apt 不更新某软件</h3>
<p>apt-mark 可以对软件包进行设置（手动/自动）安装标记，也可以用来处理软件包的 dpkg(1) 选中状态，以及列出或过滤拥有某个标记的软件包。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>apt-mark auto – 标记指定软件包为自动安装
</span></span><span style="display:flex;"><span>apt-mark manual – 标记指定软件包为手动安装
</span></span><span style="display:flex;"><span>apt-mark minimize-manual – Mark all dependencies of meta packages as automatically installed.
</span></span><span style="display:flex;"><span>apt-mark hold – 标记指定软件包为保留<span style="color:#f92672">(</span>held back<span style="color:#f92672">)</span>，阻止软件自动更新
</span></span><span style="display:flex;"><span>apt-mark unhold – 取消指定软件包的保留<span style="color:#f92672">(</span>held back<span style="color:#f92672">)</span>标记，解除阻止自动更新
</span></span><span style="display:flex;"><span>apt-mark showauto – 列出所有自动安装的软件包
</span></span><span style="display:flex;"><span>apt-mark showmanual – 列出所有手动安装的软件包
</span></span><span style="display:flex;"><span>apt-mark showhold – 列出设为保留的软件包
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 比如保留某个软件不更新可以使用hold标记,如docker</span>
</span></span><span style="display:flex;"><span>apt-mark hold docker*
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>apt-mark showhold
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 如果要解除保留可以使用unhold</span>
</span></span><span style="display:flex;"><span>apt-mark unhold docker*
</span></span></code></pre></div><h3 id="git-设置">git 设置</h3>
<p>由于 wsl 支持 windows 和 linux 的命令互操作，你实际上会有两个 git，一个 wsl 的 git，一个 windows 的 git.exe。</p>
<p><strong>WSL git 配置</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git config --global core.editor vim
</span></span><span style="display:flex;"><span>git config --global http.proxy http://127.0.0.1:7890
</span></span><span style="display:flex;"><span>git config --global https.proxy http://127.0.0.1:7890
</span></span><span style="display:flex;"><span>git config --global <span style="color:#e6db74">&#34;includeIf.hasconfig:remote.*.url:*://*github.com*/**.path&#34;</span> .gitconfig_github
</span></span><span style="display:flex;"><span>git config --global <span style="color:#e6db74">&#34;includeIf.hasconfig:remote.*.url:git@github.com:*/**.path&#34;</span> .gitconfig_github
</span></span><span style="display:flex;"><span>cat &gt; ~/.gitconfig_github <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[user]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        name = arloor
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        email = admin@arloor.com
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>git config --global credential.helper store
</span></span><span style="display:flex;"><span>git config --global pull.rebase true
</span></span><span style="display:flex;"><span><span style="color:#75715e"># wsl的git忽略文件权限的变更</span>
</span></span><span style="display:flex;"><span>git config --global core.filemode false
</span></span><span style="display:flex;"><span><span style="color:#75715e"># wsl的git 提交时自动将crlf转换为lf，checkout时不转成crlf</span>
</span></span><span style="display:flex;"><span>git config --global core.autocrlf input
</span></span></code></pre></div><p><strong>windows git 配置</strong></p>
<p>wsl 的 git 提交时自动将 crlf 转换为 lf，checkout 时不转成 crlf</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git config --global core.autocrlf input
</span></span><span style="display:flex;"><span>git config --global pull.rebase true
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 保存 windows 的 git 凭证，避免每次都输入用户名和密码</span>
</span></span><span style="display:flex;"><span>git config --global credential.helper manager-core
</span></span></code></pre></div><p>autocrlf 的配置详见<a href="https://git-scm.com/book/en/v2/Customizing-Git-Git-Configuration#_formatting_and_whitespace">git 文档</a></p>
<p>简单解释就是：</p>
<ul>
<li>windows 使用 crlf 换行，linux 和 macos 使用 lf 换行（早期 macos 使用 cr 换行）</li>
<li>autocrlf=true，提交到 index 时自动将 crlf 换成 lf，checkout 时自动将 lf 换成 crlf。适合 windows 使用，widnwos 默认配置</li>
<li>autocrlf=input，提交到 index 时自动将 crlf 换成 lf，checkout 时不自动转换。适合 macos 和 linux 用。</li>
<li>autocrlf=false，不自动转换换行符。</li>
</ul>
<p>git 文档推荐，linux 和 macos 使用 input，windows 使用 true。这样保证 index、linux、macos 中永远是 lf，windows 中是 crlf。</p>
<p><strong>但是</strong>我的设置成了 windows 上也是 input。</p>
<p>直接原因是我有很多 shell 脚本，原本 git.exe 的 bash 是可以执行 crlf 的 shell 文件的。安装 wsl 后，bash 被替换为了 Debian 的 bash，不能处理 crlf 的 shell 文件。——我需要 shell 脚本是 lf 的。根本原因，换行符的问题是一个历史遗留问题，是操作系统之间的壁垒。现代的 ide 或者文本编辑器都是跨平台使用的，他们能处理换行符的问题，那么用 vscode，idea 就行了，不要用 windows 的老版文本编辑器了。我已经比较习惯在 linux 处理文本了，vim、grep、awk、sed 等等很爽，wsl 的最大好处就是在 windows 上能用上原生的 bash，那就文本全部 linux 化好了。</p>
<h3 id="安装-ca-证书">安装 ca 证书</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cp your-certificate.crt /usr/local/share/ca-certificates/
</span></span><span style="display:flex;"><span>update-ca-certificates
</span></span></code></pre></div><h2 id="docker-和-podman">docker 和 podman</h2>
<ul>
<li>如果你遇到 docker 无法从 Windows 访问的问题。首先确保 docker 版本在 27.3.0 以上，这个版本修复了这个问题，见<a href="https://github.com/moby/moby/pull/48514/files#diff-aa946998315144e84ceffe7bd84918fd8d34183af1cae444ce90e2b620ec8371">[27.x backport] Do not DNAT packets from WSL2&rsquo;s loopback0</a>。如果不能升级 docker 的话，可以在 /etc/docker/daemon.json 里添加一句 &ldquo;iptables&rdquo;: false，然后重启 docker daemon</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;iptables&#34;</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>podman 容器需要设置 <code>--network host</code>，否则其他容器访问会报错 no route to host。</li>
</ul>
<h2 id="参考文档">参考文档</h2>
<ul>
<li><a href="https://www.ryanshang.com/2024/01/06/WSL2%E8%AE%BE%E7%BD%AE%E9%95%9C%E5%83%8F%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F/">WSL2 设置镜像网络模式</a></li>
<li><a href="https://learn.microsoft.com/zh-cn/windows/wsl/wsl-config">WSL 中的高级设置配置</a></li>
</ul>
<h2 id="内存释放太慢最不满意的一点">内存释放太慢，最不满意的一点</h2>
<p>即使有了<code>autoMemoryReclaim</code>，任务管理器里看到的 <code>VmmemWSL</code> 还是远大于 wsl 里 top 看到的 res + buffer/cache。即使<code>wsl -t Debian</code> 也不会释放内存，只有<code>wsl --shutdown</code>才可以释放内存。观察到断开所有 wsl 的 terminal 和所有由用户启动的后台进程（不包含 systemd 启动的）都结束后，wsl 会在一段时间后自动 shutdown，此时 VmmemWSL 也会降为 0。但如果有后台进程常驻的话，就不会自动关闭了，这就建议放个 bat 文件在桌面，不用 wsl 的时候就 shutdown 掉吧。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>@echo off
</span></span><span style="display:flex;"><span>wsl --shutdown
</span></span></code></pre></div><p>相关 issue: <a href="https://github.com/microsoft/WSL/issues/4166">WSL 2 consumes massive amounts of RAM and doesn&rsquo;t return it</a></p>
<p>关于内存回收的问题，找到两个文章：</p>
<table>
  <thead>
      <tr>
          <th>文章</th>
          <th>时间</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><a href="https://devblogs.microsoft.com/commandline/memory-reclaim-in-the-windows-subsystem-for-linux-2/">Memory Reclaim in the Windows Subsystem for Linux 2</a></td>
          <td>October 30th, 2019</td>
          <td>基于某 kernel patch 的 pageReporting，将虚拟机闲置的连续的内存返还给宿主机。WSL 会在 cpu Idle 的时候进行内存的 compaction，然后进行返还。也可以手动执行<code>echo 1 &gt; /proc/sys/vm/compact_memory</code>触发</td>
      </tr>
      <tr>
          <td><a href="https://devblogs.microsoft.com/commandline/windows-subsystem-for-linux-september-2023-update/#automatic-memory-reclaim">Automatic memory reclaim</a></td>
          <td>September 18th, 2023</td>
          <td>“逐渐释放”：基于 CgroupV2 的 memory.reclaim 特性逐渐释放 page cache，与 docker 使用的 CgroupV1 冲突。“idle 时立即释放”：不依赖 CgroupV2 的特性，可与 docker 共存</td>
      </tr>
  </tbody>
</table>
<h2 id="让-wsl-一直在后台运行">让 wsl 一直在后台运行</h2>
<p><a href="https://www.cnblogs.com/wswind/p/17201979.html">https://www.cnblogs.com/wswind/p/17201979.html</a></p>
<p><strong>简单方案：</strong> 写个 VBS 脚本，启动 wsl 的 terminal 在后台一直等待输入：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>set ws<span style="color:#f92672">=</span>wscript.CreateObject<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;wscript.shell&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>ws.run <span style="color:#e6db74">&#34;wsl -d Debian&#34;</span>, <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p><strong>进阶方案：</strong> 只启动一个后台进程，即使多次运行该 VBS 脚本：</p>
<p>keepalive 命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt; /usr/local/bin/keepalive <span style="color:#e6db74">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">command=&#34;watch -n 30 &#39;uptime |head -n 3 | tee /tmp/uptime&#39;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ps -ef|grep &#34;${command}&#34;|grep -v grep
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if [ $? -ne 0 ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    sh -c &#34;${command}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">else
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    echo &#34;The command is already running&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>chmod +x /usr/local/bin/keepalive
</span></span></code></pre></div><p>写个 VBS 脚本：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>set ws<span style="color:#f92672">=</span>wscript.CreateObject<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;wscript.shell&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>ws.run <span style="color:#e6db74">&#34;wsl -d Debian /usr/local/bin/keepalive&#34;</span>, <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>将这个 VBS 脚本的快捷方式放到启动文件夹，这样就可以在开机时自动运行了。启动文件夹在：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>%userprofile%<span style="color:#ae81ff">\A</span>ppData<span style="color:#ae81ff">\R</span>oaming<span style="color:#ae81ff">\M</span>icrosoft<span style="color:#ae81ff">\W</span>indows<span style="color:#ae81ff">\S</span>tart Menu<span style="color:#ae81ff">\P</span>rograms<span style="color:#ae81ff">\S</span>tartup
</span></span></code></pre></div><p>或者使用 windows 的任务计划程序设置为用户登录时自动运行，参考<a href="https://www.sjdhome.com/blog/post/wsl2-auto-start/">实现 WSL 2 开机免登录自动启动</a>：</p>
<p><img src="/img/task-scheduler-keep-wsl-1.png" alt="alt text">
<img src="/img/task-scheduler-keep-wsl-2.png" alt="alt text">
<img src="/img/task-scheduler-keep-wsl-3.png" alt="alt text"></p>
<h2 id="卸载发行版">卸载发行版</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bat" data-lang="bat"><span style="display:flex;"><span>wsl --terminate Debian # 停止
</span></span><span style="display:flex;"><span>wsl --unregister Debian # 卸载
</span></span></code></pre></div><h2 id="wsl2-debian12-安装-openssh-server">WSL2 debian12 安装 openssh-server</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>apt remove -y openssh-server
</span></span><span style="display:flex;"><span>apt install -y openssh-server
</span></span><span style="display:flex;"><span>mkdir -p /root/.ssh
</span></span><span style="display:flex;"><span>echo ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDZQzKHfZLlFEdaRUjfSK4twhL0y7+v23Ko4EI1nl6E1/zYqloSZCH3WqQFLGA7gnFlqSAfEHgCdD/4Ubei5a49iG0KSPajS6uPkrB/eiirTaGbe8oRKv2ib4R7ndbwdlkcTBLYFxv8ScfFQv6zBVX3ywZtRCboTxDPSmmrNGb2nhPuFFwnbOX8McQO5N4IkeMVedUlC4w5//xxSU67i1i/7kZlpJxMTXywg8nLlTuysQrJHOSQvYHG9a6TbL/tOrh/zwVFbBS+kx7X1DIRoeC0jHlVJSSwSfw6ESrH9JW71cAvn6x6XjjpGdQZJZxpnR1NTiG4Q5Mog7lCNMJjPtwJ not@home &gt;/root/.ssh/authorized_keys
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;s/\(#\)\?PasswordAuthentication yes/PasswordAuthentication no/g&#39;</span> /etc/ssh/sshd_config
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;s/\(#\)\?PubkeyAuthentication no/PubkeyAuthentication yes/g&#39;</span> /etc/ssh/sshd_config
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;s/\(#\)\?Port .*/Port 222/g&#39;</span> /etc/ssh/sshd_config <span style="color:#75715e"># 改成222端口</span>
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;s/\(#\)\?UseDNS.*/UseDNS no/g&#39;</span> /etc/ssh/sshd_config
</span></span><span style="display:flex;"><span>systemctl restart sshd
</span></span><span style="display:flex;"><span>systemctl enable ssh.service
</span></span></code></pre></div><p>放通 windows 防火墙：</p>
<p><img src="/img/winodws11-firewall-setup-port.png" alt="alt text"></p>
<p><img src="/img/winodws11-firewall-setup-222-port.png" alt="alt text"></p>
<p>然后一路下一步即可。</p>
<p>或者直接在管理员权限的 powershell 执行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>$port=<span style="color:#ae81ff">2222</span>
</span></span><span style="display:flex;"><span>New-NetFirewallRule -DisplayName <span style="color:#e6db74">&#34;Allow Port </span>$port<span style="color:#e6db74">&#34;</span> -Direction Inbound -Protocol TCP -LocalPort $port -Action Allow
</span></span></code></pre></div><p>之后就可以使用 vscode remote-ssh 到 WSL2 上来开发了。具体的 ssh config 如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Host wsl
</span></span><span style="display:flex;"><span>  HostName 192.168.xx.xx
</span></span><span style="display:flex;"><span>  Port <span style="color:#ae81ff">222</span>
</span></span><span style="display:flex;"><span>  User root
</span></span></code></pre></div><p>不过因为 wsl2 有 idle 自动关闭的特性，所以从外部 remote-ssh 进来时，需要从外部保活 WSL2。思路是 ssh 到 windows 上（参考<a href="/posts/mac-wakeonlan-windows-11-msi-motherboard/#windows11-%E5%90%AF%E7%94%A8openssh">widnows11 启用 openssh-server</a>），然后执行一个前台命令一直运行，具体命令是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ssh windows_user@windows -t wsl
</span></span></code></pre></div><h2 id="将-vhdx-文件移动到-d-盘">将 vhdx 文件移动到 D 盘</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>(Get-ChildItem -Path HKCU<span style="color:#960050;background-color:#1e0010">:</span>\Software\Microsoft\Windows\CurrentVersion\Lxss | Where-Object { $_.GetValue(<span style="color:#e6db74">&#34;DistributionName&#34;</span>) <span style="color:#f92672">-eq</span> <span style="color:#e6db74">&#39;Debian&#39;</span> }).GetValue(<span style="color:#e6db74">&#34;BasePath&#34;</span>) + <span style="color:#e6db74">&#34;\ext4.vhdx&#34;</span>
</span></span><span style="display:flex;"><span>wsl -l
</span></span><span style="display:flex;"><span>wsl --export Debian d://Debian.tar  <span style="color:#75715e"># 导出成tar文件</span>
</span></span><span style="display:flex;"><span>wsl --unregister Debian <span style="color:#75715e"># 需要先注销原来的发行版</span>
</span></span><span style="display:flex;"><span>mkdir d:\wsl <span style="color:#75715e"># 创建目录</span>
</span></span><span style="display:flex;"><span>wsl --import Debian d:\wsl D:\Debian.tar  --version <span style="color:#ae81ff">2</span><span style="color:#75715e"># 导入到D盘</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 确认vhdx文件位置</span>
</span></span><span style="display:flex;"><span>(Get-ChildItem -Path HKCU<span style="color:#960050;background-color:#1e0010">:</span>\Software\Microsoft\Windows\CurrentVersion\Lxss | Where-Object { $_.GetValue(<span style="color:#e6db74">&#34;DistributionName&#34;</span>) <span style="color:#f92672">-eq</span> <span style="color:#e6db74">&#39;Debian&#39;</span> }).GetValue(<span style="color:#e6db74">&#34;BasePath&#34;</span>) + <span style="color:#e6db74">&#34;\ext4.vhdx&#34;</span>
</span></span></code></pre></div><h2 id="安装-rhel10-作为-wsl">安装 rhel10 作为 WSL</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>mkdir D:\redhat
</span></span><span style="display:flex;"><span>wsl --import rhel D:\redhat C:\Users\arloor\Downloads\composer-api-8d21250f-6d7f-<span style="color:#ae81ff">4483</span>-8a1e-c79c51929d45-disk.tar.gz
</span></span><span style="display:flex;"><span>wsl.exe --shutdown
</span></span><span style="display:flex;"><span>wsl.exe --manage rhel --set-sparse true --allow-unsafe
</span></span></code></pre></div><h2 id="常见报错解决">常见报错解决</h2>
<h3 id="0x80070422-wslservice-服务未启动">0x80070422 wslservice 服务未启动</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>无法启动服务，原因可能是已被禁用或与其相关联的设备没有启动。
</span></span><span style="display:flex;"><span>Error code: Wsl/0x80070422
</span></span></code></pre></div><p>解决方案：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bat" data-lang="bat"><span style="display:flex;"><span>sc.exe config wslservice start= demand
</span></span></code></pre></div><h3 id="0x8004032d-虚拟机平台功能未启用">0x8004032d 虚拟机平台功能未启用</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bat" data-lang="bat"><span style="display:flex;"><span>WslRegisterDistribution failed with error: 0x8004032d
</span></span><span style="display:flex;"><span>Error: 0x8004032d (null)
</span></span></code></pre></div><p>解决方案：在启用和关闭 windows 功能中打开“虚拟机平台”或使用下面的 cmd 命令并重启</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bat" data-lang="bat"><span style="display:flex;"><span>dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart
</span></span></code></pre></div><h3 id="端口被占用问题解决">端口被占用问题解决</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bat" data-lang="bat"><span style="display:flex;"><span># 查看当前动态端口范围
</span></span><span style="display:flex;"><span>netsh int ipv4 show dynamicport tcp
</span></span><span style="display:flex;"><span># 查看被使用的端口
</span></span><span style="display:flex;"><span>netsh int ipv4 show excludedportrange protocol=tcp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 修改动态端口范围
</span></span><span style="display:flex;"><span>netsh int ipv4 set dynamic tcp start=50000 num=15536
</span></span><span style="display:flex;"><span>netsh int ipv6 set dynamic tcp start=50000 num=15536
</span></span><span style="display:flex;"><span># 重启网络
</span></span><span style="display:flex;"><span>net stop winnat
</span></span><span style="display:flex;"><span>net start winnat
</span></span></code></pre></div>
  </div>
  

<div class="navigation navigation-single">
    
    <a href="/posts/obs-use/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">OBS直播、录屏</span>
    </a>
    
    
    <a href="/posts/macos-settings/" class="navigation-next">
      <span class="navigation-tittle">macOS一些配置</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  


</article>


  </div>
<style>
  .content.container {
        width: 100%;
        max-width: none;
        height: calc(100vh - var(--sidebar-height, 49px));
        border: none;
        display: block;
        overflow-y: auto;
        box-sizing: border-box;
        margin-left: 0;
        margin-right: 0;
  }

  body:not(.type-iframe) .content.container {
        padding-left: max(1.5rem, calc((100% - var(--content-max-width, 38rem)) / 2));
        padding-right: max(1.5rem, calc((100% - var(--content-max-width, 38rem)) / 2));
  }
</style>
<script>
    (function () {
        var contentSelector = '.content.container';
        var rafId = 0;
        var resizeDebounceTimer = 0;
        var pendingHashScroll = false;

        function getHashTarget() {
            var hash = window.location.hash;
            var targetId = '';

            if (!hash || hash === '#') {
                return null;
            }

            targetId = hash.slice(1);
            try {
                targetId = decodeURIComponent(targetId);
            } catch (e) {
                
            }

            return document.getElementById(targetId);
        }

        function scrollToHashTarget() {
            var target = getHashTarget();
            if (!target) {
                return;
            }
            try {
                target.scrollIntoView({ block: 'start', inline: 'nearest' });
            } catch (e) {
                target.scrollIntoView(true);
            }
        }

        function applyPendingHashScroll() {
            if (!pendingHashScroll) {
                return;
            }
            pendingHashScroll = false;
            scrollToHashTarget();
        }

        function resizeContentHeight() {
            var content = document.querySelector(contentSelector);
            if (!content) {
                return;
            }
            var rect = content.getBoundingClientRect();
            var available = window.innerHeight - rect.top;
            if (available < 0) {
                available = 0;
            }
            content.style.height = available + 'px';
            applyPendingHashScroll();
        }

        function scheduleResize() {
            if (rafId) {
                return;
            }
            rafId = window.requestAnimationFrame(function () {
                rafId = 0;
                resizeContentHeight();
            });
        }

        function scheduleResizeDebounced(delay) {
            window.clearTimeout(resizeDebounceTimer);
            resizeDebounceTimer = window.setTimeout(scheduleResize, delay || 120);
        }

        function requestHashScroll() {
            if (!window.location.hash || window.location.hash === '#') {
                return;
            }
            pendingHashScroll = true;
            scheduleResize();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function () {
                scheduleResize();
                requestHashScroll();
            }, { once: true });
        } else {
            scheduleResize();
            requestHashScroll();
        }

        window.addEventListener('load', function () {
            scheduleResize();
            requestHashScroll();
        });
        window.addEventListener('pageshow', function () {
            scheduleResize();
            requestHashScroll();
        });
        window.addEventListener('hashchange', requestHashScroll);
        window.addEventListener('resize', function () {
            scheduleResizeDebounced(120);
        });

        var menuToggle = document.getElementById('menuToggle');
        if (menuToggle) {
            menuToggle.addEventListener('change', function () {
                scheduleResize();
                window.setTimeout(scheduleResize, 250);
            });
        }
    })();
</script>
  
    



<script defer src="/js/all.js" crossorigin="anonymous"></script>

    
    
    <script src="/js/highlight.min.js"></script>
    <script src="/js/languages/dos.min.js"></script>
        
            
                <script src="https://us.arloor.dev/https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/powershell.min.js"></script>
                
            
        
    <script type="text/javascript">
        
        hljs.configure({languages: ["powershell"]});
        
        hljs.highlightAll();
    </script>
    

<style>
    .code-block-wrapper {
        position: relative;
    }
    .copy-code-button {
        position: absolute;
        top: 8px;
        right: 8px;
        padding: 6px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.3s, background 0.3s;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .copy-code-button svg {
        width: 16px;
        height: 16px;
        fill: #fff;
        transition: fill 0.3s;
    }
    .code-block-wrapper:hover .copy-code-button {
        opacity: 1;
    }
    .copy-code-button:hover {
        background: rgba(255, 255, 255, 0.2);
    }
    .copy-code-button.copied {
        background: rgba(46, 160, 67, 0.8);
        border-color: rgba(46, 160, 67, 1);
    }
    .copy-code-button.copied svg {
        fill: #fff;
    }
</style>
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
        
        document.querySelectorAll('pre code').forEach(function(codeBlock) {
            var pre = codeBlock.parentNode;
            
            
            if (pre.parentNode.classList.contains('code-block-wrapper')) {
                return;
            }
            
            
            var wrapper = document.createElement('div');
            wrapper.className = 'code-block-wrapper';
            pre.parentNode.insertBefore(wrapper, pre);
            wrapper.appendChild(pre);
            
            
            var button = document.createElement('button');
            button.className = 'copy-code-button';
            button.innerHTML = '<svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path></svg>';
            button.setAttribute('aria-label', '复制代码');
            button.setAttribute('title', '复制代码');
            
            var copyIcon = '<svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path></svg>';
            var checkIcon = '<svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16"><path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path></svg>';
            
            
            button.addEventListener('click', function() {
                var code = codeBlock.textContent;
                navigator.clipboard.writeText(code).then(function() {
                    button.innerHTML = checkIcon;
                    button.classList.add('copied');
                    button.setAttribute('aria-label', '已复制');
                    button.setAttribute('title', '已复制');
                    setTimeout(function() {
                        button.innerHTML = copyIcon;
                        button.classList.remove('copied');
                        button.setAttribute('aria-label', '复制代码');
                        button.setAttribute('title', '复制代码');
                    }, 2000);
                }).catch(function(err) {
                    console.error('复制失败:', err);
                });
            });
            
            wrapper.appendChild(button);
        });
    });
</script>




    



</body>

</html>
