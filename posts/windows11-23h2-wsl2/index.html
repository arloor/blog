<!DOCTYPE html>
<html lang="zh-CN">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    
    <link rel="canonical" href="https://www.arloor.com/posts/windows11-23h2-wsl2/">
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.139.4">

    
    
    

<title>Windows11 WSL2使用 • ARLOOR</title>
<meta name="description" content="今天，你学习了吗">
<meta name="keywords" content="刘港欢, arloor, moontell">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Windows11 WSL2使用">
  <meta name="twitter:description" content="wsl全称是windows的linux子系统，可以理解为在你的windows电脑上提供一个linux的工作环境。">
      <meta name="twitter:site" content="@njulgh">

<meta property="og:url" content="https://www.arloor.com/posts/windows11-23h2-wsl2/">
  <meta property="og:site_name" content="ARLOOR">
  <meta property="og:title" content="Windows11 WSL2使用">
  <meta property="og:description" content="wsl全称是windows的linux子系统，可以理解为在你的windows电脑上提供一个linux的工作环境。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-09-22T13:45:23+08:00">
    <meta property="article:modified_time" content="2024-09-22T13:45:23+08:00">
    <meta property="article:tag" content="Windows">


    





<link rel="stylesheet" href="/styles/atom-one-dark.min.css">








<link rel="stylesheet" href="/scss/hyde-hyde.484b96856b25751067d56c8c0af9dc1fd6372707029b6d56ee178da6bead45b5.css" integrity="sha256-SEuWhWsldRBn1WyMCvncH9Y3JwcCm21W7heNpr6tRbU=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">




<link rel="stylesheet" href="/scss/hugo-toc.0873834b0f2e9fdc9e1d0301e8ebce21fc10383882a41e9373f29b90e85a9987.css" integrity="sha256-CHODSw8un9yeHQMB6OvOIfwQODiCpB6Tc/KbkOhamYc=">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    

</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="/">
          
          ARLOOR
          
        </a>
      </span>
      <a href="/">
        
        
        <div class="author-image">
          <img src="/img/head.jpeg" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
        
      </a>
      
      <p class="site__description">
         都是瞎写的 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">ARLOOR</label>
      <div class="menu-content">
        <div class="show-in-small">
          <a href="/">
            
            
            <div class="author-image">
              <img src="/img/head.jpeg" alt="Author Image"
                class="img--circle img--headshot element--center">
            </div>
            
            
          </a>
        </div>
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>文章</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/">
						<span>分类</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>关于我</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="http://beian.miit.gov.cn/">
						<span>苏ICP备17024437号</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://x.com/njulgh" rel="me"><i class="fa-brands fa-x-twitter fa-lg"></i></a>
	
	
	
	
	
	<a href="https://github.com/arloor" rel="me"><i class="fa-brands fa-github fa-lg"></i></a>
	
	
	
	
	
	
	
	
	
	
	
	
	
	<a href="https://t.me/never_contact_me" rel="me"><i class="fa-brands fa-telegram fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="mailto:admin@arloor.com" rel="me"><i class="fa-solid fa-at fa-lg"></i></a>
	
	
	
	
</section>
      </div>
    </div>
    
<div class="copyright">
  &copy; 2024 arloor
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>


<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/arloor/hyde-arloor">hyde-arloor</a>.
</div>


  </div>
</div>
        <div class="content container">
            
    
<article>
  <header>
    <h1>Windows11 WSL2使用</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Sep 22, 2024
    
    
    
      
      
          in
          
          
              <a class="badge badge-category" href="/categories/undefined">UNDEFINED</a>
              
          
      
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/windows">windows</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 9 min read
</div>


  </header>
  
  
  
    <div class="toc-wrapper">
      <input type="checkbox" id="tocToggle">
      <label for="tocToggle">Table of Content</label>
      
          <nav id="TableOfContents">
  <ul>
    <li><a href="#windows虚拟化的基础知识">windows虚拟化的基础知识</a></li>
    <li><a href="#userprofilewslconfig">%userprofile%/.wslconfig</a></li>
    <li><a href="#安装wsl2">安装WSL2</a></li>
    <li><a href="#第一次启动">第一次启动</a></li>
    <li><a href="#其他设置">其他设置</a>
      <ul>
        <li><a href="#apt设置代理">apt设置代理</a></li>
        <li><a href="#apt不更新某软件">apt不更新某软件</a></li>
        <li><a href="#git设置">git设置</a></li>
        <li><a href="#安装ca证书">安装ca证书</a></li>
      </ul>
    </li>
    <li><a href="#docker和podman">docker和podman</a></li>
    <li><a href="#参考文档">参考文档</a></li>
    <li><a href="#内存释放太慢最不满意的一点">内存释放太慢，最不满意的一点</a></li>
    <li><a href="#让wsl一直在后台运行">让wsl一直在后台运行</a></li>
    <li><a href="#常见报错解决">常见报错解决</a>
      <ul>
        <li><a href="#0x80070422-wslservice服务未启动">0x80070422 wslservice服务未启动</a></li>
        <li><a href="#0x8004032d-虚拟机平台功能未启用">0x8004032d 虚拟机平台功能未启用</a></li>
        <li><a href="#端口被占用问题解决">端口被占用问题解决</a></li>
      </ul>
    </li>
    <li><a href="#卸载发行版">卸载发行版</a></li>
    <li><a href="#wsl2-debian12-安装docker并配置daemonjson">WSL2 debian12 安装docker并配置daemon.json</a></li>
    <li><a href="#wsl2-debian12-安装openssh-server">WSL2 debian12 安装openssh-server</a></li>
  </ul>
</nav>
      
    </div>
  
  
  <div class="post">
    <p>wsl全称是windows的linux子系统，可以理解为在你的windows电脑上提供一个linux的工作环境。</p>
<h2 id="windows虚拟化的基础知识">windows虚拟化的基础知识</h2>
<table>
  <thead>
      <tr>
          <th>windows功能</th>
          <th>作用</th>
          <th>其他</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Hyper-V</td>
          <td>微软自己的虚拟化工具</td>
          <td>包含了“管理工具”和“平台”，其中“平台”包含“服务”和“虚拟机监控程序”</td>
      </tr>
      <tr>
          <td>Windows Subsystem for Linux</td>
          <td>WSL1，不是我们讨论的WSL2所需要的</td>
          <td></td>
      </tr>
      <tr>
          <td>Virtual Machine Platform</td>
          <td>虚拟机平台（WSL2的底层依赖）</td>
          <td>看到说Hyper-V也依赖这个，但启用Hyper-V并不需要启用虚拟机平台，因此我觉得Hyper-V依赖的是“Hyper-V虚拟机监控程序”吧</td>
      </tr>
      <tr>
          <td>Windows Sandbox</td>
          <td>一个隔离的桌面环境</td>
          <td>我反正没用过，不了解</td>
      </tr>
      <tr>
          <td>Windows 虚拟机监控程序平台</td>
          <td>用于支持vmware等第三方虚拟机软件</td>
          <td></td>
      </tr>
  </tbody>
</table>



<img src="/img/windows-feature-disable-virt.png" alt="" width="400px" style="max-width: 100%;">

<blockquote>
<ol>
<li>虚拟机平台会一定程度上影响游戏性能，为了游戏性能，可以关闭虚拟机平台、Hyper-V。Windows虚拟机监控程序平台、适用于Linux的Windows子系统我理解是不影响游戏性能的。参考<a href="https://prod.support.services.microsoft.com/zh-cn/windows/%E7%94%A8%E4%BA%8E%E5%9C%A8-windows-11-%E4%B8%AD%E4%BC%98%E5%8C%96%E6%B8%B8%E6%88%8F%E6%80%A7%E8%83%BD%E7%9A%84%E9%80%89%E9%A1%B9-a255f612-2949-4373-a566-ff6f3f474613">用于在 Windows 11 中优化游戏性能的选项</a>。</li>
<li>Hyper-V和vmware等软件是冲突的，详见<a href="https://learn.microsoft.com/zh-cn/troubleshoot/windows-client/application-management/virtualization-apps-not-work-with-hyper-v">虚拟化应用程序无法与 Hyper-V、Device Guard 和 Credential Guard 协同工作</a></li>
</ol>
</blockquote>
<p><strong>关闭虚拟机平台和Hyper-V虚拟机监控程序：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bat" data-lang="bat"><span style="display:flex;"><span>dism.exe /online /disable-feature /featurename:VirtualMachinePlatform /norestart
</span></span><span style="display:flex;"><span>DISM /Online /Disable-Feature /FeatureName:Microsoft-Hyper-V-All /NoRestart
</span></span><span style="display:flex;"><span>@<span style="color:#75715e">REM 其实只要关闭 Microsoft-Hyper-V-Hypervisor 就行了</span>
</span></span></code></pre></div><p><strong>开启虚拟机平台和Hyper-V虚拟机监控程序：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bat" data-lang="bat"><span style="display:flex;"><span>dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart
</span></span><span style="display:flex;"><span>DISM /Online /Enable-Feature /All /FeatureName:Microsoft-Hyper-V-All /NoRestart
</span></span></code></pre></div><p><strong>查看所有windows功能</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bat" data-lang="bat"><span style="display:flex;"><span>dism.exe /online /Get-Features
</span></span></code></pre></div><h2 id="userprofilewslconfig">%userprofile%/.wslconfig</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span>[<span style="color:#a6e22e">wsl2</span>]
</span></span><span style="display:flex;"><span><span style="color:#75715e"># networkingMode=bridged</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># vmSwitch=Home # 此处的名称和指定的虚拟网络交换机一致</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># dhcp=false # 禁用DHCP，在WSL2系统中通过设置Linux的静态IP实现获取IP</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">networkingMode</span> = <span style="color:#a6e22e">mirrored</span> <span style="color:#75715e"># 端口自动转发，Windows和WSL共享端口，都使用127.0.0.1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">dnsTunneling</span> = <span style="color:#66d9ef">true</span> <span style="color:#75715e"># WSL的DNS请求通过Windows转发</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">firewall</span> = <span style="color:#66d9ef">true</span> <span style="color:#75715e"># WSL同步Windows防火墙规则</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">autoProxy</span> = <span style="color:#66d9ef">true</span> <span style="color:#75715e"># Windows设置代理时自动同步给WSL，用于使用代理访问外网</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">experimental</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sparseVhd</span> = <span style="color:#66d9ef">true</span> <span style="color:#75715e"># 自动清理磁盘空间</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">autoMemoryReclaim</span> = <span style="color:#a6e22e">gradual</span> <span style="color:#75715e"># 可以在gradual 、dropcache 、disabled之间选择。 如果设置成gradual，需要设置kernelCommandLine以开启cgroupV2，否则docker会有问题</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">hostAddressLoopback</span> = <span style="color:#66d9ef">true</span> <span style="color:#75715e"># WSL2中访问Windows的localhost</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">wsl2</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">swap</span> = <span style="color:#ae81ff">0</span> <span style="color:#75715e"># 禁用swap，使用内存交换文件，不使用磁盘交换文件</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 开启cgroup v2，用于docker和autoMemoryReclaim = gradual共存</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kernelCommandLine</span> = <span style="color:#a6e22e">cgroup_no_v1</span>=<span style="color:#a6e22e">all</span> <span style="color:#a6e22e">systemd</span>.<span style="color:#a6e22e">unified_cgroup_hierarchy</span>=<span style="color:#ae81ff">1</span> 
</span></span></code></pre></div><p>上面的配置启用了自动内存回收，不过仍然可以手动释放page cache（在wsl中执行）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;sync; echo 3 &gt; /proc/sys/vm/drop_caches; touch /root/drop_caches_last_run&#34;</span> |tee /tmp/drop_caches
</span></span><span style="display:flex;"><span>install /tmp/drop_caches /usr/local/bin/loss
</span></span><span style="display:flex;"><span>loss
</span></span></code></pre></div><h2 id="安装wsl2">安装WSL2</h2>
<p>这里使用了Debian12，因为我不喜欢Ubuntu的Snap，而且Debian12的wsl发行版支持ebpf。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bat" data-lang="bat"><span style="display:flex;"><span>@<span style="color:#75715e">REM 启用VMP 虚拟机平台</span>
</span></span><span style="display:flex;"><span>dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">echo</span> you may need reboot to take effect
</span></span><span style="display:flex;"><span>@<span style="color:#75715e">REM 启用wslservice</span>
</span></span><span style="display:flex;"><span>sc.exe config wslservice start= demand
</span></span><span style="display:flex;"><span>wsl --set-default-version 2
</span></span><span style="display:flex;"><span>wsl -v
</span></span><span style="display:flex;"><span>wsl --list --online
</span></span><span style="display:flex;"><span>wsl --install -d Debian
</span></span><span style="display:flex;"><span>@<span style="color:#75715e">REM 设置默认root用户</span>
</span></span><span style="display:flex;"><span>debian config --default-user root
</span></span></code></pre></div><h2 id="第一次启动">第一次启动</h2>
<p>设置用户名和密码：</p>
<p><img src="/img/Snipaste_2024-09-21_16-56-02.png" alt=""></p>
<p>启用systemd：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ! grep -q <span style="color:#e6db74">&#34;systemd=true&#34;</span> /etc/wsl.conf; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    cat <span style="color:#e6db74">&lt;&lt;EOF | sudo tee /etc/wsl.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[boot]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">systemd = true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[user]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">default = root
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span></code></pre></div><p>执行 <code>wsl --shutdown</code> 重启wsl，然后就可以使用systemd了。</p>
<h2 id="其他设置">其他设置</h2>
<h3 id="apt设置代理">apt设置代理</h3>
<p>默认安装的Debian的默认源是官方源，国内比较慢，直接配置apt代理。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ! grep -q Acquire::http::Proxy /etc/apt/apt.conf.d/proxy.conf;<span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    cat <span style="color:#e6db74">&lt;&lt;EOF | sudo tee /etc/apt/apt.conf.d/proxy.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Acquire::http::Proxy &#34;https://user:passwd@server:port/&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Acquire::https::Proxy &#34;https://user:passwd@server:port/&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 否则报错没有ca-certificates
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Acquire::https::Verify-Peer &#34;false&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span></code></pre></div><h3 id="apt不更新某软件">apt不更新某软件</h3>
<p>apt-mark 可以对软件包进行设置（手动/自动）安装标记，也可以用来处理软件包的 dpkg(1) 选中状态，以及列出或过滤拥有某个标记的软件包。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>apt-mark auto – 标记指定软件包为自动安装
</span></span><span style="display:flex;"><span>apt-mark manual – 标记指定软件包为手动安装
</span></span><span style="display:flex;"><span>apt-mark minimize-manual – Mark all dependencies of meta packages as automatically installed.
</span></span><span style="display:flex;"><span>apt-mark hold – 标记指定软件包为保留<span style="color:#f92672">(</span>held back<span style="color:#f92672">)</span>，阻止软件自动更新
</span></span><span style="display:flex;"><span>apt-mark unhold – 取消指定软件包的保留<span style="color:#f92672">(</span>held back<span style="color:#f92672">)</span>标记，解除阻止自动更新
</span></span><span style="display:flex;"><span>apt-mark showauto – 列出所有自动安装的软件包
</span></span><span style="display:flex;"><span>apt-mark showmanual – 列出所有手动安装的软件包
</span></span><span style="display:flex;"><span>apt-mark showhold – 列出设为保留的软件包
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>比如保留某个软件不更新可以使用hold标记,如docker
</span></span><span style="display:flex;"><span>sudo apt-mark hold docker*
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo apt-mark showhold
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>如果要解除保留可以使用unhold
</span></span><span style="display:flex;"><span>sudo apt-mark unhold docker*
</span></span></code></pre></div><h3 id="git设置">git设置</h3>
<p>由于wsl支持windows和linux的命令互操作，你实际上会有两个git，一个wsl的git，一个windows的git.exe。</p>
<p><strong>WSL git配置</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git config --global core.editor vim
</span></span><span style="display:flex;"><span>git config --global http.proxy http://127.0.0.1:7890
</span></span><span style="display:flex;"><span>git config --global https.proxy http://127.0.0.1:7890
</span></span><span style="display:flex;"><span>git config --global <span style="color:#e6db74">&#34;includeIf.hasconfig:remote.*.url:*://*github.com*/**.path&#34;</span> .gitconfig_github
</span></span><span style="display:flex;"><span>git config --global <span style="color:#e6db74">&#34;includeIf.hasconfig:remote.*.url:git@github.com:*/**.path&#34;</span> .gitconfig_github
</span></span><span style="display:flex;"><span>cat &gt; ~/.gitconfig_github <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[user]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        name = arloor
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        email = admin@arloor.com
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>git config --global credential.helper store
</span></span><span style="display:flex;"><span><span style="color:#75715e"># wsl的git忽略文件权限的变更</span>
</span></span><span style="display:flex;"><span>git config --global core.filemode false
</span></span><span style="display:flex;"><span><span style="color:#75715e"># wsl的git 提交时自动将crlf转换为lf，checkout时不转成crlf</span>
</span></span><span style="display:flex;"><span>git config --global core.autocrlf input
</span></span></code></pre></div><p><strong>windows git配置</strong></p>
<p>wsl的git 提交时自动将crlf转换为lf，checkout时不转成crlf</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git config --global core.autocrlf input
</span></span></code></pre></div><p>autocrlf的配置详见<a href="https://git-scm.com/book/en/v2/Customizing-Git-Git-Configuration#_formatting_and_whitespace">git文档</a></p>
<p>简单解释就是：</p>
<ul>
<li>windows使用crlf换行，linux和macos使用lf换行（早期macos使用cr换行）</li>
<li>autocrlf=true，提交到index时自动将crlf换成lf，checkout时自动将lf换成crlf。适合windows使用，widnwos默认配置</li>
<li>autocrlf=input，提交到index时自动将crlf换成lf，checkout时不自动转换。适合macos和linux用。</li>
<li>autocrlf=false，不自动转换换行符。</li>
</ul>
<p>git文档推荐，linux和macos使用input，windows使用true。这样保证index、linux、macos中永远是lf，windows中是crlf。</p>
<p><strong>但是</strong>我的设置成了windows上也是input。</p>
<p>直接原因是我有很多shell脚本，原本git.exe的bash是可以执行crlf的shell文件的。安装wsl后，bash被替换为了Debian的bash，不能处理crlf的shell文件。——我需要shell脚本是lf的。根本原因，换行符的问题是一个历史遗留问题，是操作系统之间的壁垒。现代的ide或者文本编辑器都是跨平台使用的，他们能处理换行符的问题，那么用vscode，idea就行了，不要用windows的老版文本编辑器了。我已经比较习惯在linux处理文本了，vim、grep、awk、sed等等很爽，wsl的最大好处就是在windows上能用上原生的bash，那就文本全部linux化好了。</p>
<h3 id="安装ca证书">安装ca证书</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo cp your-certificate.crt /usr/local/share/ca-certificates/
</span></span><span style="display:flex;"><span>sudo update-ca-certificates
</span></span></code></pre></div><h2 id="docker和podman">docker和podman</h2>
<ul>
<li>如果你遇到 docker 无法从 Windows 访问的问题，这个是 iptables 的问题，在 /etc/docker/daemon.json 里添加一句 &ldquo;iptables&rdquo;: false 就好了。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#f92672">&#34;iptables&#34;</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>podman容器需要设置 <code>--network host</code>，否则其他容器访问会报错 no route to host。</li>
</ul>
<h2 id="参考文档">参考文档</h2>
<ul>
<li><a href="https://www.ryanshang.com/2024/01/06/WSL2%E8%AE%BE%E7%BD%AE%E9%95%9C%E5%83%8F%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F/">WSL2设置镜像网络模式</a></li>
<li><a href="https://learn.microsoft.com/zh-cn/windows/wsl/wsl-config">WSL 中的高级设置配置</a></li>
</ul>
<h2 id="内存释放太慢最不满意的一点">内存释放太慢，最不满意的一点</h2>
<p>即使有了<code>autoMemoryReclaim</code>，任务管理器里看到的 <code>VmmemWSL</code> 还是远大于 wsl 里top看到的res + buffer/cache。即使<code>wsl -t Debian</code> 也不会释放内存，只有<code>wsl --shutdown</code>才可以释放内存。观察到断开所有wsl的terminal和所有由用户启动的后台进程（不包含systemd启动的）都结束后，wsl会在一段时间后自动shutdown，此时VmmemWSL也会降为0。但如果有后台进程常驻的话，就不会自动关闭了，这就建议放个bat文件在桌面，不用wsl的时候就shutdown掉吧。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>@echo off
</span></span><span style="display:flex;"><span>wsl --shutdown
</span></span></code></pre></div><p>相关issue: <a href="https://github.com/microsoft/WSL/issues/4166">WSL 2 consumes massive amounts of RAM and doesn&rsquo;t return it</a></p>
<p>关于内存回收的问题，找到两个文章：</p>
<table>
  <thead>
      <tr>
          <th>文章</th>
          <th>时间</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><a href="https://devblogs.microsoft.com/commandline/memory-reclaim-in-the-windows-subsystem-for-linux-2/">Memory Reclaim in the Windows Subsystem for Linux 2</a></td>
          <td>October 30th, 2019</td>
          <td>基于某kernel patch的pageReporting，将虚拟机闲置的连续的内存返还给宿主机。WSL会在cpu Idle的时候进行内存的compaction，然后进行返还。也可以手动执行<code>echo 1 &gt; /proc/sys/vm/compact_memory</code>触发</td>
      </tr>
      <tr>
          <td><a href="https://devblogs.microsoft.com/commandline/windows-subsystem-for-linux-september-2023-update/#automatic-memory-reclaim">Automatic memory reclaim</a></td>
          <td>September 18th, 2023</td>
          <td>“逐渐释放”：基于CgroupV2的memory.reclaim特性逐渐释放page cache，与docker使用的CgroupV1冲突。“idle时立即释放”：不依赖CgroupV2的特性，可与docker共存</td>
      </tr>
  </tbody>
</table>
<h2 id="让wsl一直在后台运行">让wsl一直在后台运行</h2>
<p><a href="https://www.cnblogs.com/wswind/p/17201979.html">https://www.cnblogs.com/wswind/p/17201979.html</a></p>
<p><strong>简单方案：</strong> 写个VBS脚本，启动wsl的terminal在后台一直等待输入：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>set ws<span style="color:#f92672">=</span>wscript.CreateObject<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;wscript.shell&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>ws.run <span style="color:#e6db74">&#34;wsl -d Debian&#34;</span>, <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p><strong>进阶方案：</strong> 只启动一个后台进程，即使多次运行该VBS脚本：</p>
<p>keepalive命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt; /usr/local/bin/keepalive <span style="color:#e6db74">&lt;&lt;\EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">command=&#34;watch -n 30 &#39;uptime |head -n 3 | tee /tmp/uptime&#39;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ps -ef|grep &#34;${command}&#34;|grep -v grep
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if [ $? -ne 0 ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    sh -c &#34;${command}&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">else
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    echo &#34;The command is already running&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">fi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>chmod +x /usr/local/bin/keepalive
</span></span></code></pre></div><p>写个VBS脚本：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>set ws<span style="color:#f92672">=</span>wscript.CreateObject<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;wscript.shell&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>ws.run <span style="color:#e6db74">&#34;wsl -d Debian /usr/local/bin/keepalive&#34;</span>, <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><h2 id="常见报错解决">常见报错解决</h2>
<h3 id="0x80070422-wslservice服务未启动">0x80070422 wslservice服务未启动</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>无法启动服务，原因可能是已被禁用或与其相关联的设备没有启动。
</span></span><span style="display:flex;"><span>Error code: Wsl/0x80070422
</span></span></code></pre></div><p>解决方案：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bat" data-lang="bat"><span style="display:flex;"><span>sc.exe config wslservice start= demand
</span></span></code></pre></div><h3 id="0x8004032d-虚拟机平台功能未启用">0x8004032d 虚拟机平台功能未启用</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bat" data-lang="bat"><span style="display:flex;"><span>WslRegisterDistribution failed with error: 0x8004032d
</span></span><span style="display:flex;"><span>Error: 0x8004032d (null)
</span></span></code></pre></div><p>解决方案：在启用和关闭windows功能中打开“虚拟机平台”或使用下面的cmd命令并重启</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bat" data-lang="bat"><span style="display:flex;"><span>dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart
</span></span></code></pre></div><h3 id="端口被占用问题解决">端口被占用问题解决</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bat" data-lang="bat"><span style="display:flex;"><span># 查看当前动态端口范围
</span></span><span style="display:flex;"><span>netsh int ipv4 show dynamicport tcp
</span></span><span style="display:flex;"><span># 查看被使用的端口
</span></span><span style="display:flex;"><span>netsh int ipv4 show excludedportrange protocol=tcp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 修改动态端口范围
</span></span><span style="display:flex;"><span>netsh int ipv4 set dynamic tcp start=50000 num=15536
</span></span><span style="display:flex;"><span>netsh int ipv6 set dynamic tcp start=50000 num=15536
</span></span><span style="display:flex;"><span># 重启网络
</span></span><span style="display:flex;"><span>net stop winnat
</span></span><span style="display:flex;"><span>net start winnat
</span></span></code></pre></div><h2 id="卸载发行版">卸载发行版</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bat" data-lang="bat"><span style="display:flex;"><span>wsl --terminate Debian # 停止
</span></span><span style="display:flex;"><span>wsl --unregister Debian # 卸载
</span></span></code></pre></div><h2 id="wsl2-debian12-安装docker并配置daemonjson">WSL2 debian12 安装docker并配置daemon.json</h2>
<ul>
<li><a href="https://docs.docker.com/engine/install/debian/#install-from-a-package">debian/#install-from-a-package</a></li>
<li><a href="https://docs.docker.com/reference/cli/dockerd/#daemon-configuration-file">#daemon-configuration-file</a></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Add Docker&#39;s official GPG key:</span>
</span></span><span style="display:flex;"><span>sudo apt-get update
</span></span><span style="display:flex;"><span>sudo apt-get install ca-certificates curl
</span></span><span style="display:flex;"><span>sudo install -m <span style="color:#ae81ff">0755</span> -d /etc/apt/keyrings
</span></span><span style="display:flex;"><span>sudo curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc
</span></span><span style="display:flex;"><span>sudo chmod a+r /etc/apt/keyrings/docker.asc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Add the repository to Apt sources:</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  <span style="color:#e6db74">&#34;deb [arch=</span><span style="color:#66d9ef">$(</span>dpkg --print-architecture<span style="color:#66d9ef">)</span><span style="color:#e6db74"> signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  </span><span style="color:#66d9ef">$(</span>. /etc/os-release <span style="color:#f92672">&amp;&amp;</span> echo <span style="color:#e6db74">&#34;</span>$VERSION_CODENAME<span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74"> stable&#34;</span> | <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null
</span></span><span style="display:flex;"><span>sudo apt-get update
</span></span><span style="display:flex;"><span>sudo apt-get install -y  docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mkdir -p /etc/docker
</span></span><span style="display:flex;"><span>cat &gt; /etc/docker/daemon.json <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;iptables&#34;: false,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;proxies&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;http-proxy&#34;: &#34;http://127.0.0.1:7890&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;https-proxy&#34;: &#34;http://127.0.0.1:7890&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;no-proxy&#34;: &#34;*.test.example.com,.example.org,127.0.0.0/8,localhost,127.0.0.1,docker-registry.somecorporation.com&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo systemctl restart docker
</span></span></code></pre></div><p>该脚本修改了 <code>daemon.json</code> 文件，具体作用如下：</p>
<ul>
<li>
<p><code>--iptables=false</code> prevents the Docker daemon from adding iptables rules. If multiple daemons manage iptables rules, they may overwrite rules set by another daemon. <strong>Be aware that disabling this option requires you to manually add iptables rules to expose container ports.</strong> If you prevent Docker from adding iptables rules, Docker also doesn&rsquo;t add IP masquerading rules, even if you set <code>--ip-masq</code> to <code>true</code>. Without IP masquerading rules, Docker containers can&rsquo;t connect to external hosts or the internet when using network other than default bridge.</p>
</li>
<li>
<p>设置了使用windows clash的代理。</p>
</li>
</ul>
<p>设置代理的另一种方式：<a href="https://docs.docker.com/engine/daemon/proxy/#daemon-configuration">proxy/#daemon-configuration</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo mkdir -p /etc/systemd/system/docker.service.d
</span></span><span style="display:flex;"><span>sudo touch /etc/systemd/system/docker.service.d/http-proxy.conf
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ! grep HTTP_PROXY /etc/systemd/system/docker.service.d/http-proxy.conf;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>cat &gt;&gt; /etc/systemd/system/docker.service.d/http-proxy.conf <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Environment=&#34;HTTP_PROXY=http://127.0.0.1:7890&#34; &#34;HTTPS_PROXY=http://127.0.0.1:7890&#34; &#34;NO_PROXY=localhost,127.0.0.1,docker-registry.somecorporation.com&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Flush changes:</span>
</span></span><span style="display:flex;"><span>sudo systemctl daemon-reload
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Restart Docker:</span>
</span></span><span style="display:flex;"><span>sudo systemctl restart docker
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Verify that the configuration has been loaded:</span>
</span></span><span style="display:flex;"><span>sudo systemctl show --property<span style="color:#f92672">=</span>Environment docker
</span></span></code></pre></div><h2 id="wsl2-debian12-安装openssh-server">WSL2 debian12 安装openssh-server</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>apt remove -y openssh-server
</span></span><span style="display:flex;"><span>apt install -y openssh-server
</span></span><span style="display:flex;"><span>mkdir -p /root/.ssh
</span></span><span style="display:flex;"><span>echo ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDZQzKHfZLlFEdaRUjfSK4twhL0y7+v23Ko4EI1nl6E1/zYqloSZCH3WqQFLGA7gnFlqSAfEHgCdD/4Ubei5a49iG0KSPajS6uPkrB/eiirTaGbe8oRKv2ib4R7ndbwdlkcTBLYFxv8ScfFQv6zBVX3ywZtRCboTxDPSmmrNGb2nhPuFFwnbOX8McQO5N4IkeMVedUlC4w5//xxSU67i1i/7kZlpJxMTXywg8nLlTuysQrJHOSQvYHG9a6TbL/tOrh/zwVFbBS+kx7X1DIRoeC0jHlVJSSwSfw6ESrH9JW71cAvn6x6XjjpGdQZJZxpnR1NTiG4Q5Mog7lCNMJjPtwJ not@home &gt;/root/.ssh/authorized_keys
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;s/\(#\)\?PasswordAuthentication yes/PasswordAuthentication no/g&#39;</span> /etc/ssh/sshd_config
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;s/\(#\)\?PubkeyAuthentication no/PubkeyAuthentication yes/g&#39;</span> /etc/ssh/sshd_config
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;s/\(#\)\?Port .*/Port 222/g&#39;</span> /etc/ssh/sshd_config <span style="color:#75715e"># 改成222端口</span>
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;s/\(#\)\?UseDNS.*/UseDNS no/g&#39;</span> /etc/ssh/sshd_config
</span></span><span style="display:flex;"><span>systemctl restart sshd
</span></span><span style="display:flex;"><span>systemctl enable ssh.service
</span></span></code></pre></div><p>放通windows防火墙：</p>
<p><img src="/img/winodws11-firewall-setup-port.png" alt="alt text"></p>
<p><img src="/img/winodws11-firewall-setup-222-port.png" alt="alt text"></p>
<p>然后一路下一步即可。</p>
<p>或者直接在管理员权限的powershell执行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>New-NetFirewallRule -DisplayName <span style="color:#e6db74">&#39;&#34;Allow SSH on Port xxxxx&#34;&#39;</span> -Direction Inbound -Protocol TCP -LocalPort xxxxx -Action Allow
</span></span></code></pre></div><p>之后就可以使用vscode remote-ssh到WSL2上来开发了。具体的ssh config如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Host wsl
</span></span><span style="display:flex;"><span>  HostName 192.168.xx.xx
</span></span><span style="display:flex;"><span>  Port <span style="color:#ae81ff">222</span>
</span></span><span style="display:flex;"><span>  User root
</span></span></code></pre></div><p>不过因为wsl2有idle自动关闭的特性，所以从外部remote-ssh进来时，需要从外部保活WSL2。思路是ssh到windows上（参考<a href="/posts/mac-wakeonlan-windows-11-msi-motherboard/#windows11-%E5%90%AF%E7%94%A8openssh">widnows11启用openssh-server</a>），然后执行一个前台命令一直运行，具体命令是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ssh windows_user@windows -t wsl
</span></span></code></pre></div><p>或者设置powershell的profile</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>$ShortName = @{
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;s&#39;</span> = <span style="color:#e6db74">&#39;Select-Object&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;g&#39;</span> = <span style="color:#e6db74">&#39;Get-Content&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;keep&#39;</span> = {
</span></span><span style="display:flex;"><span>        Start-Process -FilePath <span style="color:#e6db74">&#34;wsl.exe&#34;</span> -ArgumentList <span style="color:#e6db74">&#34;-d Debian /usr/local/bin/keepalive&#34;</span> -WorkingDirectory $env:USERPROFILE
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  ...</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 为每个键设置别名或执行相应的命令</span>
</span></span><span style="display:flex;"><span>$ShortName.Keys | ForEach-Object {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ($_ <span style="color:#f92672">-eq</span> <span style="color:#e6db74">&#39;keep&#39;</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 对 &#39;keep&#39; 使用函数</span>
</span></span><span style="display:flex;"><span>        Set-Item -Path <span style="color:#e6db74">&#34;function:</span>$($_)<span style="color:#e6db74">&#34;</span> -Value $ShortName.$_ 
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 对其他命令设置别名</span>
</span></span><span style="display:flex;"><span>        Set-Alias $_ $ShortName.$_
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>之后ssh上去后执行<code>keep</code>即可。尝试了<code>ssh xxx -t keep</code>是没这个效果的，得先ssh进去，再执行keep，后面就能退出这个ssh的窗口了。</p>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="/posts/obs-use/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">OBS直播、录屏</span>
    </a>
    
    
    <a href="/posts/rust/pick-up-rust/" class="navigation-next">
      <span class="navigation-tittle">Rust学习路径</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  


</article>


        </div>
        
    



<script defer src="/js/all.js" crossorigin="anonymous"></script>

    
    
    <script src="/js/highlight.min.js"></script>
    <script src="/js/languages/dos.min.js"></script>
        
            
                <script src="https://us.arloor.dev/https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/powershell.min.js"></script>
                
            
        
    <script type="text/javascript">
        
        hljs.configure({languages: ["powershell"]});
        
        hljs.highlightAll();
    </script>
    




    



    </body>
</html>
