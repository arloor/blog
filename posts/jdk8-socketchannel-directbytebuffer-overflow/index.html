<!DOCTYPE html>
<html lang="zh-CN">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    
    <link rel="canonical" href="https://www.arloor.com/posts/jdk8-socketchannel-directbytebuffer-overflow/">
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.152.2">

    
    
    

<title>老版本Java8 NIO Socket Channel读写HeapByteBuffer导致的直接内存泄漏 • ARLOOR</title>
<meta name="description" content="今天，你学习了吗">
<meta name="keywords" content="刘港欢, arloor, moontell">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="老版本Java8 NIO Socket Channel读写HeapByteBuffer导致的直接内存泄漏">
  <meta name="twitter:description" content="前言 Hbase会为每一个region server创建一个IPC client线程来做读写操作，并且该线程空闲两分钟就会被关闭。并且Hbase使用Java NIO的Socket Channel和HeapByteBuffer来做读写操作。由于JDK内部机制的问题，会导致直接内存泄漏，下面介绍所谓的内部机制来剖析根因。">
      <meta name="twitter:site" content="@njulgh">

<meta property="og:url" content="https://www.arloor.com/posts/jdk8-socketchannel-directbytebuffer-overflow/">
  <meta property="og:site_name" content="ARLOOR">
  <meta property="og:title" content="老版本Java8 NIO Socket Channel读写HeapByteBuffer导致的直接内存泄漏">
  <meta property="og:description" content="前言 Hbase会为每一个region server创建一个IPC client线程来做读写操作，并且该线程空闲两分钟就会被关闭。并且Hbase使用Java NIO的Socket Channel和HeapByteBuffer来做读写操作。由于JDK内部机制的问题，会导致直接内存泄漏，下面介绍所谓的内部机制来剖析根因。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-12-01T16:44:35+08:00">
    <meta property="article:modified_time" content="2023-12-01T16:44:35+08:00">
    <meta property="article:tag" content="Java">


    





<link rel="stylesheet" href="/styles/atom-one-dark.min.css">








<link rel="stylesheet" href="/scss/hyde-hyde.484b96856b25751067d56c8c0af9dc1fd6372707029b6d56ee178da6bead45b5.css" integrity="sha256-SEuWhWsldRBn1WyMCvncH9Y3JwcCm21W7heNpr6tRbU=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">




<link rel="stylesheet" href="/scss/hugo-toc.0873834b0f2e9fdc9e1d0301e8ebce21fc10383882a41e9373f29b90e85a9987.css" integrity="sha256-CHODSw8un9yeHQMB6OvOIfwQODiCpB6Tc/KbkOhamYc=">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    

</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="/">
          
          ARLOOR
          
        </a>
      </span>
      <a href="/">
        
        
        <div class="author-image">
          <img src="/img/head.jpeg" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
        
      </a>
      
      <p class="site__description">
         都是瞎写的 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">ARLOOR</label>
      <div class="menu-content">
        <div class="show-in-small">
          <a href="/">
            
            
            <div class="author-image">
              <img src="/img/head.jpeg" alt="Author Image"
                class="img--circle img--headshot element--center">
            </div>
            
            
          </a>
        </div>
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>文章</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/">
						<span>分类</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>关于我</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/grafana/d/a0d0b2fe-285a-44ba-8509-a404961d6da49/rust-http-proxy">
						<span>Grafana</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="http://beian.miit.gov.cn/">
						<span>沪ICP备2025110448号</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://x.com/njulgh" rel="me"><i class="fa-brands fa-x-twitter fa-lg"></i></a>
	
	
	
	
	
	<a href="https://github.com/arloor" rel="me"><i class="fa-brands fa-github fa-lg"></i></a>
	
	
	
	
	
	
	
	
	
	
	
	
	
	<a href="https://t.me/never_contact_me" rel="me"><i class="fa-brands fa-telegram fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="mailto:admin@arloor.com" rel="me"><i class="fa-solid fa-at fa-lg"></i></a>
	
	
	
	
</section>
      </div>
    </div>
    
<div class="copyright">
  &copy; 2025 arloor
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>


<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/arloor/hyde-arloor">hyde-arloor</a>.
</div>


  </div>
</div>
        <div class="content container">
            
    
<article>
  <header>
    <h1>老版本Java8 NIO Socket Channel读写HeapByteBuffer导致的直接内存泄漏</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Dec 1, 2023
    
    
    
      
      
          in
          
          
              <a class="badge badge-category" href="/categories/undefined">UNDEFINED</a>
              
          
      
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/java">java</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 4 min read
</div>


  </header>
  
  
  
    <div class="toc-wrapper">
      <input type="checkbox" id="tocToggle">
      <label for="tocToggle">Table of Content</label>
      
          <nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#解释">解释</a>
      <ul>
        <li><a href="#1-sunniochsocketchannelimplwrite">1. sun.nio.ch.SocketChannelImpl#write</a></li>
        <li><a href="#2-sunniochioutilwrite">2. sun.nio.ch.IOUtil#write</a></li>
        <li><a href="#3-sunniochutilgettemporarydirectbuffer">3. sun.nio.ch.Util#getTemporaryDirectBuffer</a></li>
        <li><a href="#4-sunniochutilbuffercache">4. sun.nio.ch.Util#bufferCache</a></li>
        <li><a href="#5-sunniochutilfree">5. sun.nio.ch.Util#free</a></li>
      </ul>
    </li>
    <li><a href="#通过arthas诊断">通过Arthas诊断</a></li>
    <li><a href="#解决方案">解决方案</a></li>
    <li><a href="#拓展">拓展</a>
      <ul>
        <li><a href="#directbytebuffer的释放">DirectByteBuffer的释放</a></li>
      </ul>
    </li>
    <li><a href="#参考文档">参考文档</a></li>
  </ul>
</nav>
      
    </div>
  
  
  <div class="post">
    <h2 id="前言">前言</h2>
<p>Hbase会为每一个region server创建一个IPC client线程来做读写操作，并且该线程空闲两分钟就会被关闭。并且Hbase使用Java NIO的<code>Socket Channel</code>和<code>HeapByteBuffer</code>来做读写操作。由于JDK内部机制的问题，会导致直接内存泄漏，下面介绍所谓的内部机制来剖析根因。</p>
<h2 id="解释">解释</h2>
<ol>
<li>NIO的socketChannel的read/write HeapByteBuffer会从threadlocal的BufferCache中获取DirectByteBuffer。</li>
<li>老版本JDK在IO线程退出时，不会调用directByteBuffer的Cleaner方法<strong>释放threadlocal中BufferCache的直接内存</strong>。</li>
<li>加上应用<strong>一直没有OldGC/FullGC</strong>，导致直接内存一直不会被回收，导致OOM</li>
</ol>
<p>下面跟一下代码：</p>
<h3 id="1-sunniochsocketchannelimplwrite">1. sun.nio.ch.SocketChannelImpl#write</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">write</span>(ByteBuffer buf) <span style="color:#66d9ef">throws</span> IOException {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (buf <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NullPointerException();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">synchronized</span> (writeLock) {
</span></span><span style="display:flex;"><span>        ensureWriteOpen();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> n <span style="color:#f92672">=</span> 0;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            begin();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">synchronized</span> (stateLock) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>isOpen())
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> 0;
</span></span><span style="display:flex;"><span>                writerThread <span style="color:#f92672">=</span> NativeThread.<span style="color:#a6e22e">current</span>();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> (;;) {
</span></span><span style="display:flex;"><span>                n <span style="color:#f92672">=</span> IOUtil.<span style="color:#a6e22e">write</span>(fd, buf, <span style="color:#f92672">-</span>1, nd);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> ((n <span style="color:#f92672">==</span> IOStatus.<span style="color:#a6e22e">INTERRUPTED</span>) <span style="color:#f92672">&amp;&amp;</span> isOpen())
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> IOStatus.<span style="color:#a6e22e">normalize</span>(n);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">finally</span> {
</span></span><span style="display:flex;"><span>            writerCleanup();
</span></span><span style="display:flex;"><span>            end(n <span style="color:#f92672">&gt;</span> 0 <span style="color:#f92672">||</span> (n <span style="color:#f92672">==</span> IOStatus.<span style="color:#a6e22e">UNAVAILABLE</span>));
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">synchronized</span> (stateLock) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> ((n <span style="color:#f92672">&lt;=</span> 0) <span style="color:#f92672">&amp;&amp;</span> (<span style="color:#f92672">!</span>isOutputOpen))
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> AsynchronousCloseException();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">assert</span> IOStatus.<span style="color:#a6e22e">check</span>(n);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="2-sunniochioutilwrite">2. sun.nio.ch.IOUtil#write</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">write</span>(FileDescriptor fd, ByteBuffer src, <span style="color:#66d9ef">long</span> position,
</span></span><span style="display:flex;"><span>                    NativeDispatcher nd)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">throws</span> IOException
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (src <span style="color:#66d9ef">instanceof</span> DirectBuffer)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> writeFromNativeBuffer(fd, src, position, nd);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Substitute a native buffer</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> pos <span style="color:#f92672">=</span> src.<span style="color:#a6e22e">position</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> lim <span style="color:#f92672">=</span> src.<span style="color:#a6e22e">limit</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> (pos <span style="color:#f92672">&lt;=</span> lim);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> rem <span style="color:#f92672">=</span> (pos <span style="color:#f92672">&lt;=</span> lim <span style="color:#f92672">?</span> lim <span style="color:#f92672">-</span> pos : 0);
</span></span><span style="display:flex;"><span>    ByteBuffer bb <span style="color:#f92672">=</span> Util.<span style="color:#a6e22e">getTemporaryDirectBuffer</span>(rem);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        bb.<span style="color:#a6e22e">put</span>(src);
</span></span><span style="display:flex;"><span>        bb.<span style="color:#a6e22e">flip</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Do not update src until we see how many bytes were written</span>
</span></span><span style="display:flex;"><span>        src.<span style="color:#a6e22e">position</span>(pos);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> n <span style="color:#f92672">=</span> writeFromNativeBuffer(fd, bb, position, nd);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (n <span style="color:#f92672">&gt;</span> 0) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// now update src</span>
</span></span><span style="display:flex;"><span>            src.<span style="color:#a6e22e">position</span>(pos <span style="color:#f92672">+</span> n);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> n;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">finally</span> {
</span></span><span style="display:flex;"><span>        Util.<span style="color:#a6e22e">offerFirstTemporaryDirectBuffer</span>(bb);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="3-sunniochutilgettemporarydirectbuffer">3. sun.nio.ch.Util#getTemporaryDirectBuffer</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Returns a temporary buffer of at least the given size
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> ByteBuffer <span style="color:#a6e22e">getTemporaryDirectBuffer</span>(<span style="color:#66d9ef">int</span> size) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// If a buffer of this size is too large for the cache, there</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// should not be a buffer in the cache that is at least as</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// large. So we&#39;ll just create a new one. Also, we don&#39;t have</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// to remove the buffer from the cache (as this method does</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// below) given that we won&#39;t put the new buffer in the cache.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (isBufferTooLarge(size)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> ByteBuffer.<span style="color:#a6e22e">allocateDirect</span>(size);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    BufferCache cache <span style="color:#f92672">=</span> bufferCache.<span style="color:#a6e22e">get</span>();
</span></span><span style="display:flex;"><span>    ByteBuffer buf <span style="color:#f92672">=</span> cache.<span style="color:#a6e22e">get</span>(size);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (buf <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> buf;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// No suitable buffer in the cache so we need to allocate a new</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// one. To avoid the cache growing then we remove the first</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// buffer from the cache and free it.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>cache.<span style="color:#a6e22e">isEmpty</span>()) {
</span></span><span style="display:flex;"><span>            buf <span style="color:#f92672">=</span> cache.<span style="color:#a6e22e">removeFirst</span>();
</span></span><span style="display:flex;"><span>            free(buf);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> ByteBuffer.<span style="color:#a6e22e">allocateDirect</span>(size);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="4-sunniochutilbuffercache">4. sun.nio.ch.Util#bufferCache</h3>
<p>新版本：无此问题。<strong>增加了 <code>threadTerminated</code> 方法</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#75715e">// Per-thread cache of temporary direct buffers</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> ThreadLocal<span style="color:#f92672">&lt;</span>BufferCache<span style="color:#f92672">&gt;</span> bufferCache <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TerminatingThreadLocal<span style="color:#f92672">&lt;</span>BufferCache<span style="color:#f92672">&gt;</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">protected</span> BufferCache <span style="color:#a6e22e">initialValue</span>() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> BufferCache();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">threadTerminated</span>(BufferCache cache) { <span style="color:#75715e">// will never be null</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span>cache.<span style="color:#a6e22e">isEmpty</span>()) {
</span></span><span style="display:flex;"><span>                ByteBuffer bb <span style="color:#f92672">=</span> cache.<span style="color:#a6e22e">removeFirst</span>();
</span></span><span style="display:flex;"><span>                free(bb);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    };
</span></span></code></pre></div><p>老版本，有此问题</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#75715e">// Per-thread cache of temporary direct buffers</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> ThreadLocal<span style="color:#f92672">&lt;</span>BufferCache<span style="color:#f92672">&gt;</span> bufferCache <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">new</span> ThreadLocal<span style="color:#f92672">&lt;</span>BufferCache<span style="color:#f92672">&gt;</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">protected</span> BufferCache <span style="color:#a6e22e">initialValue</span>() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> BufferCache();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    };
</span></span></code></pre></div><h3 id="5-sunniochutilfree">5. sun.nio.ch.Util#free</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Frees the memory for the given direct buffer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">free</span>(ByteBuffer buf) {
</span></span><span style="display:flex;"><span>        ((DirectBuffer)buf).<span style="color:#a6e22e">cleaner</span>().<span style="color:#a6e22e">clean</span>();
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><h2 id="通过arthas诊断">通过Arthas诊断</h2>
<p>Java中直接内存有三种分配方式</p>
<table>
  <thead>
      <tr>
          <th>方式</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>java.nio.channels.FileChannel#map</td>
          <td>通过mmap系统调用分配</td>
      </tr>
      <tr>
          <td>java.nio.ByteBuffer#allocateDirect</td>
          <td>通过JVM直接内存分配</td>
      </tr>
      <tr>
          <td>native code via JNI</td>
          <td>部分JVM实现支持</td>
      </tr>
  </tbody>
</table>
<p>通过Arthas的stack方法追踪这些方法的调用栈就能看出来是哪里分配了直接内存，在这个case里就能看到是 <code>sun.nio.ch.Util# getTemporaryDirectBuffer</code> 申请的内存。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>options unsafe true
</span></span><span style="display:flex;"><span>stack java.nio.ByteBuffer allocateDirect  -n <span style="color:#ae81ff">5</span>
</span></span></code></pre></div><h2 id="解决方案">解决方案</h2>
<ol>
<li>升级JDK到1.8.0_301及以上版本</li>
<li>设置JVM参数<code>-XX:MaxDirectMemorySize=1g</code>，限制直接内存的大小，到达限制时触发FullGC，释放直接内存</li>
<li>设置<code>jdk.nio.maxCachedBufferSize</code>为0，禁用BufferCache</li>
</ol>
<h2 id="拓展">拓展</h2>
<h3 id="directbytebuffer的释放">DirectByteBuffer的释放</h3>
<p>参考<a href="https://stackoverflow.com/questions/36077641/java-when-does-direct-buffer-released">https://stackoverflow.com/questions/36077641/java-when-does-direct-buffer-released</a>说的：不使用finalizer，而是使用了sun.misc.Cleaner API。</p>
<p>PS: netty的池化直接内存又不一样，那是NoCleaner版本的直接内存，由netty自己管理，所以也<em>不会统计到JVM的直接内存中（此处有点遗忘了，待确定）</em></p>
<p>DirectByteBuffer does not use old Java finalizers. Instead, it uses internal sun.misc.Cleaner API. It creates new thread and stores a PhantomReference to every DirectByteBuffer created (except duplicates and slices which refer to the primary buffer). When the DirectByteBuffer becomes phantom-reachable (that is, no strong, soft or weak references to the byte buffer exist anymore) and garbage collector sees this, it adds this buffer to the ReferenceQueue which is processed by Cleaner thread. So three events should occur:</p>
<p>DirectByteBuffer becomes phantom-reachable.
Garbage collection is performed (in separate thread), DirectByteBuffer Java object is collected and an entry is added to the ReferenceQueue.
Cleaner thread reaches this entry and runs the registered clean-up action (in this case, it&rsquo;s java.nio.DirectByteBuffer.Deallocator object), this action finally frees the native memory.
So in general you have no guarantee when it&rsquo;s freed. If you have enough memory in the Java heap, garbage collector may not be activated for a long time. Also even when it&rsquo;s phantom-reachable, Cleaner thread may need some time to reach this entry. It might be busy processing previous objects which also used the Cleaner API. Note however that partial work-around is implemented in JDK: if you create new DirectByteBuffer and allocated too much direct memory before, garbage collector might be called explicitly to enforce deallocation of previously abandoned buffers. See Bits.reserveMemory() (called from DirectByteBuffer constructor) for details.</p>
<p>Note that in Java-9 the internal Cleaner API was rectified and published for general use: now it&rsquo;s java.lang.ref.Cleaner. Reading the JavaDoc you may get more details how it works.</p>
<p>对应代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    DirectByteBuffer(<span style="color:#66d9ef">int</span> cap) {                   <span style="color:#75715e">// package-private</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">super</span>(<span style="color:#f92672">-</span>1, 0, cap, cap);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">boolean</span> pa <span style="color:#f92672">=</span> VM.<span style="color:#a6e22e">isDirectMemoryPageAligned</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> ps <span style="color:#f92672">=</span> Bits.<span style="color:#a6e22e">pageSize</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">long</span> size <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">max</span>(1L, (<span style="color:#66d9ef">long</span>)cap <span style="color:#f92672">+</span> (pa <span style="color:#f92672">?</span> ps : 0));
</span></span><span style="display:flex;"><span>        Bits.<span style="color:#a6e22e">reserveMemory</span>(size, cap);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">long</span> base <span style="color:#f92672">=</span> 0;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            base <span style="color:#f92672">=</span> unsafe.<span style="color:#a6e22e">allocateMemory</span>(size);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (OutOfMemoryError x) {
</span></span><span style="display:flex;"><span>            Bits.<span style="color:#a6e22e">unreserveMemory</span>(size, cap);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> x;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        unsafe.<span style="color:#a6e22e">setMemory</span>(base, size, (<span style="color:#66d9ef">byte</span>) 0);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (pa <span style="color:#f92672">&amp;&amp;</span> (base <span style="color:#f92672">%</span> ps <span style="color:#f92672">!=</span> 0)) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Round up to page boundary</span>
</span></span><span style="display:flex;"><span>            address <span style="color:#f92672">=</span> base <span style="color:#f92672">+</span> ps <span style="color:#f92672">-</span> (base <span style="color:#f92672">&amp;</span> (ps <span style="color:#f92672">-</span> 1));
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            address <span style="color:#f92672">=</span> base;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        cleaner <span style="color:#f92672">=</span> Cleaner.<span style="color:#a6e22e">create</span>(<span style="color:#66d9ef">this</span>, <span style="color:#66d9ef">new</span> Deallocator(base, size, cap)); <span style="color:#75715e">// !!!这里创建了一个Cleaner对象</span>
</span></span><span style="display:flex;"><span>        att <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><h2 id="参考文档">参考文档</h2>
<ul>
<li><a href="https://stackoverflow.com/questions/36077641/java-when-does-direct-buffer-released">https://stackoverflow.com/questions/36077641/java-when-does-direct-buffer-released</a></li>
<li><a href="https://www.evanjones.ca/java-bytebuffer-leak.html">https://www.evanjones.ca/java-bytebuffer-leak.html</a></li>
<li><a href="https://cloud.tencent.com/developer/article/2240063">https://cloud.tencent.com/developer/article/2240063</a></li>
</ul>
  </div>
  

<div class="navigation navigation-single">
    
    <a href="/posts/grafana-new-table/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Grafana表格Pannel配置</span>
    </a>
    
    
    <a href="/posts/async-profiler/" class="navigation-next">
      <span class="navigation-tittle">Async Profiler使用</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  


</article>


        </div>
        
    



<script defer src="/js/all.js" crossorigin="anonymous"></script>

    
    
    <script src="/js/highlight.min.js"></script>
    <script src="/js/languages/dos.min.js"></script>
        
    <script type="text/javascript">
        
        hljs.highlightAll();
    </script>
    




    



    </body>
</html>
