<!DOCTYPE html>
<html lang="zh-CN">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    
    <link rel="canonical" href="https://www.arloor.com/posts/k3s-multi-cloud-air-gap-install/">
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.144.2">

    
    
    

<title>K3S多云环境下的离线部署 • ARLOOR</title>
<meta name="description" content="今天，你学习了吗">
<meta name="keywords" content="刘港欢, arloor, moontell">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="K3S多云环境下的离线部署">
  <meta name="twitter:description" content="这几天把k8s折腾了个遍，个人觉得k3s更适合我，主要有五个优势
类似springboot的“约定优于配置”，就是默认给你一个开箱即用的东西，如果需要，再进行修改。而不是k8s那样样样要你配置 内置LoadBalancer实现，而不是像k8s那样没有LoadBalancer实现，导致裸机安装情况下得用NodePort、HostPort、HostNetwork来暴露服务，或者安装Metallb。 可以轻松的支持多云环境，对我这种有多个云厂商vps的玩家很友好 资源消耗较少。虽然节点增加后，控制面的内存压力也不小 文档docs.k3s.io很清晰。PS：不要看中文版的文档，也不要看rancher中国的文档，垃圾">
      <meta name="twitter:site" content="@njulgh">

<meta property="og:url" content="https://www.arloor.com/posts/k3s-multi-cloud-air-gap-install/">
  <meta property="og:site_name" content="ARLOOR">
  <meta property="og:title" content="K3S多云环境下的离线部署">
  <meta property="og:description" content="这几天把k8s折腾了个遍，个人觉得k3s更适合我，主要有五个优势
类似springboot的“约定优于配置”，就是默认给你一个开箱即用的东西，如果需要，再进行修改。而不是k8s那样样样要你配置 内置LoadBalancer实现，而不是像k8s那样没有LoadBalancer实现，导致裸机安装情况下得用NodePort、HostPort、HostNetwork来暴露服务，或者安装Metallb。 可以轻松的支持多云环境，对我这种有多个云厂商vps的玩家很友好 资源消耗较少。虽然节点增加后，控制面的内存压力也不小 文档docs.k3s.io很清晰。PS：不要看中文版的文档，也不要看rancher中国的文档，垃圾">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-07-23T11:01:10+08:00">
    <meta property="article:modified_time" content="2023-07-23T11:01:10+08:00">
    <meta property="article:tag" content="K8s">


    





<link rel="stylesheet" href="/styles/atom-one-dark.min.css">








<link rel="stylesheet" href="/scss/hyde-hyde.484b96856b25751067d56c8c0af9dc1fd6372707029b6d56ee178da6bead45b5.css" integrity="sha256-SEuWhWsldRBn1WyMCvncH9Y3JwcCm21W7heNpr6tRbU=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">




<link rel="stylesheet" href="/scss/hugo-toc.0873834b0f2e9fdc9e1d0301e8ebce21fc10383882a41e9373f29b90e85a9987.css" integrity="sha256-CHODSw8un9yeHQMB6OvOIfwQODiCpB6Tc/KbkOhamYc=">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    

</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="/">
          
          ARLOOR
          
        </a>
      </span>
      <a href="/">
        
        
        <div class="author-image">
          <img src="/img/head.jpeg" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
        
      </a>
      
      <p class="site__description">
         都是瞎写的 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">ARLOOR</label>
      <div class="menu-content">
        <div class="show-in-small">
          <a href="/">
            
            
            <div class="author-image">
              <img src="/img/head.jpeg" alt="Author Image"
                class="img--circle img--headshot element--center">
            </div>
            
            
          </a>
        </div>
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>文章</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/">
						<span>分类</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>关于我</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="http://beian.miit.gov.cn/">
						<span>沪ICP备2025110448号</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://x.com/njulgh" rel="me"><i class="fa-brands fa-x-twitter fa-lg"></i></a>
	
	
	
	
	
	<a href="https://github.com/arloor" rel="me"><i class="fa-brands fa-github fa-lg"></i></a>
	
	
	
	
	
	
	
	
	
	
	
	
	
	<a href="https://t.me/never_contact_me" rel="me"><i class="fa-brands fa-telegram fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="mailto:admin@arloor.com" rel="me"><i class="fa-solid fa-at fa-lg"></i></a>
	
	
	
	
</section>
      </div>
    </div>
    
<div class="copyright">
  &copy; 2025 arloor
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>


<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/arloor/hyde-arloor">hyde-arloor</a>.
</div>


  </div>
</div>
        <div class="content container">
            
    
<article>
  <header>
    <h1>K3S多云环境下的离线部署</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Jul 23, 2023
    
    
    
      
      
          in
          
          
              <a class="badge badge-category" href="/categories/undefined">UNDEFINED</a>
              
          
      
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/k8s">k8s</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 8 min read
</div>


  </header>
  
  
  
    <div class="toc-wrapper">
      <input type="checkbox" id="tocToggle">
      <label for="tocToggle">Table of Content</label>
      
          <nav id="TableOfContents">
  <ul>
    <li><a href="#环境说明">环境说明</a></li>
    <li><a href="#离线安装">离线安装</a>
      <ul>
        <li><a href="#创建控制面server节点">创建控制面Server节点</a></li>
        <li><a href="#agent节点加入集群">Agent节点加入集群</a></li>
        <li><a href="#卸载server和agent">卸载Server和Agent</a></li>
        <li><a href="#另一个选择使用rancher的中国加速镜像安装">另一个选择：使用Rancher的中国加速镜像安装</a></li>
      </ul>
    </li>
    <li><a href="#测试dns正常工作">测试dns正常工作</a></li>
    <li><a href="#kubernetes-dashboard安装">kubernetes dashboard安装</a>
      <ul>
        <li><a href="#使用manifest安装">使用manifest安装</a></li>
        <li><a href="#使用helm安装">使用helm安装</a></li>
        <li><a href="#生成访问token">生成访问token</a></li>
      </ul>
    </li>
    <li><a href="#访问集群">访问集群</a>
      <ul>
        <li><a href="#mac上管理该k3s集群">Mac上管理该k3s集群：</a></li>
      </ul>
    </li>
    <li><a href="#server或agent-ip改变时的操作">Server或Agent IP改变时的操作</a></li>
  </ul>
</nav>
      
    </div>
  
  
  <div class="post">
    <p>这几天把k8s折腾了个遍，个人觉得k3s更适合我，主要有五个优势</p>
<ol>
<li>类似springboot的“约定优于配置”，就是默认给你一个开箱即用的东西，如果需要，再进行修改。而不是k8s那样样样要你配置</li>
<li>内置<a href="https://docs.k3s.io/networking#service-load-balancer">LoadBalancer实现</a>，而不是像k8s那样没有LoadBalancer实现，导致裸机安装情况下得用NodePort、HostPort、HostNetwork来暴露服务，或者安装Metallb。</li>
<li>可以轻松的支持多云环境，对我这种有多个云厂商vps的玩家很友好</li>
<li>资源消耗较少。虽然节点增加后，控制面的内存压力也不小</li>
<li>文档<a href="https://docs.k3s.io/">docs.k3s.io</a>很清晰。PS：不要看中文版的文档，也不要看rancher中国的文档，垃圾</li>
</ol>
<h2 id="环境说明">环境说明</h2>
<ul>
<li>linux发型版： RHEL9.2</li>
<li>关闭firewalld</li>
<li>关闭selinux</li>
<li>安装v1.27.3+k3s1版本k3s</li>
<li>安装v2.7.0版本kubernetes-dashboard</li>
</ul>
<h2 id="离线安装">离线安装</h2>
<p>步骤说明：</p>
<ol>
<li>下载离线安装包</li>
<li>下载k3s可执行文件</li>
<li>下载install.sh安装脚本</li>
<li>进行安装</li>
</ol>
<p>Tips：</p>
<ol>
<li>关于离线安装，参考：<a href="https://docs.k3s.io/installation/airgap#manually-deploy-images-method">Manually Deploy Images Method</a>。下面的脚本通过wget和mv命令展示了如何准备各项资源来做离线安装</li>
<li>关于多云部署，参考<a href="https://docs.k3s.io/installation/network-options#distributed-hybrid-or-multicloud-cluster">Distributed hybrid or multicloud cluster</a>。</li>
<li>多云部署需要预先安装wireguard的内核模块，RHEL9的5.14内核已经内置，老的发行版需要参考<a href="https://www.wireguard.com/install/">WireGuard Install Guide</a>(k3s agent节点也需要安装wireguard内核模块)</li>
<li>执行安装脚本时，默认会把当前的http_proxy环境变量传递给kubectl、kubelet、containerd。我通过 <code>CONTAINERD_</code>开头的环境变量配置了仅供containerd使用的而不影响kubectl、kubelet的本地clash代理，用于加速镜像拉取。不过这不是必须的，因为docker hub没有被墙。代理传递参考：<a href="https://docs.k3s.io/advanced#configuring-an-http-proxy">Configuring an HTTP proxy</a>。</li>
<li><code>--node-external-ip=&lt;SERVER_EXTERNAL_IP&gt; --flannel-backend=wireguard-native --flannel-external-ip</code> 来设置server的使用外网ip，以实现多云集群</li>
<li><code>--node-external-ip=&lt;AGENT_EXTERNAL_IP&gt;</code> 来实现Agent使用外网ip，以实现多云集群。</li>
<li>多云集群下，k3s的监管流量走外网的websocket，cluster流量走wireguard的VPN。我的集群是国内和国外机器都有，wireguard流量特征明显，不知道gfw会不会干扰wireguard流量</li>
<li>禁用traefik ingress controller。我觉得它用起来太烦了，而且还占用了80、443端口，不如直接用LoadBalancer</li>
<li>集群节点越多，对控制面节点的CPU、内存压力越大，参见<a href="https://docs.k3s.io/installation/requirements#cpu-and-memory">requirements#cpu-and-memory</a></li>
</ol>
<h3 id="创建控制面server节点">创建控制面Server节点</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget <span style="color:#e6db74">&#34;https://github.com/k3s-io/k3s/releases/download/v1.27.3%2Bk3s1/k3s-airgap-images-amd64.tar&#34;</span> -O k3s-airgap-images-amd64.tar
</span></span><span style="display:flex;"><span>sudo mkdir -p /var/lib/rancher/k3s/agent/images/
</span></span><span style="display:flex;"><span>sudo mv -f ./k3s-airgap-images-amd64.tar /var/lib/rancher/k3s/agent/images/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>wget <span style="color:#e6db74">&#34;https://github.com/k3s-io/k3s/releases/download/v1.27.3%2Bk3s1/k3s&#34;</span> -O k3s 
</span></span><span style="display:flex;"><span>mv -f k3s /usr/local/bin/k3s
</span></span><span style="display:flex;"><span>chmod +x /usr/local/bin/k3s
</span></span><span style="display:flex;"><span>wget <span style="color:#e6db74">&#34;https://get.k3s.io/&#34;</span> -O install.sh
</span></span><span style="display:flex;"><span>chmod +x install.sh
</span></span><span style="display:flex;"><span>. unpass <span style="color:#75715e">#取消我的http_proxy环境变量</span>
</span></span><span style="display:flex;"><span>CONTAINERD_HTTP_PROXY<span style="color:#f92672">=</span>http://127.0.0.1:3128 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>CONTAINERD_HTTPS_PROXY<span style="color:#f92672">=</span>http://127.0.0.1:3128 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>CONTAINERD_NO_PROXY<span style="color:#f92672">=</span>127.0.0.0/8,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>K3S_TOKEN<span style="color:#f92672">=</span><span style="color:#ae81ff">12345</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>INSTALL_K3S_SKIP_DOWNLOAD<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>./install.sh <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--node-external-ip<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;`curl https://bwg.arloor.dev:444/ip -k`&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--flannel-backend<span style="color:#f92672">=</span>wireguard-native <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--flannel-external-ip <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--disable<span style="color:#f92672">=</span>traefik <span style="color:#75715e"># 禁用traefik ingress controller</span>
</span></span><span style="display:flex;"><span>watch kubectl get pod -A
</span></span></code></pre></div><p>安装好server后，在server node上执行以下命令来得到agent加入集群的token：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat /var/lib/rancher/k3s/server/token
</span></span></code></pre></div><h3 id="agent节点加入集群">Agent节点加入集群</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>. unpass
</span></span><span style="display:flex;"><span>wget <span style="color:#e6db74">&#34;http://cdn.arloor.com/k3s/k3s-airgap-images-amd64.tar&#34;</span> -O k3s-airgap-images-amd64.tar <span style="color:#75715e"># https://github.com/k3s-io/k3s/releases/download/v1.27.3%2Bk3s1/k3s-airgap-images-amd64.tar</span>
</span></span><span style="display:flex;"><span>sudo mkdir -p /var/lib/rancher/k3s/agent/images/
</span></span><span style="display:flex;"><span>sudo mv -f ./k3s-airgap-images-amd64.tar /var/lib/rancher/k3s/agent/images/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>wget <span style="color:#e6db74">&#34;http://cdn.arloor.com/k3s/k3s&#34;</span> -O k3s <span style="color:#75715e">#https://github.com/k3s-io/k3s/releases/download/v1.27.3%2Bk3s1/k3s</span>
</span></span><span style="display:flex;"><span>mv -f k3s /usr/local/bin/k3s
</span></span><span style="display:flex;"><span>chmod +x /usr/local/bin/k3s
</span></span><span style="display:flex;"><span>wget <span style="color:#e6db74">&#34;http://cdn.arloor.com/k3s/install.sh&#34;</span> -O install.sh <span style="color:#75715e">#https://get.k3s.io/</span>
</span></span><span style="display:flex;"><span>chmod +x install.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># server上 cat /var/lib/rancher/k3s/server/token  的到token</span>
</span></span><span style="display:flex;"><span>K3S_TOKEN<span style="color:#f92672">=</span>K10098693af78777497406169383c59586da0916a6fc63bd293d9881f48b4789e0f::server:12345 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>INSTALL_K3S_SKIP_DOWNLOAD<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>K3S_URL<span style="color:#f92672">=</span>https://118.25.142.222:6443  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>bash install.sh <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--node-external-ip<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;`curl https://bwg.arloor.dev:444/ip -k`&#34;</span>
</span></span></code></pre></div><p>如果Agent节点能自由访问Internet，也可以用下面的命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://get.k3s.io/ -O install.sh <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#f92672">&amp;&amp;</span> chmod +x install.sh
</span></span><span style="display:flex;"><span>INSTALL_K3S_VERSION<span style="color:#f92672">=</span>v1.27.3+k3s1 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>K3S_TOKEN<span style="color:#f92672">=</span>K10098693af78777497406169383c59586da0916a6fc63bd293d9881f48b4789e0f::server:12345 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>K3S_URL<span style="color:#f92672">=</span>https://118.25.142.222:6443  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>./install.sh <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--node-external-ip<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;`curl https://bwg.arloor.dev:444/ip -k`&#34;</span>
</span></span></code></pre></div><h3 id="卸载server和agent">卸载Server和Agent</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/usr/local/bin/k3s-uninstall.sh
</span></span><span style="display:flex;"><span>/usr/local/bin/k3s-agent-uninstall.sh
</span></span></code></pre></div><h3 id="另一个选择使用rancher的中国加速镜像安装">另一个选择：使用Rancher的中国加速镜像安装</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>. unpass
</span></span><span style="display:flex;"><span>curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh -o install.sh
</span></span><span style="display:flex;"><span>chmod +x install.sh
</span></span><span style="display:flex;"><span>INSTALL_K3S_MIRROR<span style="color:#f92672">=</span>cn  INSTALL_K3S_VERSION<span style="color:#f92672">=</span>v1.27.3+k3s1 K3S_TOKEN<span style="color:#f92672">=</span><span style="color:#ae81ff">12345</span> ./install.sh <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>		--node-external-ip<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;`curl https://bwg.arloor.dev:444/ip -k`&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --flannel-backend<span style="color:#f92672">=</span>wireguard-native <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --flannel-external-ip <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>		--disable<span style="color:#f92672">=</span>traefik
</span></span><span style="display:flex;"><span>watch kubectl get pod -A
</span></span></code></pre></div><p>虽然rancher中国的文档不咋样，但是这个加速镜像还是要点赞的， <code>INSTALL_K3S_MIRROR=cn</code> 环境变量就是来使用加速镜像的。此方式也不需要使用代理。我是在<a href="https://docs.rancher.cn/docs/k3s/installation/install-options/_index/#%E4%BD%BF%E7%94%A8%E8%84%9A%E6%9C%AC%E5%AE%89%E8%A3%85%E7%9A%84%E9%80%89%E9%A1%B9">Rancher中国的安装选项介绍</a>找到这个镜像的。建议配合 <code>INSTALL_K3S_VERSION=v1.27.3+k3s1</code>环境变量指定k3s版本为v1.27.3+k3s1(我离线安装的版本)</p>
<h2 id="测试dns正常工作">测试dns正常工作</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl run curl --image<span style="color:#f92672">=</span>redhat/ubi9-minimal --attach --command --rm --restart<span style="color:#f92672">=</span>Never -- <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>sh -c <span style="color:#e6db74">&#39;curl https://kubernetes.default:443 -k -v; echo $?&#39;</span>
</span></span></code></pre></div><table>
  <thead>
      <tr>
          <th>参数</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>--attach</code></td>
          <td>附加到pod中</td>
      </tr>
      <tr>
          <td><code>--command</code></td>
          <td><code>--</code> 后的表示命令，而不是参数</td>
      </tr>
      <tr>
          <td><code>--rm</code></td>
          <td>运行完成后删除pod</td>
      </tr>
      <tr>
          <td><code>--restart=Never</code></td>
          <td>不设置的话，会是backoff的状态</td>
      </tr>
  </tbody>
</table>
<h2 id="kubernetes-dashboard安装">kubernetes dashboard安装</h2>
<p>先介绍两种安装方式，首先是通过manifest yaml文件安装，另一种是通过helm chart安装。再介绍token生成，以及使用token登陆kubernetes-dashboard。</p>
<h3 id="使用manifest安装">使用manifest安装</h3>
<blockquote>
<p>这里还是使用v2.7.0版本，因为v3.0.0版本需要ingress-nginx-controller，而我不想用ingress-controller。</p></blockquote>
<p>下载k8s dashboard的manifest，并预先下载镜像</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>. pass
</span></span><span style="display:flex;"><span>wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml -O recommended.yaml
</span></span><span style="display:flex;"><span>. unpass
</span></span><span style="display:flex;"><span>crictl pull docker.io/kubernetesui/dashboard:v2.7.0
</span></span><span style="display:flex;"><span>crictl pull docker.io/kubernetesui/metrics-scraper:v1.0.8
</span></span></code></pre></div><p>修改Service/kubernetes-dashboard，将type设置成LoadBalancer，修改port为8443，修改后的样子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8443</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">8443</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">kubernetes-dashboard</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">LoadBalancer</span>
</span></span></code></pre></div><p>创建工作负载</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>. unpass
</span></span><span style="display:flex;"><span>kubectl apply -f recommended.yaml
</span></span><span style="display:flex;"><span>watch kubectl get pod -n kubernetes-dashboard
</span></span></code></pre></div><h3 id="使用helm安装">使用helm安装</h3>
<p>安装helm：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://get.helm.sh/helm-v3.12.0-linux-amd64.tar.gz -O /tmp/helm-v3.12.0-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>tar -zxvf /tmp/helm-v3.12.0-linux-amd64.tar.gz -C /tmp
</span></span><span style="display:flex;"><span>mv /tmp/linux-amd64/helm  /usr/local/bin/
</span></span></code></pre></div><p>安装dashboard的helm chart</p>
<blockquote>
<p>需要先参考<a href="#%E8%AE%BF%E9%97%AE%E9%9B%86%E7%BE%A4">访问集群</a>设置kubeconfig，从而让helm与集群交互</p></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm repo add kubernetes-dashboard https://kubernetes.github.io/dashboard/
</span></span><span style="display:flex;"><span>helm repo update
</span></span><span style="display:flex;"><span>helm search repo kubernetes-dashboard -l <span style="color:#75715e">#找到 app version 2.7.0对应的version为6.0.8</span>
</span></span><span style="display:flex;"><span>helm show values kubernetes-dashboard/kubernetes-dashboard --version 6.0.8 &gt; /tmp/values.yaml 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改values.yaml</span>
</span></span><span style="display:flex;"><span>cat &gt; /tmp/values.yaml <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">service:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  type: LoadBalancer
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # Dashboard service port
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  externalPort: 8443
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metricsScraper:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ## Wether to enable dashboard-metrics-scraper
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metrics-server:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  enabled: false # k3s自带了metrics-server所以这里为false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - --kubelet-insecure-tls # 必要
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - --cert-dir=/tmp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - --secure-port=4443
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - --kubelet-preferred-address-types=ExternalIP,InternalIP,Hostname
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - --kubelet-use-node-status-port
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - --metric-resolution=15s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>kubectl create namespace kubernetes-dashboard
</span></span><span style="display:flex;"><span>helm install kubernetes-dashboard kubernetes-dashboard/kubernetes-dashboard  --version 6.0.8  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-n kubernetes-dashboard <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-f /tmp/values.yaml
</span></span><span style="display:flex;"><span>watch kubectl get pod -n kubernetes-dashboard
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 卸载</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># helm delete kubernetes-dashboard --namespace kubernetes-dashboard </span>
</span></span></code></pre></div><h3 id="生成访问token">生成访问token</h3>
<p>kubernetes-dashboard使用RBAC的权限控制，需要我们生成ServiceRole和ClusterRoleBinding，并生成token。可以生成永不过期的token，也可以生成带过期时间的token</p>
<h4 id="永不过期的token">永不过期的token</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f - <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ServiceAccount
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: arloor
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ClusterRoleBinding
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: arloor
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">roleRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  apiGroup: rbac.authorization.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  kind: ClusterRole
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: cluster-admin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">subjects:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- kind: ServiceAccount
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: arloor
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Secret
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: arloor-secret
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  annotations:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    kubernetes.io/service-account.name: arloor
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">type: kubernetes.io/service-account-token
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl get secret/arloor-secret -o yaml <span style="color:#75715e">#查看token字段，base64格式的</span>
</span></span><span style="display:flex;"><span>kubectl describe secret/arloor-secret <span style="color:#75715e"># 查看token字段，原始的</span>
</span></span></code></pre></div><p>其中 kubectl get 得到的是Base64编码过的，需要base64解码才能使用：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>base64 -d - <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">xxxxxxx token
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><h4 id="带过期时间的token">带过期时间的token</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f - <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ServiceAccount
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: arloor
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: ClusterRoleBinding
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: arloor
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">roleRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  apiGroup: rbac.authorization.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  kind: ClusterRole
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: cluster-admin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">subjects:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- kind: ServiceAccount
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: arloor
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: default
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat &gt; /usr/local/bin/token <span style="color:#e6db74">&lt;&lt;\EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kubectl create token arloor --duration 24000h
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>chmod +x /usr/local/bin/token
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>token <span style="color:#75715e"># 有效期100天</span>
</span></span></code></pre></div><p> 使用token登陆dashboard后可以看到类似下面的界面</p>
<p><img src="/img/k3s-two-nodes.png" alt=""></p>
<p>kubernetes-dashboard的鉴权机制可以看<a href="https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/README.md#login-view">access-control</a>。我是用的文档中的Authorization header配合chrome的modHeader插件来使用上面的token进行鉴权，这样使用dashboard就很方便了。</p>
<p>k8s的RBAC鉴权机制可以参考<a href="https://juejin.cn/post/7116104973644988446">Kubernetes（k8s）权限管理RBAC详解</a>。简单说就是Role Based Access Control ，Role定义了访问一系列资源的权限。Subject有User、Group、ServiceAccount等几种。每个NameSpace都有一个默认ServiceAccount，名为&quot;default&quot;。Role和Subject（主体）通过RoleBinding绑定，绑定后Subject就有了Role定义的权限。ClusterRole有集群所有命名空间的权限，Role只有指定命名空间的权限。</p>
<h2 id="访问集群">访问集群</h2>
<p>kubeconfig保存在 /etc/rancher/k3s/k3s.yaml。如果你安装了上游k8s的命令行工具，例如kubectl、helm，你需要给他们配置正确的kubeconfig位置。有三种方式，推荐方式三。</p>
<ol>
<li>配置KUBECONFIG环境变量</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>export KUBECONFIG<span style="color:#f92672">=</span>/etc/rancher/k3s/k3s.yaml
</span></span><span style="display:flex;"><span>kubectl get pods --all-namespaces
</span></span><span style="display:flex;"><span>helm ls --all-namespaces
</span></span></code></pre></div><ol start="2">
<li>增加 <code>--kubeconfig</code> 参数</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl --kubeconfig /etc/rancher/k3s/k3s.yaml get pods --all-namespaces
</span></span><span style="display:flex;"><span>helm --kubeconfig /etc/rancher/k3s/k3s.yaml ls --all-namespaces
</span></span></code></pre></div><ol start="3">
<li>复制到默认kubeconfig的位置</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cp -f /etc/rancher/k3s/k3s.yaml ~/.kube/config
</span></span></code></pre></div><h3 id="mac上管理该k3s集群">Mac上管理该k3s集群：</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir ~/.kube
</span></span><span style="display:flex;"><span>scp root@mi.arloor.com:/etc/rancher/k3s/k3s.yaml ~/.kube/config
</span></span><span style="display:flex;"><span>curl -LO <span style="color:#e6db74">&#34;https://dl.k8s.io/release/v1.27.3/bin/darwin/arm64/kubectl&#34;</span>
</span></span><span style="display:flex;"><span>chmod +x kubectl
</span></span><span style="display:flex;"><span>mv kubectl /data/bin/
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#e6db74">&#39;s/127.0.0.1/118.25.142.222/&#39;</span> ~/.kube/config
</span></span><span style="display:flex;"><span>kubectl get nodes
</span></span></code></pre></div><p>其中，Mac上安装kubectl参考<a href="https://kubernetes.io/docs/tasks/tools/install-kubectl-macos/#install-kubectl-binary-with-curl-on-macos">install-kubectl-binary-with-curl-on-macos</a>。注意kubectl和集群版本要保持一致，否则有些api可能不兼容。</p>
<p>另外，使用sed命令是要注意： Mac 和 Linux 在 sed 命令的 -i 参数上存在一些不同。在 Linux 上，-i 参数后面可以直接跟着文件名，但在 macOS 上，-i 需要后跟一个扩展名。这个扩展名用于创建一个备份文件。如果你不想创建备份文件，你可以使用空字符串（&quot;&quot;）作为扩展名。</p>
<h2 id="server或agent-ip改变时的操作">Server或Agent IP改变时的操作</h2>
<p>下面以ServerIP变更为例：</p>
<p><strong>Server</strong></p>
<ol>
<li>修改 <code>/etc/systemd/system/k3s.service</code> 中的 <code>--node-external-ip</code> 参数</li>
<li>重启k3s服务</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl restart k3s
</span></span></code></pre></div><p><strong>Agent</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;s/K3S_URL.*/K3S_URL=&#34;https:\/\/154.xx.xx.xx:6443&#34;/&#39;</span>  /etc/systemd/system/k3s-agent.service.env
</span></span><span style="display:flex;"><span>systemctl restart k3s-agent.service
</span></span></code></pre></div>
  </div>
  

<div class="navigation navigation-single">
    
    <a href="/posts/clash-tun-gateway/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Clash Tun模式和透明代理</span>
    </a>
    
    
    <a href="/posts/k3s-create-service-of-proxy/" class="navigation-next">
      <span class="navigation-tittle">在K8S集群中创建clash代理服务</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  


</article>


        </div>
        
    



<script defer src="/js/all.js" crossorigin="anonymous"></script>

    
    
    <script src="/js/highlight.min.js"></script>
    <script src="/js/languages/dos.min.js"></script>
        
    <script type="text/javascript">
        
        hljs.highlightAll();
    </script>
    




    



    </body>
</html>
