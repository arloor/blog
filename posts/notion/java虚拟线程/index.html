<!DOCTYPE html>
<html lang="zh-CN">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    
    <link rel="canonical" href="https://www.arloor.com/posts/notion/java%E8%99%9A%E6%8B%9F%E7%BA%BF%E7%A8%8B/">
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.142.0">

    
    
    

<title>Java虚拟线程 • ARLOOR</title>
<meta name="description" content="今天，你学习了吗">
<meta name="keywords" content="刘港欢, arloor, moontell">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Java虚拟线程">
  <meta name="twitter:description" content="内容来自JEP 444
thread-per-thread style。BIO thread-sharing style. Reactive模式，write on complete 一个lambda表达式，异步编程十分痛苦。signal their completion to a callback，并且listener在不同的线程中，观测，trycatch等很困难。典型的就是Netty thread-per-request style with virtual threads 详细说明：">
      <meta name="twitter:site" content="@njulgh">

<meta property="og:url" content="https://www.arloor.com/posts/notion/java%E8%99%9A%E6%8B%9F%E7%BA%BF%E7%A8%8B/">
  <meta property="og:site_name" content="ARLOOR">
  <meta property="og:title" content="Java虚拟线程">
  <meta property="og:description" content="内容来自JEP 444
thread-per-thread style。BIO thread-sharing style. Reactive模式，write on complete 一个lambda表达式，异步编程十分痛苦。signal their completion to a callback，并且listener在不同的线程中，观测，trycatch等很困难。典型的就是Netty thread-per-request style with virtual threads 详细说明：">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-20T12:04:13+08:00">
    <meta property="article:modified_time" content="2024-04-20T12:04:13+08:00">
    <meta property="article:tag" content="Java">


    





<link rel="stylesheet" href="/styles/atom-one-dark.min.css">








<link rel="stylesheet" href="/scss/hyde-hyde.484b96856b25751067d56c8c0af9dc1fd6372707029b6d56ee178da6bead45b5.css" integrity="sha256-SEuWhWsldRBn1WyMCvncH9Y3JwcCm21W7heNpr6tRbU=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">




<link rel="stylesheet" href="/scss/hugo-toc.0873834b0f2e9fdc9e1d0301e8ebce21fc10383882a41e9373f29b90e85a9987.css" integrity="sha256-CHODSw8un9yeHQMB6OvOIfwQODiCpB6Tc/KbkOhamYc=">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    

</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="/">
          
          ARLOOR
          
        </a>
      </span>
      <a href="/">
        
        
        <div class="author-image">
          <img src="/img/head.jpeg" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
        
      </a>
      
      <p class="site__description">
         都是瞎写的 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">ARLOOR</label>
      <div class="menu-content">
        <div class="show-in-small">
          <a href="/">
            
            
            <div class="author-image">
              <img src="/img/head.jpeg" alt="Author Image"
                class="img--circle img--headshot element--center">
            </div>
            
            
          </a>
        </div>
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>文章</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/">
						<span>分类</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>关于我</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="http://beian.miit.gov.cn/">
						<span>沪ICP备2025110448号</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://x.com/njulgh" rel="me"><i class="fa-brands fa-x-twitter fa-lg"></i></a>
	
	
	
	
	
	<a href="https://github.com/arloor" rel="me"><i class="fa-brands fa-github fa-lg"></i></a>
	
	
	
	
	
	
	
	
	
	
	
	
	
	<a href="https://t.me/never_contact_me" rel="me"><i class="fa-brands fa-telegram fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="mailto:admin@arloor.com" rel="me"><i class="fa-solid fa-at fa-lg"></i></a>
	
	
	
	
</section>
      </div>
    </div>
    
<div class="copyright">
  &copy; 2025 arloor
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>


<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/arloor/hyde-arloor">hyde-arloor</a>.
</div>


  </div>
</div>
        <div class="content container">
            
    
<article>
  <header>
    <h1>Java虚拟线程</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Apr 20, 2024
    
    
    
      
      
          in
          
          
              <a class="badge badge-category" href="/categories/undefined">UNDEFINED</a>
              
          
      
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/java">java</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 3 min read
</div>


  </header>
  
  
  
    <div class="toc-wrapper">
      <input type="checkbox" id="tocToggle">
      <label for="tocToggle">Table of Content</label>
      
          <nav id="TableOfContents"></nav>
      
    </div>
  
  
  <div class="post">
    <p>内容来自<a href="https://openjdk.org/jeps/444">JEP 444</a></p>
<ol>
<li>thread-per-thread style。BIO</li>
<li>thread-sharing style. Reactive模式，write on complete 一个lambda表达式，异步编程十分痛苦。signal their completion to a callback，并且listener在不同的线程中，观测，trycatch等很困难。典型的就是Netty</li>
<li><strong>thread-per-request style with virtual threads</strong></li>
</ol>
<p>详细说明：</p>
<p>Application code in the thread-per-request style can run in a virtual thread for the entire duration of a request, but the virtual thread consumes an OS thread only while it performs calculations on the CPU. The result is the same scalability as the asynchronous style, except it is achieved transparently: When code running in a virtual thread calls a blocking I/O operation in the <code>java.*</code> API, the runtime performs a non-blocking OS call and automatically suspends the virtual thread until it can be resumed later.</p>
<p>virtual thread让我们在编写IO处理程序（典型的是http服务器），可以用thread-per-request的风格编写看似同步的代码（没有call back，没有on complete，没有异步编程的复杂度）。但是这些代码只有在做CPU计算的时候才占据一个OS thread，当运行在虚拟线程中的代码调用一个阻塞IO操作时，jvm实际做了一个非阻塞的系统调用，并让出了OS thread。同时，虚拟线程也能更好地使用已有的java工具，例如stack、try catch、for循环等，因为这些代码都在一个线程里（虚拟的）</p>
<p><strong>BIO编写的便利性+reactive编程的并发性能</strong></p>
<p><strong>In summary, virtual threads preserve the reliable thread-per-request style that is harmonious with the design of the Java Platform while utilizing the hardware optimally.</strong></p>
<p>能够增加存在大量等待（BIO/sleep/BlockingQueue.take(））的程序的并发性</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handle</span>(Request request, Response response) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> url1 <span style="color:#f92672">=</span> ...
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> url2 <span style="color:#f92672">=</span> ...
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> (<span style="color:#66d9ef">var</span> executor <span style="color:#f92672">=</span> Executors.<span style="color:#a6e22e">newVirtualThreadPerTaskExecutor</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> future1 <span style="color:#f92672">=</span> executor.<span style="color:#a6e22e">submit</span>(() <span style="color:#f92672">-&gt;</span> fetchURL(url1));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> future2 <span style="color:#f92672">=</span> executor.<span style="color:#a6e22e">submit</span>(() <span style="color:#f92672">-&gt;</span> fetchURL(url2));
</span></span><span style="display:flex;"><span>        response.<span style="color:#a6e22e">send</span>(future1.<span style="color:#a6e22e">get</span>() <span style="color:#f92672">+</span> future2.<span style="color:#a6e22e">get</span>());
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> (ExecutionException <span style="color:#f92672">|</span> InterruptedException e) {
</span></span><span style="display:flex;"><span>        response.<span style="color:#a6e22e">fail</span>(e);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>String <span style="color:#a6e22e">fetchURL</span>(URL url) <span style="color:#66d9ef">throws</span> IOException {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> (<span style="color:#66d9ef">var</span> in <span style="color:#f92672">=</span> url.<span style="color:#a6e22e">openStream</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> String(in.<span style="color:#a6e22e">readAllBytes</span>(), StandardCharsets.<span style="color:#a6e22e">UTF_8</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>但是不是所有的阻塞操作都可以让虚拟线程让出CPU，比如一些文件系统操作（来自操作系统），或者Object wait（来自JVM）</p>
<p>下面的过程会导致虚拟线程pin到平台线程上，导致不能unmount</p>
<ol>
<li>When it executes code inside a <code>synchronized</code> block or method, or</li>
<li>When it executes a <code>native</code> method or a <a href="https://openjdk.java.net/jeps/424">foreign function</a>.</li>
</ol>
<p>虚拟线程的stack存储在heap上</p>
<p><a href="https://docs.oracle.com/en/java/javase/21/core/virtual-threads.html#GUID-2DDA5807-5BD5-4ABC-B62A-A1230F0566E0">Multithreaded Client Server Example</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EchoServer</span> {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span> args) <span style="color:#66d9ef">throws</span> IOException {
</span></span><span style="display:flex;"><span>         
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (args.<span style="color:#a6e22e">length</span> <span style="color:#f92672">!=</span> 1) {
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;Usage: java EchoServer &lt;port&gt;&#34;</span>);
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">exit</span>(1);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>         
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> portNumber <span style="color:#f92672">=</span> Integer.<span style="color:#a6e22e">parseInt</span>(args<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> (
</span></span><span style="display:flex;"><span>            ServerSocket serverSocket <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">new</span> ServerSocket(Integer.<span style="color:#a6e22e">parseInt</span>(args<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>));
</span></span><span style="display:flex;"><span>        ) {                
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">while</span> (<span style="color:#66d9ef">true</span>) {
</span></span><span style="display:flex;"><span>                Socket clientSocket <span style="color:#f92672">=</span> serverSocket.<span style="color:#a6e22e">accept</span>();
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// Accept incoming connections</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// Start a service thread</span>
</span></span><span style="display:flex;"><span>                Thread.<span style="color:#a6e22e">ofVirtual</span>().<span style="color:#a6e22e">start</span>(() <span style="color:#f92672">-&gt;</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">try</span> (
</span></span><span style="display:flex;"><span>                        PrintWriter out <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">new</span> PrintWriter(clientSocket.<span style="color:#a6e22e">getOutputStream</span>(), <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>                        BufferedReader in <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BufferedReader(
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">new</span> InputStreamReader(clientSocket.<span style="color:#a6e22e">getInputStream</span>()));
</span></span><span style="display:flex;"><span>                    ) {
</span></span><span style="display:flex;"><span>                        String inputLine;
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">while</span> ((inputLine <span style="color:#f92672">=</span> in.<span style="color:#a6e22e">readLine</span>()) <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>                            System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(inputLine);
</span></span><span style="display:flex;"><span>                            out.<span style="color:#a6e22e">println</span>(inputLine);
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>                    } <span style="color:#66d9ef">catch</span> (IOException e) { 
</span></span><span style="display:flex;"><span>                        e.<span style="color:#a6e22e">printStackTrace</span>();
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                });
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;Exception caught when trying to listen on port &#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">+</span> portNumber <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; or listening for a connection&#34;</span>);
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(e.<span style="color:#a6e22e">getMessage</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EchoClient</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span> args) <span style="color:#66d9ef">throws</span> IOException {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (args.<span style="color:#a6e22e">length</span> <span style="color:#f92672">!=</span> 2) {
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">println</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Usage: java EchoClient &lt;hostname&gt; &lt;port&gt;&#34;</span>);
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">exit</span>(1);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        String hostName <span style="color:#f92672">=</span> args<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> portNumber <span style="color:#f92672">=</span> Integer.<span style="color:#a6e22e">parseInt</span>(args<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> (
</span></span><span style="display:flex;"><span>            Socket echoSocket <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Socket(hostName, portNumber);
</span></span><span style="display:flex;"><span>            PrintWriter out <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">new</span> PrintWriter(echoSocket.<span style="color:#a6e22e">getOutputStream</span>(), <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>            BufferedReader in <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">new</span> BufferedReader(
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">new</span> InputStreamReader(echoSocket.<span style="color:#a6e22e">getInputStream</span>()));
</span></span><span style="display:flex;"><span>        ) {
</span></span><span style="display:flex;"><span>            BufferedReader stdIn <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">new</span> BufferedReader(
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">new</span> InputStreamReader(System.<span style="color:#a6e22e">in</span>));
</span></span><span style="display:flex;"><span>            String userInput;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">while</span> ((userInput <span style="color:#f92672">=</span> stdIn.<span style="color:#a6e22e">readLine</span>()) <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>                out.<span style="color:#a6e22e">println</span>(userInput);
</span></span><span style="display:flex;"><span>                System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;echo: &#34;</span> <span style="color:#f92672">+</span> in.<span style="color:#a6e22e">readLine</span>());
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (userInput.<span style="color:#a6e22e">equals</span>(<span style="color:#e6db74">&#34;bye&#34;</span>)) <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (UnknownHostException e) {
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;Don&#39;t know about host &#34;</span> <span style="color:#f92672">+</span> hostName);
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">exit</span>(1);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;Couldn&#39;t get I/O for the connection to &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                hostName);
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">exit</span>(1);
</span></span><span style="display:flex;"><span>        } 
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
  </div>
  

<div class="navigation navigation-single">
    
    <a href="/posts/libbpf-rust-integration/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">在Rust项目中集成libbpf-rs</span>
    </a>
    
    
    <a href="/posts/nvidia-fan-speed-control/" class="navigation-next">
      <span class="navigation-tittle">Nvidia显卡风扇为什么不转？如何手动设置转速</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  


</article>


        </div>
        
    



<script defer src="/js/all.js" crossorigin="anonymous"></script>

    
    
    <script src="/js/highlight.min.js"></script>
    <script src="/js/languages/dos.min.js"></script>
        
    <script type="text/javascript">
        
        hljs.highlightAll();
    </script>
    




    



    </body>
</html>
