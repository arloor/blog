<!DOCTYPE html>
<html lang="zh-CN">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.54.0" />

    
    
    

<title>docker使用笔记 • ARLOOR</title>


    
    <meta  name="keywords" content="">





<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="docker使用笔记"/>
<meta name="twitter:description" content="docker很火，所以我想入门。这篇文章是记录学习的，所以可能很乱，称为杂说"/>

<meta property="og:title" content="docker使用笔记" />
<meta property="og:description" content="docker很火，所以我想入门。这篇文章是记录学习的，所以可能很乱，称为杂说" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://arloor.com/posts/docker/docker-first-use/" />
<meta property="article:published_time" content="2019-01-02T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2019-01-02T00:00:00&#43;00:00"/><meta property="og:site_name" content="刘港欢" />


    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">








<link rel="stylesheet" href="/scss/hyde-hyde.a771f2aeb2361d1f677007a55e336949db17bfa914b9813c355347dd79c63c44.css" integrity="sha256-p3HyrrI2HR9ncAelXjNpSdsXv6kUuYE8NVNH3XnGPEQ=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">




<link rel="stylesheet" href="/scss/hugo-toc.8549a64d301421b4256ea9a0d5ca8b99178799f569d5d2daeb95f24cef3ce6b7.css" integrity="sha256-hUmmTTAUIbQlbqmg1cqLmReHmfVp1dLa65XyTO885rc=">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    

</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="/">ARLOOR</a>
      </span>
      
      
      
      
      <div class="author-image">
        
        <a href="/"><img src="/img/head.jpeg" alt="Author Image"
            class="img--circle img--headshot element--center"></a>
      </div>
      
      
      
      <p class="site__description">
         私人小破站 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">ARLOOR</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>文章</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/categories/">
						<span>分类</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/">
						<span>标签</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>About</span>
					</a>
				</li>
			 
		
		</li>
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/njulgh" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	
	<a href="https://github.com/arloor" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
	
	
	<a href="https://t.me/popstary" rel="me"><i class="fab fa-telegram fa-lg" aria-hidden="true"></i></a>
	
	
	
	<a href="mailto:admin@arloor.com" rel="me"><i class="fas fa-at fa-lg" aria-hidden="true"></i></a>
	
</section>

      </div>
    </div>
    
<div class="copyright">
  &copy; 2019 arloor
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>


<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
</div>


  </div>
</div>
        <div class="content container">
            
    <article>
  <header>
    <h1>docker使用笔记</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Jan 2, 2019
    
    
    
      
      
          in
          
          
              <a class="badge badge-category" href="/categories/docker">DOCKER</a>
              
          
      
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/program">program</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 7 min read
</div>


  </header>
  
  
  <div class="toc-wrapper">
    <input type="checkbox" id="tocToggle">
    <label for="tocToggle">Table of Content</label>
    
        <nav id="TableOfContents">
<ul>
<li><a href="#变成自己的docker">变成自己的docker</a>
<ul>
<li><a href="#设置docker命令使用代理">设置docker命令使用代理</a></li>
<li><a href="#设置国内镜像">设置国内镜像</a></li>
<li><a href="#配置不需要sudo">配置不需要sudo</a></li>
</ul></li>
<li><a href="#java的简单docker使用">java的简单docker使用</a>
<ul>
<li><a href="#编写dockerfile">编写Dockerfile</a></li>
<li><a href="#构建image-容器-运行">构建image、容器、运行</a></li>
<li><a href="#进入容器一探究竟">进入容器一探究竟</a></li>
</ul></li>
<li><a href="#自己改造一个镜像">自己改造一个镜像</a>
<ul>
<li><a href="#以centos为基础构建image">以centos为基础构建image</a></li>
<li><a href="#用基础映像启动一个容器-并进行修改">用基础映像启动一个容器，并进行修改</a>
<ul>
<li><a href="#run-sh">run.sh</a></li>
</ul></li>
<li><a href="#持久化修改好的容器">持久化修改好的容器</a></li>
<li><a href="#运行这个完成体映像">运行这个完成体映像</a></li>
<li><a href="#进入这个正在在运行的容器">进入这个正在在运行的容器</a></li>
<li><a href="#删除容器-镜像">删除容器、镜像</a></li>
</ul></li>
<li><a href="#push本地镜像到docker-hub">push本地镜像到docker hub</a></li>
<li><a href="#centos-7的docker使用">centos 7的docker使用</a>
<ul>
<li><a href="#安装docker-ce">安装docker-ce</a></li>
<li><a href="#iptables">iptables</a></li>
</ul></li>
</ul>
</nav>
    
  </div>
  
  <div class="post">
    <p>docker很火，所以我想入门。这篇文章是记录学习的，所以可能很乱，称为杂说</p>

<h1 id="变成自己的docker">变成自己的docker</h1>

<p>为了用的顺手，做两方面调整：配置使用代理、设置不需要sudo</p>

<h2 id="设置docker命令使用代理">设置docker命令使用代理</h2>

<p>在之前的博客中，我多次提到使用<code>. pass</code>来设置shell的代理，但是这对docker没有作用。</p>

<p>在使用systemd的linux发行版中（比如ubuntu 18.04），可以这样配置：参见<a href="https://docs.docker.com/config/daemon/systemd/#httphttps-proxy">#httphttps-proxy</a></p>

<pre><code>#覆盖 the default docker.service file
sudo mkdir -p /etc/systemd/system/docker.service.d
sudo vim /etc/systemd/system/docker.service.d/http-proxy.conf

# 写入下列内容，配置proxy
[Service]
Environment=&quot;HTTP_PROXY=http://127.0.0.1:8081/&quot; &quot;NO_PROXY=localhost,127.0.0.1,docker-registry.somecorporation.com&quot;

# Flush changes:
sudo systemctl daemon-reload
#Restart Docker:
sudo systemctl restart docker
#Verify that the configuration has been loaded:
sudo systemctl show --property=Environment docker
# 像这样：Environment=HTTP_PROXY=http://127.0.0.1:8081/ NO_PROXY=localhost,127.0.0.1,docker-registry.so
</code></pre>

<h2 id="设置国内镜像">设置国内镜像</h2>

<p>除了上面的设置代理，还可以配置国内镜像</p>

<pre><code>vi /etc/docker/daemon.json

#写入以下内容
{
 &quot;registry-mirrors&quot;: [&quot;https://registry.docker-cn.com&quot;]
}

# 最后
# Flush changes:
sudo systemctl daemon-reload
#Restart Docker:
sudo systemctl restart docker
</code></pre>

<h2 id="配置不需要sudo">配置不需要sudo</h2>

<pre><code>sudo groupadd docker
sudo usermod -aG docker $USER
</code></pre>

<p>解释：</p>

<p>The Docker daemon binds to a Unix socket instead of a TCP port. By default that Unix socket is owned by the user root and other users can only access it using sudo. The Docker daemon always runs as the root user.</p>

<p>If you don’t want to preface the docker command with sudo, create a Unix group called docker and add users to it. When the Docker daemon starts, it creates a Unix socket accessible by members of the docker group.</p>

<p>重启一下电脑（虚拟机/服务器）这样就可以不加sudo地使用docker了。如果在运行docker命令时报：</p>

<pre><code>WARNING: Error loading config file: /home/user/.docker/config.json -
stat /home/user/.docker/config.json: permission denied
</code></pre>

<p>是因为<code>~/.docker/</code>directory was created with incorrect permissions due to the sudo commands.</p>

<p>这时候就把这个文件夹删掉好了。或者参照官网：</p>

<p>To fix this problem, either remove the ~/.docker/ directory (it is recreated automatically, but any custom settings are lost), or change its ownership and permissions using the following commands:</p>

<pre><code>$ sudo chown &quot;$USER&quot;:&quot;$USER&quot; /home/&quot;$USER&quot;/.docker -R
$ sudo chmod g+rwx &quot;$HOME/.docker&quot; -R
</code></pre>

<h1 id="java的简单docker使用">java的简单docker使用</h1>

<p>以自己的proxyserver为例子：</p>

<h2 id="编写dockerfile">编写Dockerfile</h2>

<pre><code>mkdir docker-proxyserver
# 里面放Dockerfile和proxyserver-1.2-jar-with-dependencies.jar
</code></pre>

<p>Dockerfile内容：</p>

<pre><code>FROM java:8
COPY . /var/www/java  
WORKDIR /var/www/java  
#RUN java -jar proxyserver-1.2-jar-with-dependencies.jar 
CMD [&quot;java&quot;, &quot;-jar&quot;,&quot;proxyserver-1.2-jar-with-dependencies.jar&quot;]
</code></pre>

<p>解释：</p>

<ol>
<li>以java8为基础映像</li>
<li>将该文件夹下所有文件复制到容器的/var/www/java文件夹</li>
<li>已/var/www/java作为工作目录</li>
<li>被注释掉了：不需要在cmd前做什么</li>
<li>CMD: docker run会执行这行命令：启动proxyserver</li>
</ol>

<h2 id="构建image-容器-运行">构建image、容器、运行</h2>

<pre><code>cd docker-proxyserver
#构建
docker build -t proxyserver .
运行
docker run proxyserver

#下面就可以看到proxyserver运行的日志了
2019-01-01 15:09:17.312 [main] INFO  com.arloor.proxyserver.ServerProxyBootStrap - 开启代理 端口:8080
</code></pre>

<h2 id="进入容器一探究竟">进入容器一探究竟</h2>

<p>上面的容器，最后通过CMD执行了java -jar命令，虽然运行了程序，但容器的运行是个黑盒。现在开始进入这个黑盒。</p>

<p>注释掉DockerFile的最后一行：</p>

<pre><code>CMD [&quot;java&quot;, &quot;-jar&quot;,&quot;proxyserver-1.2-jar-with-dependencies.jar&quot;]
</code></pre>

<p>重新构建映像，并以交互模式run容器：</p>

<pre><code>sudo docker build -t proxyserver .
docker run -it  proxyserver /bin/bash 　＃-it表示交互模式
#或者：docker run -it  proxyserver
</code></pre>

<p>之后的terminal:</p>

<pre><code>x1@carbon:~/docker-proxyserver$ docker run -it  proxyserver /bin/bash
root@2afdacfb0dff:/var/www/java# ls
Dockerfile  proxyserver-1.2-jar-with-dependencies.jar
root@2afdacfb0dff:/var/www/java# uname -a
Linux 2afdacfb0dff 4.15.0-43-generic #46-Ubuntu SMP Thu Dec 6 14:45:28 UTC 2018 x86_64 GNU/Linux
root@2afdacfb0dff:/var/www/java# echo $PATH
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
root@2afdacfb0dff:/var/www/java# reboot
Failed to talk to init daemon.
</code></pre>

<p>这就像一个虚拟机啊。可以看出不同的大概是最后一个命令<code>reboot</code>的执行结果：Failed to talk to init daemon.可以看出进程隔离这个原理的影子吧</p>

<h1 id="自己改造一个镜像">自己改造一个镜像</h1>

<p>上面我们已经知道了，是可以进入镜像执行一些命令的，比如执行一些解压、设置PATH、新建软连接都是可以的，这就是安装软件的过程了。</p>

<p>而<code>docker commit</code>则允许<code>Create a new image from a container's changes</code>：由一个被修改过的容器创建一个映像。这给我们提供了魔改镜像、自定义镜像的能力。</p>

<p>以一个需要nodejs8和java８的项目为例：我们以centos为基础映像，启动容器，然后进行魔改（安装jdk和node）。</p>

<h2 id="以centos为基础构建image">以centos为基础构建image</h2>

<p>Dockerfile:</p>

<pre><code>FROM centos:7
COPY . /app
WORKDIR /app
EXPOSE 4000
</code></pre>

<p>集成centos7映像，将本文件夹下的所有文件（是项目代码）复制到容器的<code>/app</code>文件下。这里也包括了npm_modules。最后定义暴露4000端口</p>

<p>构建映像：</p>

<pre><code>docker build -t simlogin-with-docker .
</code></pre>

<h2 id="用基础映像启动一个容器-并进行修改">用基础映像启动一个容器，并进行修改</h2>

<pre><code>docker run -it -v ~/Downloads/:/usr/my/docker/download/ simlogin-with-docker /bin/bash
</code></pre>

<p>解释：使用simlogin-with-docke镜像启动一个container。<code>-it</code>表示交互模式——启动容器后会进入docker的shell。<code>-v ~/Downloads/:/path/in/container</code>表示将宿主机的<code>下载</code>目录挂载到容器的<code>/usr/my/docker/download/</code>。最后的<code>/bin/bash</code>是容器所执行的CMD。注意我们在Dockfile中并没有定义CMD，所以在这里需要加上<code>/bin/bash</code>。实际上不加<code>/bin/bash</code>好像也可以。</p>

<p>之后的终端是这样的</p>

<pre><code>x1@carbon:~$ docker run -it -v ~/Downloads/:/usr/my/docker/download/ simlogin-with-docker /bin/bash
[root@4c97d816eba7 app]#
</code></pre>

<p>这样就进入了容器的shell，像不像进入了一个虚拟机</p>

<p>这样就可以对这个“虚拟机”进行修改了：我做了以下：安装java和nodejs、yum安装相关库、pm2、设置PATH、编写启动脚本<code>/app/run.sh</code></p>

<p>这些步骤只讲最后一步，因为前面的步骤和在虚拟机里操作一模一样，而编写run.sh则很关键也有一些坑。</p>

<h3 id="run-sh">run.sh</h3>

<pre><code>#! /bin/bash

. ~/.bashrc  #关键：导入PATH
pm2 start process.json --env local
tail -f /dev/null  # 关键：让此bash进程永远不退出
</code></pre>

<p>第一个坑：最好手动导入PATH</p>

<p>第二个坑：CMD执行的进程结束，容器进程就结束了。所以加上最后一句让bash进程永不退出。这点坑了我很久。。。</p>

<p>把这些做完之后，这个容器的就是我们需要的样子了。下一步就是将这个容器“持久化”成一个image，这样以后就可以直接启动容器而不需要再做环境修改。</p>

<h2 id="持久化修改好的容器">持久化修改好的容器</h2>

<p>第一点！不要在容器的“交互性”shell中输exit或者ctrl+D！就是不要让这个容器的运行结束</p>

<p>第二步：另起终端。输入<code>docker ps</code>或<code>docker container list</code>，显示现在运行的容器，显示如下：</p>

<pre><code>x1@carbon:~$ docker container list
CONTAINER ID        IMAGE                  COMMAND             CREATED             STATUS              PORTS               NAMES
4c97d816eba7        simlogin-with-docker   &quot;/bin/bash&quot;         22 minutes ago      Up 22 minutes       4000/tcp            distracted_agnesi
x1@carbon:~$ docker ps
CONTAINER ID        IMAGE                  COMMAND             CREATED             STATUS              PORTS               NAMES
4c97d816eba7        simlogin-with-docker   &quot;/bin/bash&quot;         22 minutes ago      Up 22 minutes       4000/tcp            distracted_agnesi
</code></pre>

<p>第三步：commit容器，也就是“持久化”为镜像了</p>

<pre><code>docker commit 4c97d816eba7 simlogin-with-docker:1.0
</code></pre>

<p>这样就新建了一个simlogin-with-docker:1.0映像。这就是最终的映像啦。</p>

<h2 id="运行这个完成体映像">运行这个完成体映像</h2>

<pre><code>docker run  -d -p 80:4000 simlogin-with-docker /app/run.sh
</code></pre>

<p><code>-d</code>表示在后台运行；</p>

<p><code>-p 80:4000</code>表示宿主机80端口映射容器4000端口；</p>

<p><code>/app/run.sh</code>表示执行的CMD，注意这个sh脚本被我们控制为了永远不会退出。</p>

<p>问题：这个sh脚本不会退出。。所以pm2启动的进程如果异常退出了，这个docker容器也不会退出，也就没有实现监控了。</p>

<h2 id="进入这个正在在运行的容器">进入这个正在在运行的容器</h2>

<p>一开始我用<code>docker attach containerID</code>，但是发现有一些问题。后来我用</p>

<pre><code>docker exec -it containerID /bin/bash
</code></pre>

<p>好了，docker算入门了吧</p>

<h2 id="删除容器-镜像">删除容器、镜像</h2>

<p>一个镜像很容易就超级超级大，有必要删除没用的镜像和容器</p>

<p>要删除镜像，需要首先删除容器。</p>

<pre><code># 删除所有容器
docker rm `docker ps -a -q`
# 删除所有镜像
docker rmi `docker images -a -q`
# 删除带关键字的镜像
docker rmi --force `docker images | grep xxx | awk '{print $3}'`
# 删除没有标签的镜像
docker rmi `docker images -q | awk '/^&lt;none&gt;/ { print $3 }'`
</code></pre>

<h1 id="push本地镜像到docker-hub">push本地镜像到docker hub</h1>

<p>首先<code>docker login</code>登录到docker hub，需要输入docker hub的用户名密码</p>

<p>然后，把本地的docker镜像打上用户名的tag..</p>

<p>最后push</p>

<pre><code>docker tag ubuntu:18.04 arloor/ubuntu:18.04
docker push arloor/ubuntu:18.04
docker search arloor
</code></pre>

<h1 id="centos-7的docker使用">centos 7的docker使用</h1>

<p>服务器一般是centos系统，记录一下centos中的一些东西</p>

<h2 id="安装docker-ce">安装docker-ce</h2>

<p>卸载旧版本</p>

<p>Docker 的早期版本称为 docker 或 docker-engine。如果安装了这些版本，请卸载它们及关联的依赖资源。</p>

<pre><code> sudo yum remove docker \
                  docker-client \
                  docker-client-latest \
                  docker-common \
                  docker-latest \
                  docker-latest-logrotate \
                  docker-logrotate \
                  docker-engine
</code></pre>

<p>安装相关依赖</p>

<pre><code>yum install -y yum-utils \
  device-mapper-persistent-data \
  lvm2
</code></pre>

<p>设置docker源</p>

<pre><code>  yum-config-manager \
    --add-repo \
    https://download.docker.com/linux/centos/docker-ce.repo
</code></pre>

<p>安装docker</p>

<pre><code>yum install docker-ce
</code></pre>

<h2 id="iptables">iptables</h2>

<p>iptables是linux下的防火墙服务。在我的使用中，遇到一个问题：编辑/etc/sysconfig/iptables配置文件后，重启iptables服务(service iptables restart)。正在运行的docker容器可以正常接受请求，却不能向其他服务器发送http请求（tcp流量）。搜索之后发现，docker服务启动时，会增加iptables规则，应该是定义nat规则的。当iptables服务重启时，docker服务增加的iptables就被丢弃了，所以会出现这样的问题。</p>

<p>所以解决方式：</p>

<ol>
<li>重启docker服务 service docker restart</li>
<li>将docker增加的iptables持久化 iptables save（不怎么推荐且我也不知道有没有什么副作用）</li>
</ol>
  </div>
  
    
        
<script src="https://utteranc.es/client.js"
        repo="arloor/blog"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
        
</script>

<script>
document.head.insertAdjacentHTML("beforeend", "<style>\n    .utterances {\n      position: relative;\n      box-sizing: border-box;\n      width: 100%;\n      max-width: 100%;\n      margin-left: auto;\n      margin-right: auto;\n    }\n    .utterances-frame {\n      position: absolute;\n      left: 0;\n      right: 0;\n      width: 1px;\n      min-width: 100%;\n      max-width: 100%;\n      height: 100%;\n      border: 0;\n    }\n  </style>");
</script>

    


  

<div class="navigation navigation-single">
    
    <a href="/posts/linux/turn-ubuntu-mine-own/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">把ubuntu18.04 变成我的ubuntu</span>
    </a>
    
    
    <a href="/posts/other/java-aes128/" class="navigation-next">
      <span class="navigation-tittle">java-AES128加密-代码与一些约定</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

</article>


        </div>
        
    
  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-133187648-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


<script defer src="https://use.fontawesome.com/releases/v5.5.0/js/all.js" integrity="sha384-GqVMZRt5Gn7tB9D9q7ONtcp4gtHIUEW/yG7h98J7IpE3kpi+srfFyyB/04OV6pG0" crossorigin="anonymous"></script>


    
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
        
    
    <script type="text/javascript">
        
        hljs.initHighlightingOnLoad();
    </script>
    






    



    </body>
</html>
